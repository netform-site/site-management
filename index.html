<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ê³µì‚¬í˜„í™©ë¦¬ìŠ¤íŠ¸</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
<style>
:root {
  --primary: #6b8cce;
  --primary-light: #e8eef7;
  --success: #7bc47f;
  --success-light: #e8f5e9;
  --warning: #e4b363;
  --warning-light: #fff8e7;
  --danger: #e07a7a;
  --danger-light: #fdeaea;
  --purple: #a78bba;
  --purple-light: #f3eef7;
  --mint: #7ec4bc;
  --mint-light: #e6f5f3;
  --peach: #e8a87c;
  --peach-light: #fdf0e6;
  --gray-50: #fafbfc;
  --gray-100: #f4f5f7;
  --gray-200: #e8eaed;
  --gray-300: #d1d5db;
  --gray-400: #9ca3af;
  --gray-500: #6b7280;
  --gray-600: #4b5563;
  --gray-700: #374151;
  --gray-800: #1f2937;
  --white: #ffffff;
  --shadow: 0 2px 8px rgba(0,0,0,0.06);
  --shadow-lg: 0 4px 16px rgba(0,0,0,0.1);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Noto Sans KR', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #e8eef5 100%); color: var(--gray-700); line-height: 1.6; min-height: 100vh; }

.header { background: var(--white); border-bottom: 1px solid var(--gray-200); padding: 1rem 1.5rem; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow); }
.header-content { max-width: 1800px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
.logo { display: flex; align-items: center; gap: 0.75rem; }
.logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.7rem; }
.logo-text { font-size: 1.25rem; font-weight: 700; color: var(--gray-800); }

.year-tabs { display: flex; gap: 0.5rem; background: var(--gray-100); padding: 0.375rem; border-radius: 12px; }
.year-tab { padding: 0.5rem 1.25rem; border: none; background: transparent; color: var(--gray-500); font-size: 0.875rem; font-weight: 500; border-radius: 8px; cursor: pointer; font-family: inherit; transition: all 0.2s; }
.year-tab:hover { color: var(--gray-700); background: var(--white); }
.year-tab.active { background: var(--white); color: var(--primary); box-shadow: var(--shadow); font-weight: 600; }

.header-actions { display: flex; gap: 0.5rem; align-items: center; }

.btn { padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.8rem; font-weight: 500; cursor: pointer; border: none; font-family: inherit; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.375rem; }
.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: #5a7bbf; }
.btn-success { background: var(--success); color: white; }
.btn-success:hover { background: #6ab36e; }
.btn-danger { background: var(--danger); color: white; }
.btn-danger:hover { background: #cf6969; }
.btn-outline { background: var(--white); border: 1px solid var(--gray-300); color: var(--gray-600); }
.btn-outline:hover { background: var(--gray-50); border-color: var(--gray-400); }
.btn-sm { padding: 0.375rem 0.75rem; font-size: 0.75rem; }

.main { max-width: 1800px; margin: 0 auto; padding: 1.5rem; }

.card { background: var(--white); border-radius: 16px; border: 1px solid var(--gray-200); box-shadow: var(--shadow); overflow: hidden; margin-bottom: 1.5rem; }
.card-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.75rem; background: var(--gray-50); }
.card-title { font-size: 1rem; font-weight: 600; color: var(--gray-800); }

.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
.stat-card { background: var(--white); border-radius: 12px; padding: 1.25rem; border: 1px solid var(--gray-200); box-shadow: var(--shadow); }
.stat-card.paid { border-left: 4px solid var(--success); background: linear-gradient(135deg, var(--white) 0%, var(--success-light) 100%); }
.stat-card.contract { border-left: 4px solid var(--primary); background: linear-gradient(135deg, var(--white) 0%, var(--primary-light) 100%); }
.stat-card.interim { border-left: 4px solid var(--warning); background: linear-gradient(135deg, var(--white) 0%, var(--warning-light) 100%); }
.stat-card.balance { border-left: 4px solid var(--peach); background: linear-gradient(135deg, var(--white) 0%, var(--peach-light) 100%); }
.stat-label { font-size: 0.8rem; color: var(--gray-600); margin-bottom: 0.5rem; font-weight: 500; }
.stat-value { font-size: 1.4rem; font-weight: 700; color: var(--gray-800); margin-bottom: 0.25rem; }
.stat-sub { font-size: 0.875rem; color: var(--gray-500); font-weight: 600; }

.upload-area { padding: 2.5rem; border: 2px dashed var(--gray-300); border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.2s; background: var(--gray-50); margin: 1rem; }
.upload-area:hover, .upload-area.dragover { border-color: var(--primary); background: var(--primary-light); }
.upload-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
.upload-text { color: var(--gray-600); margin-bottom: 0.25rem; font-weight: 500; }
.upload-sub { font-size: 0.8rem; color: var(--gray-400); }
#fileInput { display: none; }

.table-wrapper { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
th { background: var(--gray-50); padding: 0.75rem 0.625rem; text-align: left; font-weight: 600; color: var(--gray-600); border-bottom: 2px solid var(--gray-200); white-space: nowrap; }
td { padding: 0.625rem; border-bottom: 1px solid var(--gray-100); vertical-align: middle; }
tr:hover { background: var(--gray-50); }
tr.selected { background: var(--primary-light); }
.text-right { text-align: right; }
.text-center { text-align: center; }
.font-mono { font-variant-numeric: tabular-nums; }

.payment-badge { display: inline-flex; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.7rem; font-weight: 600; }
.payment-badge.paid { background: var(--success-light); color: #2d7a32; }
.payment-badge.partial { background: var(--warning-light); color: #b8860b; }

/* í˜„ì¥ìƒì„¸ ëª¨ë‹¬ íƒ­ */
.detail-tabs { display: flex; gap: 0; border-bottom: 2px solid var(--gray-200); margin-bottom: 1rem; }
.detail-tab { padding: 0.75rem 1.5rem; border: none; background: transparent; color: var(--gray-500); font-size: 0.875rem; font-weight: 500; cursor: pointer; font-family: inherit; transition: all 0.2s; border-bottom: 2px solid transparent; margin-bottom: -2px; }
.detail-tab:hover { color: var(--gray-700); }
.detail-tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600; }

.detail-section { display: none; }
.detail-section.active { display: block; }

.detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
.detail-card { background: var(--gray-50); border-radius: 12px; padding: 1rem; border: 1px solid var(--gray-200); }
.detail-card-title { font-size: 0.875rem; font-weight: 600; color: var(--gray-700); margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--gray-200); }

.detail-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
.detail-table th { background: var(--gray-100); padding: 0.5rem; text-align: center; font-weight: 500; border: 1px solid var(--gray-200); }
.detail-table td { padding: 0.5rem; border: 1px solid var(--gray-200); }
.detail-table input { width: 100%; padding: 0.375rem; border: 1px solid var(--gray-300); border-radius: 4px; font-size: 0.8rem; font-family: inherit; }
.detail-table input:focus { outline: none; border-color: var(--primary); }
.detail-table input[type="number"] { text-align: right; }

.summary-row { background: var(--primary-light) !important; font-weight: 600; }
.summary-row td { color: var(--primary); }

.btn-detail { background: var(--purple-light); color: var(--purple); border: 1px solid var(--purple); }
.btn-detail:hover { background: var(--purple); color: white; }
.payment-badge.unpaid { background: var(--gray-100); color: var(--gray-500); }

.type-badge { padding: 0.2rem 0.5rem; border-radius: 6px; font-size: 0.7rem; font-weight: 600; }
.type-direct { background: var(--primary-light); color: var(--primary); }
.type-consulting { background: var(--purple-light); color: var(--purple); }

.checkbox { width: 18px; height: 18px; accent-color: var(--primary); cursor: pointer; }

.modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 1000; align-items: center; justify-content: center; padding: 1rem; }
.modal.active { display: flex; }
.modal-content { background: white; border-radius: 16px; max-width: 900px; width: 100%; max-height: 90vh; overflow: hidden; box-shadow: var(--shadow-lg); }
.modal-header { padding: 1.25rem; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; background: var(--gray-50); }
.modal-title { font-size: 1.125rem; font-weight: 600; color: var(--gray-800); }
.modal-close { width: 32px; height: 32px; border: none; background: var(--gray-100); border-radius: 8px; cursor: pointer; font-size: 1.25rem; color: var(--gray-500); }
.modal-close:hover { background: var(--gray-200); }
.modal-body { padding: 1.5rem; overflow-y: auto; max-height: calc(90vh - 140px); }
.modal-footer { padding: 1rem 1.25rem; border-top: 1px solid var(--gray-200); display: flex; justify-content: flex-end; gap: 0.5rem; background: var(--gray-50); }

.form-group { margin-bottom: 1rem; }
.form-label { display: block; font-size: 0.8rem; font-weight: 500; color: var(--gray-600); margin-bottom: 0.375rem; }
.form-input, .form-select { width: 100%; padding: 0.625rem 0.75rem; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 0.875rem; font-family: inherit; }
.form-input:focus, .form-select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
.form-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }

.payment-section { background: var(--gray-50); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; }
.payment-section-title { font-size: 0.875rem; font-weight: 600; color: var(--gray-700); margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--gray-200); }
.payment-section.contract { border-left: 4px solid var(--primary); }
.payment-section.interim { border-left: 4px solid var(--warning); }
.payment-section.interim2 { border-left: 4px solid var(--peach); }
.payment-section.balance { border-left: 4px solid var(--success); }

.toast { position: fixed; bottom: 2rem; right: 2rem; padding: 1rem 1.5rem; border-radius: 10px; color: white; font-weight: 500; z-index: 2000; transform: translateY(100px); opacity: 0; transition: all 0.3s; }
.toast.show { transform: translateY(0); opacity: 1; }
.toast.success { background: var(--success); }
.toast.error { background: var(--danger); }
.toast.info { background: var(--primary); }

.delete-count { background: var(--danger-light); color: var(--danger); padding: 0.25rem 0.625rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem; }

/* ê²€ìƒ‰ ì˜ì—­ */
.search-section { background: var(--white); border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 1rem; border: 1px solid var(--gray-200); box-shadow: var(--shadow); }
.search-row { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
.search-group { display: flex; align-items: center; gap: 0.5rem; }
.search-label { font-size: 0.8rem; font-weight: 500; color: var(--gray-600); white-space: nowrap; }
.search-input { padding: 0.5rem 0.75rem; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 0.875rem; font-family: inherit; min-width: 180px; }
.search-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
.search-select { padding: 0.5rem 0.75rem; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 0.875rem; font-family: inherit; background: white; min-width: 120px; }
.search-select:focus { outline: none; border-color: var(--primary); }
.btn-search { background: var(--primary); color: white; padding: 0.5rem 1rem; border: none; border-radius: 8px; font-size: 0.875rem; cursor: pointer; display: flex; align-items: center; gap: 0.375rem; font-family: inherit; }
.btn-search:hover { background: #5a7bbf; }
.btn-reset { background: var(--gray-100); color: var(--gray-600); padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 0.875rem; cursor: pointer; font-family: inherit; }
.btn-reset:hover { background: var(--gray-200); }
.search-result { font-size: 0.8rem; color: var(--gray-500); margin-left: auto; }
.search-result strong { color: var(--primary); }

/* ë‹´ë‹¹ìë³„ í†µê³„ */
.manager-stats-section { background: var(--white); border-radius: 12px; margin-bottom: 1rem; border: 1px solid var(--gray-200); box-shadow: var(--shadow); overflow: hidden; }
.manager-stats-header { padding: 1rem 1.25rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
.manager-stats-header:hover { opacity: 0.95; }
.toggle-icon { transition: transform 0.3s; }
.toggle-icon.collapsed { transform: rotate(-90deg); }
.manager-stats-content { padding: 1.25rem; display: block; }
.manager-stats-content.collapsed { display: none; }
.manager-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
.manager-category { }
.category-title { font-size: 1rem; font-weight: 700; color: var(--gray-700); margin-bottom: 0.75rem; padding: 0.5rem; background: var(--gray-100); border-radius: 6px; }
.manager-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
.manager-table th { background: var(--gray-50); padding: 0.625rem 0.5rem; text-align: center; font-weight: 600; color: var(--gray-600); border: 1px solid var(--gray-200); }
.manager-table td { padding: 0.5rem; border: 1px solid var(--gray-200); }
.manager-table td:first-child { text-align: left; }
.manager-table td:not(:first-child) { text-align: right; font-family: 'Courier New', monospace; }
.manager-table tbody tr:hover { background: var(--gray-50); }
.manager-table .subtotal-row { background: #e3f2fd; }
.manager-table .subtotal-row td { font-weight: 600; }
.manager-table .type-row { background: var(--gray-50); }
.manager-table .type-row td:first-child { padding-left: 1.5rem; font-size: 0.75rem; }
.grand-total-section { margin-top: 1rem; padding-top: 1rem; border-top: 2px solid var(--gray-300); }
.grand-total-table { max-width: 100%; }
.grand-total-table td { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600; padding: 0.75rem 1rem; }
.grand-total-table td:first-child { width: 200px; text-align: left; }
.grand-total-table td:not(:first-child) { text-align: right; font-family: 'Courier New', monospace; }

/* ê´€ë¦¬ì ì„¹ì…˜ */
.admin-section { background: var(--white); border-radius: 12px; margin-bottom: 1rem; border: 1px solid var(--gray-200); box-shadow: var(--shadow); overflow: hidden; }
.admin-header { padding: 0.875rem 1.25rem; background: var(--gray-100); color: var(--gray-600); font-weight: 500; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--gray-200); }
.admin-header:hover { background: var(--gray-200); }
.admin-content { padding: 1rem 1.25rem; background: var(--gray-50); }
.admin-buttons { display: flex; gap: 0.75rem; flex-wrap: wrap; }
.btn-admin { background: var(--gray-600); color: white; padding: 0.625rem 1rem; border: none; border-radius: 8px; font-size: 0.875rem; cursor: pointer; font-family: inherit; transition: all 0.2s; }
.btn-admin:hover { background: var(--gray-700); }

/* ì •ì‚° í…Œì´ë¸” */
.settlement-table { width: 100%; border-collapse: collapse; font-size: 0.78rem; }
.settlement-table th { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 0.7rem 0.5rem; text-align: center; font-weight: 600; border: 1px solid #2c3e50; white-space: nowrap; }
.settlement-table td { padding: 0.55rem 0.5rem; border: 1px solid var(--gray-300); text-align: right; font-family: 'Courier New', monospace; color: var(--gray-800); background: white; }
.settlement-table td:nth-child(1) { text-align: center; font-weight: 600; color: #2c3e50; }
.settlement-table td:nth-child(2) { text-align: center; font-weight: 600; }
.settlement-table td:nth-child(3) { text-align: center; }
.settlement-table td:nth-child(4) { text-align: center; font-family: inherit; font-size: 0.72rem; }
.settlement-table td:nth-child(5) { text-align: left; font-family: inherit; font-weight: 600; color: #1565c0; min-width: 120px; }
.settlement-table td:nth-child(7) { text-align: center; font-weight: 600; }
.settlement-table td:nth-child(17) { text-align: center; font-family: inherit; }
.settlement-table tbody tr:hover { background: #e3f2fd !important; }
.settlement-table tbody tr:nth-child(even) { background: #fafafa; }
.settlement-table tbody tr.status-ì…ê¸ˆ td:nth-child(7) { background: #c8e6c9; color: #2e7d32; border-radius: 4px; }
.settlement-table tbody tr.status-ì§„í–‰ td:nth-child(7) { background: #fff3e0; color: #e65100; border-radius: 4px; }
.settlement-table tbody tr.status-ë¯¸ì…ê¸ˆ td:nth-child(7) { background: #ffcdd2; color: #c62828; border-radius: 4px; }
.settlement-table tbody tr .profit-positive { color: #2e7d32; font-weight: 700; }
.settlement-table tbody tr .profit-negative { color: #c62828; font-weight: 700; }
.settlement-table tfoot td { background: linear-gradient(135deg, #eceff1 0%, #cfd8dc 100%); font-weight: 700; padding: 0.75rem 0.5rem; color: #37474f; font-size: 0.82rem; border: 1px solid #b0bec5; }

/* ì •ì‚° ìš”ì•½ ì¹´ë“œ */
.settlement-summary-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
.settlement-summary-card { background: var(--white); border-radius: 10px; padding: 1rem; border: 1px solid var(--gray-200); box-shadow: var(--shadow); }
.settlement-summary-card .manager-name { font-size: 1rem; font-weight: 700; color: var(--gray-700); margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--primary); }
.settlement-summary-card .summary-row { display: flex; justify-content: space-between; padding: 0.375rem 0; font-size: 0.8rem; }
.settlement-summary-card .summary-row .label { color: var(--gray-500); }
.settlement-summary-card .summary-row .value { font-weight: 600; font-family: 'Courier New', monospace; }
.settlement-summary-card .summary-total { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px dashed var(--gray-300); }
.settlement-summary-card .summary-total .value { color: var(--primary); font-size: 1.1rem; }

@media (max-width: 768px) {
  .header-content { flex-direction: column; }
  .year-tabs { flex-wrap: wrap; justify-content: center; }
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .form-row { grid-template-columns: 1fr; }
  .search-row { flex-direction: column; align-items: stretch; }
  .search-group { width: 100%; }
  .search-input, .search-select { width: 100%; }
  .search-result { margin-left: 0; margin-top: 0.5rem; }
  .manager-stats-grid { grid-template-columns: 1fr; }
  .settlement-summary-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<header class="header">
  <div class="header-content">
    <div class="logo">
      <div class="logo-icon">LIST</div>
      <span class="logo-text">ê³µì‚¬í˜„í™©ë¦¬ìŠ¤íŠ¸</span>
    </div>
    <div class="year-tabs" id="yearTabs">
      <button type="button" class="year-tab" data-year="2020-2021">2020~2021</button>
      <button type="button" class="year-tab" data-year="2022">2022</button>
      <button type="button" class="year-tab" data-year="2023">2023</button>
      <button type="button" class="year-tab" data-year="2024">2024</button>
      <button type="button" class="year-tab" data-year="2025">2025</button>
      <button type="button" class="year-tab active" data-year="2026">2026</button>
    </div>
    <div class="header-actions">
      <button class="btn btn-outline" onclick="setResetPassword()" style="font-size:0.75rem;padding:0.25rem 0.5rem;" title="ì´ˆê¸°í™” ë¹„ë°€ë²ˆí˜¸ ì„¤ì •/ë³€ê²½">ğŸ”</button>
      <button class="btn btn-outline" onclick="clearStorage()" style="color:var(--danger);border-color:var(--danger);" title="ë¹„ë°€ë²ˆí˜¸ í•„ìš”">âš ï¸ ì´ˆê¸°í™”</button>
      <button class="btn btn-outline" onclick="exportToExcel()">ë‹¤ìš´ë¡œë“œ</button>
      <button class="btn btn-outline" onclick="document.getElementById('bulkSummaryInput').click()" style="color:#9c27b0;border-color:#9c27b0;" title="ì´ê´„í‘œ ì—¬ëŸ¬ ê°œ í•œë²ˆì— ì—…ë¡œë“œ">ğŸ“ ì´ê´„í‘œ ì¼ê´„</button>
      <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">ì—‘ì…€ ì—…ë¡œë“œ</button>
    </div>
  </div>
</header>

<main class="main">
  <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)">
  <input type="file" id="bulkSummaryInput" accept=".xlsx,.xls" multiple onchange="handleBulkSummaryUpload(event)">
  
  <!-- ë©”ì¸ íƒ­: ê³µì‚¬í˜„í™© / ê¸°ìˆ ì»¨ì„¤íŒ… -->
  <div class="main-list-tabs" style="display:flex;gap:0;margin-bottom:1rem;border-bottom:3px solid #1976d2;position:relative;z-index:10;">
    <button type="button" class="main-list-tab active" onclick="switchMainListTab('construction')" id="mainTabConstruction" style="padding:0.75rem 2rem;border:none;background:#1976d2;color:white;font-weight:600;font-size:1rem;cursor:pointer;border-radius:8px 8px 0 0;margin-right:4px;">
      ğŸ—ï¸ ê³µì‚¬í˜„í™©
    </button>
    <button type="button" class="main-list-tab" onclick="switchMainListTab('consulting')" id="mainTabConsulting" style="padding:0.75rem 2rem;border:none;background:#e0e0e0;color:#666;font-weight:600;font-size:1rem;cursor:pointer;border-radius:8px 8px 0 0;">
      ğŸ“‹ ê¸°ìˆ ì»¨ì„¤íŒ…
    </button>
  </div>
  
  <!-- ê³µì‚¬í˜„í™© ì„¹ì…˜ -->
  <div id="mainConstructionSection">
    <div class="stats-grid">
    <div class="stat-card paid">
      <div class="stat-label">âœ… ì…ê¸ˆì™„ë£Œ (ì”ê¸ˆê¹Œì§€)</div>
      <div class="stat-value" id="statPaidAmount">0ì›</div>
      <div class="stat-sub" id="statPaidCount">0ê±´ <span style="font-size:0.7rem;color:#888;">(VATë³„ë„)</span></div>
    </div>
    <div class="stat-card contract">
      <div class="stat-label">ğŸ“ ê³„ì•½ê¸ˆ ì…ê¸ˆ</div>
      <div class="stat-value" id="statContractAmount">0ì›</div>
      <div class="stat-sub" id="statContractCount">0ê±´ <span style="font-size:0.7rem;color:#888;">(VATë³„ë„)</span></div>
    </div>
    <div class="stat-card interim">
      <div class="stat-label">ğŸ”„ ì¤‘ë„ê¸ˆ ì§„í–‰</div>
      <div class="stat-value" id="statInterimAmount">0ì›</div>
      <div class="stat-sub" id="statInterimCount">0ê±´ <span style="font-size:0.7rem;color:#888;">(VATë³„ë„)</span></div>
    </div>
    <div class="stat-card balance">
      <div class="stat-label">â³ ë¯¸ì…ê¸ˆ/ì§„í–‰ì¤‘</div>
      <div class="stat-value" id="statBalanceAmount">0ì›</div>
      <div class="stat-sub" id="statBalanceCount">0ê±´ <span style="font-size:0.7rem;color:#888;">(VATë³„ë„)</span></div>
    </div>
    </div><!-- stats-grid ë -->

  <!-- ê´€ë¦¬ì ì „ìš© ë©”ë‰´ (ë¹„ë°€ë²ˆí˜¸ ë³´í˜¸) -->
  <div class="admin-section" id="adminSection">
    <div class="admin-header" onclick="toggleAdminSection()">
      <span>ğŸ”’ ê´€ë¦¬ì ì „ìš©</span>
      <span class="toggle-icon" id="adminToggleIcon">â–¼</span>
    </div>
    <div class="admin-content" id="adminContent" style="display:none;">
      <div class="admin-buttons">
        <button class="btn btn-admin" onclick="showManagerStats()">ğŸ‘¥ ë‹´ë‹¹ìë³„ ì‹¤ì  í˜„í™©</button>
        <button class="btn btn-admin" onclick="showSettlementManagement()">ğŸ’° ì •ì‚° ê´€ë¦¬</button>
        <button class="btn btn-admin" onclick="document.getElementById('settlementFileInput').click()">ğŸ“‚ ì •ì‚°ë¦¬ìŠ¤íŠ¸ ì—…ë¡œë“œ</button>
        <button class="btn btn-admin" onclick="showLastBulkUploadResults()" style="background:#9c27b0;">ğŸ“‹ ì´ê´„í‘œ ê²°ê³¼</button>
        <button class="btn btn-admin" onclick="openPasswordChangeModal()" style="margin-left:auto;background:var(--gray-500);">âš™ï¸ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
      </div>
      <input type="file" id="settlementFileInput" accept=".xlsx,.xls" style="display:none;" onchange="handleSettlementUpload(event)">
    </div>
  </div>

  <!-- ë‹´ë‹¹ìë³„ í†µê³„ (ìˆ¨ê¹€) -->
  <div class="manager-stats-section" id="managerStatsSection" style="display:none;">
    <div class="manager-stats-header" onclick="toggleManagerStats()">
      <span>ğŸ‘¥ ë‹´ë‹¹ìë³„ ì‹¤ì  í˜„í™©</span>
      <span class="toggle-icon" id="managerToggleIcon">â–¼</span>
    </div>
    <div class="manager-stats-content" id="managerStatsContent">
      <div class="manager-stats-grid">
        <!-- ë³¸ì‚¬ -->
        <div class="manager-category">
          <div class="category-title">< ë³¸ ì‚¬ ></div>
          <table class="manager-table">
            <thead>
              <tr>
                <th>ë‹´ë‹¹ì</th>
                <th>ê³„ì•½ê±´ìˆ˜</th>
                <th>ê³µì‚¬ê¸ˆì•¡(VATë³„ë„)</th>
                <th>ê³µì‚¬ê¸ˆì•¡(VATí¬í•¨)</th>
              </tr>
            </thead>
            <tbody id="hqManagerTableBody">
            </tbody>
            <tfoot>
              <tr class="subtotal-row">
                <td><strong>ë³¸ì‚¬ ì˜ì—…ë‹´ë‹¹ì ê³µì‚¬ê¸ˆì•¡ í•©ê³„</strong></td>
                <td id="hqTotalCount"><strong>0</strong></td>
                <td id="hqTotalAmount"><strong>0</strong></td>
                <td id="hqTotalAmountTax"><strong>0</strong></td>
              </tr>
              <tr class="type-row">
                <td>ê³µì‚¬ê¸ˆì•¡ í•©ê³„ [ POUR ì»¨ì„¤íŒ… ]</td>
                <td id="hqConsultingCount">0</td>
                <td id="hqConsultingAmount">0</td>
                <td id="hqConsultingAmountTax">0</td>
              </tr>
              <tr class="type-row">
                <td>ê³µì‚¬ê¸ˆì•¡ í•©ê³„ [ ì§ ì˜ ]</td>
                <td id="hqDirectCount">0</td>
                <td id="hqDirectAmount">0</td>
                <td id="hqDirectAmountTax">0</td>
              </tr>
            </tfoot>
          </table>
        </div>
        
        <!-- ì™¸ì£¼ -->
        <div class="manager-category">
          <div class="category-title">< ì™¸ ì£¼ ></div>
          <table class="manager-table">
            <thead>
              <tr>
                <th>ë‹´ë‹¹ì</th>
                <th>ê³„ì•½ê±´ìˆ˜</th>
                <th>ê³µì‚¬ê¸ˆì•¡(VATë³„ë„)</th>
                <th>ê³µì‚¬ê¸ˆì•¡(VATí¬í•¨)</th>
              </tr>
            </thead>
            <tbody id="extManagerTableBody">
            </tbody>
            <tfoot>
              <tr class="subtotal-row">
                <td><strong>ì™¸ì£¼ ì˜ì—…ë‹´ë‹¹ì ê³µì‚¬ê¸ˆì•¡ í•©ê³„</strong></td>
                <td id="extTotalCount"><strong>0</strong></td>
                <td id="extTotalAmount"><strong>0</strong></td>
                <td id="extTotalAmountTax"><strong>0</strong></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
      
      <!-- ì „ì²´ í•©ê³„ -->
      <div class="grand-total-section">
        <table class="manager-table grand-total-table">
          <tr>
            <td><strong>ì „ì²´ í•©ê³„</strong></td>
            <td id="grandTotalCount"><strong>0ê±´</strong></td>
            <td id="grandTotalAmount"><strong>0</strong></td>
            <td id="grandTotalAmountTax"><strong>0</strong></td>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <!-- ê²€ìƒ‰ ì˜ì—­ -->
  <div class="search-section">
    <div class="search-row">
      <div class="search-group">
        <span class="search-label">ğŸ” ê²€ìƒ‰</span>
        <input type="text" class="search-input" id="searchKeyword" placeholder="í˜„ì¥ëª…, ê³µì‚¬ëª…, ë‹´ë‹¹ì ê²€ìƒ‰..." onkeyup="handleSearchKeyup(event)">
      </div>
      <div class="search-group">
        <span class="search-label">ì…ê¸ˆìƒíƒœ</span>
        <select class="search-select" id="searchStatus" onchange="performSearch()">
          <option value="">ì „ì²´</option>
          <option value="completed">ì…ê¸ˆì™„ë£Œ</option>
          <option value="contract">ê³„ì•½ê¸ˆì…ê¸ˆ</option>
          <option value="interim">ì¤‘ë„ê¸ˆì§„í–‰</option>
          <option value="unpaid">ë¯¸ì…ê¸ˆ</option>
          <option value="progress">ì§„í–‰ì¤‘</option>
          <option value="cancelled">í•´ì§€</option>
        </select>
      </div>
      <div class="search-group">
        <span class="search-label">ê³µì‚¬ìœ í˜•</span>
        <select class="search-select" id="searchType" onchange="performSearch()">
          <option value="">ì „ì²´</option>
          <option value="ì§ì˜(ë³¸)">ì§ì˜(ë³¸)</option>
          <option value="ì§ì˜(ì™¸)">ì§ì˜(ì™¸)</option>
          <option value="ì»¨ì„¤íŒ…(ë³¸)">ì»¨ì„¤íŒ…(ë³¸)</option>
          <option value="ì»¨ì„¤íŒ…(ì™¸)">ì»¨ì„¤íŒ…(ì™¸)</option>
        </select>
      </div>
      <button class="btn-search" onclick="performSearch()">ê²€ìƒ‰</button>
      <button class="btn-reset" onclick="resetSearch()">ì´ˆê¸°í™”</button>
      <div class="search-result" id="searchResult"></div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <div style="display:flex;align-items:center;gap:0.75rem;">
        <span class="card-title" id="tableTitle">2025ë…„ ê³µì‚¬í˜„í™©</span>
        <span style="font-size:0.8rem;color:var(--gray-400);" id="totalCount">ì´ 0ê±´</span>
      </div>
      <div style="display:flex;gap:0.5rem;">
        <button class="btn btn-danger btn-sm" id="deleteSelectedBtn" style="display:none;" onclick="deleteSelected()">ì„ íƒ ì‚­ì œ <span class="delete-count" id="deleteCount">0</span></button>
        <button class="btn btn-success btn-sm" onclick="openAddModal()">ì¶”ê°€</button>
      </div>
    </div>
    
    <div class="upload-area" id="uploadArea">
      <div class="upload-icon">ğŸ“‚</div>
      <div class="upload-text">ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</div>
      <div class="upload-sub">ì§€ì› í˜•ì‹: .xlsx, .xls, .csv</div>
    </div>
    
    <div class="table-wrapper" id="tableWrapper" style="display:none;">
      <table>
        <thead>
          <tr>
            <th style="width:40px;"><input type="checkbox" class="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
            <th>NO</th>
            <th>ì§€ì—­</th>
            <th>ê³µì‚¬í˜„ì¥</th>
            <th>ê³µì‚¬ëª…</th>
            <th class="text-right">ê³„ì•½ê¸ˆì•¡<br><span style="font-size:0.65rem;color:#888;">(VATë³„ë„)</span></th>
            <th class="text-right">ê³„ì•½ê¸ˆì•¡<br><span style="font-size:0.65rem;color:#888;">(VATí¬í•¨)</span></th>
            <th>ê³„ì•½ì¼</th>
            <th>ì°©ê³µì¼</th>
            <th>ì¤€ê³µì¼</th>
            <th class="text-center">ê³„ì•½ê¸ˆ</th>
            <th class="text-center">ì¤‘ë„ê¸ˆ</th>
            <th class="text-center">ì”ê¸ˆ</th>
            <th>ìœ í˜•</th>
            <th>ë‹´ë‹¹ì</th>
            <th style="min-width:120px;">í˜„ì¥ì†Œì¥</th>
            <th style="width:60px;">ìƒì„¸</th>
            <th style="width:60px;">ê´€ë¦¬</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>
  </div><!-- mainConstructionSection ë -->
  
  <!-- ê¸°ìˆ ì»¨ì„¤íŒ… ë©”ì¸ ì„¹ì…˜ -->
  <div id="mainConsultingSection" style="display:none;">
    <!-- í†µê³„ ì¹´ë“œ -->
    <div class="stats-grid" style="grid-template-columns:repeat(4,1fr);">
      <div class="stat-card" style="border-left-color:#00897b;">
        <div class="stat-label">ğŸ“Š ì´ í˜„ì¥</div>
        <div class="stat-value" id="consultingMainStatTotal" style="color:#00897b;">0ê±´</div>
      </div>
      <div class="stat-card" style="border-left-color:#2196f3;">
        <div class="stat-label">ğŸ“‹ ì»¨ì„¤íŒ…(Y)</div>
        <div class="stat-value" id="consultingMainStatY" style="color:#2196f3;">0ê±´</div>
      </div>
      <div class="stat-card" style="border-left-color:#ff9800;">
        <div class="stat-label">ğŸ’° ì´ ë‚™ì°°ê¸ˆì•¡</div>
        <div class="stat-value" id="consultingMainStatBid" style="color:#ff9800;">0ì›</div>
      </div>
      <div class="stat-card" style="border-left-color:#4caf50;">
        <div class="stat-label">ğŸ“ˆ ì´ ì‹¤í–‰ê¸ˆì•¡</div>
        <div class="stat-value" id="consultingMainStatExec" style="color:#4caf50;">0ì›</div>
      </div>
    </div>
    
    <!-- í•„í„° ë° ì¶”ê°€ ë²„íŠ¼ -->
    <div class="search-section">
      <div class="search-row">
        <button class="btn btn-primary" onclick="openConsultingItemModal()">â• ì‹ ê·œ ë“±ë¡</button>
        <input type="text" id="consultingMainSearch" placeholder="ğŸ” í˜„ì¥ëª… ê²€ìƒ‰..." oninput="filterConsultingMain()" style="padding:0.5rem 0.75rem;border:1px solid #ddd;border-radius:6px;width:180px;">
        <select id="consultingMainYearFilter" class="search-select" onchange="filterConsultingMain()">
          <option value="">ì „ì²´ ë…„ë„</option>
          <option value="2024">2024ë…„</option>
          <option value="2025">2025ë…„</option>
          <option value="2026">2026ë…„</option>
        </select>
        <select id="consultingMainTypeFilter" class="search-select" onchange="filterConsultingMain()">
          <option value="">êµ¬ë¶„ ì „ì²´</option>
          <option value="ì¼ë°˜">ì¼ë°˜</option>
          <option value="ì‹œì§€ì›">ì‹œì§€ì›</option>
          <option value="ì‚¬í›„ì •ì‚°">ì‚¬í›„ì •ì‚°</option>
        </select>
        <select id="consultingMainManagerFilter" class="search-select" onchange="filterConsultingMain()">
          <option value="">ì „ì²´ ë‹´ë‹¹ì</option>
        </select>
        <div style="margin-left:auto;display:flex;gap:0.5rem;align-items:center;">
          <span id="consultingMainCount" style="font-size:0.85rem;color:#666;">0ê±´</span>
          <button class="btn btn-success btn-sm" onclick="downloadConsultingListExcel()">ğŸ“¥ ì—‘ì…€</button>
        </div>
      </div>
    </div>
    
    <!-- í…Œì´ë¸” -->
    <div class="table-container">
      <table class="data-table" id="consultingMainTable">
        <thead>
          <tr>
            <th style="width:45px;">ë…„ë„</th>
            <th style="width:65px;">êµ¬ë¶„</th>
            <th style="width:50px;">ì»¨ì„¤íŒ…</th>
            <th style="min-width:130px;">ê³µì‚¬í˜„ì¥</th>
            <th style="min-width:100px;">ê³µì‚¬ëª…</th>
            <th style="width:95px;">ë‚™ì°°ê¸ˆì•¡</th>
            <th style="width:95px;">ì‹¤í–‰ê¸ˆì•¡</th>
            <th style="width:65px;">ì˜ì—…ë‹´ë‹¹</th>
            <th style="width:80px;">ì—…ì²´ëª…</th>
            <th style="width:60px;">ì—…ì²´ë‹´ë‹¹</th>
            <th style="width:70px;">í•˜ìê¸°ê°„</th>
            <th style="width:60px;">í˜„ì¥ì†Œì¥</th>
            <th style="width:45px;">ì‚¬ì§„</th>
            <th style="width:85px;">ê³„ì•½ì¼</th>
            <th style="width:85px;">ì‹¤ì°©ê³µì¼</th>
            <th style="width:85px;">ì‹¤ì¤€ê³µì¼</th>
            <th style="min-width:80px;">ë¹„ê³ </th>
            <th style="width:70px;">ê´€ë¦¬</th>
          </tr>
        </thead>
        <tbody id="consultingMainTableBody"></tbody>
      </table>
    </div>
  </div><!-- mainConsultingSection ë -->
</main>

<div class="modal" id="editModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">ê³µì‚¬ ì •ë³´ ìˆ˜ì •</div>
      <button class="modal-close" onclick="closeModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editIndex">
      
      <div class="form-row">
        <div class="form-group"><label class="form-label">NO</label><input type="text" class="form-input" id="editNo"></div>
        <div class="form-group"><label class="form-label">ì§€ì—­</label><input type="text" class="form-input" id="editRegion"></div>
        <div class="form-group"><label class="form-label">ê³µì‚¬ìœ í˜•</label>
          <select class="form-select" id="editType">
            <option value="">ì„ íƒ</option>
            <option value="ì§ì˜(ë³¸)">ì§ì˜(ë³¸)</option>
            <option value="ì§ì˜(ì™¸)">ì§ì˜(ì™¸)</option>
            <option value="ì»¨ì„¤íŒ…(ë³¸)">ì»¨ì„¤íŒ…(ë³¸)</option>
            <option value="ì»¨ì„¤íŒ…(ì™¸)">ì»¨ì„¤íŒ…(ì™¸)</option>
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group" style="grid-column:span 2;"><label class="form-label">ê³µì‚¬í˜„ì¥</label><input type="text" class="form-input" id="editSite"></div>
        <div class="form-group"><label class="form-label">ì˜ì—…ë‹´ë‹¹ì</label><input type="text" class="form-input" id="editManager"></div>
      </div>
      
      <div class="form-group"><label class="form-label">ê³µì‚¬ëª…</label><input type="text" class="form-input" id="editName"></div>
      
      <div class="form-row">
        <div class="form-group"><label class="form-label">ê³„ì•½ê¸ˆì•¡ (ë¶€ê°€ì„¸ë³„ë„)</label><input type="text" class="form-input" id="editAmount" oninput="updateTaxAmount()"></div>
        <div class="form-group"><label class="form-label">ê³„ì•½ê¸ˆì•¡ (ë¶€ê°€ì„¸í¬í•¨)</label><input type="text" class="form-input" id="editAmountTax" readonly style="background:var(--gray-50);"></div>
        <div class="form-group"><label class="form-label">í˜„ì¥ì†Œì¥</label><input type="text" class="form-input" id="editSiteManager"></div>
      </div>
      
      <div class="form-row">
        <div class="form-group"><label class="form-label">ê³„ì•½ì¼</label><input type="date" class="form-input" id="editContractDate"></div>
        <div class="form-group"><label class="form-label">ì°©ê³µì¼</label><input type="date" class="form-input" id="editStartDate"></div>
        <div class="form-group"><label class="form-label">ì¤€ê³µì¼</label><input type="date" class="form-input" id="editEndDate"></div>
      </div>
      
      <div class="payment-section contract">
        <div class="payment-section-title">ê³„ì•½ê¸ˆ</div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">ê¸ˆì•¡</label><input type="text" class="form-input" id="editContract1Amt"></div>
          <div class="form-group"><label class="form-label">ê³„ì‚°ì„œ ë°œí–‰ì¼</label><input type="date" class="form-input" id="editContract1Bill"></div>
          <div class="form-group"><label class="form-label">ì…ê¸ˆì¼</label><input type="date" class="form-input" id="editContract1Paid"></div>
        </div>
      </div>
      
      <div class="payment-section interim">
        <div class="payment-section-title">ì¤‘ë„ê¸ˆ</div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">ê¸ˆì•¡</label><input type="text" class="form-input" id="editInterim1Amt"></div>
          <div class="form-group"><label class="form-label">ê³„ì‚°ì„œ ë°œí–‰ì¼</label><input type="date" class="form-input" id="editInterim1Bill"></div>
          <div class="form-group"><label class="form-label">ì…ê¸ˆì¼</label><input type="date" class="form-input" id="editInterim1Paid"></div>
        </div>
      </div>
      
      <div class="payment-section interim2">
        <div class="payment-section-title">ì¤‘ë„ê¸ˆ2</div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">ê¸ˆì•¡</label><input type="text" class="form-input" id="editInterim2Amt"></div>
          <div class="form-group"><label class="form-label">ê³„ì‚°ì„œ ë°œí–‰ì¼</label><input type="date" class="form-input" id="editInterim2Bill"></div>
          <div class="form-group"><label class="form-label">ì…ê¸ˆì¼</label><input type="date" class="form-input" id="editInterim2Paid"></div>
        </div>
      </div>
      
      <div class="payment-section balance">
        <div class="payment-section-title">ì”ê¸ˆ</div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">ê¸ˆì•¡</label><input type="text" class="form-input" id="editBalance1Amt"></div>
          <div class="form-group"><label class="form-label">ê³„ì‚°ì„œ ë°œí–‰ì¼</label><input type="date" class="form-input" id="editBalance1Bill"></div>
          <div class="form-group"><label class="form-label">ì…ê¸ˆì¼</label><input type="date" class="form-input" id="editBalance1Paid"></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal()">ì·¨ì†Œ</button>
      <button class="btn btn-success" onclick="saveData()">ì €ì¥</button>
    </div>
  </div>
</div>

<div class="modal" id="deleteModal">
  <div class="modal-content" style="max-width:400px;">
    <div class="modal-header">
      <div class="modal-title">ì‚­ì œ í™•ì¸</div>
      <button class="modal-close" onclick="closeDeleteModal()">Ã—</button>
    </div>
    <div class="modal-body" style="text-align:center;padding:2rem;">
      <div style="font-size:3rem;margin-bottom:1rem;">âš ï¸</div>
      <div style="font-size:1rem;margin-bottom:0.5rem;" id="deleteMessage">ì„ íƒí•œ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
      <div style="font-size:0.8rem;color:var(--gray-400);">ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
    </div>
    <div class="modal-footer" style="justify-content:center;">
      <button class="btn btn-outline" onclick="closeDeleteModal()">ì·¨ì†Œ</button>
      <button class="btn btn-danger" onclick="confirmDelete()">ì‚­ì œ</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ -->
<div class="modal" id="passwordChangeModal">
  <div class="modal-content" style="max-width:420px;">
    <div class="modal-header">
      <div class="modal-title">âš™ï¸ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
      <button class="modal-close" onclick="closePasswordChangeModal()">Ã—</button>
    </div>
    <div class="modal-body" style="padding:1.5rem;">
      <div class="form-group" style="margin-bottom:1rem;">
        <label class="form-label">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
        <input type="password" id="currentPassword" class="form-input" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
      </div>
      <div class="form-group" style="margin-bottom:1rem;">
        <label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
        <input type="password" id="newPassword" class="form-input" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
      </div>
      <div class="form-group" style="margin-bottom:0.5rem;">
        <label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
        <input type="password" id="confirmPassword" class="form-input" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ë‹¤ì‹œ ì…ë ¥">
      </div>
      <div id="passwordChangeError" style="color:var(--danger);font-size:0.8rem;margin-top:0.5rem;display:none;"></div>
      <div id="passwordChangeSuccess" style="color:var(--success);font-size:0.8rem;margin-top:0.5rem;display:none;"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closePasswordChangeModal()">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="changePassword()">ë³€ê²½</button>
    </div>
  </div>
</div>

<!-- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ -->
<div class="modal" id="passwordModal">
  <div class="modal-content" style="max-width:400px;">
    <div class="modal-header">
      <div class="modal-title">ğŸ” ê´€ë¦¬ì ì¸ì¦</div>
      <button class="modal-close" onclick="closePasswordModal()">Ã—</button>
    </div>
    <div class="modal-body" style="text-align:center;padding:2rem;">
      <div style="font-size:3rem;margin-bottom:1rem;">ğŸ”’</div>
      <div style="margin-bottom:1rem;color:var(--gray-600);">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
      <input type="password" id="adminPassword" class="form-input" style="text-align:center;font-size:1.2rem;letter-spacing:0.3rem;" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" onkeyup="handlePasswordKeyup(event)">
      <div id="passwordError" style="color:var(--danger);font-size:0.8rem;margin-top:0.5rem;display:none;">ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.</div>
    </div>
    <div class="modal-footer" style="justify-content:center;">
      <button class="btn btn-outline" onclick="closePasswordModal()">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="verifyPassword()">í™•ì¸</button>
    </div>
  </div>
</div>

<!-- ì •ì‚° ê´€ë¦¬ ëª¨ë‹¬ -->
<div class="modal" id="settlementModal">
  <div class="modal-content" style="max-width:1400px;max-height:90vh;overflow-y:auto;">
    <div class="modal-header" style="background:var(--gray-100);color:var(--gray-700);">
      <div class="modal-title">ğŸ’° ì •ì‚° ê´€ë¦¬</div>
      <button class="modal-close" onclick="closeSettlementModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <!-- ì •ì‚°ê´€ë¦¬ íƒ­ -->
      <div class="settlement-main-tabs" style="display:flex;gap:0;margin-bottom:1.5rem;border-bottom:2px solid #ddd;">
        <button class="settlement-main-tab active" onclick="switchSettlementMainTab('construction')" id="tabConstruction" style="padding:0.75rem 1.5rem;border:none;background:#1976d2;color:white;font-weight:600;cursor:pointer;border-radius:8px 8px 0 0;margin-right:4px;">
          ğŸ—ï¸ ê³µì‚¬ ì •ì‚°
        </button>
        <button class="settlement-main-tab" onclick="switchSettlementMainTab('consulting')" id="tabConsulting" style="padding:0.75rem 1.5rem;border:none;background:#e0e0e0;color:#666;font-weight:600;cursor:pointer;border-radius:8px 8px 0 0;">
          ğŸ“‹ ê¸°ìˆ ì»¨ì„¤íŒ…
        </button>
      </div>
      
      <!-- ê³µì‚¬ ì •ì‚° ì„¹ì…˜ -->
      <div id="constructionSection">
      <!-- í†µê³„ ì¹´ë“œ -->
      <div id="settlementStatsCards" style="display:grid;grid-template-columns:repeat(5,1fr);gap:0.75rem;margin-bottom:1.5rem;">
        <div style="background:white;border:1px solid #e0e0e0;border-left:4px solid #2196f3;padding:1rem;border-radius:8px;">
          <div style="font-size:0.8rem;color:#666;margin-bottom:0.5rem;">ğŸ“Š ê³µì‚¬ê¸ˆì•¡</div>
          <div id="settlementStatAmount" style="font-size:1.3rem;font-weight:700;color:#1565c0;">0ì›</div>
          <div id="settlementStatAmountCount" style="font-size:0.75rem;color:#999;">0ê±´</div>
        </div>
        <div style="background:white;border:1px solid #e0e0e0;border-left:4px solid #ff9800;padding:1rem;border-radius:8px;">
          <div style="font-size:0.8rem;color:#666;margin-bottom:0.5rem;">ğŸ’¸ ì§€ì¶œì´ì•¡</div>
          <div id="settlementStatExpense" style="font-size:1.3rem;font-weight:700;color:#e65100;">0ì›</div>
        </div>
        <div style="background:white;border:1px solid #e0e0e0;border-left:4px solid #4caf50;padding:1rem;border-radius:8px;">
          <div style="font-size:0.8rem;color:#666;margin-bottom:0.5rem;">ğŸ’° ì´ìµê¸ˆ</div>
          <div id="settlementStatProfit" style="font-size:1.3rem;font-weight:700;color:#2e7d32;">0ì›</div>
          <div id="settlementStatProfitRate" style="font-size:0.75rem;color:#999;">ì´ìµë¥  0%</div>
        </div>
        <div style="background:white;border:1px solid #e0e0e0;border-left:4px solid #9c27b0;padding:1rem;border-radius:8px;">
          <div style="font-size:0.8rem;color:#666;margin-bottom:0.5rem;">ğŸ‘¤ ì •ì‚°ê¸ˆì•¡ (15%)</div>
          <div id="settlementStatSettlement" style="font-size:1.3rem;font-weight:700;color:#7b1fa2;">0ì›</div>
        </div>
        <div style="background:white;border:1px solid #e0e0e0;border-left:4px solid #607d8b;padding:1rem;border-radius:8px;">
          <div style="font-size:0.8rem;color:#666;margin-bottom:0.5rem;">ğŸ¢ íšŒì‚¬ìˆ˜ìµ (85%)</div>
          <div id="settlementStatCompany" style="font-size:1.3rem;font-weight:700;color:#455a64;">0ì›</div>
        </div>
      </div>
      
      <!-- í•„í„° ì˜ì—­ -->
      <div style="margin-bottom:1rem;display:flex;gap:0.75rem;align-items:center;flex-wrap:wrap;">
        <input type="text" id="settlementSearchInput" placeholder="ğŸ” í˜„ì¥ëª… ê²€ìƒ‰..." oninput="filterSettlementByManager()" style="padding:0.5rem 0.75rem;border:1px solid #ddd;border-radius:6px;width:180px;font-size:0.85rem;">
        <select id="settlementYearFilter" class="search-select" onchange="filterSettlementByManager()">
          <option value="">ì „ì²´ ë…„ë„</option>
          <option value="2024">2024ë…„</option>
          <option value="2025">2025ë…„</option>
          <option value="2024+2025">24ë…„ ë¯¸ì •ì‚° + 25ë…„</option>
          <option value="2026-1H">2026ë…„ ìƒë°˜ê¸° (1~6ì›”)</option>
          <option value="2026-2H">2026ë…„ í•˜ë°˜ê¸° (7~12ì›”)</option>
          <option value="2026">2026ë…„ ì „ì²´</option>
        </select>
        <select id="settlementTypeFilter" class="search-select" onchange="filterSettlementByManager()">
          <option value="">ë³¸ì‚¬/ì™¸ì£¼ ì „ì²´</option>
          <option value="ë³¸ì‚¬">ë³¸ì‚¬</option>
          <option value="ì™¸ì£¼">ì™¸ì£¼</option>
        </select>
        <select id="settlementManagerFilter" class="search-select" onchange="filterSettlementByManager()">
          <option value="">ì „ì²´ ë‹´ë‹¹ì</option>
        </select>
        <select id="settlementStatusFilter" class="search-select" onchange="filterSettlementByManager()">
          <option value="">ì…ê¸ˆìƒíƒœ ì „ì²´</option>
          <option value="ì…ê¸ˆ">ì…ê¸ˆì™„ë£Œ</option>
          <option value="ì§„í–‰">ì§„í–‰ì¤‘</option>
          <option value="ë¯¸ì…ê¸ˆ">ë¯¸ì…ê¸ˆ</option>
        </select>
        <select id="settlementSettledFilter" class="search-select" onchange="filterSettlementByManager()">
          <option value="">ì •ì‚°ì—¬ë¶€ ì „ì²´</option>
          <option value="ì •ì‚°ì™„ë£Œ">ì •ì‚°ì™„ë£Œ</option>
          <option value="ë¯¸ì •ì‚°">ë¯¸ì •ì‚°</option>
          <option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
        </select>
        <div style="margin-left:auto;font-size:0.85rem;color:var(--gray-500);">
          <span id="settlementFilterResult"></span>
        </div>
      </div>
      
      <!-- 26ë…„ ë°˜ê¸° ì •ì‚° ì•ˆë‚´ -->
      <div id="halfYearNotice" style="display:none;background:#e3f2fd;padding:0.75rem 1rem;border-radius:8px;margin-bottom:1rem;font-size:0.85rem;color:#1565c0;">
        ğŸ“… <strong>26ë…„ ë°˜ê¸° ì •ì‚° ê¸°ì¤€:</strong> ìƒë°˜ê¸°(1~6ì›” ì…ê¸ˆ â†’ 7ì›” ì •ì‚°) / í•˜ë°˜ê¸°(7~12ì›” ì…ê¸ˆ â†’ ë‹¤ìŒí•´ 1ì›” ì •ì‚°)
      </div>
      
      <!-- ì •ì‚° í…Œì´ë¸” -->
      <div style="overflow-x:auto;">
        <table class="settlement-table" id="settlementTable">
          <thead>
            <tr>
              <th style="width:40px;">ë…„ë„</th>
              <th style="width:50px;">NO</th>
              <th style="width:50px;">êµ¬ë¶„</th>
              <th style="width:55px;">ê³µì‚¬ì¢…ë¥˜</th>
              <th style="min-width:130px;">ê³µì‚¬í˜„ì¥</th>
              <th style="width:90px;">ê³µì‚¬ê¸ˆì•¡</th>
              <th style="width:55px;">ì…ê¸ˆ</th>
              <th style="width:70px;">ì…ê¸ˆì¼</th>
              <th style="width:80px;">ìì¬ë¹„</th>
              <th style="width:80px;">ë…¸ë¬´ë¹„</th>
              <th style="width:80px;">ê²½ë¹„í•©ê³„</th>
              <th style="width:90px;">ì§€ì¶œì´ì•¡</th>
              <th style="width:90px;">ì´ìµê¸ˆ</th>
              <th style="width:50px;">ì´ìµë¥ </th>
              <th style="width:90px;">ì •ì‚°ê¸ˆì•¡<br>(15%)</th>
              <th style="width:90px;">íšŒì‚¬ìˆ˜ìµ<br>(85%)</th>
              <th style="width:55px;">ë‹´ë‹¹ì</th>
              <th style="width:55px;">ì •ì‚°</th>
            </tr>
          </thead>
          <tbody id="settlementTableBody">
          </tbody>
          <tfoot id="settlementTableFoot">
          </tfoot>
        </table>
      </div>
      
      <!-- ë‹´ë‹¹ìë³„ ì •ì‚° ìš”ì•½ -->
      <div class="settlement-summary" id="settlementSummary" style="margin-top:1.5rem;">
        <h3 style="margin-bottom:1rem;color:var(--gray-700);">ğŸ“Š ë‹´ë‹¹ìë³„ ì •ì‚° ìš”ì•½</h3>
        <div id="managerSettlementSummary"></div>
      </div>
      </div><!-- constructionSection ë -->
      
      <!-- ê¸°ìˆ ì»¨ì„¤íŒ… ì„¹ì…˜ -->
      <div id="consultingSection" style="display:none;">
        <!-- í†µê³„ ì¹´ë“œ -->
        <div id="consultingStatsCards" style="display:grid;grid-template-columns:repeat(5,1fr);gap:0.75rem;margin-bottom:1.5rem;">
          <div style="background:white;border:1px solid #e0e0e0;border-left:4px solid #00897b;padding:1rem;border-radius:8px;">
            <div style="font-size:0.8rem;color:#666;margin-bottom:0.5rem;">ğŸ“Š ë‚™ì°°ê¸ˆì•¡</div>
            <div id="consultingStatAmount" style="font-size:1.3rem;font-weight:700;color:#00897b;">0ì›</div>
            <div id="consultingStatCount" style="font-size:0.75rem;color:#999;">0ê±´</div>
          </div>
          <div style="background:white;border:1px solid #e0e0e0;border-left:4px solid #ff9800;padding:1rem;border-radius:8px;">
            <div style="font-size:0.8rem;color:#666;margin-bottom:0.5rem;">ğŸ’¸ ì§€ì¶œì´ì•¡</div>
            <div id="consultingStatExpense" style="font-size:1.3rem;font-weight:700;color:#e65100;">0ì›</div>
          </div>
          <div style="background:white;border:1px solid #e0e0e0;border-left:4px solid #4caf50;padding:1rem;border-radius:8px;">
            <div style="font-size:0.8rem;color:#666;margin-bottom:0.5rem;">ğŸ’° ì´ìµê¸ˆ</div>
            <div id="consultingStatProfit" style="font-size:1.3rem;font-weight:700;color:#2e7d32;">0ì›</div>
            <div id="consultingStatProfitRate" style="font-size:0.75rem;color:#999;">ì´ìµë¥  0%</div>
          </div>
          <div style="background:white;border:1px solid #e0e0e0;border-left:4px solid #9c27b0;padding:1rem;border-radius:8px;">
            <div style="font-size:0.8rem;color:#666;margin-bottom:0.5rem;">ğŸ‘¤ ì •ì‚°ê¸ˆì•¡ (15%)</div>
            <div id="consultingStatSettlement" style="font-size:1.3rem;font-weight:700;color:#7b1fa2;">0ì›</div>
          </div>
          <div style="background:white;border:1px solid #e0e0e0;border-left:4px solid #607d8b;padding:1rem;border-radius:8px;">
            <div style="font-size:0.8rem;color:#666;margin-bottom:0.5rem;">ğŸ¢ íšŒì‚¬ìˆ˜ìµ (85%)</div>
            <div id="consultingStatCompany" style="font-size:1.3rem;font-weight:700;color:#455a64;">0ì›</div>
          </div>
        </div>
        
        <!-- í•„í„° ë° ì¶”ê°€ ë²„íŠ¼ -->
        <div style="margin-bottom:1rem;display:flex;gap:0.75rem;align-items:center;flex-wrap:wrap;">
          <button class="btn btn-primary btn-sm" onclick="openConsultingAddModal()">â• ì‹ ê·œ ë“±ë¡</button>
          <select id="consultingYearFilter" class="search-select" onchange="filterConsultingData()">
            <option value="">ì „ì²´ ë…„ë„</option>
            <option value="2024">2024ë…„</option>
            <option value="2025">2025ë…„</option>
            <option value="2026">2026ë…„</option>
          </select>
          <select id="consultingTypeFilter" class="search-select" onchange="filterConsultingData()">
            <option value="">êµ¬ë¶„ ì „ì²´</option>
            <option value="ì¼ë°˜">ì¼ë°˜</option>
            <option value="ì‹œì§€ì›">ì‹œì§€ì›</option>
            <option value="ì‚¬í›„ì •ì‚°">ì‚¬í›„ì •ì‚°</option>
          </select>
          <select id="consultingManagerFilter" class="search-select" onchange="filterConsultingData()">
            <option value="">ì „ì²´ ë‹´ë‹¹ì</option>
          </select>
          <select id="consultingSettledFilter" class="search-select" onchange="filterConsultingData()">
            <option value="">ì •ì‚°ì—¬ë¶€ ì „ì²´</option>
            <option value="ì •ì‚°ì™„ë£Œ">ì •ì‚°ì™„ë£Œ</option>
            <option value="ë¯¸ì •ì‚°">ë¯¸ì •ì‚°</option>
            <option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
          </select>
          <div style="margin-left:auto;font-size:0.85rem;color:var(--gray-500);">
            <span id="consultingFilterResult"></span>
          </div>
        </div>
        
        <!-- ê¸°ìˆ ì»¨ì„¤íŒ… í…Œì´ë¸” -->
        <div style="overflow-x:auto;">
          <table class="settlement-table" id="consultingTable">
            <thead>
              <tr>
                <th style="width:45px;">ë…„ë„</th>
                <th style="width:70px;">êµ¬ë¶„</th>
                <th style="min-width:150px;">ê³µì‚¬í˜„ì¥</th>
                <th style="min-width:120px;">ê³µì‚¬ëª…</th>
                <th style="width:100px;">ë‚™ì°°ê¸ˆì•¡</th>
                <th style="width:90px;">ì‹¤í–‰ê¸ˆì•¡</th>
                <th style="width:90px;">íšŒì‚¬ê²½ë¹„</th>
                <th style="width:90px;">ê¸°íƒ€ê²½ë¹„</th>
                <th style="width:100px;">ì§€ì¶œì´ì•¡</th>
                <th style="width:100px;">ì´ìµê¸ˆ</th>
                <th style="width:55px;">ì´ìµë¥ </th>
                <th style="width:100px;">ì •ì‚°ê¸ˆì•¡<br>(15%)</th>
                <th style="width:60px;">ë‹´ë‹¹ì</th>
                <th style="width:60px;">ì •ì‚°</th>
                <th style="width:50px;">ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody id="consultingTableBody">
            </tbody>
            <tfoot id="consultingTableFoot">
            </tfoot>
          </table>
        </div>
        
        <!-- ë‹´ë‹¹ìë³„ ì •ì‚° ìš”ì•½ -->
        <div class="settlement-summary" id="consultingSummary" style="margin-top:1.5rem;">
          <h3 style="margin-bottom:1rem;color:var(--gray-700);">ğŸ“Š ë‹´ë‹¹ìë³„ ì •ì‚° ìš”ì•½</h3>
          <div id="consultingManagerSummary"></div>
        </div>
      </div><!-- consultingSection ë -->
      
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeSettlementModal()">ë‹«ê¸°</button>
      <button class="btn" onclick="openEmailManageModal()" style="background:#607d8b;color:white;">âš™ï¸ ì´ë©”ì¼ ê´€ë¦¬</button>
      <button class="btn btn-warning" onclick="openConfirmationModal()" style="background:#ff9800;color:white;">ğŸ“„ ë‹´ë‹¹ì í™•ì¸ì„œ</button>
      <button class="btn btn-primary" onclick="openReportModal('ë³¸ì‚¬')">ğŸ“‹ ë³¸ì‚¬ ë³´ê³ ì„œ</button>
      <button class="btn" onclick="openReportModal('ì™¸ì£¼')" style="background:#9c27b0;color:white;">ğŸ“‹ ì™¸ì£¼ ë³´ê³ ì„œ</button>
      <button class="btn btn-success" onclick="downloadSettlementExcel()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
    </div>
  </div>
</div>

<!-- ê¸°ìˆ ì»¨ì„¤íŒ… ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal" id="consultingAddModal">
  <div class="modal-content" style="max-width:600px;">
    <div class="modal-header" style="background:#00897b;color:white;">
      <div class="modal-title" id="consultingAddModalTitle">ğŸ“‹ ê¸°ìˆ ì»¨ì„¤íŒ… ë“±ë¡</div>
      <button class="modal-close" onclick="closeConsultingAddModal()" style="color:white;">Ã—</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="consultingEditId">
      <div style="display:grid;gap:1rem;">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
          <div>
            <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:0.25rem;">ë…„ë„ *</label>
            <select id="consultingYear" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;">
              <option value="2024">2024ë…„</option>
              <option value="2025" selected>2025ë…„</option>
              <option value="2026">2026ë…„</option>
            </select>
          </div>
          <div>
            <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:0.25rem;">êµ¬ë¶„ *</label>
            <select id="consultingType" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;">
              <option value="ì¼ë°˜">ì¼ë°˜</option>
              <option value="ì‹œì§€ì›">ì‹œì§€ì›</option>
              <option value="ì‚¬í›„ì •ì‚°">ì‚¬í›„ì •ì‚°</option>
            </select>
          </div>
        </div>
        <div>
          <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:0.25rem;">ê³µì‚¬í˜„ì¥ *</label>
          <input type="text" id="consultingSite" placeholder="ì˜ˆ: OOì•„íŒŒíŠ¸" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;">
        </div>
        <div>
          <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:0.25rem;">ê³µì‚¬ëª…</label>
          <input type="text" id="consultingProject" placeholder="ì˜ˆ: ê¸°ìˆ ì»¨ì„¤íŒ… ìš©ì—­" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
          <div>
            <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:0.25rem;">ë‚™ì°°ê¸ˆì•¡ *</label>
            <input type="number" id="consultingBidAmount" placeholder="0" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;">
          </div>
          <div>
            <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:0.25rem;">ë‹´ë‹¹ì *</label>
            <select id="consultingManager" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;">
              <option value="">ì„ íƒ</option>
            </select>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;">
          <div>
            <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:0.25rem;">ì‹¤í–‰ê¸ˆì•¡</label>
            <input type="number" id="consultingExecAmount" placeholder="0" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;" oninput="calcConsultingPreview()">
          </div>
          <div>
            <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:0.25rem;">íšŒì‚¬ê²½ë¹„</label>
            <input type="number" id="consultingCompanyExp" placeholder="0" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;" oninput="calcConsultingPreview()">
          </div>
          <div>
            <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:0.25rem;">ê¸°íƒ€ê²½ë¹„</label>
            <input type="number" id="consultingOtherExp" placeholder="0" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;" oninput="calcConsultingPreview()">
          </div>
        </div>
        <!-- ê³„ì‚° ë¯¸ë¦¬ë³´ê¸° -->
        <div style="background:#e0f2f1;padding:1rem;border-radius:8px;margin-top:0.5rem;">
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.75rem;text-align:center;">
            <div>
              <div style="font-size:0.75rem;color:#666;">ì§€ì¶œì´ì•¡</div>
              <div id="consultingPreviewExpense" style="font-size:1rem;font-weight:700;color:#e65100;">0ì›</div>
            </div>
            <div>
              <div style="font-size:0.75rem;color:#666;">ì´ìµê¸ˆ</div>
              <div id="consultingPreviewProfit" style="font-size:1rem;font-weight:700;color:#2e7d32;">0ì›</div>
            </div>
            <div>
              <div style="font-size:0.75rem;color:#666;">ì´ìµë¥ </div>
              <div id="consultingPreviewRate" style="font-size:1rem;font-weight:700;">0%</div>
            </div>
            <div>
              <div style="font-size:0.75rem;color:#666;">ì •ì‚°ê¸ˆì•¡(15%)</div>
              <div id="consultingPreviewSettlement" style="font-size:1rem;font-weight:700;color:#7b1fa2;">0ì›</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeConsultingAddModal()">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveConsultingData()">ğŸ’¾ ì €ì¥</button>
    </div>
  </div>
</div>

<!-- ê¸°ìˆ ì»¨ì„¤íŒ… í˜„ì¥ ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬ -->
<div class="modal" id="consultingListModal">
  <div class="modal-content" style="max-width:1500px;max-height:95vh;overflow-y:auto;">
    <div class="modal-header" style="background:#00897b;color:white;">
      <div class="modal-title">ğŸ“‹ ê¸°ìˆ ì»¨ì„¤íŒ… í˜„ì¥ ë¦¬ìŠ¤íŠ¸</div>
      <button class="modal-close" onclick="closeConsultingListModal()" style="color:white;">Ã—</button>
    </div>
    <div class="modal-body">
      <!-- í•„í„° ë° ì¶”ê°€ ë²„íŠ¼ -->
      <div style="margin-bottom:1rem;display:flex;gap:0.75rem;align-items:center;flex-wrap:wrap;">
        <button class="btn btn-primary btn-sm" onclick="openConsultingItemModal()">â• ì‹ ê·œ ë“±ë¡</button>
        <input type="text" id="consultingListSearch" placeholder="ğŸ” í˜„ì¥ëª… ê²€ìƒ‰..." oninput="filterConsultingList()" style="padding:0.5rem;border:1px solid #ddd;border-radius:4px;width:150px;">
        <select id="consultingListYearFilter" class="search-select" onchange="filterConsultingList()">
          <option value="">ì „ì²´ ë…„ë„</option>
          <option value="2024">2024ë…„</option>
          <option value="2025" selected>2025ë…„</option>
          <option value="2026">2026ë…„</option>
        </select>
        <select id="consultingListTypeFilter" class="search-select" onchange="filterConsultingList()">
          <option value="">êµ¬ë¶„ ì „ì²´</option>
          <option value="ì¼ë°˜">ì¼ë°˜</option>
          <option value="ì‹œì§€ì›">ì‹œì§€ì›</option>
          <option value="ì‚¬í›„ì •ì‚°">ì‚¬í›„ì •ì‚°</option>
        </select>
        <select id="consultingListManagerFilter" class="search-select" onchange="filterConsultingList()">
          <option value="">ì „ì²´ ë‹´ë‹¹ì</option>
        </select>
        <div style="margin-left:auto;font-size:0.85rem;color:var(--gray-500);">
          <span id="consultingListCount">0ê±´</span>
        </div>
      </div>
      
      <!-- í…Œì´ë¸” -->
      <div style="overflow-x:auto;">
        <table class="data-table" id="consultingListTable" style="font-size:0.8rem;">
          <thead>
            <tr style="background:#00897b;color:white;">
              <th style="width:45px;">ë…„ë„</th>
              <th style="width:65px;">êµ¬ë¶„</th>
              <th style="width:50px;">ì»¨ì„¤íŒ…</th>
              <th style="min-width:130px;">ê³µì‚¬í˜„ì¥</th>
              <th style="min-width:100px;">ê³µì‚¬ëª…</th>
              <th style="width:90px;">ë‚™ì°°ê¸ˆì•¡</th>
              <th style="width:90px;">ì‹¤í–‰ê¸ˆì•¡</th>
              <th style="width:60px;">ì˜ì—…ë‹´ë‹¹</th>
              <th style="width:80px;">ì—…ì²´ëª…</th>
              <th style="width:60px;">ì—…ì²´ë‹´ë‹¹</th>
              <th style="width:75px;">í•˜ìê¸°ê°„</th>
              <th style="width:60px;">í˜„ì¥ì†Œì¥</th>
              <th style="width:45px;">ì‚¬ì§„</th>
              <th style="width:80px;">ê³„ì•½ì¼</th>
              <th style="width:80px;">ì‹¤ì°©ê³µì¼</th>
              <th style="width:80px;">ì‹¤ì¤€ê³µì¼</th>
              <th style="min-width:80px;">ë¹„ê³ </th>
              <th style="width:60px;">ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody id="consultingListTableBody">
          </tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeConsultingListModal()">ë‹«ê¸°</button>
      <button class="btn btn-success" onclick="downloadConsultingListExcel()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
    </div>
  </div>
</div>

<!-- ê¸°ìˆ ì»¨ì„¤íŒ… í˜„ì¥ ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal" id="consultingItemModal">
  <div class="modal-content" style="max-width:700px;max-height:90vh;overflow-y:auto;">
    <div class="modal-header" style="background:#00897b;color:white;">
      <div class="modal-title" id="consultingItemModalTitle">ğŸ“‹ ê¸°ìˆ ì»¨ì„¤íŒ… í˜„ì¥ ë“±ë¡</div>
      <button class="modal-close" onclick="closeConsultingItemModal()" style="color:white;">Ã—</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="consultingItemEditId">
      <div style="display:grid;gap:1rem;">
        <!-- ê¸°ë³¸ ì •ë³´ -->
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;">
          <div>
            <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:0.25rem;">ë…„ë„ *</label>
            <select id="consultingItemYear" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;">
              <option value="2024">2024ë…„</option>
              <option value="2025" selected>2025ë…„</option>
              <option value="2026">2026ë…„</option>
            </select>
          </div>
          <div>
            <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:0.25rem;">êµ¬ë¶„ *</label>
            <select id="consultingItemType" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;">
              <option value="ì¼ë°˜">ì¼ë°˜</option>
              <option value="ì‹œì§€ì›">ì‹œì§€ì›</option>
              <option value="ì‚¬í›„ì •ì‚°">ì‚¬í›„ì •ì‚°</option>
            </select>
          </div>
          <div>
            <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:0.25rem;">ì»¨ì„¤íŒ… *</label>
            <select id="consultingItemConsulting" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;">
              <option value="Y">Y</option>
              <option value="N">N</option>
            </select>
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
          <div>
            <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:0.25rem;">ê³µì‚¬í˜„ì¥ *</label>
            <input type="text" id="consultingItemSite" placeholder="ì˜ˆ: OOì•„íŒŒíŠ¸" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;">
          </div>
          <div>
            <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:0.25rem;">ê³µì‚¬ëª…</label>
            <input type="text" id="consultingItemProject" placeholder="ì˜ˆ: ì™¸ë²½ ì•ˆì „ì§„ë‹¨" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;">
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;">
          <div>
            <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:0.25rem;">ë‚™ì°°ê¸ˆì•¡</label>
            <input type="number" id="consultingItemBidAmount" placeholder="0" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;">
          </div>
          <div>
            <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:0.25rem;">ì‹¤í–‰ê¸ˆì•¡</label>
            <input type="number" id="consultingItemExecAmount" placeholder="0" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;">
          </div>
          <div>
            <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:0.25rem;">ì˜ì—…ë‹´ë‹¹ì *</label>
            <select id="consultingItemManager" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;">
              <option value="">ì„ íƒ</option>
            </select>
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;">
          <div>
            <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:0.25rem;">ì—…ì²´ëª…</label>
            <input type="text" id="consultingItemCompany" placeholder="" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;">
          </div>
          <div>
            <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:0.25rem;">ì—…ì²´ë‹´ë‹¹ì</label>
            <input type="text" id="consultingItemCompanyManager" placeholder="" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;">
          </div>
          <div>
            <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:0.25rem;">í•˜ìê¸°ê°„</label>
            <input type="text" id="consultingItemWarranty" placeholder="ì˜ˆ: 2ë…„" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;">
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;">
          <div>
            <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:0.25rem;">í˜„ì¥ì†Œì¥</label>
            <input type="text" id="consultingItemFieldManager" placeholder="" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;">
          </div>
          <div>
            <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:0.25rem;">ì‚¬ì§„ì²©</label>
            <select id="consultingItemPhoto" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;">
              <option value="X">X</option>
              <option value="O">O</option>
            </select>
          </div>
          <div>
            <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:0.25rem;">ê³„ì•½ì¼</label>
            <input type="date" id="consultingItemContractDate" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;">
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
          <div>
            <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:0.25rem;">ì‹¤ì°©ê³µì¼</label>
            <input type="date" id="consultingItemStartDate" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;">
          </div>
          <div>
            <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:0.25rem;">ì‹¤ì¤€ê³µì¼</label>
            <input type="date" id="consultingItemEndDate" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;">
          </div>
        </div>
        
        <div>
          <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:0.25rem;">ë¹„ê³ </label>
          <textarea id="consultingItemNote" rows="2" placeholder="ë©”ëª¨ ì‚¬í•­" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;resize:vertical;"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeConsultingItemModal()">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveConsultingItem()">ğŸ’¾ ì €ì¥</button>
    </div>
  </div>
</div>

<!-- ë‹´ë‹¹ì ì´ë©”ì¼ ê´€ë¦¬ ëª¨ë‹¬ -->
<div class="modal" id="emailManageModal">
  <div class="modal-content" style="max-width:500px;">
    <div class="modal-header" style="background:#607d8b;color:white;">
      <div class="modal-title">âš™ï¸ ë‹´ë‹¹ì ì´ë©”ì¼ ê´€ë¦¬</div>
      <button class="modal-close" onclick="closeEmailManageModal()" style="color:white;">Ã—</button>
    </div>
    <div class="modal-body" id="emailManageContent" style="max-height:60vh;overflow-y:auto;">
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeEmailManageModal()">ë‹«ê¸°</button>
      <button class="btn btn-primary" onclick="saveAllManagerEmails()">ğŸ’¾ ì €ì¥</button>
    </div>
  </div>
</div>

<!-- ë‹´ë‹¹ì í™•ì¸ì„œ ëª¨ë‹¬ -->
<div class="modal" id="confirmationModal">
  <div class="modal-content" style="max-width:900px;max-height:90vh;overflow-y:auto;">
    <div class="modal-header" style="background:#ff9800;color:white;">
      <div class="modal-title">ğŸ“„ ë‹´ë‹¹ì í™•ì¸ì„œ</div>
      <button class="modal-close" onclick="closeConfirmationModal()" style="color:white;">Ã—</button>
    </div>
    <div class="modal-body">
      <!-- í™•ì¸ì„œ ìœ í˜• íƒ­ -->
      <div style="display:flex;gap:4px;margin-bottom:1rem;">
        <button type="button" id="confirmTabConstruction" onclick="switchConfirmationTab('construction')" style="padding:0.6rem 1.2rem;border:none;background:#1976d2;color:white;font-weight:600;cursor:pointer;border-radius:6px 6px 0 0;">
          ğŸ—ï¸ ê³µì‚¬ì •ì‚°
        </button>
        <button type="button" id="confirmTabConsulting" onclick="switchConfirmationTab('consulting')" style="padding:0.6rem 1.2rem;border:none;background:#e0e0e0;color:#666;font-weight:600;cursor:pointer;border-radius:6px 6px 0 0;">
          ğŸ“‹ ê¸°ìˆ ì»¨ì„¤íŒ…
        </button>
        <button type="button" id="confirmTabIntegrated" onclick="switchConfirmationTab('integrated')" style="padding:0.6rem 1.2rem;border:none;background:#e0e0e0;color:#666;font-weight:600;cursor:pointer;border-radius:6px 6px 0 0;">
          ğŸ“Š í†µí•© í™•ì¸ì„œ
        </button>
      </div>
      
      <div style="background:#fff3e0;padding:1rem;border-radius:8px;margin-bottom:1rem;">
        <p style="margin:0 0 0.75rem 0;font-size:0.9rem;">ğŸ“Œ ë‹´ë‹¹ìë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ë‹´ë‹¹ìì˜ í˜„ì¥ë§Œ í‘œì‹œë©ë‹ˆë‹¤.</p>
        <div style="display:flex;gap:0.75rem;flex-wrap:wrap;align-items:center;">
          <select id="confirmationManagerSelect" class="search-select" onchange="renderConfirmationPreview()" style="min-width:150px;">
            <option value="">ì „ì²´ ë‹´ë‹¹ì</option>
          </select>
          <select id="confirmationYearSelect" class="search-select" onchange="renderConfirmationPreview()" style="min-width:120px;">
            <option value="">ì „ì²´ ë…„ë„</option>
            <option value="2024">2024ë…„</option>
            <option value="2025">2025ë…„</option>
            <option value="2026">2026ë…„</option>
            <option value="2024+2025">24ë…„ ë¯¸ì •ì‚°+25ë…„</option>
          </select>
          <select id="confirmationSettledSelect" class="search-select" onchange="renderConfirmationPreview()" style="min-width:120px;">
            <option value="">ì •ì‚°ì—¬ë¶€ ì „ì²´</option>
            <option value="ì •ì‚°ì™„ë£Œ">ì •ì‚°ì™„ë£Œ</option>
            <option value="ë¯¸ì •ì‚°">ë¯¸ì •ì‚°</option>
            <option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
          </select>
        </div>
      </div>
      <div id="confirmationPreview"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeConfirmationModal()">ë‹«ê¸°</button>
      <button class="btn btn-primary" onclick="downloadConfirmationPDF()">ğŸ“¥ PDF ë‹¤ìš´ë¡œë“œ</button>
      <button class="btn btn-success" onclick="sendConfirmationEmail()">ğŸ“§ ì´ë©”ì¼ ë°œì†¡</button>
    </div>
  </div>
</div>

<!-- ëŒ€í‘œ ë³´ê³ ì„œ ëª¨ë‹¬ -->
<div class="modal" id="reportModal">
  <div class="modal-content" style="max-width:900px;max-height:90vh;overflow-y:auto;">
    <div class="modal-header" style="background:var(--gray-700);color:white;">
      <div class="modal-title" id="reportModalTitle">ğŸ“‹ ëŒ€í‘œë‹˜ ë³´ê³ ì„œ</div>
      <button class="modal-close" onclick="closeReportModal()" style="color:white;">Ã—</button>
    </div>
    <div class="modal-body" id="reportContent">
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeReportModal()">ë‹«ê¸°</button>
      <button class="btn btn-primary" onclick="printReport()">ğŸ–¨ï¸ ì¸ì‡„</button>
      <button class="btn btn-success" onclick="downloadReportExcel()">ğŸ“¥ ì—‘ì…€</button>
    </div>
  </div>
</div>

<!-- í˜„ì¥ìƒì„¸ ëª¨ë‹¬ -->
<div class="modal" id="detailModal">
  <div class="modal-content" style="max-width:1200px;max-height:90vh;overflow-y:auto;">
    <div class="modal-header">
      <div class="modal-title" id="detailModalTitle">í˜„ì¥ ìƒì„¸ - ì´ê´„í‘œ</div>
      <div style="display:flex;gap:0.5rem;align-items:center;">
        <button class="btn btn-outline btn-sm" onclick="document.getElementById('summaryFileInput').click()" title="ê¸°ì¡´ ì´ê´„í‘œ ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸°">ğŸ“‚ ì´ê´„í‘œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="btn btn-outline btn-sm" onclick="downloadSummaryExcel()" title="í˜„ì¬ ë‚´ìš©ì„ ì´ê´„í‘œ ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œ">ğŸ“¥ ì´ê´„í‘œ ë‹¤ìš´ë¡œë“œ</button>
        <button class="modal-close" onclick="closeDetailModal()">Ã—</button>
      </div>
    </div>
    <input type="file" id="summaryFileInput" accept=".xlsx,.xls" style="display:none;" onchange="handleSummaryUpload(event)">
    <div class="modal-body">
      <input type="hidden" id="detailIndex">
      
      <!-- í˜„ì¥ ê¸°ë³¸ ì •ë³´ -->
      <div style="background:var(--primary-light);padding:1rem;border-radius:8px;margin-bottom:1rem;">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;">
          <div><span style="color:var(--gray-500);font-size:0.75rem;">ê³µì‚¬í˜„ì¥</span><div id="detailSiteName" style="font-weight:600;"></div></div>
          <div><span style="color:var(--gray-500);font-size:0.75rem;">ê³µì‚¬ëª…</span><div id="detailProjectName" style="font-size:0.875rem;"></div></div>
          <div><span style="color:var(--gray-500);font-size:0.75rem;">ê³„ì•½ê¸ˆì•¡(VATë³„ë„)</span><div id="detailContractAmt" style="font-weight:600;color:var(--primary);"></div></div>
          <div><span style="color:var(--gray-500);font-size:0.75rem;">ê³µì‚¬ê¸°ê°„</span><div id="detailPeriod" style="font-size:0.875rem;"></div></div>
        </div>
      </div>
      
      <!-- íƒ­ ë©”ë‰´ -->
      <div class="detail-tabs">
        <button class="detail-tab active" onclick="switchDetailTab('summary')">ì´ê´„í‘œ</button>
        <button class="detail-tab" onclick="switchDetailTab('settlement')">ì •ì‚°ì„œ</button>
      </div>
      
      <!-- ì´ê´„í‘œ íƒ­ -->
      <div class="detail-section active" id="detailSummary">
        <!-- ìƒë‹¨ ì •ë³´ -->
        <div style="display:grid;grid-template-columns:2fr 1fr;gap:1rem;margin-bottom:1.5rem;">
          <div class="detail-card">
            <div class="detail-card-title">ê³µì‚¬ ì •ë³´</div>
            <table class="detail-table">
              <tbody>
                <tr>
                  <td style="width:100px;background:var(--gray-100);font-weight:500;">ê³µì‚¬í˜„ì¥</td>
                  <td colspan="3"><input type="text" id="detail_site_input" style="width:100%;"></td>
                </tr>
                <tr>
                  <td style="background:var(--gray-100);font-weight:500;">ê³µì‚¬ëª…</td>
                  <td colspan="3"><input type="text" id="detail_project_input" style="width:100%;"></td>
                </tr>
                <tr>
                  <td style="background:var(--gray-100);font-weight:500;">ê³µì‚¬ê¸°ê°„</td>
                  <td><input type="text" id="detail_period_input" placeholder="2025ë…„ Oì›” ~ Oì›”" style="width:100%;"></td>
                  <td style="width:100px;background:var(--gray-100);font-weight:500;">ê³µì‚¬ê¸ˆì•¡</td>
                  <td><input type="number" id="detail_amount_input" style="width:100%;"></td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div class="detail-card">
            <div class="detail-card-title">ë‹´ë‹¹ì</div>
            <table class="detail-table">
              <tbody>
                <tr><td style="width:80px;background:var(--gray-100);">íšŒì‚¬</td><td><input type="text" id="detail_company" value="ãˆœì„ë¯¼ì´ì•¤ì”¨" style="width:100%;"></td></tr>
                <tr><td style="background:var(--gray-100);">ì†Œì¥</td><td><input type="text" id="detail_site_manager" style="width:100%;"></td></tr>
                <tr><td style="background:var(--gray-100);">ì˜ì—…ë‹´ë‹¹ì</td><td><input type="text" id="detail_hq_manager" style="width:100%;"></td></tr>
                <tr><td style="background:var(--gray-100);">í˜„ì¥ë‹´ë‹¹</td><td><input type="text" id="detail_field_manager" style="width:100%;"></td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- ì‹¤í–‰ë‹¨ê°€ ì •ë³´ -->
        <div class="detail-card" style="margin-bottom:1.5rem;">
          <div class="detail-card-title">ê³„ì•½ ìš”ì•½</div>
          <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:0;text-align:center;">
            <div style="background:var(--gray-100);padding:0.5rem;border:1px solid var(--gray-200);font-weight:500;">ê³„ì•½ê¸ˆì•¡</div>
            <div style="background:var(--gray-100);padding:0.5rem;border:1px solid var(--gray-200);font-weight:500;">ìì¬ë¹„</div>
            <div style="background:var(--gray-100);padding:0.5rem;border:1px solid var(--gray-200);font-weight:500;">ë…¸ë¬´ë¹„</div>
            <div style="background:var(--gray-100);padding:0.5rem;border:1px solid var(--gray-200);font-weight:500;">ê¸°íƒ€ê²½ë¹„</div>
            <div style="background:var(--gray-100);padding:0.5rem;border:1px solid var(--gray-200);font-weight:500;">ì§€ì¶œê³„</div>
            <div style="background:var(--gray-100);padding:0.5rem;border:1px solid var(--gray-200);font-weight:500;">ì”ì•¡</div>
          </div>
          <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:0;text-align:center;">
            <div style="padding:0.75rem;border:1px solid var(--gray-200);font-weight:700;color:var(--primary);" id="summaryContract">0</div>
            <div style="padding:0.75rem;border:1px solid var(--gray-200);font-weight:600;" id="summaryMaterial">0</div>
            <div style="padding:0.75rem;border:1px solid var(--gray-200);font-weight:600;" id="summaryLabor">0</div>
            <div style="padding:0.75rem;border:1px solid var(--gray-200);font-weight:600;" id="summaryOther">0</div>
            <div style="padding:0.75rem;border:1px solid var(--gray-200);font-weight:600;color:var(--danger);" id="summaryExpense">0</div>
            <div style="padding:0.75rem;border:1px solid var(--gray-200);font-weight:700;color:var(--success);" id="summaryBalance">0</div>
          </div>
          <!-- ì •ì‚°ê¸ˆì•¡ (ê¸ˆì•¡ì¡°ì • ìˆì„ ê²½ìš° í‘œì‹œ) -->
          <div id="adjustmentRow" style="display:none;">
            <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:0;text-align:center;margin-top:0.5rem;">
              <div style="background:var(--warning-light);padding:0.5rem;border:1px solid var(--warning);font-weight:500;grid-column:span 2;">
                ê¸ˆì•¡ì¡°ì • í›„ ì •ì‚°ê¸ˆì•¡
              </div>
              <div style="padding:0.75rem;border:1px solid var(--warning);font-weight:700;color:var(--warning);grid-column:span 2;" id="summaryAdjustedAmount">0</div>
              <div style="padding:0.75rem;border:1px solid var(--warning);font-weight:700;grid-column:span 2;" id="summaryAdjustedBalance">0</div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:0;text-align:center;">
              <div style="font-size:0.7rem;color:var(--gray-500);grid-column:span 2;"></div>
              <div style="font-size:0.7rem;color:var(--gray-500);grid-column:span 2;">(ì¡°ì • í›„ ê¸ˆì•¡)</div>
              <div style="font-size:0.7rem;color:var(--gray-500);grid-column:span 2;">(ì¡°ì • í›„ ì”ì•¡)</div>
            </div>
          </div>
        </div>
        
        <!-- ìˆ˜ê¸ˆë‚´ì—­ & íˆ¬ì…ë‚´ì—­ -->
        <div style="display:grid;grid-template-columns:1.2fr 1.8fr;gap:1rem;">
          <!-- ìˆ˜ê¸ˆë‚´ì—­ -->
          <div class="detail-card">
            <div class="detail-card-title">ìˆ˜ê¸ˆë‚´ì—­</div>
            <table class="detail-table">
              <thead>
                <tr><th style="width:70px;">êµ¬ë¶„</th><th style="width:110px;">ì¼ì</th><th style="width:90px;">ê¸ˆì•¡</th><th style="min-width:80px;">ë‚´ìš©</th></tr>
              </thead>
              <tbody>
                <tr>
                  <td style="background:var(--primary-light);">ê³„ì•½ê¸ˆ</td>
                  <td><input type="date" id="åcontract_date" style="width:100%;"></td>
                  <td><input type="number" id="åcontract_amt" onchange="updateDetailTotals()" style="width:100%;"></td>
                  <td><input type="text" id="åcontract_note" placeholder="" style="width:100%;"></td>
                </tr>
                <tr>
                  <td style="background:var(--warning-light);">ì¤‘ë„ê¸ˆ1ì°¨</td>
                  <td><input type="date" id="åinterim_date" style="width:100%;"></td>
                  <td><input type="number" id="åinterim_amt" onchange="updateDetailTotals()" style="width:100%;"></td>
                  <td><input type="text" id="åinterim_note" placeholder="" style="width:100%;"></td>
                </tr>
                <tr>
                  <td style="background:var(--warning-light);opacity:0.8;">ì¤‘ë„ê¸ˆ2ì°¨</td>
                  <td><input type="date" id="åinterim2_date" style="width:100%;"></td>
                  <td><input type="number" id="åinterim2_amt" onchange="updateDetailTotals()" style="width:100%;"></td>
                  <td><input type="text" id="åinterim2_note" placeholder="" style="width:100%;"></td>
                </tr>
                <tr>
                  <td style="background:var(--success-light);">ì”ê¸ˆ</td>
                  <td><input type="date" id="åbalance_date" style="width:100%;"></td>
                  <td><input type="number" id="åbalance_amt" onchange="updateDetailTotals()" style="width:100%;"></td>
                  <td><input type="text" id="åbalance_note" placeholder="" style="width:100%;"></td>
                </tr>
                <tr>
                  <td style="background:var(--purple-light);">ê¸°íƒ€ì…ê¸ˆ1</td>
                  <td><input type="date" id="åetc_date" style="width:100%;"></td>
                  <td><input type="number" id="åetc_amt" onchange="updateDetailTotals()" style="width:100%;"></td>
                  <td><input type="text" id="åetc_note" placeholder="" style="width:100%;"></td>
                </tr>
                <tr>
                  <td style="background:var(--purple-light);opacity:0.8;">ê¸°íƒ€ì…ê¸ˆ2</td>
                  <td><input type="date" id="åetc2_date" style="width:100%;"></td>
                  <td><input type="number" id="åetc2_amt" onchange="updateDetailTotals()" style="width:100%;"></td>
                  <td><input type="text" id="åetc2_note" placeholder="" style="width:100%;"></td>
                </tr>
                <tr>
                  <td style="background:var(--gray-200);">ê¸ˆì•¡ì¡°ì •</td>
                  <td><input type="date" id="åadjust_date" style="width:100%;"></td>
                  <td><input type="number" id="åadjust_amt" onchange="updateDetailTotals()" style="width:100%;" placeholder="Â±ê¸ˆì•¡"></td>
                  <td><input type="text" id="åadjust_note" placeholder="" style="width:100%;"></td>
                </tr>
                <tr class="summary-row">
                  <td colspan="2">í•©ê³„</td>
                  <td id="åtotal">0</td>
                  <td></td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- íˆ¬ì…ë‚´ì—­ í†µí•© -->
          <div class="detail-card">
            <div class="detail-card-title">íˆ¬ì…ë‚´ì—­ <span style="font-size:0.75rem;color:var(--gray-400);font-weight:normal;">(ìì¬ë¹„/ë…¸ë¬´ë¹„/ê¸°íƒ€ê²½ë¹„)</span></div>
            <table class="detail-table">
              <thead>
                <tr>
                  <th style="width:80px;">êµ¬ë¶„</th>
                  <th style="width:100px;">ì¼ì</th>
                  <th style="width:120px;">ê¸ˆì•¡</th>
                  <th>ë‚´ìš©</th>
                  <th style="width:100px;">ì§€ê¸‰ì¼</th>
                  <th style="width:40px;"></th>
                </tr>
              </thead>
              <tbody id="expenseTableBody"></tbody>
              <tfoot>
                <tr class="summary-row">
                  <td>í•©ê³„</td>
                  <td></td>
                  <td id="expenseTotal">0</td>
                  <td colspan="3"></td>
                </tr>
              </tfoot>
            </table>
            <div style="margin-top:0.5rem;display:flex;gap:0.5rem;">
              <button class="btn btn-outline btn-sm" onclick="addExpenseRow('ìì¬ë¹„')" style="background:var(--primary-light);">+ ìì¬ë¹„</button>
              <button class="btn btn-outline btn-sm" onclick="addExpenseRow('ë…¸ë¬´ë¹„')" style="background:var(--warning-light);">+ ë…¸ë¬´ë¹„</button>
              <button class="btn btn-outline btn-sm" onclick="addExpenseRow('ê¸°íƒ€ê²½ë¹„')" style="background:var(--purple-light);">+ ê¸°íƒ€ê²½ë¹„</button>
            </div>
          </div>
        </div>
        
        <!-- ë¹„ê³  -->
        <div class="detail-card" style="margin-top:1rem;">
          <div class="detail-card-title">ë¹„ê³ </div>
          <textarea id="detail_memo" style="width:100%;height:80px;padding:0.5rem;border:1px solid var(--gray-300);border-radius:4px;font-family:inherit;font-size:0.875rem;resize:vertical;" placeholder="ì¶”ê°€ ë©”ëª¨ ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
        </div>
        
        <!-- ì‚¬ì§„ ì²¨ë¶€ -->
        <div class="detail-card" style="margin-top:1rem;">
          <div class="detail-card-title">ğŸ“· ì‚¬ì§„ ì²¨ë¶€</div>
          <div style="padding:0.5rem;">
            <input type="file" id="detailPhotoInput" accept="image/*" multiple onchange="handleDetailPhotoUpload(event)" style="display:none;">
            <button class="btn btn-outline btn-sm" onclick="document.getElementById('detailPhotoInput').click()">
              ğŸ“· ì‚¬ì§„ ì¶”ê°€
            </button>
            <span style="font-size:0.75rem;color:#888;margin-left:0.5rem;">ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥ (í˜„ì¥ì‚¬ì§„, ì‘ì—…ì‚¬ì§„ ë“±)</span>
            <div id="detailPhotoPreview" style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-top:0.5rem;"></div>
          </div>
        </div>
      </div>
      
      <!-- ì •ì‚°ì„œ íƒ­ -->
      <div class="detail-section" id="detailSettlement">
        <!-- ì •ì‚°ì„œ í—¤ë” -->
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;flex:1;">
            <div><label style="font-size:0.75rem;color:var(--gray-500);">ì˜ì—…ë‹´ë‹¹ì</label><input type="text" class="form-input" id="settlement_sales"></div>
            <div><label style="font-size:0.75rem;color:var(--gray-500);">ì‹¤í–‰íŒ€(í˜„ì¥ì†Œì¥)</label><input type="text" class="form-input" id="settlement_field"></div>
          </div>
          <div style="margin-left:1rem;">
            <button class="btn btn-primary" onclick="sendToSiteManager()" style="white-space:nowrap;">ğŸ“§ í˜„ì¥ì†Œì¥ ì†¡ë¶€</button>
          </div>
        </div>
        
        <div class="detail-grid" style="grid-template-columns:1fr;">
          <!-- ê³µì‚¬ ë§¤ì¶œ/ë§¤ì… -->
          <div class="detail-card">
            <div class="detail-card-title">ê³µì‚¬ ë‚´ì—­</div>
            <table class="detail-table">
              <thead><tr><th style="width:120px;">ê³µì‚¬ì¢…ë¥˜</th><th>ë‚´ìš©</th><th style="width:120px;">ë§¤ì¶œì•¡</th><th style="width:120px;">ë§¤ì…ì•¡</th><th style="width:150px;">ë¹„ê³ </th></tr></thead>
              <tbody id="settlementWorkBody"></tbody>
              <tfoot>
                <tr class="summary-row"><td colspan="2">ì†Œê³„</td><td id="workSalesTotal">0</td><td id="workPurchaseTotal">0</td><td></td></tr>
              </tfoot>
            </table>
            <button class="btn btn-outline btn-sm" style="margin-top:0.5rem;" onclick="addSettlementWorkRow()">+ í–‰ ì¶”ê°€</button>
          </div>
          
          <!-- ìì¬ë¹„ -->
          <div class="detail-card">
            <div class="detail-card-title">ìì¬ë¹„</div>
            <table class="detail-table">
              <thead><tr><th>ë‚´ìš©</th><th style="width:120px;">ë§¤ì…ì•¡</th><th style="width:150px;">ë¹„ê³ </th></tr></thead>
              <tbody id="settlementMaterialBody"></tbody>
              <tfoot>
                <tr class="summary-row"><td>ì†Œê³„</td><td id="materialPurchaseTotal">0</td><td></td></tr>
              </tfoot>
            </table>
            <button class="btn btn-outline btn-sm" style="margin-top:0.5rem;" onclick="addSettlementMaterialRow()">+ í–‰ ì¶”ê°€</button>
          </div>
          
          <!-- ë…¸ë¬´ë¹„ -->
          <div class="detail-card">
            <div class="detail-card-title">ë…¸ë¬´ë¹„</div>
            <table class="detail-table">
              <thead><tr><th>ë‚´ìš©</th><th style="width:120px;">ë§¤ì…ì•¡</th><th style="width:150px;">ë¹„ê³ </th></tr></thead>
              <tbody id="settlementLaborBody"></tbody>
              <tfoot>
                <tr class="summary-row"><td>ì†Œê³„</td><td id="laborPurchaseTotal">0</td><td></td></tr>
              </tfoot>
            </table>
            <button class="btn btn-outline btn-sm" style="margin-top:0.5rem;" onclick="addSettlementLaborRow()">+ í–‰ ì¶”ê°€</button>
          </div>
          
          <!-- ê¸°íƒ€ê²½ë¹„ -->
          <div class="detail-card">
            <div class="detail-card-title">ê¸°íƒ€ê²½ë¹„</div>
            <table class="detail-table">
              <thead><tr><th>ë‚´ìš©</th><th style="width:120px;">ë§¤ì…ì•¡</th><th style="width:150px;">ë¹„ê³ </th></tr></thead>
              <tbody id="settlementOtherBody"></tbody>
              <tfoot>
                <tr class="summary-row"><td>ì†Œê³„</td><td id="otherPurchaseTotal">0</td><td></td></tr>
              </tfoot>
            </table>
            <button class="btn btn-outline btn-sm" style="margin-top:0.5rem;" onclick="addSettlementOtherRow()">+ í–‰ ì¶”ê°€</button>
          </div>
        </div>
        
        <!-- ì •ì‚°ì„œ í•©ê³„ -->
        <div style="margin-top:1.5rem;background:var(--success-light);padding:1.5rem;border-radius:8px;border:2px solid var(--success);">
          <div class="detail-card-title" style="color:var(--success);margin-bottom:1rem;">ì •ì‚°ì„œ í•©ê³„</div>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1.5rem;text-align:center;">
            <div>
              <div style="font-size:0.75rem;color:var(--gray-500);">ì´ ë§¤ì¶œì•¡</div>
              <div style="font-size:1.5rem;font-weight:700;color:var(--primary);" id="totalSales">0</div>
            </div>
            <div>
              <div style="font-size:0.75rem;color:var(--gray-500);">ì´ ë§¤ì…ì•¡</div>
              <div style="font-size:1.5rem;font-weight:700;color:var(--danger);" id="totalPurchase">0</div>
            </div>
            <div>
              <div style="font-size:0.75rem;color:var(--gray-500);">ì†ìµ</div>
              <div style="font-size:1.5rem;font-weight:700;" id="totalProfit">0</div>
            </div>
            <div>
              <div style="font-size:0.75rem;color:var(--gray-500);">ì†ìµë¥ </div>
              <div style="font-size:1.5rem;font-weight:700;" id="profitRate">0%</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeDetailModal()">ë‹«ê¸°</button>
      <button class="btn btn-primary" onclick="printSettlement()">ğŸ–¨ï¸ ì •ì‚°ì„œ ì¸ì‡„</button>
      <button class="btn btn-warning" onclick="openFieldSettlementModal()" style="background:#f0ad4e;">ğŸ–¨ï¸ í˜„ì¥ì†Œì¥ìš©</button>
      <button class="btn" onclick="openSalesSettlementModal()" style="background:#9c27b0;color:white;">ğŸ–¨ï¸ ì˜ì—…ë‹´ë‹¹ììš©</button>
      <button class="btn btn-success" onclick="saveDetailData()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- ì˜ì—…ë‹´ë‹¹ììš© ì •ì‚°ì„œ í¸ì§‘ ëª¨ë‹¬ -->
<div id="salesSettlementModal" class="modal">
  <div class="modal-content" style="max-width:900px;">
    <div class="modal-header" style="background:#f3e5f5;border-bottom:2px solid #9c27b0;">
      <h3 style="color:#7b1fa2;">ğŸ“‹ ì˜ì—…ë‹´ë‹¹ììš© ì •ì‚°ì„œ í¸ì§‘</h3>
      <button class="modal-close" onclick="closeSalesSettlementModal()">&times;</button>
    </div>
    <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
      <!-- ê¸°ë³¸ ì •ë³´ -->
      <div class="detail-card" style="background:#f3e5f5;border:1px solid #ce93d8;">
        <div class="detail-card-title" style="background:#9c27b0;color:white;">ê¸°ë³¸ ì •ë³´</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;padding:1rem;">
          <div>
            <label class="form-label">ê³µì‚¬í˜„ì¥</label>
            <input type="text" class="form-input" id="sales_site" readonly style="background:#f5f5f5;">
          </div>
          <div>
            <label class="form-label">ê³µì‚¬ëª…</label>
            <input type="text" class="form-input" id="sales_project" readonly style="background:#f5f5f5;">
          </div>
          <div>
            <label class="form-label">ì˜ì—…ë‹´ë‹¹ì</label>
            <input type="text" class="form-input" id="sales_manager" style="font-weight:700;color:#7b1fa2;font-size:1.1rem;">
          </div>
          <div>
            <label class="form-label">í˜„ì¥ì†Œì¥</label>
            <input type="text" class="form-input" id="sales_field_manager" readonly style="background:#f5f5f5;">
          </div>
        </div>
      </div>
      
      <!-- ê³µì‚¬ ë‚´ì—­ -->
      <div class="detail-card" style="margin-top:1rem;">
        <div class="detail-card-title" style="background:#9c27b0;color:white;">ê³µì‚¬ ë‚´ì—­ <span style="font-size:0.7rem;font-weight:normal;">(ë§¤ì¶œì•¡ ì§ì ‘ ì…ë ¥)</span></div>
        <table class="detail-table">
          <thead>
            <tr>
              <th style="width:80px;">êµ¬ë¶„</th>
              <th>ë‚´ìš©</th>
              <th style="width:150px;">ë§¤ì¶œì•¡</th>
            </tr>
          </thead>
          <tbody id="salesWorkTableBody"></tbody>
        </table>
      </div>
      
      <!-- ë§¤ì… ë‚´ì—­ (ìì¬ë¹„+ë…¸ë¬´ë¹„+ê¸°íƒ€ê²½ë¹„) -->
      <div class="detail-card" style="margin-top:1rem;">
        <div class="detail-card-title" style="background:#7b1fa2;color:white;">ğŸ“¦ ë§¤ì… ë‚´ì—­ <span style="font-size:0.7rem;font-weight:normal;">(ìˆ˜ì • ê°€ëŠ¥)</span></div>
        <table class="detail-table">
          <thead>
            <tr>
              <th style="width:80px;">êµ¬ë¶„</th>
              <th>ë‚´ìš©</th>
              <th style="width:120px;">ê¸ˆì•¡</th>
              <th style="width:110px;">ì§€ê¸‰ì¼</th>
              <th style="width:120px;">ë¹„ê³ </th>
              <th style="width:40px;"></th>
            </tr>
          </thead>
          <tbody id="salesExpenseTableBody"></tbody>
          <tfoot>
            <tr style="background:#f3e5f5;font-weight:700;">
              <td colspan="2" class="text-right">ë§¤ì…ì•¡ í•©ê³„</td>
              <td class="text-right" id="salesExpenseTotal">0</td>
              <td colspan="3"></td>
            </tr>
          </tfoot>
        </table>
        <div style="padding:0.5rem;">
          <button class="btn btn-outline btn-sm" onclick="addSalesExpenseRow('ìì¬ë¹„')">+ ìì¬ë¹„</button>
          <button class="btn btn-outline btn-sm" onclick="addSalesExpenseRow('ë…¸ë¬´ë¹„')">+ ë…¸ë¬´ë¹„</button>
          <button class="btn btn-outline btn-sm" onclick="addSalesExpenseRow('ê¸°íƒ€ê²½ë¹„')">+ ê¸°íƒ€ê²½ë¹„</button>
        </div>
      </div>
      
      <!-- ì •ì‚° ìš”ì•½ -->
      <div class="detail-card" style="margin-top:1rem;">
        <div class="detail-card-title" style="background:#9c27b0;color:white;">ì •ì‚° ìš”ì•½ <span style="font-size:0.7rem;font-weight:normal;">(ìë™ ê³„ì‚°)</span></div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0;text-align:center;">
          <div style="padding:1rem;border:1px solid #ddd;">
            <div style="font-size:0.75rem;color:#666;">ë§¤ì¶œì•¡</div>
            <div style="font-size:1.2rem;font-weight:700;color:#1976d2;" id="salesSalesTotal">0</div>
          </div>
          <div style="padding:1rem;border:1px solid #ddd;">
            <div style="font-size:0.75rem;color:#666;">ë§¤ì…ì•¡</div>
            <div style="font-size:1.2rem;font-weight:700;color:#c62828;" id="salesPurchaseTotal">0</div>
          </div>
          <div style="padding:1rem;border:1px solid #ddd;background:#f3e5f5;">
            <div style="font-size:0.75rem;color:#666;">ì •ì‚°ê¸ˆì•¡ (ì´ìµ)</div>
            <div style="font-size:1.2rem;font-weight:700;color:#2e7d32;" id="salesSettlementTotal">0</div>
          </div>
        </div>
        <div style="padding:0.75rem;background:#e8f5e9;border-radius:0 0 8px 8px;font-size:0.75rem;color:#2e7d32;text-align:center;">
          â€» ì •ì‚°ê¸ˆì•¡ = ë§¤ì¶œì•¡ - ë§¤ì…ì•¡ (ìì¬ë¹„ + ë…¸ë¬´ë¹„ + ê¸°íƒ€ê²½ë¹„)
        </div>
      </div>
      
      <!-- ë¹„ê³  -->
      <div class="detail-card" style="margin-top:1rem;">
        <div class="detail-card-title" style="background:#9c27b0;color:white;">ğŸ“ ë¹„ê³ </div>
        <div style="padding:1rem;">
          <textarea id="salesMemo" placeholder="ì¶”ê°€ ë©”ëª¨ ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”..." style="width:100%;height:80px;border:1px solid #ddd;border-radius:4px;padding:0.5rem;resize:vertical;"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer" style="background:#f3e5f5;">
      <button class="btn btn-outline" onclick="closeSalesSettlementModal()">ë‹«ê¸°</button>
      <button class="btn btn-success" onclick="saveSalesSettlementData()" style="background:#4caf50;color:white;">ğŸ’¾ ì €ì¥</button>
      <button class="btn" onclick="printSalesSettlement()" style="background:#9c27b0;color:white;">ğŸ–¨ï¸ ì¸ì‡„</button>
    </div>
  </div>
</div>
<div id="fieldSettlementModal" class="modal">
  <div class="modal-content" style="max-width:900px;">
    <div class="modal-header" style="background:#fff3e0;border-bottom:2px solid #f0ad4e;">
      <h3 style="color:#e65100;">ğŸ“‹ í˜„ì¥ì†Œì¥ìš© ì •ì‚°ì„œ í¸ì§‘</h3>
      <button class="modal-close" onclick="closeFieldSettlementModal()">&times;</button>
    </div>
    <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
      <!-- ê¸°ë³¸ ì •ë³´ -->
      <div class="detail-card" style="margin-bottom:1rem;">
        <div class="detail-card-title" style="background:#fff3e0;color:#e65100;">ê¸°ë³¸ ì •ë³´</div>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;padding:1rem;">
          <div class="form-group">
            <label class="form-label">ê³µì‚¬í˜„ì¥</label>
            <input type="text" class="form-input" id="field_site" readonly style="background:#f5f5f5;">
          </div>
          <div class="form-group">
            <label class="form-label">ê³µì‚¬ëª…</label>
            <input type="text" class="form-input" id="field_project">
          </div>
          <div class="form-group">
            <label class="form-label">ì˜ì—…ë‹´ë‹¹ì</label>
            <input type="text" class="form-input" id="field_sales">
          </div>
          <div class="form-group">
            <label class="form-label">í˜„ì¥ì†Œì¥ ì„ íƒ <span style="font-size:0.7rem;color:#888;">(ì¸ì‡„í•  ì†Œì¥ ì„ íƒ)</span></label>
            <div style="display:flex;gap:0.5rem;">
              <select class="form-input" id="field_manager_select" style="border-color:#f0ad4e;flex:1;" onchange="onFieldManagerSelect()">
                <option value="">-- ì†Œì¥ ì„ íƒ --</option>
              </select>
              <button class="btn btn-outline btn-sm" onclick="addNewFieldManager()" style="white-space:nowrap;border-color:#f0ad4e;color:#e65100;">+ ì¶”ê°€</button>
            </div>
            <input type="hidden" id="field_manager">
          </div>
        </div>
        <!-- ì„ íƒëœ í˜„ì¥ì†Œì¥ í‘œì‹œ -->
        <div id="selectedManagerDisplay" style="padding:0 1rem 1rem;display:none;">
          <div style="font-size:0.8rem;color:#e65100;margin-bottom:0.5rem;">ğŸ“Œ ì„ íƒëœ í˜„ì¥ì†Œì¥:</div>
          <div id="selectedManagerName" style="font-size:1.1rem;font-weight:700;color:#e65100;padding:0.5rem;background:#fff8e1;border-radius:4px;"></div>
        </div>
      </div>
      
      <!-- ê³µì‚¬ì¢…ë¥˜ (ë§¤ì¶œì•¡ ì§ì ‘ ì…ë ¥) -->
      <div class="detail-card" style="margin-bottom:1rem;">
        <div class="detail-card-title" style="background:#fff3e0;color:#e65100;">ê³µì‚¬ ë‚´ì—­ <span style="font-size:0.7rem;color:#888;font-weight:normal;">(ë§¤ì¶œì•¡ ì§ì ‘ ì…ë ¥)</span></div>
        <table class="detail-table">
          <thead>
            <tr>
              <th style="width:100px;">êµ¬ë¶„</th>
              <th>ë‚´ìš©</th>
              <th style="width:150px;">ë§¤ì¶œì•¡</th>
            </tr>
          </thead>
          <tbody id="fieldWorkTableBody">
          </tbody>
        </table>
      </div>
      
      <!-- ìì¬ë¹„ ë‚´ì—­ (ìˆ˜ì • ê°€ëŠ¥) -->
      <div class="detail-card" style="margin-bottom:1rem;">
        <div class="detail-card-title" style="background:#e3f2fd;color:#1565c0;">ìì¬ë¹„ ë‚´ì—­ (ë§¤ì…ì•¡) <span style="font-size:0.7rem;color:#888;font-weight:normal;">(ìˆ˜ì • ê°€ëŠ¥)</span></div>
        <table class="detail-table">
          <thead>
            <tr>
              <th style="width:150px;">ë‚´ìš©</th>
              <th style="width:130px;">ê¸ˆì•¡</th>
              <th>ë¹„ê³ </th>
              <th style="width:40px;"></th>
            </tr>
          </thead>
          <tbody id="fieldMaterialTableBody">
          </tbody>
          <tfoot>
            <tr class="summary-row" style="background:#e3f2fd;">
              <td><strong>ìì¬ë¹„ í•©ê³„</strong></td>
              <td class="text-right"><strong id="fieldMaterialTotal">0</strong></td>
              <td colspan="2"></td>
            </tr>
          </tfoot>
        </table>
        <div style="padding:0.5rem;">
          <button class="btn btn-outline btn-sm" onclick="addFieldMaterialRow()" style="color:#1565c0;border-color:#1565c0;">+ ìì¬ë¹„ ì¶”ê°€</button>
        </div>
      </div>
      
      <!-- ë…¸ë¬´ë¹„ ë‚´ì—­ (ìˆ˜ì • ê°€ëŠ¥) -->
      <div class="detail-card" style="margin-bottom:1rem;">
        <div class="detail-card-title" style="background:#fff3e0;color:#e65100;">ë…¸ë¬´ë¹„ ë‚´ì—­ (ë§¤ì…ì•¡) <span style="font-size:0.7rem;color:#888;font-weight:normal;">(ìˆ˜ì • ê°€ëŠ¥)</span></div>
        <table class="detail-table">
          <thead>
            <tr>
              <th style="width:150px;">ë‚´ìš©</th>
              <th style="width:130px;">ê¸ˆì•¡</th>
              <th style="width:110px;">ì§€ê¸‰ì¼</th>
              <th>ë¹„ê³ </th>
              <th style="width:40px;"></th>
            </tr>
          </thead>
          <tbody id="fieldLaborTableBody">
          </tbody>
          <tfoot>
            <tr class="summary-row" style="background:#fff3e0;">
              <td><strong>ë…¸ë¬´ë¹„ í•©ê³„</strong></td>
              <td class="text-right"><strong id="fieldLaborTotal">0</strong></td>
              <td colspan="3"></td>
            </tr>
          </tfoot>
        </table>
        <div style="padding:0.5rem;">
          <button class="btn btn-outline btn-sm" onclick="addFieldLaborRow()">+ ë…¸ë¬´ë¹„ ì¶”ê°€</button>
        </div>
      </div>
      
      <!-- ì •ì‚° ìš”ì•½ (ìë™ ê³„ì‚°) -->
      <div class="detail-card">
        <div class="detail-card-title" style="background:#fff3e0;color:#e65100;">ì •ì‚° ìš”ì•½ <span style="font-size:0.7rem;color:#888;font-weight:normal;">(ìë™ ê³„ì‚°)</span></div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0;text-align:center;">
          <div style="padding:1rem;border:1px solid #ddd;">
            <div style="font-size:0.75rem;color:#666;">ë§¤ì¶œì•¡</div>
            <div style="font-size:1.2rem;font-weight:700;color:#1976d2;" id="fieldSalesTotal">0</div>
          </div>
          <div style="padding:1rem;border:1px solid #ddd;">
            <div style="font-size:0.75rem;color:#666;">ìì¬ë¹„</div>
            <div style="font-size:1.2rem;font-weight:700;color:#1565c0;" id="fieldMaterialTotalSummary">0</div>
          </div>
          <div style="padding:1rem;border:1px solid #ddd;">
            <div style="font-size:0.75rem;color:#666;">ë…¸ë¬´ë¹„</div>
            <div style="font-size:1.2rem;font-weight:700;color:#e65100;" id="fieldLaborTotalSummary">0</div>
          </div>
          <div style="padding:1rem;border:1px solid #ddd;background:#fff8e1;">
            <div style="font-size:0.75rem;color:#666;">ì •ì‚°ê¸ˆì•¡</div>
            <div style="font-size:1.2rem;font-weight:700;color:#2e7d32;" id="fieldSettlementTotal">0</div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0;text-align:center;border-top:1px solid #ddd;">
          <div style="padding:0.75rem;border-right:1px solid #ddd;">
            <div style="font-size:0.75rem;color:#666;">ë§¤ì…ì•¡ í•©ê³„ (ìì¬ë¹„+ë…¸ë¬´ë¹„)</div>
            <div style="font-size:1.1rem;font-weight:700;color:#c62828;" id="fieldPurchaseTotal">0</div>
          </div>
          <div style="padding:0.75rem;">
            <div style="font-size:0.75rem;color:#666;">ì •ì‚°ê¸ˆì•¡ (ë§¤ì¶œ-ë§¤ì…)</div>
            <div style="font-size:1.1rem;font-weight:700;color:#2e7d32;" id="fieldSettlementTotal2">0</div>
          </div>
        </div>
        <div style="padding:0.75rem;background:#e8f5e9;border-radius:0 0 8px 8px;font-size:0.75rem;color:#2e7d32;text-align:center;">
          â€» ì •ì‚°ê¸ˆì•¡ = ë§¤ì¶œì•¡ - ë§¤ì…ì•¡(ìì¬ë¹„ + ë…¸ë¬´ë¹„)
        </div>
      </div>
      
      <!-- ë¹„ê³  -->
      <div class="detail-card" style="margin-top:1rem;">
        <div class="detail-card-title" style="background:#fff3e0;color:#e65100;">ğŸ“ ë¹„ê³ </div>
        <div style="padding:1rem;">
          <textarea id="fieldMemo" placeholder="ì¶”ê°€ ë©”ëª¨ ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”..." style="width:100%;height:80px;border:1px solid #ddd;border-radius:4px;padding:0.5rem;resize:vertical;"></textarea>
        </div>
      </div>
      
      <!-- ì‚¬ì§„ ì²¨ë¶€ -->
      <div class="detail-card" style="margin-top:1rem;">
        <div class="detail-card-title" style="background:#fff3e0;color:#e65100;">ğŸ“· ì‚¬ì§„ ì²¨ë¶€</div>
        <div style="padding:1rem;">
          <input type="file" id="fieldPhotoInput" accept="image/*" multiple onchange="handleFieldPhotoUpload(event)" style="display:none;">
          <button class="btn btn-outline btn-sm" onclick="document.getElementById('fieldPhotoInput').click()" style="margin-bottom:0.5rem;">
            ğŸ“· ì‚¬ì§„ ì¶”ê°€
          </button>
          <span style="font-size:0.75rem;color:#888;margin-left:0.5rem;">ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥</span>
          <div id="fieldPhotoPreview" style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-top:0.5rem;"></div>
        </div>
      </div>
    </div>
    <div class="modal-footer" style="background:#fff3e0;">
      <button class="btn btn-outline" onclick="closeFieldSettlementModal()">ë‹«ê¸°</button>
      <button class="btn btn-success" onclick="saveFieldSettlementData()" style="background:#4caf50;color:white;">ğŸ’¾ ì €ì¥</button>
      <button class="btn btn-warning" onclick="printFieldSettlement()" style="background:#f0ad4e;">ğŸ–¨ï¸ ì¸ì‡„</button>
    </div>
  </div>
</div>

<script>
let allData = {};
let currentYear = '2026';
let selectedItems = new Set();
let deleteTarget = null;
let searchFilter = { keyword: '', status: '', type: '' };
let filteredData = null;

// ë³¸ì‚¬ ë‹´ë‹¹ì ëª©ë¡ (ì™¸ì£¼ê°€ ì•„ë‹Œ ì§ì›)
const HQ_MANAGERS = ['í™©ìœ¤ì„ ', 'ê¹€ì„±ë¯¼', 'ì´í•„ì„ ', 'í•œì¤€ì—½', 'ì •ì •í›ˆ', 'ì¡°ì¬ì—°'];
// ì •ì‚° ì œì™¸ ë‹´ë‹¹ì (ë³¸ì‚¬ ì •ì‚° ëŒ€ìƒ ì•„ë‹˜)
const EXCLUDE_MANAGERS = ['ê¸°íƒ€', 'ë°•ì—°ì§„'];
// ì™¸ì£¼ ë‹´ë‹¹ì (ë˜ëŠ” ê¸°íƒ€(ì™¸) ë“±)
const EXT_MANAGERS = ['ê¸°íƒ€(ì™¸)'];

// ë‹´ë‹¹ì ì´ë©”ì¼ ê´€ë¦¬
let managerEmails = {};

// ë‹´ë‹¹ì ì´ë©”ì¼ ê¸°ë³¸ê°’
const DEFAULT_MANAGER_EMAILS = {
  'ì •ì •í›ˆ': 'jjh@netformrnd.com',
  'ì´í•„ì„ ': 'lps@netformrnd.com',
  'í•œì¤€ì—½': 'han1026@netformrnd.com',
  'ì¡°ì¬ì—°': 'jjy@netformrnd.com',
  'ê¹€ì„±ë¯¼': 'ksm@netformrnd.com',
  'í™©ìœ¤ì„ ': 'hwang@netformrnd.com'
};

// ë‹´ë‹¹ì ì´ë©”ì¼ ë¡œë“œ
function loadManagerEmails() {
  try {
    const saved = localStorage.getItem('managerEmails');
    if (saved) {
      managerEmails = JSON.parse(saved);
    }
    // ê¸°ë³¸ê°’ ë³‘í•© (ì €ì¥ëœ ê°’ì´ ì—†ëŠ” ë‹´ë‹¹ìë§Œ)
    Object.keys(DEFAULT_MANAGER_EMAILS).forEach(manager => {
      if (!managerEmails[manager]) {
        managerEmails[manager] = DEFAULT_MANAGER_EMAILS[manager];
      }
    });
  } catch(e) {
    console.error('ì´ë©”ì¼ ë¡œë“œ ì‹¤íŒ¨:', e);
    managerEmails = {...DEFAULT_MANAGER_EMAILS};
  }
}

// ë‹´ë‹¹ì ì´ë©”ì¼ ì €ì¥
function saveManagerEmails() {
  localStorage.setItem('managerEmails', JSON.stringify(managerEmails));
}

// í˜„ì¥ ìƒì„¸ ì‚¬ì§„ ì €ì¥ìš©
let detailPhotos = [];

document.addEventListener('DOMContentLoaded', () => {
  initYearTabs();
  initDragDrop();
  loadFromStorage();
  loadFieldSettlementFromStorage();  // í˜„ì¥ì†Œì¥ë³„ ì •ì‚° ë°ì´í„° ë¡œë“œ
  loadSalesSettlementFromStorage();  // ì˜ì—…ë‹´ë‹¹ìë³„ ì •ì‚° ë°ì´í„° ë¡œë“œ
  loadManagerEmails();  // ë‹´ë‹¹ì ì´ë©”ì¼ ë¡œë“œ
  loadConsultingData();  // ê¸°ìˆ ì»¨ì„¤íŒ… ì •ì‚° ë°ì´í„° ë¡œë“œ
  loadConsultingListData();  // ê¸°ìˆ ì»¨ì„¤íŒ… í˜„ì¥ ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
});

function initYearTabs() {
  document.querySelectorAll('.year-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      document.querySelectorAll('.year-tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      currentYear = this.dataset.year;
      selectedItems.clear();
      updateDeleteButton();
      resetSearch();  // ê²€ìƒ‰ ì´ˆê¸°í™”
      renderTable();
      updateStats();
      
      // ê¸°ìˆ ì»¨ì„¤íŒ… íƒ­ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ê¸°ìˆ ì»¨ì„¤íŒ…ë„ í•„í„°ë§
      const consultingSection = document.getElementById('mainConsultingSection');
      if (consultingSection && consultingSection.style.display !== 'none') {
        // ë…„ë„ í•„í„° ë“œë¡­ë‹¤ìš´ë„ ë™ê¸°í™”
        const yearFilter = document.getElementById('consultingMainYearFilter');
        if (yearFilter) {
          // 2020-2021 ê°™ì€ ë²”ìœ„ëŠ” ë¹ˆê°’ìœ¼ë¡œ
          if (currentYear.includes('-')) {
            yearFilter.value = '';
          } else {
            yearFilter.value = currentYear;
          }
        }
        renderConsultingMain();
      }
    });
  });
}

function initDragDrop() {
  const area = document.getElementById('uploadArea');
  area.addEventListener('click', () => document.getElementById('fileInput').click());
  area.addEventListener('dragover', e => { e.preventDefault(); area.classList.add('dragover'); });
  area.addEventListener('dragleave', () => area.classList.remove('dragover'));
  area.addEventListener('drop', e => { e.preventDefault(); area.classList.remove('dragover'); if (e.dataTransfer.files[0]) processExcel(e.dataTransfer.files[0]); });
}

function handleFileUpload(e) { if (e.target.files[0]) processExcel(e.target.files[0]); e.target.value = ''; }

function processExcel(file) {
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
      
      // ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™”
      allData = {};
      
      const sheetMapping = { 
        '2020ì¼ë¶€~2021': '2020-2021', 
        '2022': '2022', 
        '2023': '2023', 
        '2024': '2024', 
        '2025': '2025' 
      };
      
      console.log('ì‹œíŠ¸ ëª©ë¡:', wb.SheetNames);
      
      wb.SheetNames.forEach(sheetName => {
        const yearKey = sheetMapping[sheetName];
        if (yearKey) {
          const json = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], { header: 1 });
          const parsed = parseSheetDataWithRedInfo(json, yearKey, RED_CELL_INFO[yearKey] || {});
          allData[yearKey] = parsed;
          console.log(`${yearKey}: ${parsed.length}ê±´ íŒŒì‹±ë¨`);
        }
      });
      
      // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì €ì¥
      saveToStorage();
      renderTable();
      updateStats();
      showToast('ì—‘ì…€ ì—…ë¡œë“œ ì™„ë£Œ!', 'success');
    } catch (err) { 
      console.error(err); 
      showToast('ì˜¤ë¥˜: ' + err.message, 'error'); 
    }
  };
  reader.readAsArrayBuffer(file);
}

function parseSheetDataWithRedInfo(json, yearKey, redInfo) {
  // í—¤ë” í–‰ ì°¾ê¸°
  let headerIdx = -1;
  for (let i = 0; i < Math.min(json.length, 10); i++) {
    if (json[i] && (json[i][0] === 'N.O' || json[i][0] === 'NO')) {
      headerIdx = i;
      break;
    }
  }
  if (headerIdx < 0) headerIdx = 3;
  
  const data = [];
  const startRow = headerIdx + 2;
  
  console.log(`${yearKey} íŒŒì‹± ì‹œì‘: headerIdx=${headerIdx}, startRow=${startRow}, ì´í–‰ìˆ˜=${json.length}`);
  
  for (let i = startRow; i < json.length; i++) {
    const row = json[i];
    if (!row) continue;
    
    const no = row[0];
    if (no === undefined || no === null || no === '') continue;
    if (typeof no === 'string') {
      const noStr = no.toString();
      if (noStr.includes('ê³„ì•½') || noStr.includes('ì†Œê³„') || 
          noStr.includes('ë…„ë„') || noStr.includes('í•©ê³„') ||
          noStr.includes('ì›”') || noStr.includes('ì£¼ì°¨')) continue;
    }
    if (!row[2] && !row[3]) continue;
    
    // NOì— í•´ë‹¹í•˜ëŠ” ë¹¨ê°„ìƒ‰ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const noKey = String(Math.floor(Number(no)));
    const redFlags = redInfo[noKey] || {};
    
    let item = {
      no: no,
      region: row[1] || '',
      site: row[2] || '',
      name: row[3] || '',
      amount: parseNum(row[4]),
      amountTax: parseNum(row[5]),
      contractDate: parseDate(row[6]),
      startDate: parseDate(row[7]),
      endDate: parseDate(row[8]),
      contract1: { amt: parseNum(row[9]), bill: parseDate(row[10]), paid: parseDate(row[11]), isRed: redFlags.contract1 || false },
      interim1: { amt: parseNum(row[12]), bill: parseDate(row[13]), paid: parseDate(row[14]), isRed: redFlags.interim1 || false },
      balance1: { amt: parseNum(row[15]), bill: parseDate(row[16]), paid: parseDate(row[17]), isRed: redFlags.balance1 || false },
      interim2: { amt: 0, bill: '', paid: '', isRed: false },
      type: '',
      manager: '',
      siteManager: ''
    };
    
    // ì‹œíŠ¸ë³„ ë‹¤ë¥¸ ì»¬ëŸ¼ ìœ„ì¹˜ ì²˜ë¦¬
    if (yearKey === '2020-2021') {
      item.type = '';
      item.manager = row[19] || '';
      item.siteManager = row[20] || '';
    } else if (yearKey === '2022') {
      item.type = '';
      item.manager = row[18] || '';
      item.siteManager = row[19] || '';
    } else {
      // 2023, 2024, 2025
      item.type = row[18] || '';
      item.manager = row[19] || '';
      item.siteManager = row[20] || '';
    }
    
    data.push(item);
  }
  
  return data;
}

function parseNum(v) { if (!v) return 0; if (typeof v === 'number') return v; return parseFloat(String(v).replace(/[,\sì›%]/g, '')) || 0; }

function parseDate(v) {
  if (!v) return '';
  // "ë¯¸ì •" ê°™ì€ í…ìŠ¤íŠ¸ëŠ” ê·¸ëŒ€ë¡œ ë³´ì¡´
  if (typeof v === 'string') {
    const str = v.trim();
    if (str === 'ë¯¸ì •' || str === '-' || str === '') return str;
    if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;
    if (/^\d{4}[.\/]\d{1,2}[.\/]\d{1,2}$/.test(str)) return str.replace(/[.\/]/g, '-');
  }
  try {
    if (typeof v === 'number') { 
      const d = new Date((v - 25569) * 86400000); 
      if (!isNaN(d.getTime())) return d.toISOString().split('T')[0]; 
    }
    const parsed = new Date(v);
    if (!isNaN(parsed.getTime())) return parsed.toISOString().split('T')[0];
    return String(v);
  } catch (e) { return String(v); }
}

function renderTable() {
  const data = allData[currentYear] || [];
  const yearLabel = currentYear === '2020-2021' ? '2020~2021' : currentYear;
  document.getElementById('tableTitle').textContent = yearLabel + 'ë…„ ê³µì‚¬í˜„í™©';
  
  // í•´ì§€ëœ ê±´ ëª©ë¡
  const cancelledList = CANCELLED_INFO[currentYear] || [];
  
  // ê²€ìƒ‰ í•„í„° ì ìš© - ì›ë³¸ ì¸ë±ìŠ¤ í¬í•¨
  let displayData = data.map((item, idx) => ({ ...item, _originalIdx: idx }));
  if (filteredData !== null) {
    // í•„í„°ë§ëœ ë°ì´í„°ë„ ì›ë³¸ ì¸ë±ìŠ¤ ìœ ì§€
    displayData = filteredData.map(item => {
      const origIdx = data.indexOf(item);
      return { ...item, _originalIdx: origIdx >= 0 ? origIdx : data.findIndex(d => d.no === item.no && d.site === item.site) };
    });
  }
  
  // ìƒíƒœë³„ ì •ë ¬: ì§„í–‰ì¤‘ â†’ ë¯¸ì…ê¸ˆ â†’ ì…ê¸ˆì™„ë£Œ â†’ í•´ì§€
  displayData = [...displayData].sort((a, b) => {
    const getStatusOrder = (item) => {
      const noKey = String(Math.floor(Number(item.no)));
      const isCancelled = cancelledList.includes(noKey) || (item.site && item.site.includes('í•´ì§€'));
      
      if (isCancelled) return 4;  // í•´ì§€ - ë§¨ ë°‘
      
      const isPaid = (p) => {
        if (!p) return false;
        if (p.isRed) return false;
        if (p.manualPaid) return true;
        return p.paid && p.paid !== '' && p.paid !== 'ë¯¸ì •';
      };
      
      const isUnpaid = (p) => {
        if (!p) return false;
        if (p.isRed) return true;
        return (p.bill && p.bill !== '' && (!p.paid || p.paid === '' || p.paid === 'ë¯¸ì •'));
      };
      
      // ì”ê¸ˆê¹Œì§€ ì™„ë£Œ = ì…ê¸ˆì™„ë£Œ
      if (isPaid(item.balance1)) return 3;
      
      // ë¯¸ì…ê¸ˆ ì²´í¬ (ê³„ì‚°ì„œ ë°œí–‰í–ˆëŠ”ë° ì…ê¸ˆ ì•ˆë¨)
      if (isUnpaid(item.contract1) || isUnpaid(item.interim1) || isUnpaid(item.balance1)) return 2;
      
      // ê·¸ ì™¸ = ì§„í–‰ì¤‘
      return 1;
    };
    
    return getStatusOrder(a) - getStatusOrder(b);
  });
  
  document.getElementById('totalCount').textContent = 'ì´ ' + displayData.length + 'ê±´' + (filteredData !== null ? ' (ê²€ìƒ‰ê²°ê³¼)' : '');
  
  if (data.length === 0) {
    document.getElementById('uploadArea').style.display = 'block';
    document.getElementById('tableWrapper').style.display = 'none';
    return;
  }
  
  document.getElementById('uploadArea').style.display = 'none';
  document.getElementById('tableWrapper').style.display = 'block';
  
  document.getElementById('tableBody').innerHTML = displayData.map((item, idx) => {
    const originalIdx = item._originalIdx;
    const isSelected = selectedItems.has(originalIdx);
    const typeClass = item.type?.includes('ì§ì˜') ? 'type-direct' : (item.type?.includes('ì»¨ì„¤íŒ…') ? 'type-consulting' : '');
    
    // ê³„ì•½ í•´ì§€ ì—¬ë¶€ ì²´í¬ (ê³µì‚¬í˜„ì¥ëª…ì— "í•´ì§€" í¬í•¨ ë˜ëŠ” CANCELLED_INFOì— ìˆëŠ” ê²½ìš°)
    const noKey = String(Math.floor(Number(item.no)));
    const cancelledList = CANCELLED_INFO[currentYear] || [];
    const isCancelled = cancelledList.includes(noKey) || (item.site && item.site.includes('í•´ì§€'));
    
    const cs = getPaymentStatus(item.contract1, isCancelled);
    const is = getPaymentStatus(item.interim1, isCancelled);
    const bs = getPaymentStatus(item.balance1, isCancelled);
    return `<tr class="${isSelected ? 'selected' : ''}">
      <td><input type="checkbox" class="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelect(${originalIdx})"></td>
      <td>${item.no || '-'}</td><td>${item.region || '-'}</td>
      <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${item.site}">${highlightKeyword(item.site) || '-'}</td>
      <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${item.name}">${highlightKeyword(item.name) || '-'}</td>
      <td class="text-right font-mono">${fmt(item.amount)}</td>
      <td class="text-right font-mono">${fmt(item.amountTax)}</td>
      <td>${item.contractDate || '-'}</td>
      <td>${item.startDate || '-'}</td>
      <td>${item.endDate || '-'}</td>
      <td class="text-center">${cs}</td><td class="text-center">${is}</td><td class="text-center">${bs}</td>
      <td>${item.type ? '<span class="type-badge ' + typeClass + '">' + item.type + '</span>' : '-'}</td>
      <td>${highlightKeyword(item.manager) || '-'}</td><td style="min-width:130px !important;max-width:150px;white-space:normal !important;word-break:break-all;">${highlightKeyword(item.siteManager) || '-'}</td>
      <td><button class="btn btn-detail btn-sm" onclick="openDetailModal(${originalIdx})">ìƒì„¸</button></td>
      <td><button class="btn btn-outline btn-sm" onclick="openEditModal(${originalIdx})">ìˆ˜ì •</button></td>
    </tr>`;
  }).join('');
  document.getElementById('selectAll').checked = selectedItems.size === displayData.length && displayData.length > 0;
}

function getPaymentStatus(p, isCancelled) {
  if (!p) return '<span class="payment-badge unpaid">-</span>';
  
  // ê³„ì•½ í•´ì§€ëœ ê²½ìš°
  if (isCancelled) return '<span class="payment-badge" style="background:#e0e0e0;color:#666;">í•´ì§€</span>';
  
  const hasBill = p.bill && p.bill !== '';
  const hasPaid = p.paid && p.paid !== '' && p.paid !== 'ë¯¸ì •';
  const hasAmt = p.amt && p.amt > 0;
  const isRed = p.isRed === true;  // ì—‘ì…€ì—ì„œ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í‘œì‹œëœ ê²½ìš°
  const manualPaid = p.manualPaid === true;  // ìˆ˜ë™ ì…ê¸ˆì™„ë£Œ ì²˜ë¦¬
  
  // ë¹¨ê°„ìƒ‰ ê¸€ì = ë¯¸ì…ê¸ˆ (ê¸ˆì•¡ì´ ìˆê³  ì•„ì§ ì…ê¸ˆ ì•ˆë¨)
  if (isRed) return '<span class="payment-badge" style="background:var(--danger-light);color:var(--danger);">ë¯¸ì…ê¸ˆ</span>';
  
  // ìˆ˜ë™ ì…ê¸ˆì™„ë£Œ ì²˜ë¦¬ëœ ê²½ìš°
  if (manualPaid) return '<span class="payment-badge paid">ì™„ë£Œ</span>';
  
  // ì…ê¸ˆì¼ì´ ìˆìœ¼ë©´ ì™„ë£Œ (ê³„ì‚°ì„œ ìœ ë¬´ ìƒê´€ì—†ì´)
  if (hasPaid) return '<span class="payment-badge paid">ì™„ë£Œ</span>';
  
  // ê³„ì‚°ì„œ ë°œí–‰í–ˆëŠ”ë° ì…ê¸ˆì¼ ì—†ìŒ = ë¯¸ì…ê¸ˆ
  if (hasBill && !hasPaid) return '<span class="payment-badge" style="background:var(--danger-light);color:var(--danger);">ë¯¸ì…ê¸ˆ</span>';
  
  // ê¸ˆì•¡ì€ ìˆëŠ”ë° ê³„ì‚°ì„œë„ ì—†ê³  ì…ê¸ˆì¼ë„ ì—†ìŒ = ì§„í–‰ì¤‘
  if (hasAmt && !hasBill && !hasPaid) return '<span class="payment-badge partial">ì§„í–‰ì¤‘</span>';
  
  return '<span class="payment-badge unpaid">-</span>';
}

function updateStats() {
  const data = allData[currentYear] || [];
  let pc=0,pa=0,cc=0,ca=0,ic=0,ia=0,bc=0,ba=0;
  
  // í•´ì§€ëœ ê±´ ëª©ë¡
  const cancelledList = CANCELLED_INFO[currentYear] || [];
  
  data.forEach(item => {
    const noKey = String(Math.floor(Number(item.no)));
    const isCancelled = cancelledList.includes(noKey) || (item.site && item.site.includes('í•´ì§€'));
    
    // í•´ì§€ëœ ê±´ì€ í†µê³„ì—ì„œ ì œì™¸
    if (isCancelled) return;
    
    // ì…ê¸ˆ ì™„ë£Œ ì²´í¬ (ì…ê¸ˆì¼ì´ ìˆê±°ë‚˜ ìˆ˜ë™ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆê³ , ë¹¨ê°„ìƒ‰ì´ ì•„ë‹ˆê³ , "ë¯¸ì •"ì´ ì•„ë‹˜)
    const isPaid = (p) => {
      if (!p) return false;
      if (p.isRed) return false;
      if (p.manualPaid) return true;
      return p.paid && p.paid !== '' && p.paid !== 'ë¯¸ì •';
    };
    
    // VATë³„ë„ ê¸ˆì•¡ ì‚¬ìš©
    const amt = item.amount || 0;
    
    // ì”ê¸ˆê¹Œì§€ ì™„ë£Œ
    if (isPaid(item.balance1)) { 
      pc++; pa += amt; 
    }
    // ì¤‘ë„ê¸ˆê¹Œì§€ ì™„ë£Œ (ì”ê¸ˆì€ ë¯¸ì™„ë£Œ)
    else if (isPaid(item.interim1)) { 
      ic++; ia += amt; 
    }
    // ê³„ì•½ê¸ˆë§Œ ì™„ë£Œ
    else if (isPaid(item.contract1)) { 
      cc++; ca += amt; 
    }
    // ë¯¸ì…ê¸ˆ/ì§„í–‰ì¤‘
    else { 
      bc++; ba += amt; 
    }
  });
  
  const vatLabel = ' <span style="font-size:0.7rem;color:#888;">(VATë³„ë„)</span>';
  document.getElementById('statPaidAmount').textContent = fmtAmount(pa);
  document.getElementById('statPaidCount').innerHTML = pc + 'ê±´' + vatLabel;
  document.getElementById('statContractAmount').textContent = fmtAmount(ca);
  document.getElementById('statContractCount').innerHTML = cc + 'ê±´' + vatLabel;
  document.getElementById('statInterimAmount').textContent = fmtAmount(ia);
  document.getElementById('statInterimCount').innerHTML = ic + 'ê±´' + vatLabel;
  document.getElementById('statBalanceAmount').textContent = fmtAmount(ba);
  document.getElementById('statBalanceCount').innerHTML = bc + 'ê±´' + vatLabel;
  
  // ë‹´ë‹¹ìë³„ í†µê³„ ì—…ë°ì´íŠ¸
  updateManagerStats();
}

// ë‹´ë‹¹ìë³„ í†µê³„ í† ê¸€
function toggleManagerStats() {
  const content = document.getElementById('managerStatsContent');
  const icon = document.getElementById('managerToggleIcon');
  content.classList.toggle('collapsed');
  icon.classList.toggle('collapsed');
}

// ë‹´ë‹¹ìë³„ í†µê³„ ì—…ë°ì´íŠ¸
function updateManagerStats() {
  const data = allData[currentYear] || [];
  const cancelledList = CANCELLED_INFO[currentYear] || [];
  
  // ë³¸ì‚¬ ë‹´ë‹¹ì ëª©ë¡ (ê³µì‚¬ìœ í˜•ì— 'ë³¸' í¬í•¨)
  // ì™¸ì£¼ ë‹´ë‹¹ì ëª©ë¡ (ê³µì‚¬ìœ í˜•ì— 'ì™¸' í¬í•¨)
  const hqManagers = {}; // { ë‹´ë‹¹ìëª…: { count, amount, amountTax, consulting: {count, amount, amountTax}, direct: {count, amount, amountTax} } }
  const extManagers = {};
  
  data.forEach(item => {
    const noKey = String(Math.floor(Number(item.no)));
    const isCancelled = cancelledList.includes(noKey) || (item.site && item.site.includes('í•´ì§€'));
    
    // í•´ì§€ëœ ê±´ì€ ì œì™¸
    if (isCancelled) return;
    
    const manager = item.manager || 'ê¸°íƒ€';
    const type = item.type || '';
    const amount = item.amount || 0;
    const amountTax = item.amountTax || 0;
    
    // ë³¸ì‚¬ vs ì™¸ì£¼ êµ¬ë¶„ (ê³µì‚¬ìœ í˜•ì— 'ë³¸' ë˜ëŠ” 'ì™¸' í¬í•¨ ì—¬ë¶€)
    const isHq = type.includes('(ë³¸)') || type.includes('ë³¸)') || (!type.includes('(ì™¸)') && !type.includes('ì™¸)'));
    const isExt = type.includes('(ì™¸)') || type.includes('ì™¸)');
    
    // ì»¨ì„¤íŒ… vs ì§ì˜ êµ¬ë¶„
    const isConsulting = type.includes('ì»¨ì„¤íŒ…');
    const isDirect = type.includes('ì§ì˜');
    
    if (isExt) {
      // ì™¸ì£¼
      if (!extManagers[manager]) {
        extManagers[manager] = { count: 0, amount: 0, amountTax: 0 };
      }
      extManagers[manager].count++;
      extManagers[manager].amount += amount;
      extManagers[manager].amountTax += amountTax;
    } else {
      // ë³¸ì‚¬
      if (!hqManagers[manager]) {
        hqManagers[manager] = { 
          count: 0, amount: 0, amountTax: 0,
          consulting: { count: 0, amount: 0, amountTax: 0 },
          direct: { count: 0, amount: 0, amountTax: 0 }
        };
      }
      hqManagers[manager].count++;
      hqManagers[manager].amount += amount;
      hqManagers[manager].amountTax += amountTax;
      
      if (isConsulting) {
        hqManagers[manager].consulting.count++;
        hqManagers[manager].consulting.amount += amount;
        hqManagers[manager].consulting.amountTax += amountTax;
      } else if (isDirect) {
        hqManagers[manager].direct.count++;
        hqManagers[manager].direct.amount += amount;
        hqManagers[manager].direct.amountTax += amountTax;
      }
    }
  });
  
  // ë³¸ì‚¬ í…Œì´ë¸” ë Œë”ë§
  let hqHtml = '';
  let hqTotalCount = 0, hqTotalAmount = 0, hqTotalAmountTax = 0;
  let hqConsultingCount = 0, hqConsultingAmount = 0, hqConsultingAmountTax = 0;
  let hqDirectCount = 0, hqDirectAmount = 0, hqDirectAmountTax = 0;
  
  // ì •ë ¬ (ê¸ˆì•¡ ë‚´ë¦¼ì°¨ìˆœ)
  const hqSorted = Object.entries(hqManagers).sort((a, b) => b[1].amountTax - a[1].amountTax);
  
  hqSorted.forEach(([name, stats]) => {
    if (name === 'ê¸°íƒ€' && stats.count === 0) return;
    hqHtml += `<tr>
      <td>ê³µì‚¬ê¸ˆì•¡ í•©ê³„ [ ${name} ]</td>
      <td style="text-align:center;">${stats.count}</td>
      <td>${fmt(stats.amount)}</td>
      <td>${fmt(stats.amountTax)}</td>
    </tr>`;
    
    hqTotalCount += stats.count;
    hqTotalAmount += stats.amount;
    hqTotalAmountTax += stats.amountTax;
    
    hqConsultingCount += stats.consulting.count;
    hqConsultingAmount += stats.consulting.amount;
    hqConsultingAmountTax += stats.consulting.amountTax;
    
    hqDirectCount += stats.direct.count;
    hqDirectAmount += stats.direct.amount;
    hqDirectAmountTax += stats.direct.amountTax;
  });
  
  document.getElementById('hqManagerTableBody').innerHTML = hqHtml;
  document.getElementById('hqTotalCount').innerHTML = `<strong>${hqTotalCount}</strong>`;
  document.getElementById('hqTotalAmount').innerHTML = `<strong>${fmt(hqTotalAmount)}</strong>`;
  document.getElementById('hqTotalAmountTax').innerHTML = `<strong>${fmt(hqTotalAmountTax)}</strong>`;
  document.getElementById('hqConsultingCount').textContent = hqConsultingCount;
  document.getElementById('hqConsultingAmount').textContent = fmt(hqConsultingAmount);
  document.getElementById('hqConsultingAmountTax').textContent = fmt(hqConsultingAmountTax);
  document.getElementById('hqDirectCount').textContent = hqDirectCount;
  document.getElementById('hqDirectAmount').textContent = fmt(hqDirectAmount);
  document.getElementById('hqDirectAmountTax').textContent = fmt(hqDirectAmountTax);
  
  // ì™¸ì£¼ í…Œì´ë¸” ë Œë”ë§
  let extHtml = '';
  let extTotalCount = 0, extTotalAmount = 0, extTotalAmountTax = 0;
  
  const extSorted = Object.entries(extManagers).sort((a, b) => b[1].amountTax - a[1].amountTax);
  
  extSorted.forEach(([name, stats]) => {
    if (name === 'ê¸°íƒ€' && stats.count === 0) return;
    extHtml += `<tr>
      <td>ê³µì‚¬ê¸ˆì•¡ í•©ê³„ [ ${name} ]</td>
      <td style="text-align:center;">${stats.count}</td>
      <td>${fmt(stats.amount)}</td>
      <td>${fmt(stats.amountTax)}</td>
    </tr>`;
    
    extTotalCount += stats.count;
    extTotalAmount += stats.amount;
    extTotalAmountTax += stats.amountTax;
  });
  
  document.getElementById('extManagerTableBody').innerHTML = extHtml || '<tr><td colspan="4" style="text-align:center;color:var(--gray-400);">ë°ì´í„° ì—†ìŒ</td></tr>';
  document.getElementById('extTotalCount').innerHTML = `<strong>${extTotalCount}</strong>`;
  document.getElementById('extTotalAmount').innerHTML = `<strong>${fmt(extTotalAmount)}</strong>`;
  document.getElementById('extTotalAmountTax').innerHTML = `<strong>${fmt(extTotalAmountTax)}</strong>`;
  
  // ì „ì²´ í•©ê³„
  const grandTotalCount = hqTotalCount + extTotalCount;
  const grandTotalAmount = hqTotalAmount + extTotalAmount;
  const grandTotalAmountTax = hqTotalAmountTax + extTotalAmountTax;
  
  document.getElementById('grandTotalCount').innerHTML = `<strong>${grandTotalCount}ê±´</strong>`;
  document.getElementById('grandTotalAmount').innerHTML = `<strong>${fmt(grandTotalAmount)}</strong>`;
  document.getElementById('grandTotalAmountTax').innerHTML = `<strong>${fmt(grandTotalAmountTax)}</strong>`;
}

function toggleSelect(idx) { selectedItems.has(idx) ? selectedItems.delete(idx) : selectedItems.add(idx); renderTable(); updateDeleteButton(); }
function toggleSelectAll() { const d = allData[currentYear] || []; document.getElementById('selectAll').checked ? d.forEach((_, i) => selectedItems.add(i)) : selectedItems.clear(); renderTable(); updateDeleteButton(); }
function updateDeleteButton() { const btn = document.getElementById('deleteSelectedBtn'); btn.style.display = selectedItems.size > 0 ? 'inline-flex' : 'none'; document.getElementById('deleteCount').textContent = selectedItems.size; }

function openAddModal() { document.getElementById('modalTitle').textContent = 'ìƒˆ ê³µì‚¬ ì¶”ê°€'; document.getElementById('editIndex').value = ''; clearForm(); document.getElementById('editModal').classList.add('active'); }

function openEditModal(idx) {
  const item = (allData[currentYear] || [])[idx]; if (!item) return;
  document.getElementById('modalTitle').textContent = 'ê³µì‚¬ ì •ë³´ ìˆ˜ì •';
  document.getElementById('editIndex').value = idx;
  document.getElementById('editNo').value = item.no || '';
  document.getElementById('editRegion').value = item.region || '';
  document.getElementById('editType').value = item.type || '';
  document.getElementById('editSite').value = item.site || '';
  document.getElementById('editName').value = item.name || '';
  document.getElementById('editAmount').value = item.amount || '';
  document.getElementById('editAmountTax').value = item.amountTax || '';
  document.getElementById('editManager').value = item.manager || '';
  document.getElementById('editSiteManager').value = item.siteManager || '';
  document.getElementById('editContractDate').value = item.contractDate || '';
  document.getElementById('editStartDate').value = item.startDate || '';
  document.getElementById('editEndDate').value = item.endDate || '';
  document.getElementById('editContract1Amt').value = item.contract1?.amt || '';
  document.getElementById('editContract1Bill').value = item.contract1?.bill || '';
  document.getElementById('editContract1Paid').value = item.contract1?.paid || '';
  document.getElementById('editInterim1Amt').value = item.interim1?.amt || '';
  document.getElementById('editInterim1Bill').value = item.interim1?.bill || '';
  document.getElementById('editInterim1Paid').value = item.interim1?.paid || '';
  document.getElementById('editInterim2Amt').value = item.interim2?.amt || '';
  document.getElementById('editInterim2Bill').value = item.interim2?.bill || '';
  document.getElementById('editInterim2Paid').value = item.interim2?.paid || '';
  document.getElementById('editBalance1Amt').value = item.balance1?.amt || '';
  document.getElementById('editBalance1Bill').value = item.balance1?.bill || '';
  document.getElementById('editBalance1Paid').value = item.balance1?.paid || '';
  document.getElementById('editModal').classList.add('active');
}

function clearForm() { document.querySelectorAll('#editModal input, #editModal select').forEach(i => i.value = ''); }
function closeModal() { document.getElementById('editModal').classList.remove('active'); }
function updateTaxAmount() { document.getElementById('editAmountTax').value = Math.round(parseNum(document.getElementById('editAmount').value) * 1.1); }

function saveData() {
  const idx = document.getElementById('editIndex').value;
  const item = {
    no: document.getElementById('editNo').value, region: document.getElementById('editRegion').value,
    type: document.getElementById('editType').value, site: document.getElementById('editSite').value,
    name: document.getElementById('editName').value, amount: parseNum(document.getElementById('editAmount').value),
    amountTax: parseNum(document.getElementById('editAmountTax').value), manager: document.getElementById('editManager').value,
    siteManager: document.getElementById('editSiteManager').value, contractDate: document.getElementById('editContractDate').value,
    startDate: document.getElementById('editStartDate').value, endDate: document.getElementById('editEndDate').value,
    contract1: { amt: parseNum(document.getElementById('editContract1Amt').value), bill: document.getElementById('editContract1Bill').value, paid: document.getElementById('editContract1Paid').value },
    interim1: { amt: parseNum(document.getElementById('editInterim1Amt').value), bill: document.getElementById('editInterim1Bill').value, paid: document.getElementById('editInterim1Paid').value },
    interim2: { amt: parseNum(document.getElementById('editInterim2Amt').value), bill: document.getElementById('editInterim2Bill').value, paid: document.getElementById('editInterim2Paid').value },
    balance1: { amt: parseNum(document.getElementById('editBalance1Amt').value), bill: document.getElementById('editBalance1Bill').value, paid: document.getElementById('editBalance1Paid').value }
  };
  if (!allData[currentYear]) allData[currentYear] = [];
  if (idx === '') { allData[currentYear].push(item); showToast('ìƒˆ ê³µì‚¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success'); }
  else { allData[currentYear][parseInt(idx)] = item; showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success'); }
  saveToStorage(); renderTable(); updateStats(); closeModal();
}

function deleteSelected() { if (selectedItems.size === 0) return; deleteTarget = 'selected'; document.getElementById('deleteMessage').textContent = `ì„ íƒí•œ ${selectedItems.size}ê°œ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`; document.getElementById('deleteModal').classList.add('active'); }
function closeDeleteModal() { document.getElementById('deleteModal').classList.remove('active'); deleteTarget = null; }
function confirmDelete() {
  if (deleteTarget === 'selected') {
    Array.from(selectedItems).sort((a,b) => b-a).forEach(i => allData[currentYear].splice(i, 1));
    showToast(`${selectedItems.size}ê°œ í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'info');
    selectedItems.clear(); updateDeleteButton();
  }
  saveToStorage(); renderTable(); updateStats(); closeDeleteModal();
}

// ì—‘ì…€ì—ì„œ ë¹¨ê°„ìƒ‰(ë¯¸ì…ê¸ˆ) í‘œì‹œëœ ì…€ ì •ë³´ (ì „ì—­ ë³€ìˆ˜)
// ê¸ˆì•¡ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ë¯¸ì…ê¸ˆìœ¼ë¡œ ì²˜ë¦¬
// 2020-2021, 2022, 2023ë…„ë„ëŠ” ëª¨ë‘ ì…ê¸ˆì™„ë£Œ
const RED_CELL_INFO = {"2020-2021": {}, "2022": {}, "2023": {}, "2024": {"20": {"balance1": true}}, "2025": {"62": {"balance1": true}, "87": {"balance1": true}, "98": {"balance1": true}, "113": {"balance1": true}, "121": {"balance1": true}}};

// ê³„ì•½ í•´ì§€ëœ ê±´ (ê³µì‚¬í˜„ì¥ëª…ì— "í•´ì§€" í¬í•¨)
const CANCELLED_INFO = {
  "2022": ["85", "86"],
  "2023": ["5", "12"],
  "2024": ["58"]
};

// ì—‘ì…€ì— ì…ê¸ˆì¼ì´ ì—†ì§€ë§Œ ì‹¤ì œ ì…ê¸ˆì™„ë£Œëœ ê±´ (ìˆ˜ë™ ì²˜ë¦¬)
const MANUAL_PAID_INFO = {
  "2022": {"151": {"balance1": true}},  // ê²½ê¸°ë„êµìœ¡ì²­ - ì”ê¸ˆ ì…ê¸ˆì™„ë£Œ
  "2025": {
    "13": {"contract1": true},   // ì‚°ì²­ì‚¼í•œì‚¬ë‘ì±„ - ê³„ì•½ê¸ˆ+ë¶€ê°€ì„¸ ì…ê¸ˆì™„ë£Œ
    "27": {"interim1": true},    // ë™íƒ„ ëŠ¥ë™ë§ˆì„ - ì¤‘ë„ê¸ˆ1ì°¨,2ì°¨ ì…ê¸ˆì™„ë£Œ
    "39": {"balance1": true},    // ì—°í¬ë™ì„±ì›ì•„íŒŒíŠ¸ - ì”ê¸ˆ+ë¶€ê°€ì„¸ ì…ê¸ˆì™„ë£Œ
    "42": {"balance1": true},    // í–‰ì‹ ë²½ì‚°ì•„íŒŒíŠ¸ - ì”ê¸ˆ(ê¸ˆì•¡ì¡°ì •) ì…ê¸ˆì™„ë£Œ
    "57": {"balance1": true},    // ë„¤ì˜¤í”Œë¡œìŠ¤ì˜¤í”¼ìŠ¤í…” - ì”ê¸ˆ+ì¶”ê°€ ì…ê¸ˆì™„ë£Œ
    "60": {"contract1": true},   // ê¶Œì„ ìš°ë‚¨ì•„íŒŒíŠ¸ - ê³„ì•½ê¸ˆ+ë¶€ê°€ì„¸ ì…ê¸ˆì™„ë£Œ
    "87": {"interim1": true},    // ì•„ì‹œì•„ì„ ìˆ˜ì´Œì•„íŒŒíŠ¸ - ì¤‘ë„ê¸ˆ1ì°¨,2ì°¨ ì…ê¸ˆì™„ë£Œ
    "113": {"contract1": true},  // ëª©ë™ì¸ìš°ì•„íŒŒíŠ¸ - ê³„ì•½ê¸ˆ+ì¶”ê°€ ì…ê¸ˆì™„ë£Œ
    "119": {"contract1": true}   // ë™íƒ„ì—­ì‹œë²”í•œí™”ê¿ˆì—ê·¸ë¦°í”„ë ˆìŠ¤í‹°ì§€ì•„íŒŒíŠ¸ - ê³„ì•½ê¸ˆ ì…ê¸ˆì™„ë£Œ
  }
};

function saveToStorage() { localStorage.setItem('constructionData', JSON.stringify(allData)); }
function loadFromStorage() { 
  const s = localStorage.getItem('constructionData'); 
  if (s) { 
    try {
      allData = JSON.parse(s);
      // ë¹¨ê°„ìƒ‰ ì •ë³´ ì ìš©
      applyRedCellInfo();
      // í˜„ì¬ ë…„ë„ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
      if (allData[currentYear] && allData[currentYear].length > 0) {
        renderTable(); 
        updateStats();
      }
    } catch(e) {
      console.error('ë¡œì»¬ìŠ¤í† ë¦¬ì§€ íŒŒì‹± ì˜¤ë¥˜:', e);
      allData = {};
    }
  } 
}

function applyRedCellInfo() {
  // ì €ì¥ëœ ë°ì´í„°ì— ë¹¨ê°„ìƒ‰ ì •ë³´ ë° ìˆ˜ë™ ì…ê¸ˆì™„ë£Œ ì •ë³´ ì ìš©
  Object.keys(allData).forEach(yearKey => {
    const redInfo = RED_CELL_INFO[yearKey] || {};
    const manualPaidInfo = MANUAL_PAID_INFO[yearKey] || {};
    const data = allData[yearKey] || [];
    
    data.forEach(item => {
      const noKey = String(Math.floor(Number(item.no)));
      const redFlags = redInfo[noKey] || {};
      const paidFlags = manualPaidInfo[noKey] || {};
      
      if (item.contract1) {
        item.contract1.isRed = redFlags.contract1 || false;
        item.contract1.manualPaid = paidFlags.contract1 || false;
      }
      if (item.interim1) {
        item.interim1.isRed = redFlags.interim1 || false;
        item.interim1.manualPaid = paidFlags.interim1 || false;
      }
      if (item.balance1) {
        item.balance1.isRed = redFlags.balance1 || false;
        item.balance1.manualPaid = paidFlags.balance1 || false;
      }
      if (item.interim2) {
        item.interim2.isRed = redFlags.interim2 || false;
        item.interim2.manualPaid = paidFlags.interim2 || false;
      }
    });
  });
}

function clearStorage() {
  // ì €ì¥ëœ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ 1234)
  const savedPassword = localStorage.getItem('resetPassword') || '1234';
  
  // 1ì°¨: ë¹„ë°€ë²ˆí˜¸ í™•ì¸
  const password = prompt('âš ï¸ ì£¼ì˜: ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤!\n\nì´ˆê¸°í™” ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:\n(ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸: 1234, ğŸ”ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥)');
  
  if (password !== savedPassword) {
    if (password !== null) {
      showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
    }
    return;
  }
  
  // 2ì°¨: ìµœì¢… í™•ì¸
  if(confirm('âš ï¸ ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')) {
    // ëª¨ë“  ê´€ë ¨ ë°ì´í„° ì‚­ì œ (ë¹„ë°€ë²ˆí˜¸ëŠ” ìœ ì§€)
    localStorage.removeItem('constructionData');
    localStorage.removeItem('detailData');
    localStorage.removeItem('fieldSettlementByManager');
    
    allData = {};
    fieldSettlementByManager = {};
    
    renderTable();
    updateStats();
    showToast('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
  }
}

// ì´ˆê¸°í™” ë¹„ë°€ë²ˆí˜¸ ì„¤ì •/ë³€ê²½
function setResetPassword() {
  const savedPassword = localStorage.getItem('resetPassword') || '1234';
  
  // í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
  const currentPw = prompt('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:\n(ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸: 1234)');
  if (currentPw !== savedPassword) {
    if (currentPw !== null) {
      showToast('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
    }
    return;
  }
  
  // ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
  const newPw = prompt('ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (4ìë¦¬ ì´ìƒ):');
  if (!newPw || newPw.length < 4) {
    if (newPw !== null) {
      showToast('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
    }
    return;
  }
  
  // ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
  const confirmPw = prompt('ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”:');
  if (newPw !== confirmPw) {
    showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
    return;
  }
  
  localStorage.setItem('resetPassword', newPw);
  showToast('ì´ˆê¸°í™” ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
}

function exportToExcel() {
  const data = allData[currentYear] || [];
  if (data.length === 0) { showToast('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error'); return; }
  const exp = data.map(d => ({
    'NO': d.no, 'ì§€ì—­': d.region, 'ê³µì‚¬í˜„ì¥': d.site, 'ê³µì‚¬ëª…': d.name,
    'ê³„ì•½ê¸ˆì•¡(ë¶€ê°€ì„¸ë³„ë„)': d.amount, 'ê³„ì•½ê¸ˆì•¡(ë¶€ê°€ì„¸í¬í•¨)': d.amountTax,
    'ê³„ì•½ì¼': d.contractDate, 'ì°©ê³µì¼': d.startDate, 'ì¤€ê³µì¼': d.endDate,
    'ê³„ì•½ê¸ˆ_ê¸ˆì•¡': d.contract1?.amt, 'ê³„ì•½ê¸ˆ_ê³„ì‚°ì„œ': d.contract1?.bill, 'ê³„ì•½ê¸ˆ_ì…ê¸ˆì¼': d.contract1?.paid,
    'ì¤‘ë„ê¸ˆ_ê¸ˆì•¡': d.interim1?.amt, 'ì¤‘ë„ê¸ˆ_ê³„ì‚°ì„œ': d.interim1?.bill, 'ì¤‘ë„ê¸ˆ_ì…ê¸ˆì¼': d.interim1?.paid,
    'ì¤‘ë„ê¸ˆ2_ê¸ˆì•¡': d.interim2?.amt, 'ì¤‘ë„ê¸ˆ2_ê³„ì‚°ì„œ': d.interim2?.bill, 'ì¤‘ë„ê¸ˆ2_ì…ê¸ˆì¼': d.interim2?.paid,
    'ì”ê¸ˆ_ê¸ˆì•¡': d.balance1?.amt, 'ì”ê¸ˆ_ê³„ì‚°ì„œ': d.balance1?.bill, 'ì”ê¸ˆ_ì…ê¸ˆì¼': d.balance1?.paid,
    'ê³µì‚¬ìœ í˜•': d.type, 'ì˜ì—…ë‹´ë‹¹ì': d.manager, 'í˜„ì¥ì†Œì¥': d.siteManager
  }));
  const ws = XLSX.utils.json_to_sheet(exp);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, currentYear + 'ë…„');
  XLSX.writeFile(wb, `ê³µì‚¬í˜„í™©_${currentYear}_${new Date().toISOString().split('T')[0]}.xlsx`);
  showToast('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
}

function fmt(v) { if (v == null || isNaN(v) || v === 0) return '-'; return new Intl.NumberFormat('ko-KR').format(Math.round(v)); }
function fmtShort(v) { if (!v) return '0ì›'; const b = v/100000000; if (b >= 1) return b.toFixed(1)+'ì–µ'; const m = v/10000; if (m >= 1) return Math.round(m).toLocaleString()+'ë§Œì›'; return v.toLocaleString()+'ì›'; }
function fmtAmount(v) { 
  if (!v || v === 0) return '0ì›'; 
  const b = v/100000000; 
  if (b >= 1) {
    const remainder = (v % 100000000) / 10000;
    if (remainder >= 1) return b.toFixed(0) + 'ì–µ ' + Math.round(remainder).toLocaleString() + 'ë§Œì›';
    return b.toFixed(1) + 'ì–µì›';
  }
  const m = v/10000; 
  if (m >= 1) return Math.round(m).toLocaleString() + 'ë§Œì›'; 
  return v.toLocaleString() + 'ì›'; 
}
function showToast(msg, type) { const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast ' + type + ' show'; setTimeout(() => t.classList.remove('show'), 3000); }

// ê²€ìƒ‰ í•¨ìˆ˜ë“¤
function handleSearchKeyup(event) {
  if (event.key === 'Enter') {
    performSearch();
  }
}

function performSearch() {
  const keyword = document.getElementById('searchKeyword').value.trim().toLowerCase();
  const status = document.getElementById('searchStatus').value;
  const type = document.getElementById('searchType').value;
  
  searchFilter = { keyword, status, type };
  
  const data = allData[currentYear] || [];
  const cancelledList = CANCELLED_INFO[currentYear] || [];
  
  if (!keyword && !status && !type) {
    filteredData = null;
    document.getElementById('searchResult').innerHTML = '';
    renderTable();
    return;
  }
  
  filteredData = data.filter(item => {
    // í‚¤ì›Œë“œ ê²€ìƒ‰ (í˜„ì¥ëª…, ê³µì‚¬ëª…, ë‹´ë‹¹ì, í˜„ì¥ì†Œì¥)
    if (keyword) {
      const searchFields = [
        item.site || '',
        item.name || '',
        item.manager || '',
        item.siteManager || '',
        item.region || '',
        String(item.no || '')
      ].join(' ').toLowerCase();
      
      if (!searchFields.includes(keyword)) return false;
    }
    
    // ê³µì‚¬ìœ í˜• í•„í„°
    if (type && item.type !== type) return false;
    
    // ì…ê¸ˆìƒíƒœ í•„í„°
    if (status) {
      const noKey = String(Math.floor(Number(item.no)));
      const isCancelled = cancelledList.includes(noKey) || (item.site && item.site.includes('í•´ì§€'));
      const itemStatus = getItemStatus(item, isCancelled);
      
      if (status === 'cancelled' && !isCancelled) return false;
      if (status === 'completed' && itemStatus !== 'completed') return false;
      if (status === 'contract' && itemStatus !== 'contract') return false;
      if (status === 'interim' && itemStatus !== 'interim') return false;
      if (status === 'unpaid' && itemStatus !== 'unpaid') return false;
      if (status === 'progress' && itemStatus !== 'progress') return false;
    }
    
    return true;
  });
  
  // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
  const resultText = filteredData.length > 0 
    ? `<strong>${filteredData.length}</strong>ê±´ ê²€ìƒ‰ë¨ (ì „ì²´ ${data.length}ê±´)` 
    : 'ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ';
  document.getElementById('searchResult').innerHTML = resultText;
  
  renderTable();
}

function getItemStatus(item, isCancelled) {
  if (isCancelled) return 'cancelled';
  
  const isPaid = (p) => {
    if (!p) return false;
    if (p.isRed) return false;
    if (p.manualPaid) return true;
    return p.paid && p.paid !== '' && p.paid !== 'ë¯¸ì •';
  };
  
  const hasAmount = (p) => p?.amt && p.amt > 0;
  const hasBill = (p) => p?.bill && p.bill !== '';
  
  // ì”ê¸ˆê¹Œì§€ ì™„ë£Œ
  if (isPaid(item.balance1)) return 'completed';
  // ì¤‘ë„ê¸ˆê¹Œì§€ ì™„ë£Œ
  if (isPaid(item.interim1)) return 'interim';
  // ê³„ì•½ê¸ˆë§Œ ì™„ë£Œ
  if (isPaid(item.contract1)) return 'contract';
  // ê³„ì‚°ì„œ ë°œí–‰í–ˆëŠ”ë° ì…ê¸ˆ ì•ˆë¨
  if (hasBill(item.contract1) || hasBill(item.interim1) || hasBill(item.balance1)) return 'unpaid';
  // ê¸ˆì•¡ë§Œ ìˆê³  ì§„í–‰ì¤‘
  if (hasAmount(item.contract1) || hasAmount(item.interim1) || hasAmount(item.balance1)) return 'progress';
  
  return 'none';
}

function resetSearch() {
  document.getElementById('searchKeyword').value = '';
  document.getElementById('searchStatus').value = '';
  document.getElementById('searchType').value = '';
  searchFilter = { keyword: '', status: '', type: '' };
  filteredData = null;
  document.getElementById('searchResult').innerHTML = '';
  renderTable();
}

function highlightKeyword(text) {
  if (!text || !searchFilter.keyword) return text;
  const keyword = searchFilter.keyword;
  const regex = new RegExp(`(${keyword})`, 'gi');
  return text.replace(regex, '<mark style="background:yellow;padding:0 2px;">$1</mark>');
}

document.getElementById('editModal').addEventListener('click', e => { if (e.target.id === 'editModal') closeModal(); });
document.getElementById('deleteModal').addEventListener('click', e => { if (e.target.id === 'deleteModal') closeDeleteModal(); });
document.getElementById('detailModal').addEventListener('click', e => { if (e.target.id === 'detailModal') closeDetailModal(); });
document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeModal(); closeDeleteModal(); closeDetailModal(); } });

// í˜„ì¥ìƒì„¸ ë°ì´í„° ì €ì¥ì†Œ
let detailData = {};

function loadDetailData() {
  const saved = localStorage.getItem('constructionDetailData');
  if (saved) {
    try { detailData = JSON.parse(saved); } catch(e) { detailData = {}; }
  }
}

function saveDetailDataToStorage() {
  localStorage.setItem('constructionDetailData', JSON.stringify(detailData));
}

function openDetailModal(idx) {
  loadDetailData();
  const data = allData[currentYear] || [];
  const item = data[idx];
  if (!item) return;
  
  document.getElementById('detailIndex').value = idx;
  document.getElementById('detailModalTitle').textContent = `í˜„ì¥ ìƒì„¸ - ${item.site || ''}`;
  document.getElementById('detailSiteName').textContent = item.site || '-';
  document.getElementById('detailProjectName').textContent = item.name || '-';
  document.getElementById('detailContractAmt').textContent = fmt(item.amount) + 'ì›';
  document.getElementById('detailPeriod').textContent = `${item.startDate || '-'} ~ ${item.endDate || '-'}`;
  
  // ê¸°ì¡´ ì €ì¥ëœ ìƒì„¸ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
  const key = `${currentYear}_${item.no}`;
  const detail = detailData[key] || {};
  
  // ê³µì‚¬ ì •ë³´ ì±„ìš°ê¸°
  document.getElementById('detail_site_input').value = detail.siteInput || item.site || '';
  document.getElementById('detail_project_input').value = detail.projectInput || item.name || '';
  document.getElementById('detail_period_input').value = detail.periodInput || '';
  document.getElementById('detail_amount_input').value = detail.amountInput || item.amount || '';
  
  // ë‹´ë‹¹ì ì •ë³´
  document.getElementById('detail_site_manager').value = detail.siteManager || item.siteManager || '';
  // ì˜ì—…ë‹´ë‹¹ìëŠ” ê³µì‚¬í˜„í™©ì˜ ë‹´ë‹¹ì(item.manager)ë¥¼ ìš°ì„  ì‚¬ìš©
  document.getElementById('detail_hq_manager').value = item.manager || detail.hqManager || '';
  document.getElementById('detail_field_manager').value = detail.fieldManager || '';
  
  // ìˆ˜ê¸ˆë‚´ì—­ ì±„ìš°ê¸° (ë¹„ê³ ëŠ” ì €ì¥ëœ ê°’ë§Œ í‘œì‹œ, ì—†ìœ¼ë©´ ë¹ˆì¹¸ - placeholderë¡œ ê¸°ë³¸ê°’ í‘œì‹œë¨)
  document.getElementById('åcontract_date').value = detail.contractDate || item.contract1?.paid || '';
  document.getElementById('åcontract_amt').value = detail.contractAmt || item.contract1?.amt || '';
  document.getElementById('åcontract_note').value = detail.contractNote || '';
  
  document.getElementById('åinterim_date').value = detail.interimDate || item.interim1?.paid || '';
  document.getElementById('åinterim_amt').value = detail.interimAmt || item.interim1?.amt || '';
  document.getElementById('åinterim_note').value = detail.interimNote || '';
  
  // ì¤‘ë„ê¸ˆ2ì°¨
  document.getElementById('åinterim2_date').value = detail.interim2Date || item.interim2?.paid || '';
  document.getElementById('åinterim2_amt').value = detail.interim2Amt || item.interim2?.amt || '';
  document.getElementById('åinterim2_note').value = detail.interim2Note || '';
  
  document.getElementById('åbalance_date').value = detail.balanceDate || item.balance1?.paid || '';
  document.getElementById('åbalance_amt').value = detail.balanceAmt || item.balance1?.amt || '';
  document.getElementById('åbalance_note').value = detail.balanceNote || '';
  
  // ê¸°íƒ€ì…ê¸ˆ
  document.getElementById('åetc_date').value = detail.etcDate || detail.vatDate || '';
  document.getElementById('åetc_amt').value = detail.etcAmt || detail.vatAmt || '';
  document.getElementById('åetc_note').value = detail.etcNote || detail.vatNote || '';
  
  // ê¸°íƒ€ì…ê¸ˆ2
  document.getElementById('åetc2_date').value = detail.etc2Date || '';
  document.getElementById('åetc2_amt').value = detail.etc2Amt || '';
  document.getElementById('åetc2_note').value = detail.etc2Note || '';
  
  // ê¸ˆì•¡ì¡°ì •
  document.getElementById('åadjust_date').value = detail.adjustDate || '';
  document.getElementById('åadjust_amt').value = detail.adjustAmt || '';
  document.getElementById('åadjust_note').value = detail.adjustNote || '';
  
  // ë¹„ê³ 
  document.getElementById('detail_memo').value = detail.memo || '';
  
  // ì‚¬ì§„ ë¶ˆëŸ¬ì˜¤ê¸°
  detailPhotos = detail.photos || [];
  renderDetailPhotoPreview();
  
  // íˆ¬ì…ë‚´ì—­ í…Œì´ë¸” ì´ˆê¸°í™”
  resetDetailTables(detail);
  
  // ì •ì‚°ì„œ ì •ë³´
  document.getElementById('settlement_sales').value = detail.settlementSales || item.manager || '';
  document.getElementById('settlement_field').value = detail.settlementField || item.siteManager || '';
  
  // í•©ê³„ ê³„ì‚°
  updateDetailTotals();
  updateSettlementTotals();
  
  // ì²« ë²ˆì§¸ íƒ­ í™œì„±í™”
  document.querySelectorAll('.detail-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.detail-section').forEach(s => s.classList.remove('active'));
  document.querySelector('.detail-tab').classList.add('active');
  document.getElementById('detailSummary').classList.add('active');
  
  document.getElementById('detailModal').classList.add('active');
}

function closeDetailModal() {
  document.getElementById('detailModal').classList.remove('active');
}

// ========== í˜„ì¥ ìƒì„¸ ì‚¬ì§„ ì²¨ë¶€ ê¸°ëŠ¥ ==========
function handleDetailPhotoUpload(event) {
  const files = event.target.files;
  if (!files.length) return;
  
  Array.from(files).forEach(file => {
    if (!file.type.startsWith('image/')) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ (ìµœëŒ€ 800px)
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement('canvas');
        const maxSize = 800;
        let width = img.width;
        let height = img.height;
        
        if (width > maxSize || height > maxSize) {
          if (width > height) {
            height = (height / width) * maxSize;
            width = maxSize;
          } else {
            width = (width / height) * maxSize;
            height = maxSize;
          }
        }
        
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        const resizedBase64 = canvas.toDataURL('image/jpeg', 0.7);
        detailPhotos.push(resizedBase64);
        renderDetailPhotoPreview();
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
  
  event.target.value = '';
}

function renderDetailPhotoPreview() {
  const container = document.getElementById('detailPhotoPreview');
  container.innerHTML = '';
  
  if (!detailPhotos || detailPhotos.length === 0) {
    container.innerHTML = '<div style="color:#999;font-size:0.8rem;">ì²¨ë¶€ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  
  detailPhotos.forEach((photo, idx) => {
    const div = document.createElement('div');
    div.style.cssText = 'position:relative;display:inline-block;';
    div.innerHTML = `
      <img src="${photo}" style="width:100px;height:100px;object-fit:cover;border-radius:4px;border:1px solid #ddd;cursor:pointer;" onclick="viewDetailPhoto(${idx})">
      <button onclick="removeDetailPhoto(${idx})" style="position:absolute;top:-5px;right:-5px;width:20px;height:20px;border-radius:50%;background:#f44336;color:white;border:none;cursor:pointer;font-size:12px;line-height:1;">Ã—</button>
    `;
    container.appendChild(div);
  });
}

function removeDetailPhoto(idx) {
  detailPhotos.splice(idx, 1);
  renderDetailPhotoPreview();
}

function viewDetailPhoto(idx) {
  const photo = detailPhotos[idx];
  const win = window.open('', '_blank');
  win.document.write(`
    <html>
    <head><title>ì‚¬ì§„ ë³´ê¸°</title></head>
    <body style="margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;background:#000;">
      <img src="${photo}" style="max-width:100%;max-height:100vh;">
    </body>
    </html>
  `);
}

function switchDetailTab(tabName) {
  document.querySelectorAll('.detail-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.detail-section').forEach(s => s.classList.remove('active'));
  
  event.target.classList.add('active');
  document.getElementById(tabName === 'summary' ? 'detailSummary' : 'detailSettlement').classList.add('active');
}

function resetDetailTables(detail) {
  // íˆ¬ì…ë‚´ì—­ í…Œì´ë¸” (í†µí•©)
  const expenseBody = document.getElementById('expenseTableBody');
  expenseBody.innerHTML = '';
  const expenses = detail.expenses || [];
  if (expenses.length === 0) {
    addExpenseRow('ìì¬ë¹„');
  } else {
    expenses.forEach((e) => addExpenseRow(e.type, e));
  }
  
  // ì •ì‚°ì„œ í…Œì´ë¸”ë“¤
  const settlementWorkBody = document.getElementById('settlementWorkBody');
  settlementWorkBody.innerHTML = '';
  const works = detail.settlementWorks || [{}];
  works.forEach((w, i) => addSettlementWorkRow(w));
  
  const settlementMaterialBody = document.getElementById('settlementMaterialBody');
  settlementMaterialBody.innerHTML = '';
  const sMaterials = detail.settlementMaterials || [{}];
  sMaterials.forEach((m, i) => addSettlementMaterialRow(m));
  
  const settlementLaborBody = document.getElementById('settlementLaborBody');
  settlementLaborBody.innerHTML = '';
  const sLabors = detail.settlementLabors || [{}];
  sLabors.forEach((l, i) => addSettlementLaborRow(l));
  
  const settlementOtherBody = document.getElementById('settlementOtherBody');
  settlementOtherBody.innerHTML = '';
  const sOthers = detail.settlementOthers || [{}];
  sOthers.forEach((o, i) => addSettlementOtherRow(o));
}

// íˆ¬ì…ë‚´ì—­ í–‰ ì¶”ê°€ (í†µí•©)
function addExpenseRow(type = 'ìì¬ë¹„', data = {}) {
  const tbody = document.getElementById('expenseTableBody');
  const tr = document.createElement('tr');
  
  let bgColor = 'var(--primary-light)';
  if (type === 'ë…¸ë¬´ë¹„') bgColor = 'var(--warning-light)';
  else if (type === 'ê¸°íƒ€ê²½ë¹„') bgColor = 'var(--purple-light)';
  
  tr.innerHTML = `
    <td style="background:${bgColor};font-weight:500;">
      <select onchange="this.parentElement.style.background = this.value==='ìì¬ë¹„'?'var(--primary-light)':this.value==='ë…¸ë¬´ë¹„'?'var(--warning-light)':'var(--purple-light)'">
        <option value="ìì¬ë¹„" ${type === 'ìì¬ë¹„' ? 'selected' : ''}>ìì¬ë¹„</option>
        <option value="ë…¸ë¬´ë¹„" ${type === 'ë…¸ë¬´ë¹„' ? 'selected' : ''}>ë…¸ë¬´ë¹„</option>
        <option value="ê¸°íƒ€ê²½ë¹„" ${type === 'ê¸°íƒ€ê²½ë¹„' ? 'selected' : ''}>ê¸°íƒ€ê²½ë¹„</option>
      </select>
    </td>
    <td><input type="date" value="${data.date || ''}" style="width:100%;"></td>
    <td><input type="text" value="${data.amount || ''}" oninput="this.value=this.value.replace(/[^0-9-]/g,'')" onchange="updateDetailTotals()" style="width:100%;text-align:right;" placeholder="ê¸ˆì•¡"></td>
    <td><input type="text" value="${data.content || ''}" placeholder="ë‚´ìš© ì…ë ¥" style="width:100%;"></td>
    <td><input type="date" value="${data.payDate || ''}" style="width:100%;"></td>
    <td><button class="btn btn-sm" style="background:var(--danger-light);color:var(--danger);border:none;padding:0.25rem 0.5rem;" onclick="this.closest('tr').remove();updateDetailTotals();">Ã—</button></td>
  `;
  tbody.appendChild(tr);
  updateDetailTotals();
}

function addSettlementWorkRow(data = {}) {
  const tbody = document.getElementById('settlementWorkBody');
  const tr = document.createElement('tr');
  tr.innerHTML = `<td><input type="text" value="${data.type || ''}" placeholder="ì‹±ê¸€ë³´ìˆ˜"></td>
    <td><input type="text" value="${data.content || ''}"></td>
    <td><input type="number" value="${data.sales || ''}" onchange="updateSettlementTotals()"></td>
    <td><input type="number" value="${data.purchase || ''}" onchange="updateSettlementTotals()"></td>
    <td><input type="text" value="${data.note || ''}"></td>`;
  tbody.appendChild(tr);
}

function addSettlementMaterialRow(data = {}) {
  const tbody = document.getElementById('settlementMaterialBody');
  const tr = document.createElement('tr');
  tr.innerHTML = `<td><input type="text" value="${data.content || ''}"></td>
    <td><input type="number" value="${data.purchase || ''}" onchange="updateSettlementTotals()"></td>
    <td><input type="text" value="${data.note || ''}"></td>`;
  tbody.appendChild(tr);
}

function addSettlementLaborRow(data = {}) {
  const tbody = document.getElementById('settlementLaborBody');
  const tr = document.createElement('tr');
  tr.innerHTML = `<td><input type="text" value="${data.content || ''}"></td>
    <td><input type="number" value="${data.purchase || ''}" onchange="updateSettlementTotals()"></td>
    <td><input type="text" value="${data.note || ''}"></td>`;
  tbody.appendChild(tr);
}

function addSettlementOtherRow(data = {}) {
  const tbody = document.getElementById('settlementOtherBody');
  const tr = document.createElement('tr');
  tr.innerHTML = `<td><input type="text" value="${data.content || ''}"></td>
    <td><input type="number" value="${data.purchase || ''}" onchange="updateSettlementTotals()"></td>
    <td><input type="text" value="${data.note || ''}"></td>`;
  tbody.appendChild(tr);
}

function updateDetailTotals() {
  // ìˆ˜ê¸ˆ í•©ê³„
  const contractAmt = parseFloat(document.getElementById('åcontract_amt').value) || 0;
  const interimAmt = parseFloat(document.getElementById('åinterim_amt').value) || 0;
  const interim2Amt = parseFloat(document.getElementById('åinterim2_amt').value) || 0;
  const balanceAmt = parseFloat(document.getElementById('åbalance_amt').value) || 0;
  const etcAmt = parseFloat(document.getElementById('åetc_amt').value) || 0;
  const etc2Amt = parseFloat(document.getElementById('åetc2_amt').value) || 0;
  const adjustAmt = parseFloat(document.getElementById('åadjust_amt').value) || 0;  // ê¸ˆì•¡ì¡°ì • (Â±)
  
  // ëª¨ë“  ìˆ˜ê¸ˆë‚´ì—­ í•©ì‚° (ê¸ˆì•¡ì¡°ì •ì€ +/- ëª¨ë‘ ê°€ëŠ¥)
  const totalReceived = contractAmt + interimAmt + interim2Amt + balanceAmt + etcAmt + etc2Amt + adjustAmt;
  
  // ê¸ˆì•¡ì¡°ì •ì´ ìˆìœ¼ë©´ í‘œì‹œ
  let adjustDisplay = '';
  if (adjustAmt !== 0) {
    const sign = adjustAmt > 0 ? '+' : '';
    adjustDisplay = ` <span style="color:${adjustAmt > 0 ? 'var(--success)' : 'var(--danger)'};">(${sign}${fmt(adjustAmt)})</span>`;
  }
  document.getElementById('åtotal').innerHTML = fmt(totalReceived) + adjustDisplay;
  
  // íˆ¬ì…ë‚´ì—­ í•©ê³„ (êµ¬ë¶„ë³„ë¡œ ê³„ì‚°)
  let materialTotal = 0, laborTotal = 0, otherTotal = 0;
  
  document.querySelectorAll('#expenseTableBody tr').forEach(tr => {
    const typeSelect = tr.querySelector('td:nth-child(1) select');
    const amountInput = tr.querySelector('td:nth-child(3) input');
    const type = typeSelect?.value || 'ìì¬ë¹„';
    const amount = parseFloat(amountInput?.value) || 0;
    
    if (type === 'ìì¬ë¹„') materialTotal += amount;
    else if (type === 'ë…¸ë¬´ë¹„') laborTotal += amount;
    else if (type === 'ê¸°íƒ€ê²½ë¹„') otherTotal += amount;
  });
  
  const expenseTotal = materialTotal + laborTotal + otherTotal;
  document.getElementById('expenseTotal').textContent = fmt(expenseTotal);
  
  // ê³„ì•½ê¸ˆì•¡ ê°€ì ¸ì˜¤ê¸°
  const contractAmount = parseFloat(document.getElementById('detail_amount_input').value) || 0;
  
  // ìš”ì•½ ì—…ë°ì´íŠ¸
  document.getElementById('summaryContract').textContent = fmt(contractAmount);
  document.getElementById('summaryMaterial').textContent = fmt(materialTotal);
  document.getElementById('summaryLabor').textContent = fmt(laborTotal);
  document.getElementById('summaryOther').textContent = fmt(otherTotal);
  document.getElementById('summaryExpense').textContent = fmt(expenseTotal);
  
  const balance = contractAmount - expenseTotal;
  document.getElementById('summaryBalance').textContent = fmt(balance);
  document.getElementById('summaryBalance').style.color = balance >= 0 ? 'var(--success)' : 'var(--danger)';
  
  // ê¸ˆì•¡ì¡°ì •ì´ ìˆìœ¼ë©´ ì •ì‚°ê¸ˆì•¡ í–‰ í‘œì‹œ
  const adjustmentRow = document.getElementById('adjustmentRow');
  if (adjustAmt !== 0) {
    adjustmentRow.style.display = 'block';
    const adjustedAmount = contractAmount + adjustAmt;  // ì¡°ì • í›„ ê¸ˆì•¡
    const adjustedBalance = adjustedAmount - expenseTotal;  // ì¡°ì • í›„ ì”ì•¡
    
    document.getElementById('summaryAdjustedAmount').textContent = fmt(adjustedAmount);
    document.getElementById('summaryAdjustedBalance').textContent = fmt(adjustedBalance);
    document.getElementById('summaryAdjustedBalance').style.color = adjustedBalance >= 0 ? 'var(--success)' : 'var(--danger)';
  } else {
    adjustmentRow.style.display = 'none';
  }
}

function updateSettlementTotals() {
  // ê³µì‚¬ ë‚´ì—­
  let workSalesTotal = 0, workPurchaseTotal = 0;
  document.querySelectorAll('#settlementWorkBody tr').forEach(tr => {
    const salesInput = tr.querySelector('td:nth-child(3) input');
    const purchaseInput = tr.querySelector('td:nth-child(4) input');
    if (salesInput) workSalesTotal += parseFloat(salesInput.value) || 0;
    if (purchaseInput) workPurchaseTotal += parseFloat(purchaseInput.value) || 0;
  });
  document.getElementById('workSalesTotal').textContent = fmt(workSalesTotal);
  document.getElementById('workPurchaseTotal').textContent = fmt(workPurchaseTotal);
  
  // ìì¬ë¹„
  let materialPurchaseTotal = 0;
  document.querySelectorAll('#settlementMaterialBody tr').forEach(tr => {
    const input = tr.querySelector('td:nth-child(2) input');
    if (input) materialPurchaseTotal += parseFloat(input.value) || 0;
  });
  document.getElementById('materialPurchaseTotal').textContent = fmt(materialPurchaseTotal);
  
  // ë…¸ë¬´ë¹„
  let laborPurchaseTotal = 0;
  document.querySelectorAll('#settlementLaborBody tr').forEach(tr => {
    const input = tr.querySelector('td:nth-child(2) input');
    if (input) laborPurchaseTotal += parseFloat(input.value) || 0;
  });
  document.getElementById('laborPurchaseTotal').textContent = fmt(laborPurchaseTotal);
  
  // ê¸°íƒ€ê²½ë¹„
  let otherPurchaseTotal = 0;
  document.querySelectorAll('#settlementOtherBody tr').forEach(tr => {
    const input = tr.querySelector('td:nth-child(2) input');
    if (input) otherPurchaseTotal += parseFloat(input.value) || 0;
  });
  document.getElementById('otherPurchaseTotal').textContent = fmt(otherPurchaseTotal);
  
  // í•©ê³„
  const totalSales = workSalesTotal;
  const totalPurchase = workPurchaseTotal + materialPurchaseTotal + laborPurchaseTotal + otherPurchaseTotal;
  const profit = totalSales - totalPurchase;
  const profitRate = totalSales > 0 ? (profit / totalSales * 100).toFixed(1) : 0;
  
  document.getElementById('totalSales').textContent = fmt(totalSales);
  document.getElementById('totalPurchase').textContent = fmt(totalPurchase);
  document.getElementById('totalProfit').textContent = fmt(profit);
  document.getElementById('totalProfit').style.color = profit >= 0 ? 'var(--success)' : 'var(--danger)';
  document.getElementById('profitRate').textContent = profitRate + '%';
  document.getElementById('profitRate').style.color = profit >= 0 ? 'var(--success)' : 'var(--danger)';
}

function saveDetailData() {
  const idx = document.getElementById('detailIndex').value;
  const data = allData[currentYear] || [];
  const item = data[idx];
  if (!item) return;
  
  const key = `${currentYear}_${item.no}`;
  
  // íˆ¬ì…ë‚´ì—­ ìˆ˜ì§‘ (í†µí•©)
  const expenses = [];
  document.querySelectorAll('#expenseTableBody tr').forEach(tr => {
    const typeSelect = tr.querySelector('td:nth-child(1) select');
    const inputs = tr.querySelectorAll('input');
    expenses.push({
      type: typeSelect?.value || 'ìì¬ë¹„',
      date: inputs[0]?.value || '',
      amount: inputs[1]?.value || '',
      content: inputs[2]?.value || '',
      payDate: inputs[3]?.value || ''
    });
  });
  
  // ì •ì‚°ì„œ ë°ì´í„° ìˆ˜ì§‘
  const settlementWorks = [];
  document.querySelectorAll('#settlementWorkBody tr').forEach(tr => {
    const inputs = tr.querySelectorAll('input');
    settlementWorks.push({
      type: inputs[0]?.value || '',
      content: inputs[1]?.value || '',
      sales: inputs[2]?.value || '',
      purchase: inputs[3]?.value || '',
      note: inputs[4]?.value || ''
    });
  });
  
  const settlementMaterials = [];
  document.querySelectorAll('#settlementMaterialBody tr').forEach(tr => {
    const inputs = tr.querySelectorAll('input');
    settlementMaterials.push({
      content: inputs[0]?.value || '',
      purchase: inputs[1]?.value || '',
      note: inputs[2]?.value || ''
    });
  });
  
  const settlementLabors = [];
  document.querySelectorAll('#settlementLaborBody tr').forEach(tr => {
    const inputs = tr.querySelectorAll('input');
    settlementLabors.push({
      content: inputs[0]?.value || '',
      purchase: inputs[1]?.value || '',
      note: inputs[2]?.value || ''
    });
  });
  
  const settlementOthers = [];
  document.querySelectorAll('#settlementOtherBody tr').forEach(tr => {
    const inputs = tr.querySelectorAll('input');
    settlementOthers.push({
      content: inputs[0]?.value || '',
      purchase: inputs[1]?.value || '',
      note: inputs[2]?.value || ''
    });
  });
  
  detailData[key] = {
    // ê³µì‚¬ ì •ë³´
    siteInput: document.getElementById('detail_site_input').value,
    projectInput: document.getElementById('detail_project_input').value,
    periodInput: document.getElementById('detail_period_input').value,
    amountInput: document.getElementById('detail_amount_input').value,
    
    // ë‹´ë‹¹ì ì •ë³´
    siteManager: document.getElementById('detail_site_manager').value,
    hqManager: document.getElementById('detail_hq_manager').value,
    fieldManager: document.getElementById('detail_field_manager').value,
    
    // ìˆ˜ê¸ˆë‚´ì—­
    contractDate: document.getElementById('åcontract_date').value,
    contractAmt: document.getElementById('åcontract_amt').value,
    contractNote: document.getElementById('åcontract_note').value,
    interimDate: document.getElementById('åinterim_date').value,
    interimAmt: document.getElementById('åinterim_amt').value,
    interimNote: document.getElementById('åinterim_note').value,
    interim2Date: document.getElementById('åinterim2_date').value,
    interim2Amt: document.getElementById('åinterim2_amt').value,
    interim2Note: document.getElementById('åinterim2_note').value,
    balanceDate: document.getElementById('åbalance_date').value,
    balanceAmt: document.getElementById('åbalance_amt').value,
    balanceNote: document.getElementById('åbalance_note').value,
    etcDate: document.getElementById('åetc_date').value,
    etcAmt: document.getElementById('åetc_amt').value,
    etcNote: document.getElementById('åetc_note').value,
    etc2Date: document.getElementById('åetc2_date').value,
    etc2Amt: document.getElementById('åetc2_amt').value,
    etc2Note: document.getElementById('åetc2_note').value,
    adjustDate: document.getElementById('åadjust_date').value,
    adjustAmt: document.getElementById('åadjust_amt').value,
    adjustNote: document.getElementById('åadjust_note').value,
    
    // ë¹„ê³ 
    memo: document.getElementById('detail_memo').value,
    
    // ì‚¬ì§„
    photos: detailPhotos || [],
    
    // íˆ¬ì…ë‚´ì—­
    expenses: expenses,
    
    // ì •ì‚°ì„œ
    settlementSales: document.getElementById('settlement_sales').value,
    settlementField: document.getElementById('settlement_field').value,
    settlementWorks: settlementWorks,
    settlementMaterials: settlementMaterials,
    settlementLabors: settlementLabors,
    settlementOthers: settlementOthers
  };
  
  // allDataì—ë„ ì£¼ìš” ì •ë³´ ë™ê¸°í™” (ê³µì‚¬í˜„í™© ëª©ë¡ì— ë°˜ì˜)
  const siteManagerValue = document.getElementById('detail_site_manager').value;
  const fieldManagerValue = document.getElementById('detail_field_manager').value;
  const hqManagerValue = document.getElementById('detail_hq_manager').value;
  
  if (siteManagerValue) item.siteManager = siteManagerValue;
  if (fieldManagerValue) item.fieldManager = fieldManagerValue;
  // ì˜ì—…ë‹´ë‹¹ì ì–‘ë°©í–¥ ë™ê¸°í™” (í˜„ì¥ ìƒì„¸ì—ì„œ ë³€ê²½í•˜ë©´ ëª©ë¡ì—ë„ ë°˜ì˜)
  if (hqManagerValue) item.manager = hqManagerValue;
  
  // allData ì €ì¥
  saveToStorage();
  
  saveDetailDataToStorage();
  showToast('ìƒì„¸ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
  
  // í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
  renderTable();
}

// í˜„ì¥ì†Œì¥ì—ê²Œ ì •ì‚°ì„œ ì†¡ë¶€
function sendToSiteManager() {
  const idx = document.getElementById('detailIndex').value;
  const data = allData[currentYear] || [];
  const item = data[idx];
  if (!item) return;
  
  const siteManager = document.getElementById('settlement_field').value || item.siteManager || '';
  const siteName = item.site || '';
  const projectName = item.name || '';
  
  // ì •ì‚°ì„œ ë‚´ìš© ìƒì„±
  const totalSales = document.getElementById('totalSales').textContent;
  const totalPurchase = document.getElementById('totalPurchase').textContent;
  const totalProfit = document.getElementById('totalProfit').textContent;
  const profitRate = document.getElementById('profitRate').textContent;
  
  const subject = `[ì •ì‚°ì„œ] ${siteName} - ${projectName}`;
  const body = `ì•ˆë…•í•˜ì„¸ìš”, ${siteManager} ì†Œì¥ë‹˜.

${siteName} í˜„ì¥ì˜ ì •ì‚°ì„œë¥¼ ì†¡ë¶€ë“œë¦½ë‹ˆë‹¤.

â–  í˜„ì¥ëª…: ${siteName}
â–  ê³µì‚¬ëª…: ${projectName}
â–  ê³„ì•½ê¸ˆì•¡: ${document.getElementById('detailContractAmt').textContent}

â–  ì •ì‚° ë‚´ì—­
  - ì´ ë§¤ì¶œì•¡: ${totalSales}
  - ì´ ë§¤ì…ì•¡: ${totalPurchase}
  - ì†ìµ: ${totalProfit}
  - ì†ìµë¥ : ${profitRate}

ìì„¸í•œ ë‚´ìš©ì€ ì²¨ë¶€ëœ ì •ì‚°ì„œë¥¼ í™•ì¸í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.

ê°ì‚¬í•©ë‹ˆë‹¤.
ãˆœì„ë¯¼ì´ì•¤ì”¨`;

  // ì´ë©”ì¼ í´ë¼ì´ì–¸íŠ¸ ì—´ê¸°
  const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.open(mailtoLink);
  
  showToast('ì´ë©”ì¼ ì‘ì„± ì°½ì´ ì—´ë ¸ìŠµë‹ˆë‹¤.', 'info');
}

// ì •ì‚°ì„œ ì¸ì‡„
function printSettlement() {
  const idx = document.getElementById('detailIndex').value;
  const data = allData[currentYear] || [];
  const item = data[idx];
  if (!item) return;
  
  const siteName = document.getElementById('detail_site_input').value || item.site || '';
  const projectName = document.getElementById('detail_project_input').value || item.name || '';
  const periodInput = document.getElementById('detail_period_input').value || '';
  const contractAmt = document.getElementById('detail_amount_input').value || item.amount || 0;
  // ë³¸ì‚¬ë‹´ë‹¹(ì´ê´„í‘œ)ì„ ìš°ì„ ìœ¼ë¡œ ì‚¬ìš©
  const salesPerson = document.getElementById('detail_hq_manager').value || document.getElementById('settlement_sales').value || item.manager || '';
  const fieldPerson = document.getElementById('settlement_field').value;
  const siteManager = document.getElementById('detail_site_manager').value;
  const hqManager = document.getElementById('detail_hq_manager').value;
  
  // ìˆ˜ê¸ˆë‚´ì—­ ìˆ˜ì§‘ (ë¹„ê³  í¬í•¨)
  const contractDate = document.getElementById('åcontract_date').value;
  const contractPayAmt = document.getElementById('åcontract_amt').value;
  const contractNote = document.getElementById('åcontract_note').value || '';
  const interimDate = document.getElementById('åinterim_date').value;
  const interimPayAmt = document.getElementById('åinterim_amt').value;
  const interimNote = document.getElementById('åinterim_note').value || '';
  const interim2Date = document.getElementById('åinterim2_date').value;
  const interim2PayAmt = document.getElementById('åinterim2_amt').value;
  const interim2Note = document.getElementById('åinterim2_note').value || '';
  const balanceDate = document.getElementById('åbalance_date').value;
  const balancePayAmt = document.getElementById('åbalance_amt').value;
  const balanceNote = document.getElementById('åbalance_note').value || '';
  const etcDate = document.getElementById('åetc_date').value;
  const etcPayAmt = document.getElementById('åetc_amt').value;
  const etcNote = document.getElementById('åetc_note').value || '';
  const etc2Date = document.getElementById('åetc2_date').value;
  const etc2PayAmt = document.getElementById('åetc2_amt').value;
  const etc2Note = document.getElementById('åetc2_note').value || '';
  const adjustDate = document.getElementById('åadjust_date').value;
  const adjustPayAmt = document.getElementById('åadjust_amt').value;
  const adjustNote = document.getElementById('åadjust_note').value || '';
  
  // íˆ¬ì…ë‚´ì—­ ì„¸ë¶€ ìˆ˜ì§‘ (ì´ê´„í‘œì—ì„œ)
  let materialItems = [], laborItems = [], otherItems = [];
  let materialTotal = 0, laborTotal = 0, otherTotal = 0;
  
  document.querySelectorAll('#expenseTableBody tr').forEach(tr => {
    const typeSelect = tr.querySelector('td:nth-child(1) select');
    const inputs = tr.querySelectorAll('input');
    const type = typeSelect?.value || 'ìì¬ë¹„';
    const date = inputs[0]?.value || '';
    const amount = parseFloat(inputs[1]?.value) || 0;
    const content = inputs[2]?.value || '';
    const payDate = inputs[3]?.value || '';
    
    if (amount > 0 || content) {
      const itemData = { date, amount, content, payDate };
      if (type === 'ìì¬ë¹„') { materialItems.push(itemData); materialTotal += amount; }
      else if (type === 'ë…¸ë¬´ë¹„') { laborItems.push(itemData); laborTotal += amount; }
      else if (type === 'ê¸°íƒ€ê²½ë¹„') { otherItems.push(itemData); otherTotal += amount; }
    }
  });
  
  const expenseTotal = materialTotal + laborTotal + otherTotal;
  const balance = parseFloat(contractAmt) - expenseTotal;
  
  // ìì¬ë¹„ ì„¸ë¶€ í–‰ ìƒì„±
  let materialRows = '';
  if (materialItems.length > 0) {
    materialItems.forEach((item, i) => {
      materialRows += `<tr>
        <td class="text-center">${i === 0 ? 'ìì¬ë¹„' : ''}</td>
        <td class="text-center">${item.date ? formatDate(item.date) : '-'}</td>
        <td>${item.content || '-'}</td>
        <td class="text-right">${fmt(item.amount)}</td>
        <td class="text-center">${item.payDate ? formatDate(item.payDate) : '-'}</td>
      </tr>`;
    });
    materialRows += `<tr class="subtotal"><td colspan="3" class="text-right"><strong>ìì¬ë¹„ ì†Œê³„</strong></td><td class="text-right"><strong>${fmt(materialTotal)}</strong></td><td></td></tr>`;
  }
  
  // ë…¸ë¬´ë¹„ ì„¸ë¶€ í–‰ ìƒì„±
  let laborRows = '';
  if (laborItems.length > 0) {
    laborItems.forEach((item, i) => {
      laborRows += `<tr>
        <td class="text-center">${i === 0 ? 'ë…¸ë¬´ë¹„' : ''}</td>
        <td class="text-center">${item.date ? formatDate(item.date) : '-'}</td>
        <td>${item.content || '-'}</td>
        <td class="text-right">${fmt(item.amount)}</td>
        <td class="text-center">${item.payDate ? formatDate(item.payDate) : '-'}</td>
      </tr>`;
    });
    laborRows += `<tr class="subtotal"><td colspan="3" class="text-right"><strong>ë…¸ë¬´ë¹„ ì†Œê³„</strong></td><td class="text-right"><strong>${fmt(laborTotal)}</strong></td><td></td></tr>`;
  }
  
  // ê¸°íƒ€ê²½ë¹„ ì„¸ë¶€ í–‰ ìƒì„±
  let otherRows = '';
  if (otherItems.length > 0) {
    otherItems.forEach((item, i) => {
      otherRows += `<tr>
        <td class="text-center">${i === 0 ? 'ê¸°íƒ€ê²½ë¹„' : ''}</td>
        <td class="text-center">${item.date ? formatDate(item.date) : '-'}</td>
        <td>${item.content || '-'}</td>
        <td class="text-right">${fmt(item.amount)}</td>
        <td class="text-center">${item.payDate ? formatDate(item.payDate) : '-'}</td>
      </tr>`;
    });
    otherRows += `<tr class="subtotal"><td colspan="3" class="text-right"><strong>ê¸°íƒ€ê²½ë¹„ ì†Œê³„</strong></td><td class="text-right"><strong>${fmt(otherTotal)}</strong></td><td></td></tr>`;
  }
  
  const printContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>ì •ì‚°ì„œ - ${siteName}</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', 'Malgun Gothic', sans-serif; padding: 30px; font-size: 11px; line-height: 1.4; }
        h1 { text-align: center; font-size: 22px; margin-bottom: 25px; border-bottom: 2px solid #333; padding-bottom: 10px; }
        
        .header-section { display: flex; justify-content: space-between; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; }
        .header-left, .header-right { }
        .header-left div, .header-right div { margin-bottom: 5px; }
        .header-right { text-align: right; }
        .label { color: #666; font-size: 10px; }
        .value { font-weight: 600; }
        
        .section-title { font-size: 13px; font-weight: 700; margin: 20px 0 10px; padding: 8px 12px; background: #e3f2fd; border-left: 4px solid #1976d2; }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; font-size: 10px; }
        th { background: #f5f5f5; font-weight: 600; text-align: center; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        
        .subtotal { background: #fff3e0; }
        .total-row { background: #e8f5e9; font-weight: 700; }
        .grand-total { background: #1976d2; color: white; font-weight: 700; font-size: 12px; }
        
        .summary-box { margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 5px; }
        .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; text-align: center; }
        .summary-item .label { font-size: 10px; color: #666; margin-bottom: 3px; }
        .summary-item .value { font-size: 16px; font-weight: 700; }
        .profit-positive { color: #2e7d32; }
        .profit-negative { color: #c62828; }
        
        .footer { margin-top: 30px; text-align: center; font-size: 10px; color: #999; border-top: 1px solid #ddd; padding-top: 15px; }
        
        @media print { 
          body { margin: 0; padding: 20px; } 
          .no-print { display: none; }
        }
      </style>
    </head>
    <body>
      <h1>ê³µì‚¬ ì •ì‚°ì„œ</h1>
      
      <div class="header-section">
        <div class="header-left">
          <div><span class="label">ê³µì‚¬í˜„ì¥:</span> <span class="value">${siteName}</span></div>
          <div><span class="label">ê³µì‚¬ëª…:</span> <span class="value">${projectName}</span></div>
          <div><span class="label">ê³µì‚¬ê¸°ê°„:</span> <span class="value">${periodInput || '-'}</span></div>
          <div><span class="label">ê³„ì•½ê¸ˆì•¡:</span> <span class="value" style="color:#1976d2;">${fmt(contractAmt)}ì›</span></div>
        </div>
        <div class="header-right">
          <div><span class="label">ì˜ì—…ë‹´ë‹¹ì:</span> <span class="value">${salesPerson || hqManager || '-'}</span></div>
          <div><span class="label">í˜„ì¥ì†Œì¥:</span> <span class="value">${fieldPerson || siteManager || '-'}</span></div>
          <div><span class="label">ì‘ì„±ì¼:</span> <span class="value">${new Date().toLocaleDateString('ko-KR')}</span></div>
        </div>
      </div>
      
      <!-- ìˆ˜ê¸ˆë‚´ì—­ -->
      <div class="section-title">ğŸ“¥ ìˆ˜ê¸ˆë‚´ì—­</div>
      <table>
        <thead>
          <tr>
            <th style="width:80px;">êµ¬ë¶„</th>
            <th style="width:100px;">ì¼ì</th>
            <th>ê¸ˆì•¡</th>
            <th>ë¹„ê³ </th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="text-center">ê³„ì•½ê¸ˆ</td>
            <td class="text-center">${contractDate ? formatDate(contractDate) : '-'}</td>
            <td class="text-right">${fmt(contractPayAmt)}</td>
            <td>${contractNote}</td>
          </tr>
          ${(parseFloat(interimPayAmt) || interimDate) ? `<tr>
            <td class="text-center">ì¤‘ë„ê¸ˆ</td>
            <td class="text-center">${interimDate ? formatDate(interimDate) : '-'}</td>
            <td class="text-right">${fmt(interimPayAmt)}</td>
            <td>${interimNote}</td>
          </tr>` : ''}
          ${(parseFloat(interim2PayAmt) || interim2Date) ? `<tr>
            <td class="text-center">ì¤‘ë„ê¸ˆ2ì°¨</td>
            <td class="text-center">${interim2Date ? formatDate(interim2Date) : '-'}</td>
            <td class="text-right">${fmt(interim2PayAmt)}</td>
            <td>${interim2Note}</td>
          </tr>` : ''}
          <tr>
            <td class="text-center">ì”ê¸ˆ</td>
            <td class="text-center">${balanceDate ? formatDate(balanceDate) : '-'}</td>
            <td class="text-right">${fmt(balancePayAmt)}</td>
            <td>${balanceNote}</td>
          </tr>
          ${(parseFloat(etcPayAmt) || etcDate) ? `<tr>
            <td class="text-center">ê¸°íƒ€ì…ê¸ˆ</td>
            <td class="text-center">${etcDate ? formatDate(etcDate) : '-'}</td>
            <td class="text-right">${fmt(etcPayAmt)}</td>
            <td>${etcNote}</td>
          </tr>` : ''}
          ${(parseFloat(etc2PayAmt) || etc2Date) ? `<tr>
            <td class="text-center">ê¸°íƒ€ì…ê¸ˆ2</td>
            <td class="text-center">${etc2Date ? formatDate(etc2Date) : '-'}</td>
            <td class="text-right">${fmt(etc2PayAmt)}</td>
            <td>${etc2Note}</td>
          </tr>` : ''}
          ${(parseFloat(adjustPayAmt) || adjustDate) ? `<tr>
            <td class="text-center">ê¸ˆì•¡ì¡°ì •</td>
            <td class="text-center">${adjustDate ? formatDate(adjustDate) : '-'}</td>
            <td class="text-right">${fmt(adjustPayAmt)}</td>
            <td>${adjustNote}</td>
          </tr>` : ''}
          <tr class="total-row">
            <td colspan="2" class="text-center"><strong>í•©ê³„</strong></td>
            <td class="text-right"><strong>${fmt((parseFloat(contractPayAmt)||0) + (parseFloat(interimPayAmt)||0) + (parseFloat(interim2PayAmt)||0) + (parseFloat(balancePayAmt)||0) + (parseFloat(etcPayAmt)||0) + (parseFloat(etc2PayAmt)||0) + (parseFloat(adjustPayAmt)||0))}</strong></td>
            <td></td>
          </tr>
        </tbody>
      </table>
      
      <!-- ì„¸ë¶€ë‚´ì—­ -->
      <div class="section-title">ğŸ“¤ ì„¸ë¶€ë‚´ì—­</div>
      <table>
        <thead>
          <tr>
            <th style="width:80px;">êµ¬ë¶„</th>
            <th style="width:90px;">ì¼ì</th>
            <th>ë‚´ìš©</th>
            <th style="width:100px;">ê¸ˆì•¡</th>
            <th style="width:90px;">ì§€ê¸‰ì¼</th>
          </tr>
        </thead>
        <tbody>
          ${materialRows}
          ${laborRows}
          ${otherRows}
          <tr class="grand-total">
            <td colspan="3" class="text-center">í•© ê³„</td>
            <td class="text-right">${fmt(expenseTotal)}</td>
            <td></td>
          </tr>
        </tbody>
      </table>
      
      <!-- ì •ì‚° ìš”ì•½ -->
      <div class="summary-box">
        <div class="summary-grid">
          <div class="summary-item">
            <div class="label">ê³„ì•½ê¸ˆì•¡</div>
            <div class="value" style="color:#1976d2;">${fmt(contractAmt)}</div>
          </div>
          <div class="summary-item">
            <div class="label">ì´ ì§€ì¶œ</div>
            <div class="value" style="color:#c62828;">${fmt(expenseTotal)}</div>
          </div>
          <div class="summary-item">
            <div class="label">ì”ì•¡ (ì†ìµ)</div>
            <div class="value ${balance >= 0 ? 'profit-positive' : 'profit-negative'}">${fmt(balance)}</div>
          </div>
          <div class="summary-item">
            <div class="label">ì†ìµë¥ </div>
            <div class="value ${balance >= 0 ? 'profit-positive' : 'profit-negative'}">${contractAmt > 0 ? (balance / contractAmt * 100).toFixed(1) : 0}%</div>
          </div>
        </div>
      </div>
      
      <div class="footer">
        <p>ãˆœì„ë¯¼ì´ì•¤ì”¨ | ${new Date().toLocaleDateString('ko-KR')} ì¶œë ¥</p>
      </div>
      
      <script>window.onload = function() { window.print(); }<\/script>
    </body>
    </html>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(printContent);
  printWindow.document.close();
}

// í˜„ì¥ì†Œì¥ìš© ì •ì‚°ì„œ ì¸ì‡„
function printSettlementForField() {
  const idx = document.getElementById('detailIndex').value;
  const data = allData[currentYear] || [];
  const item = data[idx];
  if (!item) return;
  
  const siteName = document.getElementById('detail_site_input').value || item.site || '';
  const projectName = document.getElementById('detail_project_input').value || item.name || '';
  const periodInput = document.getElementById('detail_period_input').value || '';
  const contractAmt = parseFloat(document.getElementById('detail_amount_input').value) || item.amount || 0;
  const salesPerson = document.getElementById('settlement_sales').value;
  const fieldPerson = document.getElementById('settlement_field').value;
  const siteManager = document.getElementById('detail_site_manager').value;
  const hqManager = document.getElementById('detail_hq_manager').value;
  
  // ê¸ˆì•¡ì¡°ì • í™•ì¸
  const adjustAmt = parseFloat(document.getElementById('åadjust_amt').value) || 0;
  const adjustedContractAmt = contractAmt + adjustAmt;
  
  // íˆ¬ì…ë‚´ì—­ ì„¸ë¶€ ìˆ˜ì§‘ (ë…¸ë¬´ë¹„ ì¤‘ì‹¬)
  let laborItems = [];
  let laborTotal = 0;
  
  document.querySelectorAll('#expenseTableBody tr').forEach(tr => {
    const typeSelect = tr.querySelector('td:nth-child(1) select');
    const inputs = tr.querySelectorAll('input');
    const type = typeSelect?.value || 'ìì¬ë¹„';
    const date = inputs[0]?.value || '';
    const amount = parseFloat(inputs[1]?.value) || 0;
    const content = inputs[2]?.value || '';
    const payDate = inputs[3]?.value || '';
    
    if ((amount > 0 || content) && type === 'ë…¸ë¬´ë¹„') {
      laborItems.push({ date, amount, content, payDate });
      laborTotal += amount;
    }
  });
  
  // í˜„ì¥ì†Œì¥ ì •ì‚°ê¸ˆì•¡ = ë…¸ë¬´ë¹„ ì´ì•¡
  const fieldSettlementAmt = laborTotal;
  const profit = adjustedContractAmt - laborTotal;
  const profitRate = adjustedContractAmt > 0 ? (profit / adjustedContractAmt * 100).toFixed(1) : 0;
  
  // ë…¸ë¬´ë¹„ ì„¸ë¶€ í–‰ ìƒì„±
  let laborRows = '';
  if (laborItems.length > 0) {
    laborItems.forEach((item, i) => {
      laborRows += `<tr>
        <td class="text-center">${i === 0 ? 'ë…¸ë¬´ë¹„' : ''}</td>
        <td class="text-center">${item.date ? formatDate(item.date) : '-'}</td>
        <td>${item.content || '-'}</td>
        <td class="text-right">${fmt(item.amount)}</td>
        <td class="text-center">${item.payDate ? formatDate(item.payDate) : '-'}</td>
      </tr>`;
    });
  }
  
  const printContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>ì •ì‚°ì„œ(í˜„ì¥ì†Œì¥ìš©) - ${siteName}</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', 'Malgun Gothic', sans-serif; padding: 30px; font-size: 11px; line-height: 1.4; }
        h1 { text-align: center; font-size: 22px; margin-bottom: 8px; }
        .subtitle { text-align: center; font-size: 12px; color: #f0ad4e; margin-bottom: 20px; font-weight: 600; }
        
        .header-section { display: flex; justify-content: space-between; margin-bottom: 20px; padding: 15px; background: #fff8e1; border-radius: 5px; border: 1px solid #f0ad4e; }
        .header-left, .header-right { }
        .header-left div, .header-right div { margin-bottom: 5px; }
        .header-right { text-align: right; }
        .label { color: #666; font-size: 10px; }
        .value { font-weight: 600; }
        
        .section-title { font-size: 13px; font-weight: 700; margin: 20px 0 10px; padding: 8px 12px; background: #fff3e0; border-left: 4px solid #f0ad4e; }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; font-size: 10px; }
        th { background: #f5f5f5; font-weight: 600; text-align: center; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        
        .total-row { background: #fff3e0; font-weight: 700; }
        .grand-total { background: #f0ad4e; color: white; font-weight: 700; font-size: 12px; }
        
        .summary-box { margin-top: 20px; padding: 20px; background: #fff8e1; border-radius: 5px; border: 2px solid #f0ad4e; }
        .summary-title { font-size: 14px; font-weight: 700; margin-bottom: 15px; text-align: center; color: #e65100; }
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center; }
        .summary-item .label { font-size: 10px; color: #666; margin-bottom: 3px; }
        .summary-item .value { font-size: 18px; font-weight: 700; }
        .profit-positive { color: #2e7d32; }
        .profit-negative { color: #c62828; }
        
        .note-box { margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 5px; font-size: 10px; color: #666; }
        .note-box strong { color: #333; }
        
        .footer { margin-top: 30px; text-align: center; font-size: 10px; color: #999; border-top: 1px solid #ddd; padding-top: 15px; }
        
        @media print { 
          body { margin: 0; padding: 20px; } 
          .no-print { display: none; }
        }
      </style>
    </head>
    <body>
      <h1>ê³µì‚¬ ì •ì‚°ì„œ</h1>
      <div class="subtitle">[ í˜„ì¥ì†Œì¥ìš© ]</div>
      
      <div class="header-section">
        <div class="header-left">
          <div><span class="label">ê³µì‚¬í˜„ì¥:</span> <span class="value">${siteName}</span></div>
          <div><span class="label">ê³µì‚¬ëª…:</span> <span class="value">${projectName}</span></div>
          <div><span class="label">ê³µì‚¬ê¸°ê°„:</span> <span class="value">${periodInput || '-'}</span></div>
        </div>
        <div class="header-right">
          <div><span class="label">ì˜ì—…ë‹´ë‹¹ì:</span> <span class="value">${salesPerson || hqManager || '-'}</span></div>
          <div><span class="label">í˜„ì¥ì†Œì¥:</span> <span class="value" style="color:#e65100;font-size:14px;">${fieldPerson || siteManager || '-'}</span></div>
          <div><span class="label">ì‘ì„±ì¼:</span> <span class="value">${new Date().toLocaleDateString('ko-KR')}</span></div>
        </div>
      </div>
      
      <!-- ê³µì‚¬ ê°œìš” -->
      <div class="section-title">ğŸ“‹ ê³µì‚¬ ê°œìš”</div>
      <table>
        <tbody>
          <tr>
            <th style="width:150px;background:#fff3e0;">ê³µì‚¬ì¢…ë¥˜</th>
            <td colspan="3">${projectName}</td>
          </tr>
          <tr>
            <th style="background:#fff3e0;">ë§¤ì¶œì•¡ (ë…¸ë¬´ë¹„ ê¸°ì¤€)</th>
            <td class="text-right" style="font-weight:700;color:#1976d2;">${fmt(laborTotal)}ì›</td>
            <th style="background:#fff3e0;">VAT</th>
            <td class="text-center">ë³„ë„</td>
          </tr>
        </tbody>
      </table>
      
      <!-- ë…¸ë¬´ë¹„ ë‚´ì—­ -->
      <div class="section-title">ğŸ‘· ë…¸ë¬´ë¹„ ë‚´ì—­</div>
      <table>
        <thead>
          <tr>
            <th style="width:80px;">êµ¬ë¶„</th>
            <th style="width:90px;">ì¼ì</th>
            <th>ë‚´ìš©</th>
            <th style="width:100px;">ê¸ˆì•¡</th>
            <th style="width:90px;">ì§€ê¸‰ì¼</th>
          </tr>
        </thead>
        <tbody>
          ${laborRows || '<tr><td colspan="5" class="text-center" style="color:#999;">ë…¸ë¬´ë¹„ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'}
          <tr class="grand-total">
            <td colspan="3" class="text-center">ë…¸ë¬´ë¹„ í•©ê³„</td>
            <td class="text-right">${fmt(laborTotal)}</td>
            <td></td>
          </tr>
        </tbody>
      </table>
      
      <!-- ì •ì‚° ìš”ì•½ -->
      <div class="summary-box">
        <div class="summary-title">ğŸ’° ì •ì‚° ë‚´ì—­</div>
        <div class="summary-grid">
          <div class="summary-item">
            <div class="label">ë§¤ì¶œì•¡ (ë…¸ë¬´ë¹„)</div>
            <div class="value" style="color:#1976d2;">${fmt(laborTotal)}</div>
          </div>
          <div class="summary-item">
            <div class="label">ë§¤ì…ì•¡</div>
            <div class="value" style="color:#c62828;">-</div>
          </div>
          <div class="summary-item">
            <div class="label">ì •ì‚°ê¸ˆì•¡</div>
            <div class="value profit-positive">${fmt(laborTotal)}</div>
          </div>
        </div>
      </div>
      
      ${memo ? `
      <div class="note-box" style="margin-top:15px;background:#fff8e1;border:1px solid #f0ad4e;">
        <strong>ğŸ“ ë¹„ê³ </strong><br>
        ${memo.replace(/\n/g, '<br>')}
      </div>
      ` : ''}
      
      ${photos.length > 0 ? `
      <div style="margin-top:15px;">
        <strong style="font-size:12px;">ğŸ“· ì²¨ë¶€ ì‚¬ì§„</strong>
        <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:8px;">
          ${photos.map(p => `<img src="${p}" style="width:150px;height:150px;object-fit:cover;border:1px solid #ddd;border-radius:4px;">`).join('')}
        </div>
      </div>
      ` : ''}
      
      <div class="note-box">
        <strong>â€» ì°¸ê³ ì‚¬í•­</strong><br>
        - ë³¸ ì •ì‚°ì„œëŠ” í˜„ì¥ì†Œì¥ìš©ìœ¼ë¡œ, ë…¸ë¬´ë¹„ ê¸°ì¤€ ì •ì‚° ë‚´ì—­ì…ë‹ˆë‹¤.<br>
        - ìì¬ë¹„, ê¸°íƒ€ê²½ë¹„ëŠ” ë³¸ì‚¬ì—ì„œ ë³„ë„ ì •ì‚°ë©ë‹ˆë‹¤.<br>
        - ë¬¸ì˜ì‚¬í•­ì€ ë³¸ì‚¬ë‹´ë‹¹ì(${hqManager || '-'})ì—ê²Œ ì—°ë½ë°”ëë‹ˆë‹¤.
      </div>
      
      <div class="footer">
        <p>ãˆœì„ë¯¼ì´ì•¤ì”¨ | ${new Date().toLocaleDateString('ko-KR')} ì¶œë ¥</p>
      </div>
      
      <script>window.onload = function() { window.print(); }<\/script>
    </body>
    </html>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(printContent);
  printWindow.document.close();
}

// ========== í˜„ì¥ì†Œì¥ìš© ì •ì‚°ì„œ í¸ì§‘ ëª¨ë‹¬ ==========
let fieldSettlementData = {
  works: [],
  materials: [],
  labors: [],
  memo: '',
  photos: []  // base64 ì´ë¯¸ì§€ ë°°ì—´
};

// í˜„ì¥ì†Œì¥ë³„ ì •ì‚° ë°ì´í„° ì €ì¥
let fieldSettlementByManager = {};

// í˜„ì¥ì†Œì¥ë³„ ë°ì´í„° ì €ì¥
function saveFieldSettlementData() {
  const idx = document.getElementById('detailIndex').value;
  const data = allData[currentYear] || [];
  const item = data[idx];
  if (!item) return;
  
  const manager = document.getElementById('field_manager').value;
  if (!manager) return;
  
  // ë¹„ê³  ê°’ ì €ì¥
  fieldSettlementData.memo = document.getElementById('fieldMemo').value || '';
  
  const key = `${currentYear}_${item.no}`;
  
  if (!fieldSettlementByManager[key]) {
    fieldSettlementByManager[key] = {};
  }
  
  fieldSettlementByManager[key][manager] = {
    works: JSON.parse(JSON.stringify(fieldSettlementData.works)),
    materials: JSON.parse(JSON.stringify(fieldSettlementData.materials)),
    labors: JSON.parse(JSON.stringify(fieldSettlementData.labors)),
    memo: fieldSettlementData.memo,
    photos: fieldSettlementData.photos || []
  };
  
  // localStorageì— ì €ì¥
  try {
    localStorage.setItem('fieldSettlementByManager', JSON.stringify(fieldSettlementByManager));
    showToast(`${manager} ì†Œì¥ ì •ì‚° ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
  } catch (e) {
    console.error('í˜„ì¥ì†Œì¥ ì •ì‚° ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', e);
    if (e.name === 'QuotaExceededError') {
      showToast('ì €ì¥ ìš©ëŸ‰ ì´ˆê³¼! ì‚¬ì§„ì„ ì¤„ì—¬ì£¼ì„¸ìš”.', 'error');
    }
  }
}

// í˜„ì¥ì†Œì¥ë³„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
function loadFieldSettlementData(manager) {
  const idx = document.getElementById('detailIndex').value;
  const data = allData[currentYear] || [];
  const item = data[idx];
  if (!item || !manager) return false;
  
  const key = `${currentYear}_${item.no}`;
  
  if (fieldSettlementByManager[key] && fieldSettlementByManager[key][manager]) {
    const saved = fieldSettlementByManager[key][manager];
    fieldSettlementData.works = JSON.parse(JSON.stringify(saved.works || []));
    fieldSettlementData.materials = JSON.parse(JSON.stringify(saved.materials || []));
    fieldSettlementData.labors = JSON.parse(JSON.stringify(saved.labors || []));
    fieldSettlementData.memo = saved.memo || '';
    fieldSettlementData.photos = saved.photos || [];
    
    // UIì— ë°˜ì˜
    document.getElementById('fieldMemo').value = fieldSettlementData.memo;
    renderFieldPhotoPreview();
    
    return true;
  }
  return false;
}

// ì•± ì‹œì‘ ì‹œ í˜„ì¥ì†Œì¥ë³„ ë°ì´í„° ë¡œë“œ
function loadFieldSettlementFromStorage() {
  try {
    const saved = localStorage.getItem('fieldSettlementByManager');
    if (saved) {
      fieldSettlementByManager = JSON.parse(saved);
    }
  } catch (e) {
    console.error('í˜„ì¥ì†Œì¥ ì •ì‚° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
  }
}

function openFieldSettlementModal() {
  const idx = document.getElementById('detailIndex').value;
  const data = allData[currentYear] || [];
  const item = data[idx];
  if (!item) return;
  
  // ê¸°ë³¸ ì •ë³´ ì±„ìš°ê¸°
  document.getElementById('field_site').value = document.getElementById('detail_site_input').value || item.site || '';
  document.getElementById('field_project').value = document.getElementById('detail_project_input').value || item.name || '';
  // ë³¸ì‚¬ë‹´ë‹¹(ì´ê´„í‘œ)ì„ ìš°ì„ ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
  document.getElementById('field_sales').value = document.getElementById('detail_hq_manager').value || item.manager || '';
  
  // í˜„ì¥ì†Œì¥ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ì½¤ë§ˆë¡œ êµ¬ë¶„ëœ ì—¬ëŸ¬ ëª…)
  const siteManagerStr = document.getElementById('detail_site_manager').value || item.siteManager || '';
  const managers = siteManagerStr.split(',').map(m => m.trim()).filter(m => m);
  
  // ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
  const select = document.getElementById('field_manager_select');
  select.innerHTML = '<option value="">-- ì†Œì¥ ì„ íƒ --</option>';
  managers.forEach(manager => {
    select.innerHTML += `<option value="${manager}">${manager}</option>`;
  });
  
  // ì²« ë²ˆì§¸ ì†Œì¥ ê¸°ë³¸ ì„ íƒ (1ëª…ì´ë©´ ìë™ ì„ íƒ)
  if (managers.length === 1) {
    select.value = managers[0];
    document.getElementById('field_manager').value = managers[0];
    document.getElementById('selectedManagerDisplay').style.display = 'block';
    document.getElementById('selectedManagerName').textContent = managers[0];
  } else if (managers.length > 1) {
    document.getElementById('field_manager').value = '';
    document.getElementById('selectedManagerDisplay').style.display = 'none';
  }
  
  // ê³µì‚¬ ë‚´ì—­ ì´ˆê¸°í™”
  fieldSettlementData.works = [];
  const projectName = document.getElementById('detail_project_input').value || item.name || '';
  
  // ë…¸ë¬´ë¹„ì—ì„œ ë§¤ì¶œì•¡ ê³„ì‚°
  let laborTotal = 0;
  document.querySelectorAll('#expenseTableBody tr').forEach(tr => {
    const typeSelect = tr.querySelector('td:nth-child(1) select');
    const inputs = tr.querySelectorAll('input');
    const type = typeSelect?.value || 'ìì¬ë¹„';
    const amount = parseFloat(inputs[1]?.value) || 0;
    if (type === 'ë…¸ë¬´ë¹„') laborTotal += amount;
  });
  
  fieldSettlementData.works.push({
    content: projectName,
    sales: laborTotal,
    purchase: 0
  });
  
  // ë…¸ë¬´ë¹„ ë‚´ì—­ ê°€ì ¸ì˜¤ê¸°
  fieldSettlementData.labors = [];
  document.querySelectorAll('#expenseTableBody tr').forEach(tr => {
    const typeSelect = tr.querySelector('td:nth-child(1) select');
    const inputs = tr.querySelectorAll('input');
    const type = typeSelect?.value || 'ìì¬ë¹„';
    const amount = parseFloat(inputs[1]?.value) || 0;
    const content = inputs[2]?.value || '';
    const payDate = inputs[3]?.value || '';
    
    if (type === 'ë…¸ë¬´ë¹„' && (amount > 0 || content)) {
      fieldSettlementData.labors.push({
        content: content,
        amount: amount,
        payDate: payDate,
        note: ''
      });
    }
  });
  
  // í…Œì´ë¸” ë Œë”ë§
  renderFieldWorkTable();
  renderFieldMaterialTable();
  renderFieldLaborTable();
  updateFieldTotals();
  
  document.getElementById('fieldSettlementModal').style.display = 'flex';
}

// í˜„ì¥ì†Œì¥ ì„ íƒ ì‹œ í˜¸ì¶œ
// í˜„ì¥ì†Œì¥ ì§ì ‘ ì¶”ê°€
function addNewFieldManager() {
  const newManager = prompt('ì¶”ê°€í•  í˜„ì¥ì†Œì¥ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:\n(ì˜ˆ: ì§ì˜(ê¹€ëŒ€í˜„), POUR(í™ê¸¸ë™) ë“±)');
  
  if (!newManager || !newManager.trim()) {
    return;
  }
  
  const managerName = newManager.trim();
  const select = document.getElementById('field_manager_select');
  
  // ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
  const existingOptions = Array.from(select.options).map(opt => opt.value);
  if (existingOptions.includes(managerName)) {
    showToast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì†Œì¥ì…ë‹ˆë‹¤.', 'error');
    return;
  }
  
  // ë“œë¡­ë‹¤ìš´ì— ì¶”ê°€
  const option = document.createElement('option');
  option.value = managerName;
  option.textContent = managerName;
  select.appendChild(option);
  
  // ìƒˆë¡œ ì¶”ê°€í•œ ì†Œì¥ ì„ íƒ
  select.value = managerName;
  onFieldManagerSelect();
  
  // í˜„ì¥ ìƒì„¸ì˜ ì†Œì¥ í•„ë“œì—ë„ ì¶”ê°€
  const siteManagerInput = document.getElementById('detail_site_manager');
  const currentManagers = siteManagerInput.value;
  if (currentManagers) {
    siteManagerInput.value = currentManagers + ', ' + managerName;
  } else {
    siteManagerInput.value = managerName;
  }
  
  showToast(`'${managerName}' ì†Œì¥ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
}

function onFieldManagerSelect() {
  const select = document.getElementById('field_manager_select');
  const selectedManager = select.value;
  
  document.getElementById('field_manager').value = selectedManager;
  
  if (selectedManager) {
    document.getElementById('selectedManagerDisplay').style.display = 'block';
    document.getElementById('selectedManagerName').textContent = selectedManager;
    
    // ì €ì¥ëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë¶ˆëŸ¬ì˜¤ê¸°
    if (loadFieldSettlementData(selectedManager)) {
      showToast(`${selectedManager} ì†Œì¥ì˜ ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, 'info');
    } else {
      // ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ë°ì´í„°ë¡œ ì´ˆê¸°í™”
      initFieldSettlementData();
    }
    
    // í…Œì´ë¸” ë Œë”ë§
    renderFieldWorkTable();
    renderFieldMaterialTable();
    renderFieldLaborTable();
    updateFieldTotals();
  } else {
    document.getElementById('selectedManagerDisplay').style.display = 'none';
  }
}

// ê¸°ë³¸ ë°ì´í„°ë¡œ ì´ˆê¸°í™” (íˆ¬ì…ë‚´ì—­ì—ì„œ ë…¸ë¬´ë¹„ ê°€ì ¸ì˜¤ê¸°)
function initFieldSettlementData() {
  const idx = document.getElementById('detailIndex').value;
  const data = allData[currentYear] || [];
  const item = data[idx];
  
  const projectName = document.getElementById('detail_project_input').value || item?.name || '';
  
  // ìì¬ë¹„, ë…¸ë¬´ë¹„ í•©ê³„ ê³„ì‚°
  let materialTotal = 0;
  let laborTotal = 0;
  document.querySelectorAll('#expenseTableBody tr').forEach(tr => {
    const typeSelect = tr.querySelector('td:nth-child(1) select');
    const inputs = tr.querySelectorAll('input');
    const type = typeSelect?.value || 'ìì¬ë¹„';
    const amount = parseFloat(inputs[1]?.value) || 0;
    if (type === 'ìì¬ë¹„') materialTotal += amount;
    if (type === 'ë…¸ë¬´ë¹„') laborTotal += amount;
  });
  
  fieldSettlementData.works = [{
    content: projectName,
    sales: materialTotal + laborTotal,  // ë§¤ì¶œì•¡ = ìì¬ë¹„ + ë…¸ë¬´ë¹„ í•©ê³„ë¡œ ì´ˆê¸°ê°’
    purchase: 0
  }];
  
  // ìì¬ë¹„ ë‚´ì—­ ê°€ì ¸ì˜¤ê¸°
  fieldSettlementData.materials = [];
  document.querySelectorAll('#expenseTableBody tr').forEach(tr => {
    const typeSelect = tr.querySelector('td:nth-child(1) select');
    const inputs = tr.querySelectorAll('input');
    const type = typeSelect?.value || 'ìì¬ë¹„';
    const amount = parseFloat(inputs[1]?.value) || 0;
    const content = inputs[2]?.value || '';
    
    if (type === 'ìì¬ë¹„' && (amount > 0 || content)) {
      fieldSettlementData.materials.push({
        content: content,
        amount: amount,
        note: ''
      });
    }
  });
  
  // ë…¸ë¬´ë¹„ ë‚´ì—­ ê°€ì ¸ì˜¤ê¸°
  fieldSettlementData.labors = [];
  document.querySelectorAll('#expenseTableBody tr').forEach(tr => {
    const typeSelect = tr.querySelector('td:nth-child(1) select');
    const inputs = tr.querySelectorAll('input');
    const type = typeSelect?.value || 'ìì¬ë¹„';
    const amount = parseFloat(inputs[1]?.value) || 0;
    const content = inputs[2]?.value || '';
    const payDate = inputs[3]?.value || '';
    
    if (type === 'ë…¸ë¬´ë¹„' && (amount > 0 || content)) {
      fieldSettlementData.labors.push({
        content: content,
        amount: amount,
        payDate: payDate,
        note: ''
      });
    }
  });
  
  // ë¹„ê³ ì™€ ì‚¬ì§„ ì´ˆê¸°í™”
  fieldSettlementData.memo = '';
  fieldSettlementData.photos = [];
  document.getElementById('fieldMemo').value = '';
  renderFieldPhotoPreview();
}

// ì‚¬ì§„ ì—…ë¡œë“œ ì²˜ë¦¬
function handleFieldPhotoUpload(event) {
  const files = event.target.files;
  if (!files.length) return;
  
  Array.from(files).forEach(file => {
    if (!file.type.startsWith('image/')) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ (ìµœëŒ€ 800px)
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement('canvas');
        const maxSize = 800;
        let width = img.width;
        let height = img.height;
        
        if (width > maxSize || height > maxSize) {
          if (width > height) {
            height = (height / width) * maxSize;
            width = maxSize;
          } else {
            width = (width / height) * maxSize;
            height = maxSize;
          }
        }
        
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        const resizedBase64 = canvas.toDataURL('image/jpeg', 0.7);
        fieldSettlementData.photos.push(resizedBase64);
        renderFieldPhotoPreview();
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
  
  // ì…ë ¥ ì´ˆê¸°í™”
  event.target.value = '';
}

// ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§
function renderFieldPhotoPreview() {
  const container = document.getElementById('fieldPhotoPreview');
  container.innerHTML = '';
  
  if (!fieldSettlementData.photos || fieldSettlementData.photos.length === 0) {
    container.innerHTML = '<div style="color:#999;font-size:0.8rem;">ì²¨ë¶€ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  
  fieldSettlementData.photos.forEach((photo, idx) => {
    const div = document.createElement('div');
    div.style.cssText = 'position:relative;display:inline-block;';
    div.innerHTML = `
      <img src="${photo}" style="width:100px;height:100px;object-fit:cover;border-radius:4px;border:1px solid #ddd;cursor:pointer;" onclick="viewFieldPhoto(${idx})">
      <button onclick="removeFieldPhoto(${idx})" style="position:absolute;top:-5px;right:-5px;width:20px;height:20px;border-radius:50%;background:#f44336;color:white;border:none;cursor:pointer;font-size:12px;line-height:1;">Ã—</button>
    `;
    container.appendChild(div);
  });
}

// ì‚¬ì§„ ì‚­ì œ
function removeFieldPhoto(idx) {
  fieldSettlementData.photos.splice(idx, 1);
  renderFieldPhotoPreview();
}

// ì‚¬ì§„ í¬ê²Œ ë³´ê¸°
function viewFieldPhoto(idx) {
  const photo = fieldSettlementData.photos[idx];
  const win = window.open('', '_blank');
  win.document.write(`
    <html>
    <head><title>ì‚¬ì§„ ë³´ê¸°</title></head>
    <body style="margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;background:#000;">
      <img src="${photo}" style="max-width:100%;max-height:100vh;">
    </body>
    </html>
  `);
}

function closeFieldSettlementModal() {
  document.getElementById('fieldSettlementModal').style.display = 'none';
}

function renderFieldWorkTable() {
  const tbody = document.getElementById('fieldWorkTableBody');
  tbody.innerHTML = '';
  
  fieldSettlementData.works.forEach((work, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="text-center">ê³µì‚¬ì¢…ë¥˜</td>
      <td><input type="text" value="${work.content || ''}" onchange="fieldSettlementData.works[${i}].content = this.value;" style="width:100%;"></td>
      <td><input type="number" value="${work.sales || ''}" onchange="updateFieldWorkSales(${i}, this.value)" style="width:100%;text-align:right;font-weight:600;color:#1976d2;background:#e3f2fd;"></td>
    `;
    tbody.appendChild(tr);
  });
}

// ë§¤ì¶œì•¡ ë³€ê²½ ì‹œ í•©ê³„ ì—…ë°ì´íŠ¸
function updateFieldWorkSales(idx, value) {
  fieldSettlementData.works[idx].sales = parseFloat(value) || 0;
  updateFieldTotals();
}

// ìì¬ë¹„ í…Œì´ë¸” ë Œë”ë§
function renderFieldMaterialTable() {
  const tbody = document.getElementById('fieldMaterialTableBody');
  tbody.innerHTML = '';
  
  fieldSettlementData.materials.forEach((material, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" value="${material.content || ''}" onchange="updateFieldMaterial(${i}, 'content', this.value)" style="width:100%;"></td>
      <td><input type="number" value="${material.amount || ''}" onchange="updateFieldMaterial(${i}, 'amount', this.value)" style="width:100%;text-align:right;"></td>
      <td><input type="text" value="${material.note || ''}" onchange="updateFieldMaterial(${i}, 'note', this.value)" style="width:100%;"></td>
      <td><button onclick="removeFieldMaterial(${i})" style="color:red;border:none;background:none;cursor:pointer;">Ã—</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function addFieldMaterialRow() {
  fieldSettlementData.materials.push({ content: '', amount: 0, note: '' });
  renderFieldMaterialTable();
}

function removeFieldMaterial(idx) {
  fieldSettlementData.materials.splice(idx, 1);
  renderFieldMaterialTable();
  updateFieldTotals();
}

function updateFieldMaterial(idx, field, value) {
  if (field === 'amount') {
    fieldSettlementData.materials[idx][field] = parseFloat(value) || 0;
  } else {
    fieldSettlementData.materials[idx][field] = value;
  }
  updateFieldTotals();
}

function renderFieldLaborTable() {
  const tbody = document.getElementById('fieldLaborTableBody');
  tbody.innerHTML = '';
  
  fieldSettlementData.labors.forEach((labor, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" value="${labor.content || ''}" onchange="updateFieldLabor(${i}, 'content', this.value)" style="width:100%;"></td>
      <td><input type="number" value="${labor.amount || ''}" onchange="updateFieldLabor(${i}, 'amount', this.value)" style="width:100%;text-align:right;"></td>
      <td><input type="date" value="${labor.payDate || ''}" onchange="updateFieldLabor(${i}, 'payDate', this.value)" style="width:100%;"></td>
      <td><input type="text" value="${labor.note || ''}" onchange="updateFieldLabor(${i}, 'note', this.value)" style="width:100%;"></td>
      <td><button onclick="removeFieldLabor(${i})" style="color:red;border:none;background:none;cursor:pointer;">Ã—</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function addFieldLaborRow() {
  fieldSettlementData.labors.push({ content: '', amount: 0, payDate: '', note: '' });
  renderFieldLaborTable();
}

function removeFieldLabor(idx) {
  fieldSettlementData.labors.splice(idx, 1);
  renderFieldLaborTable();
  updateFieldTotals();
}

function updateFieldLabor(idx, field, value) {
  if (field === 'amount') {
    fieldSettlementData.labors[idx][field] = parseFloat(value) || 0;
  } else {
    fieldSettlementData.labors[idx][field] = value;
  }
  updateFieldTotals();
}

function updateFieldTotals() {
  // ìì¬ë¹„ í•©ê³„ ê³„ì‚°
  let materialTotal = 0;
  fieldSettlementData.materials.forEach(m => {
    materialTotal += m.amount || 0;
  });
  
  // ë…¸ë¬´ë¹„ í•©ê³„ ê³„ì‚°
  let laborTotal = 0;
  fieldSettlementData.labors.forEach(l => {
    laborTotal += l.amount || 0;
  });
  
  // ë§¤ì¶œì•¡ = ê³µì‚¬ ë‚´ì—­ì—ì„œ ì§ì ‘ ì…ë ¥í•œ ê°’
  let salesTotal = 0;
  fieldSettlementData.works.forEach(w => {
    salesTotal += w.sales || 0;
  });
  
  // ë§¤ì…ì•¡ = ìì¬ë¹„ + ë…¸ë¬´ë¹„ í•©ê³„
  const purchaseTotal = materialTotal + laborTotal;
  
  // ì •ì‚°ê¸ˆì•¡ = ë§¤ì¶œì•¡ - ë§¤ì…ì•¡
  const settlementTotal = salesTotal - purchaseTotal;
  
  // ìì¬ë¹„/ë…¸ë¬´ë¹„ ê°œë³„ í•©ê³„
  document.getElementById('fieldMaterialTotal').textContent = fmt(materialTotal);
  document.getElementById('fieldLaborTotal').textContent = fmt(laborTotal);
  
  // ì •ì‚° ìš”ì•½
  document.getElementById('fieldSalesTotal').textContent = fmt(salesTotal);
  document.getElementById('fieldMaterialTotalSummary').textContent = fmt(materialTotal);
  document.getElementById('fieldLaborTotalSummary').textContent = fmt(laborTotal);
  document.getElementById('fieldPurchaseTotal').textContent = fmt(purchaseTotal);
  document.getElementById('fieldSettlementTotal').textContent = fmt(settlementTotal);
  document.getElementById('fieldSettlementTotal2').textContent = fmt(settlementTotal);
  
  // ì •ì‚°ê¸ˆì•¡ ìƒ‰ìƒ (ì–‘ìˆ˜:ì´ˆë¡, ìŒìˆ˜:ë¹¨ê°•)
  const color = settlementTotal >= 0 ? '#2e7d32' : '#c62828';
  document.getElementById('fieldSettlementTotal').style.color = color;
  document.getElementById('fieldSettlementTotal2').style.color = color;
}

function printFieldSettlement() {
  const siteName = document.getElementById('field_site').value;
  const projectName = document.getElementById('field_project').value;
  const salesPerson = document.getElementById('field_sales').value;
  const fieldManager = document.getElementById('field_manager').value;
  
  // ì†Œì¥ ì„ íƒ í™•ì¸
  if (!fieldManager) {
    showToast('ì¸ì‡„í•  í˜„ì¥ì†Œì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
    return;
  }
  
  // ë¹„ê³ ì™€ ì‚¬ì§„ ê°€ì ¸ì˜¤ê¸°
  const memo = document.getElementById('fieldMemo').value || '';
  const photos = fieldSettlementData.photos || [];
  
  // ìì¬ë¹„ í•©ê³„ ê³„ì‚°
  let materialTotal = 0;
  fieldSettlementData.materials.forEach(m => {
    materialTotal += m.amount || 0;
  });
  
  // ë…¸ë¬´ë¹„ í•©ê³„ ê³„ì‚°
  let laborTotal = 0;
  fieldSettlementData.labors.forEach(l => {
    laborTotal += l.amount || 0;
  });
  
  // ë§¤ì¶œì•¡ = ì§ì ‘ ì…ë ¥í•œ ê°’
  let salesTotal = 0;
  fieldSettlementData.works.forEach(w => {
    salesTotal += w.sales || 0;
  });
  
  // ë§¤ì…ì•¡ = ìì¬ë¹„ + ë…¸ë¬´ë¹„ í•©ê³„
  const purchaseTotal = materialTotal + laborTotal;
  // ì •ì‚°ê¸ˆì•¡ = ë§¤ì¶œì•¡ - ë§¤ì…ì•¡
  const settlementTotal = salesTotal - purchaseTotal;
  
  // ê³µì‚¬ ë‚´ì—­ í–‰ ìƒì„±
  const workContent = fieldSettlementData.works[0]?.content || projectName;
  const workSales = fieldSettlementData.works[0]?.sales || salesTotal;
  const workRows = `
    <tr>
      <td class="text-center">ê³µì‚¬ì¢…ë¥˜</td>
      <td>${workContent || '-'}</td>
      <td class="text-right" style="font-weight:600;color:#1976d2;">${fmt(workSales)}</td>
    </tr>
    <tr class="subtotal">
      <td colspan="2" class="text-right"><strong>ì†Œê³„</strong></td>
      <td class="text-right"><strong>${fmt(salesTotal)}</strong></td>
    </tr>`;
  
  // ìì¬ë¹„ ë‚´ì—­ í–‰ ìƒì„±
  let materialRows = '';
  fieldSettlementData.materials.forEach((m, i) => {
    materialRows += `<tr>
      <td class="text-center">${i === 0 ? 'ìì¬ë¹„' : ''}</td>
      <td>${m.content || '-'}</td>
      <td class="text-right">${fmt(m.amount)}</td>
      <td>${m.note || ''}</td>
    </tr>`;
  });
  if (materialRows) {
    materialRows += `<tr class="subtotal" style="background:#e3f2fd;"><td colspan="2" class="text-right"><strong>ìì¬ë¹„ ì†Œê³„</strong></td><td class="text-right"><strong>${fmt(materialTotal)}</strong></td><td></td></tr>`;
  }
  
  // ë…¸ë¬´ë¹„ ë‚´ì—­ í–‰ ìƒì„±
  let laborRows = '';
  fieldSettlementData.labors.forEach((l, i) => {
    laborRows += `<tr>
      <td class="text-center">${i === 0 ? 'ë…¸ë¬´ë¹„' : ''}</td>
      <td>${l.content || '-'}</td>
      <td class="text-right">${fmt(l.amount)}</td>
      <td class="text-center">${l.payDate || '-'}</td>
      <td>${l.note || ''}</td>
    </tr>`;
  });
  if (laborRows) {
    laborRows += `<tr class="subtotal"><td colspan="2" class="text-right"><strong>ë…¸ë¬´ë¹„ ì†Œê³„</strong></td><td class="text-right"><strong>${fmt(laborTotal)}</strong></td><td colspan="2"></td></tr>`;
  }
  
  const printContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>ì •ì‚°ì„œ(í˜„ì¥ì†Œì¥ìš©) - ${siteName}</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', 'Malgun Gothic', sans-serif; padding: 30px; font-size: 11px; line-height: 1.4; }
        h1 { text-align: center; font-size: 22px; margin-bottom: 8px; }
        .subtitle { text-align: center; font-size: 12px; color: #f0ad4e; margin-bottom: 20px; font-weight: 600; }
        
        .header-section { display: flex; justify-content: space-between; margin-bottom: 20px; padding: 15px; background: #fff8e1; border-radius: 5px; border: 1px solid #f0ad4e; }
        .header-left div, .header-right div { margin-bottom: 5px; }
        .header-right { text-align: right; }
        .label { color: #666; font-size: 10px; }
        .value { font-weight: 600; }
        
        .section-title { font-size: 13px; font-weight: 700; margin: 20px 0 10px; padding: 8px 12px; background: #fff3e0; border-left: 4px solid #f0ad4e; }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; font-size: 10px; }
        th { background: #f5f5f5; font-weight: 600; text-align: center; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        
        .subtotal { background: #fff3e0; }
        .total-row { background: #f0ad4e; color: white; font-weight: 700; }
        
        .summary-box { margin-top: 20px; padding: 20px; background: #fff8e1; border-radius: 5px; border: 2px solid #f0ad4e; }
        .summary-title { font-size: 14px; font-weight: 700; margin-bottom: 15px; text-align: center; color: #e65100; }
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center; }
        .summary-item .label { font-size: 10px; color: #666; margin-bottom: 3px; }
        .summary-item .value { font-size: 18px; font-weight: 700; }
        .profit-positive { color: #2e7d32; }
        
        .note-box { margin-top: 15px; padding: 10px; background: #e8f5e9; border-radius: 5px; font-size: 9px; color: #2e7d32; text-align: center; }
        
        .footer { margin-top: 30px; text-align: center; font-size: 10px; color: #999; border-top: 1px solid #ddd; padding-top: 15px; }
        
        @media print { body { margin: 0; padding: 20px; } }
      </style>
    </head>
    <body>
      <h1>ê³µì‚¬ ì •ì‚°ì„œ</h1>
      <div class="subtitle">[ í˜„ì¥ì†Œì¥ìš© ]</div>
      
      <div class="header-section">
        <div class="header-left">
          <div><span class="label">ê³µì‚¬í˜„ì¥:</span> <span class="value">${siteName}</span></div>
          <div><span class="label">VAT:</span> <span class="value">ë³„ë„</span></div>
        </div>
        <div class="header-right">
          <div><span class="label">ì˜ì—…ë‹´ë‹¹ì:</span> <span class="value">${salesPerson || '-'}</span></div>
          <div><span class="label">í˜„ì¥ì†Œì¥:</span> <span class="value" style="color:#e65100;font-size:14px;">${fieldManager || '-'}</span></div>
        </div>
      </div>
      
      <!-- ê³µì‚¬ ë‚´ì—­ -->
      <div class="section-title">ğŸ“‹ ê³µì‚¬ ë‚´ì—­</div>
      <table>
        <thead>
          <tr>
            <th style="width:80px;">êµ¬ë¶„</th>
            <th>ë‚´ìš©</th>
            <th style="width:150px;">ë§¤ì¶œì•¡</th>
          </tr>
        </thead>
        <tbody>
          ${workRows}
        </tbody>
      </table>
      
      <!-- ìì¬ë¹„ ë‚´ì—­ -->
      ${materialRows ? `
      <div class="section-title" style="background:#e3f2fd;border-left-color:#1565c0;">ğŸ§± ìì¬ë¹„ ë‚´ì—­</div>
      <table>
        <thead>
          <tr>
            <th style="width:80px;">êµ¬ë¶„</th>
            <th>ë‚´ìš©</th>
            <th style="width:120px;">ë§¤ì…ì•¡</th>
            <th style="width:100px;">ë¹„ê³ </th>
          </tr>
        </thead>
        <tbody>
          ${materialRows}
        </tbody>
      </table>
      ` : ''}
      
      <!-- ë…¸ë¬´ë¹„ ë‚´ì—­ -->
      ${laborRows ? `
      <div class="section-title">ğŸ‘· ë…¸ë¬´ë¹„ ë‚´ì—­</div>
      <table>
        <thead>
          <tr>
            <th style="width:80px;">êµ¬ë¶„</th>
            <th>ë‚´ìš©</th>
            <th style="width:120px;">ë§¤ì…ì•¡</th>
            <th style="width:90px;">ì§€ê¸‰ì¼</th>
            <th style="width:100px;">ë¹„ê³ </th>
          </tr>
        </thead>
        <tbody>
          ${laborRows}
        </tbody>
      </table>
      ` : ''}
      
      <!-- ì •ì‚° ìš”ì•½ -->
      <div class="summary-box">
        <div class="summary-title">ğŸ’° ì •ì‚° ë‚´ì—­</div>
        <div class="summary-grid" style="grid-template-columns: repeat(4, 1fr);">
          <div class="summary-item">
            <div class="label">ë§¤ì¶œì•¡</div>
            <div class="value" style="color:#1976d2;">${fmt(salesTotal)}</div>
          </div>
          <div class="summary-item">
            <div class="label">ìì¬ë¹„</div>
            <div class="value" style="color:#1565c0;">${fmt(materialTotal)}</div>
          </div>
          <div class="summary-item">
            <div class="label">ë…¸ë¬´ë¹„</div>
            <div class="value" style="color:#e65100;">${fmt(laborTotal)}</div>
          </div>
          <div class="summary-item">
            <div class="label">ì •ì‚°ê¸ˆì•¡</div>
            <div class="value" style="color:${settlementTotal >= 0 ? '#2e7d32' : '#c62828'};">${fmt(settlementTotal)}</div>
          </div>
        </div>
        <div style="margin-top:10px;padding-top:10px;border-top:1px dashed #f0ad4e;text-align:center;">
          <span style="color:#666;font-size:10px;">ë§¤ì…ì•¡ í•©ê³„ (ìì¬ë¹„+ë…¸ë¬´ë¹„): </span>
          <span style="font-weight:700;color:#c62828;">${fmt(purchaseTotal)}</span>
        </div>
        <div class="note-box">
          â€» ì •ì‚°ê¸ˆì•¡ = ë§¤ì¶œì•¡ - ë§¤ì…ì•¡(ìì¬ë¹„ + ë…¸ë¬´ë¹„)
        </div>
      </div>
      
      <div class="footer">
        <p>ãˆœì„ë¯¼ì´ì•¤ì”¨ | ${new Date().toLocaleDateString('ko-KR')} ì¶œë ¥</p>
      </div>
      
      <script>window.onload = function() { window.print(); }<\/script>
    </body>
    </html>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(printContent);
  printWindow.document.close();
}

// ========== ì˜ì—…ë‹´ë‹¹ììš© ì •ì‚°ì„œ ==========
let salesSettlementData = {
  works: [],
  expenses: [],
  memo: ''
};
let salesSettlementByManager = {};

function openSalesSettlementModal() {
  const idx = document.getElementById('detailIndex').value;
  const data = allData[currentYear] || [];
  const item = data[idx];
  if (!item) return;
  
  // ê¸°ë³¸ ì •ë³´ ì±„ìš°ê¸°
  document.getElementById('sales_site').value = document.getElementById('detail_site_input').value || item.site || '';
  document.getElementById('sales_project').value = document.getElementById('detail_project_input').value || item.name || '';
  document.getElementById('sales_manager').value = document.getElementById('detail_hq_manager').value || item.manager || '';
  document.getElementById('sales_field_manager').value = document.getElementById('detail_site_manager').value || item.siteManager || '';
  
  // ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
  const key = `${currentYear}_${item.no}`;
  if (salesSettlementByManager[key]) {
    salesSettlementData = JSON.parse(JSON.stringify(salesSettlementByManager[key]));
    document.getElementById('salesMemo').value = salesSettlementData.memo || '';
  } else {
    // ê¸°ë³¸ ë°ì´í„° ì´ˆê¸°í™”
    initSalesSettlementData();
  }
  
  // í…Œì´ë¸” ë Œë”ë§
  renderSalesWorkTable();
  renderSalesExpenseTable();
  updateSalesTotals();
  
  document.getElementById('salesSettlementModal').style.display = 'flex';
}

function closeSalesSettlementModal() {
  document.getElementById('salesSettlementModal').style.display = 'none';
}

function initSalesSettlementData() {
  const projectName = document.getElementById('detail_project_input').value || '';
  
  // ë§¤ì¶œì•¡ = ê³„ì•½ê¸ˆì•¡
  const contractAmt = parseFloat(document.getElementById('detail_amount_input').value) || 0;
  
  salesSettlementData.works = [{
    content: projectName,
    sales: contractAmt
  }];
  
  // ë§¤ì…ë‚´ì—­ = íˆ¬ì…ë‚´ì—­ì—ì„œ ê°€ì ¸ì˜¤ê¸°
  salesSettlementData.expenses = [];
  document.querySelectorAll('#expenseTableBody tr').forEach(tr => {
    const typeSelect = tr.querySelector('td:nth-child(1) select');
    const inputs = tr.querySelectorAll('input');
    const type = typeSelect?.value || 'ìì¬ë¹„';
    const amount = parseFloat(inputs[1]?.value) || 0;
    const content = inputs[2]?.value || '';
    const payDate = inputs[3]?.value || '';
    
    if (amount > 0 || content) {
      salesSettlementData.expenses.push({
        type: type,
        content: content,
        amount: amount,
        payDate: payDate,
        note: ''
      });
    }
  });
  
  salesSettlementData.memo = '';
  document.getElementById('salesMemo').value = '';
}

function renderSalesWorkTable() {
  const tbody = document.getElementById('salesWorkTableBody');
  tbody.innerHTML = '';
  
  salesSettlementData.works.forEach((work, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="text-center">ê³µì‚¬ì¢…ë¥˜</td>
      <td><input type="text" value="${work.content || ''}" onchange="salesSettlementData.works[${i}].content = this.value;" style="width:100%;"></td>
      <td><input type="number" value="${work.sales || ''}" onchange="updateSalesWorkSales(${i}, this.value)" style="width:100%;text-align:right;font-weight:600;color:#1976d2;background:#e3f2fd;"></td>
    `;
    tbody.appendChild(tr);
  });
}

function updateSalesWorkSales(idx, value) {
  salesSettlementData.works[idx].sales = parseFloat(value) || 0;
  updateSalesTotals();
}

function renderSalesExpenseTable() {
  const tbody = document.getElementById('salesExpenseTableBody');
  tbody.innerHTML = '';
  
  salesSettlementData.expenses.forEach((exp, i) => {
    const tr = document.createElement('tr');
    const bgColor = exp.type === 'ìì¬ë¹„' ? '#e3f2fd' : exp.type === 'ë…¸ë¬´ë¹„' ? '#fff3e0' : '#f3e5f5';
    tr.innerHTML = `
      <td class="text-center" style="background:${bgColor};">${exp.type}</td>
      <td><input type="text" value="${exp.content || ''}" onchange="salesSettlementData.expenses[${i}].content = this.value;" style="width:100%;"></td>
      <td><input type="number" value="${exp.amount || ''}" onchange="updateSalesExpense(${i}, this.value)" style="width:100%;text-align:right;"></td>
      <td><input type="date" value="${exp.payDate || ''}" onchange="salesSettlementData.expenses[${i}].payDate = this.value;" style="width:100%;"></td>
      <td><input type="text" value="${exp.note || ''}" onchange="salesSettlementData.expenses[${i}].note = this.value;" style="width:100%;"></td>
      <td class="text-center"><button onclick="removeSalesExpense(${i})" style="color:#c62828;border:none;background:none;cursor:pointer;">âœ•</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function addSalesExpenseRow(type) {
  salesSettlementData.expenses.push({
    type: type,
    content: '',
    amount: 0,
    payDate: '',
    note: ''
  });
  renderSalesExpenseTable();
}

function removeSalesExpense(idx) {
  salesSettlementData.expenses.splice(idx, 1);
  renderSalesExpenseTable();
  updateSalesTotals();
}

function updateSalesExpense(idx, value) {
  salesSettlementData.expenses[idx].amount = parseFloat(value) || 0;
  updateSalesTotals();
}

function updateSalesTotals() {
  // ë§¤ì¶œì•¡
  let salesTotal = 0;
  salesSettlementData.works.forEach(w => salesTotal += w.sales || 0);
  
  // ë§¤ì…ì•¡
  let expenseTotal = 0;
  salesSettlementData.expenses.forEach(e => expenseTotal += e.amount || 0);
  
  // ì •ì‚°ê¸ˆì•¡
  const settlementTotal = salesTotal - expenseTotal;
  
  document.getElementById('salesSalesTotal').textContent = fmt(salesTotal);
  document.getElementById('salesExpenseTotal').textContent = fmt(expenseTotal);
  document.getElementById('salesPurchaseTotal').textContent = fmt(expenseTotal);
  
  const settlementEl = document.getElementById('salesSettlementTotal');
  settlementEl.textContent = fmt(settlementTotal);
  settlementEl.style.color = settlementTotal >= 0 ? '#2e7d32' : '#c62828';
}

function saveSalesSettlementData() {
  const idx = document.getElementById('detailIndex').value;
  const data = allData[currentYear] || [];
  const item = data[idx];
  if (!item) return;
  
  salesSettlementData.memo = document.getElementById('salesMemo').value || '';
  
  const key = `${currentYear}_${item.no}`;
  salesSettlementByManager[key] = JSON.parse(JSON.stringify(salesSettlementData));
  
  try {
    localStorage.setItem('salesSettlementByManager', JSON.stringify(salesSettlementByManager));
    showToast('ì˜ì—…ë‹´ë‹¹ììš© ì •ì‚° ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
  } catch (e) {
    console.error('ì˜ì—…ë‹´ë‹¹ì ì •ì‚° ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', e);
  }
}

function loadSalesSettlementFromStorage() {
  try {
    const saved = localStorage.getItem('salesSettlementByManager');
    if (saved) {
      salesSettlementByManager = JSON.parse(saved);
    }
  } catch (e) {
    console.error('ì˜ì—…ë‹´ë‹¹ì ì •ì‚° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
  }
}

function printSalesSettlement() {
  const siteName = document.getElementById('sales_site').value;
  const projectName = document.getElementById('sales_project').value;
  const salesManager = document.getElementById('sales_manager').value;
  const fieldManager = document.getElementById('sales_field_manager').value;
  const memo = document.getElementById('salesMemo').value || '';
  
  // ë§¤ì¶œì•¡
  let salesTotal = 0;
  salesSettlementData.works.forEach(w => salesTotal += w.sales || 0);
  
  // ë§¤ì…ì•¡
  let expenseTotal = 0;
  let materialTotal = 0, laborTotal = 0, otherTotal = 0;
  salesSettlementData.expenses.forEach(e => {
    expenseTotal += e.amount || 0;
    if (e.type === 'ìì¬ë¹„') materialTotal += e.amount || 0;
    else if (e.type === 'ë…¸ë¬´ë¹„') laborTotal += e.amount || 0;
    else otherTotal += e.amount || 0;
  });
  
  const settlementTotal = salesTotal - expenseTotal;
  
  // ê³µì‚¬ë‚´ì—­ í–‰
  const workContent = salesSettlementData.works[0]?.content || projectName;
  const workSales = salesSettlementData.works[0]?.sales || salesTotal;
  
  // ë§¤ì…ë‚´ì—­ í–‰
  let expenseRows = '';
  salesSettlementData.expenses.forEach((e, i) => {
    expenseRows += `<tr>
      <td class="text-center">${e.type}</td>
      <td>${e.content || '-'}</td>
      <td class="text-right">${fmt(e.amount)}</td>
      <td class="text-center">${e.payDate || '-'}</td>
      <td>${e.note || ''}</td>
    </tr>`;
  });
  
  const printContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>ì˜ì—…ë‹´ë‹¹ììš© ì •ì‚°ì„œ</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Malgun Gothic', sans-serif; font-size: 12px; padding: 30px; }
        
        h1 { text-align: center; font-size: 22px; margin-bottom: 5px; color: #7b1fa2; }
        .subtitle { text-align: center; font-size: 14px; color: #9c27b0; margin-bottom: 20px; }
        
        .header-section { display: flex; justify-content: space-between; margin-bottom: 20px; padding: 15px; background: #f3e5f5; border-radius: 5px; }
        .header-left, .header-right { font-size: 11px; }
        .header-left .label, .header-right .label { color: #666; }
        .header-left .value, .header-right .value { font-weight: 600; margin-left: 5px; }
        
        .section-title { font-size: 12px; font-weight: 700; margin: 15px 0 8px 0; padding-bottom: 3px; border-bottom: 2px solid #9c27b0; color: #7b1fa2; }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; font-size: 10px; }
        th { background: #f5f5f5; font-weight: 600; text-align: center; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        
        .subtotal { background: #f3e5f5; }
        .total-row { background: #9c27b0; color: white; font-weight: 700; }
        
        .summary-box { margin-top: 20px; padding: 20px; background: #f3e5f5; border-radius: 5px; border: 2px solid #9c27b0; }
        .summary-title { font-size: 14px; font-weight: 700; margin-bottom: 15px; text-align: center; color: #7b1fa2; }
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center; }
        .summary-item .label { font-size: 10px; color: #666; margin-bottom: 3px; }
        .summary-item .value { font-size: 18px; font-weight: 700; }
        .profit-positive { color: #2e7d32; }
        .profit-negative { color: #c62828; }
        
        .note-box { margin-top: 15px; padding: 10px; background: #fff8e1; border-radius: 5px; font-size: 9px; color: #f57c00; }
        .memo-box { margin-top: 15px; padding: 10px; background: #e8f5e9; border-radius: 5px; font-size: 10px; }
        
        .footer { margin-top: 30px; text-align: center; font-size: 10px; color: #999; border-top: 1px solid #ddd; padding-top: 15px; }
        
        @media print { body { margin: 0; padding: 20px; } }
      </style>
    </head>
    <body>
      <h1>ê³µì‚¬ ì •ì‚°ì„œ</h1>
      <div class="subtitle">[ ì˜ì—…ë‹´ë‹¹ììš© ]</div>
      
      <div class="header-section">
        <div class="header-left">
          <div><span class="label">ê³µì‚¬í˜„ì¥:</span> <span class="value">${siteName}</span></div>
          <div><span class="label">ê³µì‚¬ëª…:</span> <span class="value">${workContent}</span></div>
        </div>
        <div class="header-right">
          <div><span class="label">ì˜ì—…ë‹´ë‹¹ì:</span> <span class="value" style="color:#7b1fa2;font-size:14px;">${salesManager || '-'}</span></div>
          <div><span class="label">í˜„ì¥ì†Œì¥:</span> <span class="value">${fieldManager || '-'}</span></div>
          <div><span class="label">ì‘ì„±ì¼:</span> <span class="value">${new Date().toLocaleDateString('ko-KR')}</span></div>
        </div>
      </div>
      
      <!-- ê³µì‚¬ ë‚´ì—­ -->
      <div class="section-title">ğŸ“‹ ê³µì‚¬ ë‚´ì—­ (ë§¤ì¶œ)</div>
      <table>
        <thead>
          <tr>
            <th style="width:80px;">êµ¬ë¶„</th>
            <th>ë‚´ìš©</th>
            <th style="width:150px;">ë§¤ì¶œì•¡</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="text-center">ê³µì‚¬ì¢…ë¥˜</td>
            <td>${workContent || '-'}</td>
            <td class="text-right" style="font-weight:600;color:#1976d2;">${fmt(workSales)}</td>
          </tr>
          <tr class="subtotal">
            <td colspan="2" class="text-right"><strong>ë§¤ì¶œ ì†Œê³„</strong></td>
            <td class="text-right"><strong>${fmt(salesTotal)}</strong></td>
          </tr>
        </tbody>
      </table>
      
      <!-- ë§¤ì… ë‚´ì—­ -->
      <div class="section-title">ğŸ“¦ ë§¤ì… ë‚´ì—­</div>
      <table>
        <thead>
          <tr>
            <th style="width:80px;">êµ¬ë¶„</th>
            <th>ë‚´ìš©</th>
            <th style="width:120px;">ê¸ˆì•¡</th>
            <th style="width:90px;">ì§€ê¸‰ì¼</th>
            <th>ë¹„ê³ </th>
          </tr>
        </thead>
        <tbody>
          ${expenseRows}
          <tr class="subtotal">
            <td colspan="2" class="text-right"><strong>ë§¤ì… ì†Œê³„</strong></td>
            <td class="text-right"><strong>${fmt(expenseTotal)}</strong></td>
            <td colspan="2"></td>
          </tr>
        </tbody>
      </table>
      
      <!-- ì •ì‚° ìš”ì•½ -->
      <div class="summary-box">
        <div class="summary-title">ğŸ’° ì •ì‚° ìš”ì•½</div>
        <div class="summary-grid">
          <div class="summary-item">
            <div class="label">ë§¤ì¶œì•¡</div>
            <div class="value" style="color:#1976d2;">${fmt(salesTotal)}</div>
          </div>
          <div class="summary-item">
            <div class="label">ë§¤ì…ì•¡</div>
            <div class="value" style="color:#c62828;">${fmt(expenseTotal)}</div>
          </div>
          <div class="summary-item">
            <div class="label">ì •ì‚°ê¸ˆì•¡ (ì´ìµ)</div>
            <div class="value ${settlementTotal >= 0 ? 'profit-positive' : 'profit-negative'}">${fmt(settlementTotal)}</div>
          </div>
        </div>
        <div style="margin-top:15px;display:grid;grid-template-columns:repeat(3,1fr);gap:10px;text-align:center;font-size:9px;color:#666;">
          <div>ìì¬ë¹„: ${fmt(materialTotal)}</div>
          <div>ë…¸ë¬´ë¹„: ${fmt(laborTotal)}</div>
          <div>ê¸°íƒ€ê²½ë¹„: ${fmt(otherTotal)}</div>
        </div>
      </div>
      
      ${memo ? `
      <div class="memo-box">
        <strong>ğŸ“ ë¹„ê³ </strong><br>
        ${memo.replace(/\n/g, '<br>')}
      </div>
      ` : ''}
      
      <div class="note-box">
        <strong>â€» ì°¸ê³ ì‚¬í•­</strong><br>
        - ë³¸ ì •ì‚°ì„œëŠ” ì˜ì—…ë‹´ë‹¹ììš©ìœ¼ë¡œ, ì „ì²´ ê³µì‚¬ ìˆ˜ìµ í˜„í™©ì…ë‹ˆë‹¤.<br>
        - ì •ì‚°ê¸ˆì•¡ = ë§¤ì¶œì•¡ - ë§¤ì…ì•¡ (ìì¬ë¹„ + ë…¸ë¬´ë¹„ + ê¸°íƒ€ê²½ë¹„)
      </div>
      
      <div class="footer">
        <p>ãˆœì„ë¯¼ì´ì•¤ì”¨ | ${new Date().toLocaleDateString('ko-KR')} ì¶œë ¥</p>
      </div>
      
      <script>window.onload = function() { window.print(); }<\/script>
    </body>
    </html>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(printContent);
  printWindow.document.close();
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`;
}

// ========== ì´ê´„í‘œ ì—‘ì…€ ì—…ë¡œë“œ ==========
function handleSummaryUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
      
      // ì´ê´„í‘œ ì‹œíŠ¸ ì°¾ê¸°
      let summarySheet = wb.Sheets['ì´ê´„í‘œ'];
      if (!summarySheet) {
        // ì²«ë²ˆì§¸ ì‹œíŠ¸ ì‚¬ìš©
        summarySheet = wb.Sheets[wb.SheetNames[0]];
      }
      
      const data = XLSX.utils.sheet_to_json(summarySheet, { header: 1, defval: '' });
      
      // ë°ì´í„° íŒŒì‹±
      parseSummaryData(data);
      
      showToast('ì´ê´„í‘œë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'success');
    } catch(err) {
      console.error(err);
      showToast('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
  };
  reader.readAsArrayBuffer(file);
  event.target.value = '';
}

function parseSummaryData(data) {
  // ì´ê´„í‘œ êµ¬ì¡° ë¶„ì„ ê²°ê³¼:
  // Row 1 (index 0): ê³µì‚¬í˜„ì¥ (ì—´ 9)
  // Row 3 (index 2): ê³µì‚¬ëª… (ì—´ 2), ê³µì‚¬ê¸°ê°„ (ì—´ 9)
  // Row 5 (index 4): ê³„ì•½ê¸ˆì•¡ (ì—´ 0)
  // Row 7 (index 6): ê³„ì•½ë‹´ë‹¹ì (ì—´ 20)
  // Row 8 (index 7): ë³¸ì‚¬ë‹´ë‹¹ì (ì—´ 20)
  // Row 9 (index 8): í˜„ì¥ë‹´ë‹¹ì (ì—´ 20), ì†Œì¥ (ì—´ 17)
  
  let siteName = '', projectName = '', period = '', amount = 0;
  let hqManager = '', siteManagerName = '', contractManager = '';
  
  // Row 1: ê³µì‚¬í˜„ì¥
  if (data[0]) {
    for (let j = 8; j < data[0].length; j++) {
      if (data[0][j] && String(data[0][j]).trim() && !String(data[0][j]).includes('ê³µì‚¬í˜„ì¥')) {
        siteName = String(data[0][j]).trim();
        break;
      }
    }
  }
  
  // Row 3: ê³µì‚¬ëª…, ê³µì‚¬ê¸°ê°„
  if (data[2]) {
    // ê³µì‚¬ëª… (ì—´ 2 ê·¼ì²˜)
    for (let j = 1; j < 8; j++) {
      if (data[2][j] && String(data[2][j]).trim() && !String(data[2][j]).includes('ê³µì‚¬ëª…') && !String(data[2][j]).includes('ê³µì‚¬ê¸°ê°„')) {
        projectName = String(data[2][j]).trim();
        break;
      }
    }
    // ê³µì‚¬ê¸°ê°„ (ì—´ 9 ê·¼ì²˜)
    for (let j = 8; j < 15; j++) {
      const cell = String(data[2][j] || '');
      if (cell.includes('ë…„') && cell.includes('ì›”')) {
        period = cell.replace('ê³µì‚¬ê¸°ê°„ :', '').replace('ê³µì‚¬ê¸°ê°„:', '').trim();
        break;
      }
    }
  }
  
  // Row 5: ê³„ì•½ê¸ˆì•¡
  if (data[4] && data[4][0]) {
    const val = parseFloat(data[4][0]);
    if (!isNaN(val) && val > 0) {
      amount = val;
    }
  }
  
  // Row 6: ì†Œì¥ ì •ë³´ (ì—´ 17)
  if (data[5]) {
    const row6Str = data[5].join(' ');
    const soMatch = row6Str.match(/ì†Œì¥[:\s]*([ê°€-í£]+)/);
    if (soMatch) siteManagerName = soMatch[1];
  }
  
  // Row 7: ê³„ì•½ë‹´ë‹¹ì (ì—´ 20)
  if (data[6] && data[6][20]) {
    contractManager = String(data[6][20]).trim();
  }
  
  // Row 8: ë³¸ì‚¬ë‹´ë‹¹ì (ì—´ 20)
  if (data[7] && data[7][20]) {
    hqManager = String(data[7][20]).trim();
  }
  
  // Row 9: í˜„ì¥ë‹´ë‹¹ì (ì—´ 20)
  let fieldManager = '';
  if (data[8] && data[8][20]) {
    fieldManager = String(data[8][20]).trim();
  }
  
  // ëŒ€ì²´ ë°©ë²•: í‚¤ì›Œë“œë¡œ ê²€ìƒ‰
  for (let i = 0; i < Math.min(15, data.length); i++) {
    const row = data[i];
    if (!row) continue;
    
    for (let j = 0; j < row.length; j++) {
      const cell = String(row[j] || '');
      
      if (cell.includes('ë³¸ì‚¬ë‹´ë‹¹ì') && row[j+1]) {
        hqManager = String(row[j+1]).trim();
      }
      if (cell.includes('í˜„ì¥ë‹´ë‹¹ì') && row[j+1]) {
        fieldManager = String(row[j+1]).trim();
      }
      if (cell.includes('ê³„ì•½ë‹´ë‹¹ì') && row[j+1]) {
        contractManager = String(row[j+1]).trim();
      }
      if (cell.includes('ì†Œì¥:') || cell.includes('ì†Œì¥ :')) {
        siteManagerName = cell.replace(/ì†Œì¥\s*:\s*/, '').trim();
      }
    }
  }
  
  console.log('íŒŒì‹± ê²°ê³¼:', { siteName, projectName, period, amount, hqManager, siteManagerName, fieldManager });
  
  // ì…ë ¥ í•„ë“œì— ì±„ìš°ê¸°
  if (siteName) document.getElementById('detail_site_input').value = siteName;
  if (projectName) document.getElementById('detail_project_input').value = projectName;
  if (period) document.getElementById('detail_period_input').value = period;
  if (amount) document.getElementById('detail_amount_input').value = amount;
  if (siteManagerName) document.getElementById('detail_site_manager').value = siteManagerName;
  // ì˜ì—…ë‹´ë‹¹ìëŠ” ê³µì‚¬í˜„í™© ëª©ë¡ì˜ ê°’ì„ ìœ ì§€ (ì´ê´„í‘œì˜ ë³¸ì‚¬ë‹´ë‹¹ìë¡œ ë®ì–´ì“°ì§€ ì•ŠìŒ)
  // if (hqManager) document.getElementById('detail_hq_manager').value = hqManager;
  if (fieldManager) document.getElementById('detail_field_manager').value = fieldManager;
  
  // ì •ì‚°ì„œ ë‹´ë‹¹ì ì •ë³´ë„ ì±„ìš°ê¸° (ì˜ì—…ë‹´ë‹¹ìëŠ” ê¸°ì¡´ ê°’ ìœ ì§€)
  // if (hqManager) document.getElementById('settlement_sales').value = hqManager;
  if (siteManagerName || fieldManager) document.getElementById('settlement_field').value = siteManagerName || fieldManager;
  
  // ìˆ˜ê¸ˆë‚´ì—­ íŒŒì‹±
  parsePaymentData(data);
  
  // íˆ¬ì…ë‚´ì—­ íŒŒì‹±
  parseExpenseData(data);
  
  // í•©ê³„ ì—…ë°ì´íŠ¸
  updateDetailTotals();
}

function parsePaymentData(data) {
  // ìˆ˜ê¸ˆë‚´ì—­ ì—´ ìœ„ì¹˜: 0(ë…„), 1(ì›”), 2(ì¼), 3(ê¸ˆì•¡), 4(ë‚´ìš©)
  // ë°ì´í„° ì‹œì‘: í–‰ 10 (index 10)
  
  const startRow = 10;
  let payments = [];
  
  for (let i = startRow; i < Math.min(startRow + 15, data.length); i++) {
    const row = data[i];
    if (!row) continue;
    
    const year = row[0], month = row[1], day = row[2], payAmt = row[3], note = row[4];
    
    // í•©ê³„ í–‰ì´ë©´ ì¤‘ë‹¨
    if (String(row[0]).includes('í•©ê³„')) break;
    
    // ê¸ˆì•¡ì´ ìˆëŠ” í–‰ë§Œ ì²˜ë¦¬ (ìˆ˜ì‹ì´ê±°ë‚˜ ìˆ«ì)
    let amt = 0;
    if (payAmt) {
      if (typeof payAmt === 'string' && payAmt.startsWith('=')) {
        // ìˆ˜ì‹ì¸ ê²½ìš° - ê±´ë„ˆë›°ê¸° (ì‹¤ì œ ê°’ì´ í•„ìš”)
        continue;
      }
      amt = parseFloat(payAmt);
    }
    
    if (amt > 0) {
      let y, m, d;
      
      // ë…„ë„ ì²˜ë¦¬
      if (year && !isNaN(parseInt(year))) {
        y = parseInt(year) > 100 ? parseInt(year) : 2000 + parseInt(year);
      } else if (payments.length > 0) {
        // ì´ì „ í–‰ì˜ ë…„ë„ ì‚¬ìš©
        y = new Date(payments[payments.length - 1].date).getFullYear();
      } else {
        y = new Date().getFullYear();
      }
      
      m = parseInt(month);
      d = parseInt(day);
      
      if (!isNaN(m) && !isNaN(d) && amt > 0) {
        payments.push({
          date: `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`,
          amount: amt,
          note: String(note || '').trim()
        });
      }
    }
  }
  
  console.log('ìˆ˜ê¸ˆë‚´ì—­ íŒŒì‹±:', payments);
  
  // ìˆ˜ê¸ˆë‚´ì—­ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
  document.getElementById('åcontract_date').value = '';
  document.getElementById('åcontract_amt').value = '';
  document.getElementById('åcontract_note').value = '';
  document.getElementById('åinterim_date').value = '';
  document.getElementById('åinterim_amt').value = '';
  document.getElementById('åinterim_note').value = '';
  document.getElementById('åinterim2_date').value = '';
  document.getElementById('åinterim2_amt').value = '';
  document.getElementById('åinterim2_note').value = '';
  document.getElementById('åbalance_date').value = '';
  document.getElementById('åbalance_amt').value = '';
  document.getElementById('åbalance_note').value = '';
  document.getElementById('åetc_date').value = '';
  document.getElementById('åetc_amt').value = '';
  document.getElementById('åetc_note').value = '';
  document.getElementById('åetc2_date').value = '';
  document.getElementById('åetc2_amt').value = '';
  document.getElementById('åetc2_note').value = '';
  
  // ë‚´ìš©ì— ë”°ë¼ ë¶„ë¥˜
  let contractSet = false, interim1Set = false, interim2Set = false, balanceSet = false, etc1Set = false, etc2Set = false;
  
  payments.forEach(p => {
    const noteLC = p.note.toLowerCase();
    
    if ((noteLC.includes('ê³„ì•½') || noteLC.includes('ì„ ê¸‰')) && !contractSet) {
      document.getElementById('åcontract_date').value = p.date;
      document.getElementById('åcontract_amt').value = p.amount;
      document.getElementById('åcontract_note').value = p.note;
      contractSet = true;
    } else if ((noteLC.includes('ì¤‘ë„') || noteLC.includes('2ì°¨') || noteLC.includes('50%')) && !interim1Set) {
      document.getElementById('åinterim_date').value = p.date;
      document.getElementById('åinterim_amt').value = p.amount;
      document.getElementById('åinterim_note').value = p.note;
      interim1Set = true;
    } else if ((noteLC.includes('ì”ê¸ˆ') || noteLC.includes('30%') || noteLC.includes('ë§ˆì§€ë§‰')) && !balanceSet) {
      document.getElementById('åbalance_date').value = p.date;
      document.getElementById('åbalance_amt').value = p.amount;
      document.getElementById('åbalance_note').value = p.note;
      balanceSet = true;
    } else {
      // ê¸°íƒ€ë¡œ ë¶„ë¥˜
      if (!etc1Set) {
        document.getElementById('åetc_date').value = p.date;
        document.getElementById('åetc_amt').value = p.amount;
        document.getElementById('åetc_note').value = p.note;
        etc1Set = true;
      } else if (!etc2Set) {
        document.getElementById('åetc2_date').value = p.date;
        document.getElementById('åetc2_amt').value = p.amount;
        document.getElementById('åetc2_note').value = p.note;
        etc2Set = true;
      }
    }
  });
  
  // ìˆœì„œëŒ€ë¡œ ë°°ì¹˜ë˜ì§€ ì•Šì€ ê²½ìš° (ê¸°ë³¸ ìˆœì„œ)
  if (!contractSet && !interim1Set && !balanceSet) {
    if (payments[0]) {
      document.getElementById('åcontract_date').value = payments[0].date;
      document.getElementById('åcontract_amt').value = payments[0].amount;
      document.getElementById('åcontract_note').value = payments[0].note;
    }
    if (payments[1]) {
      document.getElementById('åinterim_date').value = payments[1].date;
      document.getElementById('åinterim_amt').value = payments[1].amount;
      document.getElementById('åinterim_note').value = payments[1].note;
    }
    if (payments[2]) {
      document.getElementById('åbalance_date').value = payments[2].date;
      document.getElementById('åbalance_amt').value = payments[2].amount;
      document.getElementById('åbalance_note').value = payments[2].note;
    }
    if (payments[3]) {
      document.getElementById('åetc_date').value = payments[3].date;
      document.getElementById('åetc_amt').value = payments[3].amount;
      document.getElementById('åetc_note').value = payments[3].note;
    }
    if (payments[4]) {
      document.getElementById('åetc2_date').value = payments[4].date;
      document.getElementById('åetc2_amt').value = payments[4].amount;
      document.getElementById('åetc2_note').value = payments[4].note;
    }
  }
}

function parseExpenseData(data) {
  // íˆ¬ì…ë‚´ì—­ í…Œì´ë¸” ì´ˆê¸°í™”
  document.getElementById('expenseTableBody').innerHTML = '';
  
  // í—¤ë”ì—ì„œ ì—´ ìœ„ì¹˜ ìë™ ê°ì§€
  const headerRow = data[8];
  let hasPayDateCol = false;
  let otherExpenseCol = -1;  // ê¸°íƒ€ê²½ë¹„ í—¤ë” ìœ„ì¹˜
  let laborCol_header = -1;   // ë…¸ë¬´ë¹„ í—¤ë” ìœ„ì¹˜
  let materialCol_header = -1; // ìì¬ë¹„ í—¤ë” ìœ„ì¹˜
  
  if (headerRow) {
    for (let j = 0; j < headerRow.length; j++) {
      const cell = String(headerRow[j] || '');
      if (cell.includes('ì§€ê¸‰ì¼') || cell.includes('ì§€ê¸‰')) {
        hasPayDateCol = true;
        console.log('ì§€ê¸‰ì¼ ì—´ ë°œê²¬:', j);
      }
      if (cell.includes('ê¸°íƒ€') && cell.includes('ê²½ë¹„')) {
        otherExpenseCol = j;
        console.log('ê¸°íƒ€ê²½ë¹„ í—¤ë” ìœ„ì¹˜:', j);
      }
      if (cell.includes('ë…¸') && cell.includes('ë¬´') && cell.includes('ë¹„')) {
        laborCol_header = j;
        console.log('ë…¸ë¬´ë¹„ í—¤ë” ìœ„ì¹˜:', j);
      }
      if (cell.includes('ì') && cell.includes('ì¬') && cell.includes('ë¹„')) {
        materialCol_header = j;
        console.log('ìì¬ë¹„ í—¤ë” ìœ„ì¹˜:', j);
      }
    }
  }
  
  // ì—´ ìœ„ì¹˜ ì„¤ì •
  let materialCol, laborCol, otherCol;
  
  if (hasPayDateCol) {
    // ì§€ê¸‰ì¼ ìˆëŠ” ì–‘ì‹
    materialCol = { month: 5, day: 6, amt: 7, content: 8, payDate: 9 };
    laborCol = { month: 10, day: 11, amt: 12, content: 13, payDate: 14 };
    otherCol = { month: 15, day: 16, amt: 17, content: 18, payDate: 19 };
  } else {
    // ì§€ê¸‰ì¼ ì—†ëŠ” ì–‘ì‹ - ê¸°íƒ€ê²½ë¹„ í—¤ë” ìœ„ì¹˜ ê¸°ì¤€ìœ¼ë¡œ ì„¤ì •
    materialCol = { month: 5, day: 6, amt: 7, content: 8, payDate: -1 };
    laborCol = { month: 9, day: 10, amt: 11, content: 12, payDate: -1 };
    
    // ê¸°íƒ€ê²½ë¹„ í—¤ë” ìœ„ì¹˜ì— ë”°ë¼ ì—´ ì„¤ì •
    if (otherExpenseCol === 15) {
      // í•œêµ­ì•„ë¸ë¦¬ì›€ íƒ€ì…: ê¸°íƒ€ê²½ë¹„ í—¤ë”ê°€ ì—´ 15
      otherCol = { month: 13, day: 14, amt: 15, content: 16, payDate: -1 };
      console.log('í•œêµ­ì•„ë¸ë¦¬ì›€ íƒ€ì… ì–‘ì‹ ê°ì§€');
    } else if (otherExpenseCol === 16) {
      // í•œë¼ë¹„ë°œë”” íƒ€ì…: ê¸°íƒ€ê²½ë¹„ í—¤ë”ê°€ ì—´ 16
      otherCol = { month: 14, day: 15, amt: 16, content: 17, payDate: -1 };
      console.log('í•œë¼ë¹„ë°œë”” íƒ€ì… ì–‘ì‹ ê°ì§€');
    } else {
      // ê¸°ë³¸ê°’ (ê¸°íƒ€ê²½ë¹„ í—¤ë” ìœ„ì¹˜ - 2 = ì›” ì—´)
      const baseCol = otherExpenseCol > 0 ? otherExpenseCol : 15;
      otherCol = { month: baseCol - 2, day: baseCol - 1, amt: baseCol, content: baseCol + 1, payDate: -1 };
      console.log('ê¸°íƒ€ê²½ë¹„ ì—´ ìë™ ê³„ì‚°:', otherCol);
    }
  }
  
  console.log('ì§€ê¸‰ì¼ ì—´ ì¡´ì¬:', hasPayDateCol);
  console.log('ê¸°íƒ€ê²½ë¹„ í—¤ë” ì—´:', otherExpenseCol);
  console.log('ìµœì¢… ì—´ ìœ„ì¹˜:', { materialCol, laborCol, otherCol });
  
  // ë°ì´í„° ì‹œì‘ í–‰ ì°¾ê¸° (í–‰ 10ë¶€í„°)
  const startRow = 10;
  
  // ë…„ë„ ì¶”ì • (ìˆ˜ê¸ˆë‚´ì—­ì˜ ì²«ë²ˆì§¸ ë…„ë„ ì‚¬ìš©)
  let baseYear = new Date().getFullYear();
  if (data[10] && data[10][0]) {
    const y = parseInt(data[10][0]);
    if (!isNaN(y)) {
      baseYear = y > 100 ? y : 2000 + y;
    }
  }
  
  // ì§€ê¸‰ì¼ íŒŒì‹± í—¬í¼ í•¨ìˆ˜
  function parsePayDate(raw) {
    if (!raw) return '';
    
    // Date ê°ì²´ì¸ ê²½ìš°
    if (raw instanceof Date) {
      return raw.toISOString().split('T')[0];
    }
    
    // ë¬¸ìì—´ì´ê³  ë‚ ì§œ í˜•ì‹ì¸ ê²½ìš°
    if (typeof raw === 'string' && raw.includes('-')) {
      return raw.split(' ')[0];  // "2025-10-31 00:00:00" â†’ "2025-10-31"
    }
    
    // Excel ì‹œë¦¬ì–¼ ë²ˆí˜¸ì¸ ê²½ìš° (ìˆ«ì)
    if (typeof raw === 'number' && raw > 40000 && raw < 60000) {
      // Excel ë‚ ì§œë¥¼ JavaScript Dateë¡œ ë³€í™˜
      // Excelì€ 1900-01-01ì„ 1ë¡œ ê³„ì‚° (1900ë…„ ìœ¤ë…„ ë²„ê·¸ í¬í•¨)
      const excelEpoch = new Date(1899, 11, 30);  // 1899-12-30
      const jsDate = new Date(excelEpoch.getTime() + raw * 24 * 60 * 60 * 1000);
      return jsDate.toISOString().split('T')[0];
    }
    
    return '';
  }
  
  // ìì¬ë¹„ íŒŒì‹±
  for (let i = startRow; i < data.length; i++) {
    const row = data[i];
    if (!row) continue;
    if (String(row[0]).includes('í•©ê³„')) break;
    
    const month = row[materialCol.month], day = row[materialCol.day];
    const amt = row[materialCol.amt], content = row[materialCol.content];
    const payDateRaw = materialCol.payDate >= 0 ? row[materialCol.payDate] : null;
    
    // ì²« ë²ˆì§¸ í–‰ë§Œ ë””ë²„ê¹…
    if (i === startRow) {
      console.log('=== ìì¬ë¹„ ì²« í–‰ ë””ë²„ê¹… ===');
      console.log('materialCol:', materialCol);
      console.log('row[' + materialCol.payDate + ']:', row[materialCol.payDate]);
      console.log('payDateRaw:', payDateRaw);
    }
    
    if (amt) {
      // ìˆ˜ì‹ì´ë©´ ê±´ë„ˆë›°ê¸°
      if (typeof amt === 'string' && amt.startsWith('=')) continue;
      
      const amount = parseFloat(amt);
      
      // ê¸ˆì•¡ì˜ ì ˆëŒ€ê°’ì´ 1000 ì´ìƒì¸ ê²ƒë§Œ (ì›”/ì¼ ê°’ê³¼ êµ¬ë¶„, ë§ˆì´ë„ˆìŠ¤ ê¸ˆì•¡ë„ í¬í•¨)
      if (!isNaN(amount) && Math.abs(amount) >= 1000) {
        let date = '';
        const m = parseInt(month);
        const d = parseInt(day);
        if (!isNaN(m) && !isNaN(d) && m >= 1 && m <= 12 && d >= 1 && d <= 31) {
          date = `${baseYear}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        }
        
        const payDate = parsePayDate(payDateRaw);
        if (i === startRow) {
          console.log('parsePayDate ê²°ê³¼:', payDate);
        }
        addExpenseRow('ìì¬ë¹„', { date, amount, content: String(content || '').trim(), payDate });
      }
    }
  }
  
  // ë…¸ë¬´ë¹„ íŒŒì‹±
  for (let i = startRow; i < data.length; i++) {
    const row = data[i];
    if (!row) continue;
    if (String(row[0]).includes('í•©ê³„')) break;
    
    const month = row[laborCol.month], day = row[laborCol.day];
    const amt = row[laborCol.amt], content = row[laborCol.content];
    const payDateRaw = laborCol.payDate >= 0 ? row[laborCol.payDate] : null;
    
    if (amt) {
      if (typeof amt === 'string' && amt.startsWith('=')) continue;
      
      const amount = parseFloat(amt);
      
      // ê¸ˆì•¡ì˜ ì ˆëŒ€ê°’ì´ 1000 ì´ìƒì¸ ê²ƒë§Œ (ë§ˆì´ë„ˆìŠ¤ ê¸ˆì•¡ë„ í¬í•¨)
      if (!isNaN(amount) && Math.abs(amount) >= 1000) {
        let date = '';
        const m = parseInt(month);
        const d = parseInt(day);
        if (!isNaN(m) && !isNaN(d) && m >= 1 && m <= 12 && d >= 1 && d <= 31) {
          date = `${baseYear}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        }
        
        const payDate = parsePayDate(payDateRaw);
        addExpenseRow('ë…¸ë¬´ë¹„', { date, amount, content: String(content || '').trim(), payDate });
      }
    }
  }
  
  // ê¸°íƒ€ê²½ë¹„ íŒŒì‹±
  console.log('=== ê¸°íƒ€ê²½ë¹„ íŒŒì‹± ì‹œì‘ ===');
  console.log('otherCol:', otherCol);
  for (let i = startRow; i < data.length; i++) {
    const row = data[i];
    if (!row) continue;
    if (String(row[0]).includes('í•©ê³„')) break;
    
    const month = row[otherCol.month], day = row[otherCol.day];
    const amt = row[otherCol.amt], content = row[otherCol.content];
    const payDateRaw = otherCol.payDate >= 0 ? row[otherCol.payDate] : null;
    
    // ë””ë²„ê·¸: ê¸°íƒ€ê²½ë¹„ ì—´ ê°’ ì¶œë ¥
    if (i <= startRow + 5) {
      console.log(`Row ${i}: month=${month}, day=${day}, amt=${amt}, content=${content}`);
    }
    
    if (amt) {
      if (typeof amt === 'string' && amt.startsWith('=')) continue;
      
      const amount = parseFloat(amt);
      
      // ê¸ˆì•¡ì˜ ì ˆëŒ€ê°’ì´ 100 ì´ìƒì¸ ê²ƒë§Œ (ê¸°íƒ€ê²½ë¹„ëŠ” ì†Œì•¡ ê°€ëŠ¥, ë§ˆì´ë„ˆìŠ¤ ê¸ˆì•¡ë„ í¬í•¨)
      if (!isNaN(amount) && Math.abs(amount) >= 100) {
        let date = '';
        const m = parseInt(month);
        const d = parseInt(day);
        if (!isNaN(m) && !isNaN(d) && m >= 1 && m <= 12 && d >= 1 && d <= 31) {
          date = `${baseYear}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        }
        
        const payDate = parsePayDate(payDateRaw);
        console.log(`ê¸°íƒ€ê²½ë¹„ ì¶”ê°€: date=${date}, amount=${amount}, content=${content}`);
        addExpenseRow('ê¸°íƒ€ê²½ë¹„', { date, amount, content: String(content || '').trim(), payDate });
      }
    }
  }
  
  console.log('íˆ¬ì…ë‚´ì—­ íŒŒì‹± ì™„ë£Œ');
}

// ========== ì´ê´„í‘œ ì¼ê´„ ì—…ë¡œë“œ ==========
async function handleBulkSummaryUpload(event) {
  const files = event.target.files;
  if (!files || files.length === 0) return;
  
  const results = {
    success: [],
    skipped: [],
    notFound: [],
    error: [],
    uploadDate: new Date().toLocaleString('ko-KR')
  };
  
  // ì „ì²´ ë…„ë„ ë°ì´í„°ì—ì„œ í˜„ì¥ëª…ë³„ ë§µ ìƒì„±
  const siteMap = {};
  Object.keys(allData).forEach(year => {
    const yearData = allData[year] || [];
    yearData.forEach((item, idx) => {
      const siteName = item.site || '';
      if (!siteMap[siteName]) {
        siteMap[siteName] = [];
      }
      siteMap[siteName].push({ idx, item, year });
    });
  });
  
  showToast(`${files.length}ê°œ íŒŒì¼ ì²˜ë¦¬ ì¤‘...`, 'info');
  
  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    const fileName = file.name;
    
    try {
      // íŒŒì¼ëª…ì—ì„œ í˜„ì¥ëª… ì¶”ì¶œ: 300_25ë…„_ê³µì‚¬ë‚´ì—­ì´ê´„í‘œ_[í˜„ì¥ëª…]_ë‚ ì§œ.xlsx
      const match = fileName.match(/ì´ê´„í‘œ_(.+?)_\d+\.xlsx?$/i);
      if (!match) {
        results.error.push({ fileName, reason: 'íŒŒì¼ëª… í˜•ì‹ ë¶ˆì¼ì¹˜' });
        continue;
      }
      
      const extractedSiteName = match[1].trim();
      
      // í˜„ì¥ ì°¾ê¸° (ë¶€ë¶„ ì¼ì¹˜) - ì „ì²´ ë…„ë„ì—ì„œ ê²€ìƒ‰
      let matchedSites = [];
      for (const siteName in siteMap) {
        if (siteName.includes(extractedSiteName) || extractedSiteName.includes(siteName)) {
          matchedSites.push(...siteMap[siteName].map(s => ({ ...s, siteName })));
        }
      }
      
      if (matchedSites.length === 0) {
        results.notFound.push({ fileName, extractedSiteName });
        continue;
      }
      
      if (matchedSites.length > 1) {
        // ë™ì¼ í˜„ì¥ëª…ì´ ì—¬ëŸ¬ ê°œ â†’ ìŠ¤í‚µ
        const years = [...new Set(matchedSites.map(s => s.year))].join(', ');
        results.skipped.push({ fileName, extractedSiteName, count: matchedSites.length, reason: 'duplicate', years });
        continue;
      }
      
      // ìœ ì¼í•œ í˜„ì¥ â†’ ë°ì´í„° íŒŒì‹± ë° ì €ì¥
      const targetIdx = matchedSites[0].idx;
      const targetItem = matchedSites[0].item;
      const targetYear = matchedSites[0].year;
      
      // ì´ë¯¸ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
      const key = `${targetYear}_${targetItem.no}`;
      let hasExistingData = false;
      
      // ì „ì—­ detailDataì—ì„œ í™•ì¸
      const existingDetail = detailData[key];
      if (existingDetail && existingDetail.expenses && existingDetail.expenses.length > 0) {
        // ì‹¤ì œ ê¸ˆì•¡ì´ ì…ë ¥ëœ í•­ëª©ì´ ìˆëŠ”ì§€ í™•ì¸
        const hasRealData = existingDetail.expenses.some(e => e.amount && Math.abs(e.amount) >= 100);
        if (hasRealData) {
          hasExistingData = true;
        }
      }
      
      if (hasExistingData) {
        results.skipped.push({ fileName, extractedSiteName, siteName: targetItem.site, reason: 'exists', year: targetYear });
        continue;
      }
      
      // ì—‘ì…€ íŒŒì¼ ì½ê¸°
      const data = await readExcelFile(file);
      
      // í•´ë‹¹ í˜„ì¥ì˜ ìƒì„¸ ë°ì´í„° íŒŒì‹± ë° ì €ì¥ (í•´ë‹¹ ë…„ë„ ê¸°ì¤€)
      await processBulkSummaryData(targetIdx, targetItem, data, fileName, targetYear);
      
      results.success.push({ fileName, siteName: targetItem.site, year: targetYear });
      
    } catch (e) {
      console.error('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', fileName, e);
      results.error.push({ fileName, reason: e.message });
    }
  }
  
  // ê²°ê³¼ ì €ì¥ (ë‚˜ì¤‘ì— ë‹¤ì‹œ í™•ì¸ ê°€ëŠ¥)
  localStorage.setItem('lastBulkUploadResults', JSON.stringify(results));
  
  // ê²°ê³¼ í‘œì‹œ
  showBulkUploadResults(results);
  
  // ì…ë ¥ ì´ˆê¸°í™”
  event.target.value = '';
  
  // ì €ì¥
  saveToStorage();
  saveDetailDataToStorage();
}

function readExcelFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames.find(n => n.includes('ì´ê´„í‘œ')) || workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        resolve(jsonData);
      } catch (err) {
        reject(err);
      }
    };
    reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
    reader.readAsArrayBuffer(file);
  });
}

async function processBulkSummaryData(idx, item, data, fileName, targetYear) {
  // ê¸°ì¡´ detailData ê°€ì ¸ì˜¤ê¸° ë˜ëŠ” ì´ˆê¸°í™”
  const year = targetYear || currentYear;
  const key = `${year}_${item.no}`;
  console.log('=== processBulkSummaryData ì‹œì‘ ===');
  console.log('key:', key, 'year:', year);
  
  // ì „ì—­ detailData ê°ì²´ ì‚¬ìš©
  let detail = detailData[key] || {};
  
  // ì´ê´„í‘œ ë°ì´í„° íŒŒì‹±
  const parsed = parseBulkSummarySheet(data, item);
  console.log('íŒŒì‹± ê²°ê³¼:', parsed);
  
  // ìƒì„¸ ë°ì´í„° ë³‘í•©
  Object.assign(detail, parsed);
  console.log('ë³‘í•© í›„ detail:', detail);
  
  // ì „ì—­ detailDataì— ì €ì¥
  detailData[key] = detail;
  console.log('detailData[key] ì €ì¥ ì™„ë£Œ');
}

function parseBulkSummarySheet(data, item) {
  const result = {
    expenses: []
  };
  
  console.log('=== parseBulkSummarySheet ì‹œì‘ ===');
  console.log('item:', item?.site, item?.no);
  
  // ì—°ë„ ì¶”ì¶œ
  let baseYear = new Date().getFullYear();
  const row3 = data[2] || [];
  for (let i = 0; i < row3.length; i++) {
    const cell = String(row3[i] || '');
    const yearMatch = cell.match(/(\d{4})ë…„/);
    if (yearMatch) {
      baseYear = parseInt(yearMatch[1]);
      break;
    }
  }
  console.log('baseYear:', baseYear);
  
  // í—¤ë” ë¶„ì„ (Row 9)
  const headerRow = data[8] || [];
  console.log('headerRow:', headerRow);
  
  // ì§€ê¸‰ì¼ ì—´ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
  let hasPayDate = false;
  let payDateCol = -1;
  for (let j = 0; j < headerRow.length; j++) {
    const cell = String(headerRow[j] || '');
    if (cell.includes('ì§€ê¸‰ì¼')) {
      hasPayDate = true;
      payDateCol = j;
      break;
    }
  }
  console.log('hasPayDate:', hasPayDate, 'payDateCol:', payDateCol);
  
  // ì—´ ìœ„ì¹˜ ì„¤ì •
  let materialCol, laborCol, otherCol;
  
  if (hasPayDate) {
    materialCol = { month: 5, day: 6, amt: 7, content: 8, payDate: 9 };
    laborCol = { month: 10, day: 11, amt: 12, content: 13, payDate: 14 };
    otherCol = { month: 15, day: 16, amt: 17, content: 18, payDate: 19 };
  } else {
    materialCol = { month: 5, day: 6, amt: 7, content: 8, payDate: -1 };
    laborCol = { month: 9, day: 10, amt: 11, content: 12, payDate: -1 };
    
    // ê¸°íƒ€ê²½ë¹„ í—¤ë” ìœ„ì¹˜ ì°¾ê¸°
    let otherExpenseCol = -1;
    for (let j = 0; j < headerRow.length; j++) {
      const cell = String(headerRow[j] || '');
      if (cell.includes('ê¸°íƒ€') && cell.includes('ê²½ë¹„')) {
        otherExpenseCol = j;
      }
    }
    
    if (otherExpenseCol === 15) {
      otherCol = { month: 13, day: 14, amt: 15, content: 16, payDate: -1 };
    } else if (otherExpenseCol === 16) {
      otherCol = { month: 14, day: 15, amt: 16, content: 17, payDate: -1 };
    } else {
      const baseCol = otherExpenseCol > 0 ? otherExpenseCol : 15;
      otherCol = { month: baseCol - 2, day: baseCol - 1, amt: baseCol, content: baseCol + 1, payDate: -1 };
    }
  }
  
  const startRow = 10;
  
  // ìì¬ë¹„ íŒŒì‹±
  for (let i = startRow; i < data.length; i++) {
    const row = data[i];
    if (!row) continue;
    if (String(row[0]).includes('í•©ê³„')) break;
    
    const month = row[materialCol.month], day = row[materialCol.day];
    const amt = row[materialCol.amt], content = row[materialCol.content];
    
    if (amt && typeof amt !== 'string') {
      const amount = parseFloat(amt);
      if (!isNaN(amount) && Math.abs(amount) >= 1000) {
        let date = '';
        const m = parseInt(month), d = parseInt(day);
        if (!isNaN(m) && !isNaN(d) && m >= 1 && m <= 12 && d >= 1 && d <= 31) {
          date = `${baseYear}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        }
        console.log('ìì¬ë¹„ ì¶”ê°€:', { type: 'ìì¬ë¹„', date, amount, content: String(content || '').trim() });
        result.expenses.push({
          type: 'ìì¬ë¹„',
          date,
          amount,
          content: String(content || '').trim(),
          payDate: ''
        });
      }
    }
  }
  
  console.log('ìì¬ë¹„ íŒŒì‹± ì™„ë£Œ, expenses ìˆ˜:', result.expenses.length);
  
  // ë…¸ë¬´ë¹„ íŒŒì‹±
  for (let i = startRow; i < data.length; i++) {
    const row = data[i];
    if (!row) continue;
    if (String(row[0]).includes('í•©ê³„')) break;
    
    const month = row[laborCol.month], day = row[laborCol.day];
    const amt = row[laborCol.amt], content = row[laborCol.content];
    
    if (amt && typeof amt !== 'string') {
      const amount = parseFloat(amt);
      if (!isNaN(amount) && Math.abs(amount) >= 1000) {
        let date = '';
        const m = parseInt(month), d = parseInt(day);
        if (!isNaN(m) && !isNaN(d) && m >= 1 && m <= 12 && d >= 1 && d <= 31) {
          date = `${baseYear}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        }
        result.expenses.push({
          type: 'ë…¸ë¬´ë¹„',
          date,
          amount,
          content: String(content || '').trim(),
          payDate: ''
        });
      }
    }
  }
  
  // ê¸°íƒ€ê²½ë¹„ íŒŒì‹±
  for (let i = startRow; i < data.length; i++) {
    const row = data[i];
    if (!row) continue;
    if (String(row[0]).includes('í•©ê³„')) break;
    
    const month = row[otherCol.month], day = row[otherCol.day];
    const amt = row[otherCol.amt], content = row[otherCol.content];
    
    if (amt && typeof amt !== 'string') {
      const amount = parseFloat(amt);
      if (!isNaN(amount) && Math.abs(amount) >= 100) {
        let date = '';
        const m = parseInt(month), d = parseInt(day);
        if (!isNaN(m) && !isNaN(d) && m >= 1 && m <= 12 && d >= 1 && d <= 31) {
          date = `${baseYear}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        }
        result.expenses.push({
          type: 'ê¸°íƒ€ê²½ë¹„',
          date,
          amount,
          content: String(content || '').trim(),
          payDate: ''
        });
      }
    }
  }
  
  // ìˆ˜ê¸ˆë‚´ì—­ íŒŒì‹±
  for (let i = startRow; i < data.length; i++) {
    const row = data[i];
    if (!row) continue;
    if (String(row[0]).includes('í•©ê³„')) break;
    
    const amt = row[3], content = row[4];
    if (amt && typeof amt !== 'string') {
      const amount = parseFloat(amt);
      if (!isNaN(amount) && amount >= 100000) {
        const contentStr = String(content || '').toLowerCase();
        const m = parseInt(row[1]), d = parseInt(row[2]);
        let date = '';
        if (!isNaN(m) && !isNaN(d) && m >= 1 && m <= 12 && d >= 1 && d <= 31) {
          date = `${baseYear}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        }
        
        if (contentStr.includes('ê³„ì•½ê¸ˆ')) {
          result.contractDate = date;
          result.contractAmt = amount;
        } else if (contentStr.includes('ì¤‘ë„ê¸ˆ') && !contentStr.includes('2')) {
          result.interimDate = date;
          result.interimAmt = amount;
        } else if (contentStr.includes('ì¤‘ë„ê¸ˆ') && contentStr.includes('2')) {
          result.interim2Date = date;
          result.interim2Amt = amount;
        } else if (contentStr.includes('ì”ê¸ˆ')) {
          result.balanceDate = date;
          result.balanceAmt = amount;
        }
      }
    }
  }
  
  console.log('=== parseBulkSummarySheet ì™„ë£Œ ===');
  console.log('ì´ expenses:', result.expenses.length);
  console.log('expenses:', result.expenses);
  
  return result;
}

function showBulkUploadResults(results) {
  // ìŠ¤í‚µëœ í•­ëª© ë¶„ë¥˜
  const duplicateSkipped = results.skipped.filter(s => s.reason === 'duplicate');
  const existsSkipped = results.skipped.filter(s => s.reason === 'exists');
  
  let html = `
    <div style="max-height:70vh;overflow-y:auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
        <h3 style="margin:0;color:#333;">ğŸ“ ì´ê´„í‘œ ì¼ê´„ ì—…ë¡œë“œ ê²°ê³¼</h3>
        <span style="font-size:0.8rem;color:#888;">ğŸ• ${results.uploadDate || new Date().toLocaleString('ko-KR')}</span>
      </div>
      
      <!-- ìš”ì•½ -->
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem;margin-bottom:1.5rem;">
        <div style="background:#c8e6c9;padding:0.75rem;border-radius:8px;text-align:center;">
          <div style="font-size:1.5rem;font-weight:700;color:#2e7d32;">${results.success.length}</div>
          <div style="font-size:0.8rem;color:#388e3c;">âœ… ì—…ë¡œë“œ ì™„ë£Œ</div>
        </div>
        <div style="background:#fff3e0;padding:0.75rem;border-radius:8px;text-align:center;">
          <div style="font-size:1.5rem;font-weight:700;color:#ef6c00;">${existsSkipped.length}</div>
          <div style="font-size:0.8rem;color:#f57c00;">â­ï¸ ê¸°ì¡´ ë°ì´í„°</div>
        </div>
        <div style="background:#ffebee;padding:0.75rem;border-radius:8px;text-align:center;">
          <div style="font-size:1.5rem;font-weight:700;color:#c62828;">${results.notFound.length}</div>
          <div style="font-size:0.8rem;color:#d32f2f;">âŒ í˜„ì¥ ì—†ìŒ</div>
        </div>
        <div style="background:#e3f2fd;padding:0.75rem;border-radius:8px;text-align:center;">
          <div style="font-size:1.5rem;font-weight:700;color:#1565c0;">${duplicateSkipped.length}</div>
          <div style="font-size:0.8rem;color:#1976d2;">âš ï¸ ì¤‘ë³µ í˜„ì¥</div>
        </div>
      </div>
  `;
  
  // ì—…ë¡œë“œ ì™„ë£Œ ëª©ë¡
  if (results.success.length > 0) {
    html += `
      <div style="margin-bottom:1rem;">
        <div style="background:#2e7d32;color:white;padding:0.5rem 1rem;border-radius:8px 8px 0 0;font-weight:600;">
          âœ… ì—…ë¡œë“œ ì™„ë£Œ (${results.success.length}ê±´)
        </div>
        <div style="border:1px solid #c8e6c9;border-top:none;border-radius:0 0 8px 8px;max-height:150px;overflow-y:auto;">
          <table style="width:100%;font-size:0.85rem;border-collapse:collapse;">
            ${results.success.map((s, i) => `
              <tr style="border-bottom:1px solid #e8f5e9;">
                <td style="padding:0.4rem 0.75rem;width:30px;color:#888;">${i+1}</td>
                <td style="padding:0.4rem 0.75rem;">${s.siteName}</td>
                <td style="padding:0.4rem 0.75rem;width:60px;color:#2e7d32;font-size:0.75rem;">${s.year || ''}ë…„</td>
              </tr>
            `).join('')}
          </table>
        </div>
      </div>
    `;
  }
  
  // í˜„ì¥ ì—†ìŒ (ë¯¸ì™„ë£Œ) ëª©ë¡
  if (results.notFound.length > 0) {
    html += `
      <div style="margin-bottom:1rem;">
        <div style="background:#c62828;color:white;padding:0.5rem 1rem;border-radius:8px 8px 0 0;font-weight:600;">
          âŒ í˜„ì¥ ì—†ìŒ - ë¦¬ìŠ¤íŠ¸ì— ë¨¼ì € ì¶”ê°€ í•„ìš” (${results.notFound.length}ê±´)
        </div>
        <div style="border:1px solid #ffcdd2;border-top:none;border-radius:0 0 8px 8px;max-height:150px;overflow-y:auto;">
          <table style="width:100%;font-size:0.85rem;border-collapse:collapse;">
            ${results.notFound.map((s, i) => `
              <tr style="border-bottom:1px solid #ffebee;">
                <td style="padding:0.4rem 0.75rem;width:30px;color:#888;">${i+1}</td>
                <td style="padding:0.4rem 0.75rem;color:#c62828;font-weight:500;">${s.extractedSiteName}</td>
                <td style="padding:0.4rem 0.75rem;font-size:0.75rem;color:#888;">${s.fileName}</td>
              </tr>
            `).join('')}
          </table>
        </div>
      </div>
    `;
  }
  
  // ì¤‘ë³µ í˜„ì¥ ëª©ë¡
  if (duplicateSkipped.length > 0) {
    html += `
      <div style="margin-bottom:1rem;">
        <div style="background:#1565c0;color:white;padding:0.5rem 1rem;border-radius:8px 8px 0 0;font-weight:600;">
          âš ï¸ ë™ì¼ í˜„ì¥ëª… ì¤‘ë³µ - ìˆ˜ë™ í™•ì¸ í•„ìš” (${duplicateSkipped.length}ê±´)
        </div>
        <div style="border:1px solid #bbdefb;border-top:none;border-radius:0 0 8px 8px;max-height:150px;overflow-y:auto;">
          <table style="width:100%;font-size:0.85rem;border-collapse:collapse;">
            ${duplicateSkipped.map((s, i) => `
              <tr style="border-bottom:1px solid #e3f2fd;">
                <td style="padding:0.4rem 0.75rem;width:30px;color:#888;">${i+1}</td>
                <td style="padding:0.4rem 0.75rem;">${s.extractedSiteName}</td>
                <td style="padding:0.4rem 0.75rem;color:#1565c0;font-weight:500;">${s.count}ê±´ ì¤‘ë³µ (${s.years || ''})</td>
              </tr>
            `).join('')}
          </table>
        </div>
      </div>
    `;
  }
  
  // ê¸°ì¡´ ë°ì´í„° ìˆìŒ (ìŠ¤í‚µ) ëª©ë¡
  if (existsSkipped.length > 0) {
    html += `
      <div style="margin-bottom:1rem;">
        <div style="background:#ef6c00;color:white;padding:0.5rem 1rem;border-radius:8px 8px 0 0;font-weight:600;">
          â­ï¸ ê¸°ì¡´ ë°ì´í„° ìˆìŒ - ìŠ¤í‚µ (${existsSkipped.length}ê±´)
        </div>
        <div style="border:1px solid #ffe0b2;border-top:none;border-radius:0 0 8px 8px;max-height:150px;overflow-y:auto;">
          <table style="width:100%;font-size:0.85rem;border-collapse:collapse;">
            ${existsSkipped.map((s, i) => `
              <tr style="border-bottom:1px solid #fff3e0;">
                <td style="padding:0.4rem 0.75rem;width:30px;color:#888;">${i+1}</td>
                <td style="padding:0.4rem 0.75rem;">${s.siteName || s.extractedSiteName}</td>
              </tr>
            `).join('')}
          </table>
        </div>
      </div>
    `;
  }
  
  // ì˜¤ë¥˜ ëª©ë¡
  if (results.error.length > 0) {
    html += `
      <div style="margin-bottom:1rem;">
        <div style="background:#616161;color:white;padding:0.5rem 1rem;border-radius:8px 8px 0 0;font-weight:600;">
          ğŸš« ì˜¤ë¥˜ (${results.error.length}ê±´)
        </div>
        <div style="border:1px solid #e0e0e0;border-top:none;border-radius:0 0 8px 8px;max-height:100px;overflow-y:auto;">
          <table style="width:100%;font-size:0.85rem;border-collapse:collapse;">
            ${results.error.map((s, i) => `
              <tr style="border-bottom:1px solid #f5f5f5;">
                <td style="padding:0.4rem 0.75rem;width:30px;color:#888;">${i+1}</td>
                <td style="padding:0.4rem 0.75rem;">${s.fileName}</td>
                <td style="padding:0.4rem 0.75rem;color:#888;font-size:0.75rem;">${s.reason}</td>
              </tr>
            `).join('')}
          </table>
        </div>
      </div>
    `;
  }
  
  html += `</div>`;
  
  // ëª¨ë‹¬ë¡œ í‘œì‹œ
  showBulkResultModal(html);
  
  if (results.success.length > 0) {
    showToast(`${results.success.length}ê±´ ì´ê´„í‘œ ì—…ë¡œë“œ ì™„ë£Œ!`, 'success');
  }
}

// ì´ê´„í‘œ ì—…ë¡œë“œ ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ
function showBulkResultModal(content) {
  // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ì œê±°
  let modal = document.getElementById('bulkResultModal');
  if (modal) {
    modal.remove();
  }
  
  // ëª¨ë‹¬ ìƒì„±
  modal = document.createElement('div');
  modal.id = 'bulkResultModal';
  modal.className = 'modal active';
  modal.innerHTML = `
    <div class="modal-content" style="max-width:700px;">
      <div class="modal-header" style="background:#9c27b0;color:white;">
        <div class="modal-title">ğŸ“ ì´ê´„í‘œ ì—…ë¡œë“œ ê²°ê³¼</div>
        <button class="modal-close" onclick="closeBulkResultModal()" style="color:white;">Ã—</button>
      </div>
      <div class="modal-body">
        ${content}
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="closeBulkResultModal()">í™•ì¸</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

function closeBulkResultModal() {
  const modal = document.getElementById('bulkResultModal');
  if (modal) {
    modal.remove();
  }
}

// ì´ì „ ì´ê´„í‘œ ì—…ë¡œë“œ ê²°ê³¼ í™•ì¸
function showLastBulkUploadResults() {
  try {
    const saved = localStorage.getItem('lastBulkUploadResults');
    if (!saved) {
      showToast('ì €ì¥ëœ ì´ê´„í‘œ ì—…ë¡œë“œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.', 'info');
      return;
    }
    
    const results = JSON.parse(saved);
    showBulkUploadResults(results);
  } catch(e) {
    console.error('ê²°ê³¼ ë¡œë“œ ì‹¤íŒ¨:', e);
    showToast('ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
  }
}

// ========== ì´ê´„í‘œ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ìŠ¤íƒ€ì¼ ì ìš©) ==========
function downloadSummaryExcel() {
  const idx = document.getElementById('detailIndex').value;
  const data = allData[currentYear] || [];
  const item = data[idx];
  
  // í˜„ì¬ ì…ë ¥ëœ ë°ì´í„° ìˆ˜ì§‘
  const siteName = document.getElementById('detail_site_input').value || item?.site || '';
  const projectName = document.getElementById('detail_project_input').value || item?.name || '';
  const period = document.getElementById('detail_period_input').value || '';
  const amount = parseFloat(document.getElementById('detail_amount_input').value) || item?.amount || 0;
  const siteManager = document.getElementById('detail_site_manager').value || '';
  const hqManager = document.getElementById('detail_hq_manager').value || '';
  const fieldManager = document.getElementById('detail_field_manager').value || '';
  
  // ìˆ˜ê¸ˆë‚´ì—­ ìˆ˜ì§‘
  const contractDate = document.getElementById('åcontract_date').value;
  const contractAmt = parseFloat(document.getElementById('åcontract_amt').value) || 0;
  const contractNote = document.getElementById('åcontract_note').value;
  const interimDate = document.getElementById('åinterim_date').value;
  const interimAmt = parseFloat(document.getElementById('åinterim_amt').value) || 0;
  const interimNote = document.getElementById('åinterim_note').value;
  const interim2Date = document.getElementById('åinterim2_date').value;
  const interim2Amt = parseFloat(document.getElementById('åinterim2_amt').value) || 0;
  const interim2Note = document.getElementById('åinterim2_note').value;
  const balanceDate = document.getElementById('åbalance_date').value;
  const balanceAmt = parseFloat(document.getElementById('åbalance_amt').value) || 0;
  const balanceNote = document.getElementById('åbalance_note').value;
  const etcDate = document.getElementById('åetc_date').value;
  const etcAmt = parseFloat(document.getElementById('åetc_amt').value) || 0;
  const etcNote = document.getElementById('åetc_note').value;
  const etc2Date = document.getElementById('åetc2_date').value;
  const etc2Amt = parseFloat(document.getElementById('åetc2_amt').value) || 0;
  const etc2Note = document.getElementById('åetc2_note').value;
  const adjustDate = document.getElementById('åadjust_date').value;
  const adjustAmt = parseFloat(document.getElementById('åadjust_amt').value) || 0;
  const adjustNote = document.getElementById('åadjust_note').value;
  
  // íˆ¬ì…ë‚´ì—­ ìˆ˜ì§‘
  let materials = [], labors = [], others = [];
  let materialTotal = 0, laborTotal = 0, otherTotal = 0;
  
  document.querySelectorAll('#expenseTableBody tr').forEach(tr => {
    const typeSelect = tr.querySelector('td:nth-child(1) select');
    const inputs = tr.querySelectorAll('input');
    const type = typeSelect?.value || 'ìì¬ë¹„';
    const date = inputs[0]?.value || '';
    const amountVal = parseFloat(inputs[1]?.value) || 0;
    const content = inputs[2]?.value || '';
    const payDate = inputs[3]?.value || '';
    
    if (amountVal > 0 || content) {
      const itemData = { date, amount: amountVal, content, payDate };
      if (type === 'ìì¬ë¹„') { materials.push(itemData); materialTotal += amountVal; }
      else if (type === 'ë…¸ë¬´ë¹„') { labors.push(itemData); laborTotal += amountVal; }
      else if (type === 'ê¸°íƒ€ê²½ë¹„') { others.push(itemData); otherTotal += amountVal; }
    }
  });
  
  const expenseTotal = materialTotal + laborTotal + otherTotal;
  const balance = amount - expenseTotal;
  
  // ì›Œí¬ë¶ ìƒì„±
  const wb = XLSX.utils.book_new();
  
  // ìŠ¤íƒ€ì¼ ì •ì˜
  const borderStyle = { style: 'thin', color: { rgb: '000000' } };
  const allBorders = { top: borderStyle, bottom: borderStyle, left: borderStyle, right: borderStyle };
  const headerStyle = { 
    font: { bold: true, sz: 11 }, 
    fill: { fgColor: { rgb: 'E8E8E8' } },
    alignment: { horizontal: 'center', vertical: 'center' },
    border: allBorders
  };
  const titleStyle = { 
    font: { bold: true, sz: 14 }, 
    alignment: { horizontal: 'center', vertical: 'center' }
  };
  const cellStyle = { 
    border: allBorders,
    alignment: { vertical: 'center' }
  };
  const numStyle = { 
    border: allBorders,
    alignment: { horizontal: 'right', vertical: 'center' },
    numFmt: '#,##0'
  };
  const pctStyle = { 
    border: allBorders,
    alignment: { horizontal: 'right', vertical: 'center' }
  };
  
  // ===== ì´ê´„í‘œ ì‹œíŠ¸ =====
  const ws1 = XLSX.utils.aoa_to_sheet([]);
  
  // ì œëª©
  XLSX.utils.sheet_add_aoa(ws1, [['ì´  ê´„  í‘œ']], { origin: 'C1' });
  ws1['C1'].s = titleStyle;
  
  // ê¸°ë³¸ ì •ë³´
  XLSX.utils.sheet_add_aoa(ws1, [
    ['ê³µì‚¬í˜„ì¥:', siteName, '', '', '', 'ê³µì‚¬ê¸ˆì•¡(VATë³„ë„):', amount.toLocaleString() + 'ì›'],
    ['ê³µì‚¬ëª…:', projectName, '', '', '', 'ê³µì‚¬ê¸°ê°„:', period]
  ], { origin: 'A3' });
  
  // ìš”ì•½ í…Œì´ë¸” í—¤ë”
  XLSX.utils.sheet_add_aoa(ws1, [
    ['êµ¬ë¶„', 'ê³„ì•½ê¸ˆì•¡', 'ìì¬ë¹„', 'ë…¸ë¬´ë¹„', 'ê¸°íƒ€ê²½ë¹„', 'ì§€ì¶œê³„', 'ì”ì•¡', 'ë‹´ë‹¹']
  ], { origin: 'A6' });
  
  // ìš”ì•½ í…Œì´ë¸” ë°ì´í„°
  XLSX.utils.sheet_add_aoa(ws1, [
    ['ê¸ˆì•¡', amount, materialTotal, laborTotal, otherTotal, expenseTotal, balance, 'ãˆœì„ë¯¼ì´ì•¤ì”¨'],
    ['ë¹„ìœ¨(%)', '100%', (amount > 0 ? (materialTotal/amount*100).toFixed(1) : 0) + '%', 
     (amount > 0 ? (laborTotal/amount*100).toFixed(1) : 0) + '%', 
     (amount > 0 ? (otherTotal/amount*100).toFixed(1) : 0) + '%',
     (amount > 0 ? (expenseTotal/amount*100).toFixed(1) : 0) + '%',
     (amount > 0 ? (balance/amount*100).toFixed(1) : 0) + '%', 'ì†Œì¥: ' + siteManager]
  ], { origin: 'A7' });
  
  // ë‹´ë‹¹ì ì •ë³´
  XLSX.utils.sheet_add_aoa(ws1, [
    ['ë³¸ì‚¬ë‹´ë‹¹ì:', hqManager, '', '', 'í˜„ì¥ë‹´ë‹¹ì:', fieldManager]
  ], { origin: 'A10' });
  
  // ìˆ˜ê¸ˆë‚´ì—­ & íˆ¬ì…ë‚´ì—­ í—¤ë”
  XLSX.utils.sheet_add_aoa(ws1, [
    ['[ ìˆ˜ê¸ˆë‚´ì—­ ]', '', '', '', '[ íˆ¬ì…ë‚´ì—­ ]', '', '', ''],
    ['ì¼ì', 'ê¸ˆì•¡', 'ë‚´ìš©', '', 'êµ¬ë¶„', 'ì¼ì', 'ê¸ˆì•¡', 'ë‚´ìš©']
  ], { origin: 'A12' });
  
  // ìˆ˜ê¸ˆë‚´ì—­ ë°ì´í„°
  const payments = [
    { date: contractDate, amt: contractAmt, note: contractNote || 'ê³„ì•½ê¸ˆ' },
    { date: interimDate, amt: interimAmt, note: interimNote || 'ì¤‘ë„ê¸ˆ1ì°¨' },
    { date: interim2Date, amt: interim2Amt, note: interim2Note || 'ì¤‘ë„ê¸ˆ2ì°¨' },
    { date: balanceDate, amt: balanceAmt, note: balanceNote || 'ì”ê¸ˆ' },
    { date: etcDate, amt: etcAmt, note: etcNote || 'ê¸°íƒ€ì…ê¸ˆ1' },
    { date: etc2Date, amt: etc2Amt, note: etc2Note || 'ê¸°íƒ€ì…ê¸ˆ2' },
    { date: adjustDate, amt: adjustAmt, note: adjustNote || 'ê¸ˆì•¡ì¡°ì •' }
  ].filter(p => p.amt !== 0);  // 0ì´ ì•„ë‹Œ ê²ƒë§Œ (ë§ˆì´ë„ˆìŠ¤ë„ í¬í•¨)
  
  // íˆ¬ì…ë‚´ì—­ í†µí•©
  const expenses = [
    ...materials.map(m => ({ ...m, type: 'ìì¬ë¹„' })),
    ...labors.map(l => ({ ...l, type: 'ë…¸ë¬´ë¹„' })),
    ...others.map(o => ({ ...o, type: 'ê¸°íƒ€ê²½ë¹„' }))
  ];
  
  const maxRows = Math.max(payments.length, expenses.length, 1);
  let rowIdx = 14;
  
  for (let i = 0; i < maxRows; i++) {
    const row = [];
    if (i < payments.length) {
      row.push(payments[i].date || '', payments[i].amt, payments[i].note);
    } else {
      row.push('', '', '');
    }
    row.push('');
    if (i < expenses.length) {
      row.push(expenses[i].type, expenses[i].date || '', expenses[i].amount, expenses[i].content);
    } else {
      row.push('', '', '', '');
    }
    XLSX.utils.sheet_add_aoa(ws1, [row], { origin: 'A' + rowIdx });
    rowIdx++;
  }
  
  // í•©ê³„
  rowIdx++;
  const totalReceived = contractAmt + interimAmt + interim2Amt + balanceAmt + etcAmt + etc2Amt + adjustAmt;
  XLSX.utils.sheet_add_aoa(ws1, [
    ['ìˆ˜ê¸ˆí•©ê³„:', totalReceived, '', '', 'ì§€ì¶œí•©ê³„:', '', expenseTotal, '']
  ], { origin: 'A' + rowIdx });
  
  // ìŠ¤íƒ€ì¼ ì ìš© (í—¤ë” í–‰)
  ['A6', 'B6', 'C6', 'D6', 'E6', 'F6', 'G6', 'H6'].forEach(cell => {
    if (ws1[cell]) ws1[cell].s = headerStyle;
  });
  
  // ë°ì´í„° ì…€ ìŠ¤íƒ€ì¼ ì ìš©
  for (let r = 7; r <= 8; r++) {
    ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'].forEach(col => {
      const cell = col + r;
      if (ws1[cell]) {
        if (col === 'A') ws1[cell].s = cellStyle;
        else ws1[cell].s = numStyle;
      }
    });
  }
  
  // ìˆ˜ê¸ˆ/íˆ¬ì… í—¤ë” ìŠ¤íƒ€ì¼
  ['A12', 'A13', 'B13', 'C13', 'E12', 'E13', 'F13', 'G13', 'H13'].forEach(cell => {
    if (ws1[cell]) ws1[cell].s = headerStyle;
  });
  
  // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
  ws1['!cols'] = [
    { wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 3 },
    { wch: 10 }, { wch: 12 }, { wch: 15 }, { wch: 20 }
  ];
  
  XLSX.utils.book_append_sheet(wb, ws1, 'ì´ê´„í‘œ');
  
  // ===== ì •ì‚°ì„œ ì‹œíŠ¸ =====
  const ws2 = XLSX.utils.aoa_to_sheet([]);
  const totalExpense = materialTotal + laborTotal + otherTotal;
  const profit = amount - totalExpense;
  const profitRate = amount > 0 ? (profit / amount * 100).toFixed(1) : 0;
  
  // ì œëª©
  XLSX.utils.sheet_add_aoa(ws2, [['ì •  ì‚°  ì„œ']], { origin: 'C1' });
  ws2['C1'].s = titleStyle;
  
  // í˜„ì¥ ì •ë³´
  XLSX.utils.sheet_add_aoa(ws2, [
    ['í˜„ì¥ëª…:', siteName],
    ['ê³µì‚¬ëª…:', projectName],
    [''],
    ['ì˜ì—…ë‹´ë‹¹ì:', hqManager, '', 'í˜„ì¥ì†Œì¥:', siteManager],
    ['', '', '', '', '', 'VAT ë³„ë„']
  ], { origin: 'A3' });
  
  // í…Œì´ë¸” í—¤ë”
  XLSX.utils.sheet_add_aoa(ws2, [
    ['êµ¬ë¶„', 'ë‚´ìš©', 'ë§¤ì¶œì•¡', 'ë§¤ì…ì•¡', 'ë¹„ê³ ']
  ], { origin: 'A9' });
  ['A9', 'B9', 'C9', 'D9', 'E9'].forEach(cell => {
    if (ws2[cell]) ws2[cell].s = headerStyle;
  });
  
  let row2 = 10;
  
  // ê³µì‚¬ì¢…ë¥˜
  XLSX.utils.sheet_add_aoa(ws2, [
    ['ê³µì‚¬ì¢…ë¥˜', projectName, amount, '', '']
  ], { origin: 'A' + row2 });
  row2++;
  XLSX.utils.sheet_add_aoa(ws2, [
    ['', 'ì†Œê³„', amount, 0, '']
  ], { origin: 'A' + row2 });
  row2++;
  
  // ìì¬ë¹„
  if (materials.length > 0) {
    materials.forEach((m, i) => {
      XLSX.utils.sheet_add_aoa(ws2, [
        [i === 0 ? 'ìì¬ë¹„' : '', m.content || '', '', m.amount, '']
      ], { origin: 'A' + row2 });
      row2++;
    });
  } else {
    XLSX.utils.sheet_add_aoa(ws2, [['ìì¬ë¹„', '', '', 0, '']], { origin: 'A' + row2 });
    row2++;
  }
  XLSX.utils.sheet_add_aoa(ws2, [['', 'ì†Œê³„', '', materialTotal, '']], { origin: 'A' + row2 });
  row2++;
  
  // ë…¸ë¬´ë¹„
  if (labors.length > 0) {
    labors.forEach((l, i) => {
      XLSX.utils.sheet_add_aoa(ws2, [
        [i === 0 ? 'ë…¸ë¬´ë¹„' : '', l.content || '', '', l.amount, '']
      ], { origin: 'A' + row2 });
      row2++;
    });
  } else {
    XLSX.utils.sheet_add_aoa(ws2, [['ë…¸ë¬´ë¹„', '', '', 0, '']], { origin: 'A' + row2 });
    row2++;
  }
  XLSX.utils.sheet_add_aoa(ws2, [['', 'ì†Œê³„', '', laborTotal, '']], { origin: 'A' + row2 });
  row2++;
  
  // ê¸°íƒ€ê²½ë¹„
  if (others.length > 0) {
    others.forEach((o, i) => {
      XLSX.utils.sheet_add_aoa(ws2, [
        [i === 0 ? 'ê¸°íƒ€ê²½ë¹„' : '', o.content || '', '', o.amount, '']
      ], { origin: 'A' + row2 });
      row2++;
    });
  } else {
    XLSX.utils.sheet_add_aoa(ws2, [['ê¸°íƒ€ê²½ë¹„', '', '', 0, '']], { origin: 'A' + row2 });
    row2++;
  }
  XLSX.utils.sheet_add_aoa(ws2, [['', 'ì†Œê³„', '', otherTotal, '']], { origin: 'A' + row2 });
  row2++;
  
  // í•©ê³„
  row2++;
  XLSX.utils.sheet_add_aoa(ws2, [
    ['ì´ê³„', '', amount, totalExpense, ''],
    ['ì†ìµ', '', profit, '(' + profitRate + '%)', ''],
    [''],
    ['ì •ì‚°ê¸ˆì•¡(15%)', '', Math.round(profit * 0.15), '', ''],
    ['íšŒì‚¬ìˆ˜ìµ(85%)', '', Math.round(profit * 0.85), '', '']
  ], { origin: 'A' + row2 });
  
  // ëª¨ë“  ë°ì´í„° ì…€ì— í…Œë‘ë¦¬ ì ìš©
  const range2 = XLSX.utils.decode_range(ws2['!ref'] || 'A1:E1');
  for (let R = 9; R <= row2 + 4; R++) {
    for (let C = 0; C <= 4; C++) {
      const cellAddr = XLSX.utils.encode_cell({ r: R - 1, c: C });
      if (ws2[cellAddr]) {
        if (C >= 2 && C <= 3) {
          ws2[cellAddr].s = numStyle;
        } else {
          ws2[cellAddr].s = cellStyle;
        }
      }
    }
  }
  
  // ì •ì‚°ì„œ ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
  ws2['!cols'] = [
    { wch: 12 }, { wch: 25 }, { wch: 15 }, { wch: 15 }, { wch: 10 }
  ];
  
  XLSX.utils.book_append_sheet(wb, ws2, 'ì •ì‚°ì„œ');
  
  // ë‹¤ìš´ë¡œë“œ
  const fileName = `ì´ê´„í‘œ_${siteName}_${new Date().toISOString().split('T')[0]}.xlsx`;
  XLSX.writeFile(wb, fileName);
  showToast('ì´ê´„í‘œ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
}

function createSettlementSheetData(siteName, projectName, amount, siteManager, hqManager, materials, labors, others, materialTotal, laborTotal, otherTotal) {
  const data = [];
  const totalExpense = materialTotal + laborTotal + otherTotal;
  const profit = amount - totalExpense;
  const profitRate = amount > 0 ? (profit / amount * 100).toFixed(1) : 0;
  
  // ìˆ«ì í¬ë§· í•¨ìˆ˜
  const fmt = (n) => n ? n.toLocaleString() : '';
  
  // í—¤ë”
  data.push(['']);
  data.push(['', '', '', 'ì •   ì‚°   ì„œ', '', '', '']);
  data.push(['']);
  data.push(['', 'í˜„ì¥ëª…:', siteName, '', '', '', '']);
  data.push(['', 'ê³µì‚¬ëª…:', projectName, '', '', '', '']);
  data.push(['']);
  data.push(['', 'ì˜ì—…ë‹´ë‹¹ì:', hqManager, '', 'í˜„ì¥ì†Œì¥:', siteManager, '']);
  data.push(['']);
  data.push(['', '', '', '', '', '', 'VAT ë³„ë„']);
  data.push(['']);
  
  // í…Œì´ë¸” í—¤ë”
  data.push(['', 'êµ¬  ë¶„', 'ë‚´    ìš©', '', 'ë§¤ì¶œì•¡', 'ë§¤ì…ì•¡', 'ë¹„ê³ ']);
  data.push(['']);
  
  // ê³µì‚¬ì¢…ë¥˜
  data.push(['', 'ê³µì‚¬ì¢…ë¥˜', projectName, '', fmt(amount), '', '']);
  data.push(['', '', 'ì†Œ  ê³„', '', fmt(amount), fmt(0), '']);
  data.push(['']);
  
  // ìì¬ë¹„
  if (materials.length > 0) {
    materials.forEach((m, i) => {
      data.push(['', i === 0 ? 'ìì¬ë¹„' : '', m.content || '', '', '', fmt(m.amount), '']);
    });
  } else {
    data.push(['', 'ìì¬ë¹„', '', '', '', fmt(0), '']);
  }
  data.push(['', '', 'ì†Œ  ê³„', '', '', fmt(materialTotal), '']);
  data.push(['']);
  
  // ë…¸ë¬´ë¹„
  if (labors.length > 0) {
    labors.forEach((l, i) => {
      data.push(['', i === 0 ? 'ë…¸ë¬´ë¹„' : '', l.content || '', '', '', fmt(l.amount), '']);
    });
  } else {
    data.push(['', 'ë…¸ë¬´ë¹„', '', '', '', fmt(0), '']);
  }
  data.push(['', '', 'ì†Œ  ê³„', '', '', fmt(laborTotal), '']);
  data.push(['']);
  
  // ê¸°íƒ€ê²½ë¹„
  if (others.length > 0) {
    others.forEach((o, i) => {
      data.push(['', i === 0 ? 'ê¸°íƒ€ê²½ë¹„' : '', o.content || '', '', '', fmt(o.amount), '']);
    });
  } else {
    data.push(['', 'ê¸°íƒ€ê²½ë¹„', '', '', '', fmt(0), '']);
  }
  data.push(['', '', 'ì†Œ  ê³„', '', '', fmt(otherTotal), '']);
  data.push(['']);
  
  // í•©ê³„
  data.push(['', '', '', '', '', '', '']);
  data.push(['', 'ì´    ê³„', '', '', fmt(amount), fmt(totalExpense), '']);
  data.push(['']);
  data.push(['', 'ì†    ìµ', '', '', fmt(profit), '(' + profitRate + '%)', '']);
  data.push(['']);
  data.push(['']);
  
  // ì •ì‚°ê¸ˆì•¡ (15%)
  const settlementAmount = profit * 0.15;
  const companyProfit = profit * 0.85;
  data.push(['', 'ì •ì‚°ê¸ˆì•¡ (15%)', '', '', fmt(Math.round(settlementAmount)), '', '']);
  data.push(['', 'íšŒì‚¬ìˆ˜ìµ (85%)', '', '', fmt(Math.round(companyProfit)), '', '']);
  
  return data;
}

// ì´ê´„í‘œ ì‹œíŠ¸ ë°ì´í„°ë„ ì˜ˆì˜ê²Œ ê°œì„ 
function createSummarySheetData(siteName, projectName, period, amount, siteManager, hqManager, fieldManager, 
                                 contractDate, contractAmt, contractNote, interimDate, interimAmt, interimNote,
                                 balanceDate, balanceAmt, balanceNote, materials, labors, others,
                                 materialTotal, laborTotal, otherTotal) {
  const data = [];
  const expenseTotal = materialTotal + laborTotal + otherTotal;
  const balance = amount - expenseTotal;
  
  // ìˆ«ì í¬ë§· í•¨ìˆ˜
  const fmt = (n) => n ? n.toLocaleString() : '';
  const pct = (n) => amount > 0 ? (n / amount * 100).toFixed(2) : '0.00';
  
  // í—¤ë” ì •ë³´
  data.push(['']);
  data.push(['', '', '', 'ì´   ê´„   í‘œ', '', '', '', '', '', '', '']);
  data.push(['']);
  data.push(['', 'ê³µì‚¬í˜„ì¥:', siteName, '', '', '', '', '', '', '', '']);
  data.push(['', 'ê³µì‚¬ëª…:', projectName, '', '', '', '', 'ê³µì‚¬ê¸°ê°„:', period, '', '']);
  data.push(['', 'ê³µì‚¬ê¸ˆì•¡(VATë³„ë„):', fmt(amount), '', '', '', '', '', '', '', '']);
  data.push(['']);
  
  // ìš”ì•½ í…Œì´ë¸”
  data.push(['', 'êµ¬ë¶„', 'ê³„ì•½ê¸ˆì•¡', 'ìì¬ë¹„', 'ë…¸ë¬´ë¹„', 'ê¸°íƒ€ê²½ë¹„', 'ì§€ì¶œê³„', 'ì”ì•¡', 'ë‹´ë‹¹', '']);
  data.push(['', 'ê¸ˆì•¡', fmt(amount), fmt(materialTotal), fmt(laborTotal), fmt(otherTotal), fmt(expenseTotal), fmt(balance), 'ãˆœì„ë¯¼ì´ì•¤ì”¨', '']);
  data.push(['', 'ë¹„ìœ¨(%)', '100%', pct(materialTotal) + '%', pct(laborTotal) + '%', pct(otherTotal) + '%', pct(expenseTotal) + '%', pct(balance) + '%', 'ì†Œì¥: ' + siteManager, '']);
  data.push(['']);
  data.push(['']);
  
  // ë‹´ë‹¹ì ì •ë³´
  data.push(['', 'ë³¸ì‚¬ë‹´ë‹¹ì:', hqManager, '', '', 'í˜„ì¥ë‹´ë‹¹ì:', fieldManager, '', '', '', '']);
  data.push(['']);
  
  // ìˆ˜ê¸ˆë‚´ì—­ & íˆ¬ì…ë‚´ì—­ í—¤ë”
  data.push(['', '[ ìˆ˜ê¸ˆë‚´ì—­ ]', '', '', '', '[ íˆ¬ì…ë‚´ì—­ ]', '', '', '', '', '']);
  data.push(['', 'ì¼ì', 'ê¸ˆì•¡', 'ë‚´ìš©', '', 'êµ¬ë¶„', 'ì¼ì', 'ê¸ˆì•¡', 'ë‚´ìš©', '', '']);
  data.push(['']);
  
  // ìˆ˜ê¸ˆë‚´ì—­
  const payments = [
    { date: contractDate, amt: contractAmt, note: contractNote || 'ê³„ì•½ê¸ˆ' },
    { date: interimDate, amt: interimAmt, note: interimNote || 'ì¤‘ë„ê¸ˆ' },
    { date: balanceDate, amt: balanceAmt, note: balanceNote || 'ì”ê¸ˆ' }
  ].filter(p => p.amt > 0);
  
  // íˆ¬ì…ë‚´ì—­ í†µí•©
  const expenses = [
    ...materials.map(m => ({ ...m, type: 'ìì¬ë¹„' })),
    ...labors.map(l => ({ ...l, type: 'ë…¸ë¬´ë¹„' })),
    ...others.map(o => ({ ...o, type: 'ê¸°íƒ€ê²½ë¹„' }))
  ];
  
  const maxRows = Math.max(payments.length, expenses.length, 1);
  
  for (let i = 0; i < maxRows; i++) {
    const row = [''];
    
    // ìˆ˜ê¸ˆë‚´ì—­
    if (i < payments.length) {
      row.push(payments[i].date || '');
      row.push(fmt(payments[i].amt));
      row.push(payments[i].note);
    } else {
      row.push('', '', '');
    }
    
    row.push(''); // êµ¬ë¶„ì„ 
    
    // íˆ¬ì…ë‚´ì—­
    if (i < expenses.length) {
      row.push(expenses[i].type);
      row.push(expenses[i].date || '');
      row.push(fmt(expenses[i].amount));
      row.push(expenses[i].content);
    } else {
      row.push('', '', '', '');
    }
    
    data.push(row);
  }
  
  data.push(['']);
  data.push(['', 'ìˆ˜ê¸ˆí•©ê³„:', fmt(contractAmt + interimAmt + balanceAmt), '', '', 'ì§€ì¶œí•©ê³„:', '', fmt(expenseTotal), '', '', '']);
  
  return data;
}

// ========== ê´€ë¦¬ì ê¸°ëŠ¥ ==========
const DEFAULT_PASSWORD = '1234';  // ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸
let isAdminAuthenticated = false;
let pendingAdminAction = null;
let settlementData = [];  // ì •ì‚° ë°ì´í„°

// ì €ì¥ëœ ë¹„ë°€ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸° (localStorage ì‚¬ìš©)
function getAdminPassword() {
  return localStorage.getItem('adminPassword') || DEFAULT_PASSWORD;
}

// ë¹„ë°€ë²ˆí˜¸ ì €ì¥
function setAdminPassword(newPwd) {
  localStorage.setItem('adminPassword', newPwd);
}

function toggleAdminSection() {
  if (!isAdminAuthenticated) {
    pendingAdminAction = 'toggle';
    openPasswordModal();
    return;
  }
  
  const content = document.getElementById('adminContent');
  const icon = document.getElementById('adminToggleIcon');
  
  if (content.style.display === 'none') {
    content.style.display = 'block';
    icon.classList.remove('collapsed');
  } else {
    content.style.display = 'none';
    icon.classList.add('collapsed');
  }
}

function openPasswordModal() {
  document.getElementById('adminPassword').value = '';
  document.getElementById('passwordError').style.display = 'none';
  document.getElementById('passwordModal').classList.add('active');
  setTimeout(() => document.getElementById('adminPassword').focus(), 100);
}

function closePasswordModal() {
  document.getElementById('passwordModal').classList.remove('active');
  pendingAdminAction = null;
}

function handlePasswordKeyup(event) {
  if (event.key === 'Enter') {
    verifyPassword();
  }
}

function verifyPassword() {
  const pwd = document.getElementById('adminPassword').value;
  if (pwd === getAdminPassword()) {
    isAdminAuthenticated = true;
    closePasswordModal();
    
    // ëŒ€ê¸° ì¤‘ì¸ ì•¡ì…˜ ì‹¤í–‰
    if (pendingAdminAction === 'toggle') {
      const content = document.getElementById('adminContent');
      content.style.display = 'block';
      document.getElementById('adminToggleIcon').classList.remove('collapsed');
    } else if (pendingAdminAction === 'managerStats') {
      document.getElementById('managerStatsSection').style.display = 'block';
      showToast('ë‹´ë‹¹ìë³„ ì‹¤ì  í˜„í™©ì´ í‘œì‹œë©ë‹ˆë‹¤.', 'success');
    } else if (pendingAdminAction === 'settlement') {
      openSettlementModal();
    }
    pendingAdminAction = null;
  } else {
    document.getElementById('passwordError').style.display = 'block';
    document.getElementById('adminPassword').value = '';
    document.getElementById('adminPassword').focus();
  }
}

function showManagerStats() {
  if (!isAdminAuthenticated) {
    pendingAdminAction = 'managerStats';
    openPasswordModal();
    return;
  }
  document.getElementById('managerStatsSection').style.display = 'block';
  showToast('ë‹´ë‹¹ìë³„ ì‹¤ì  í˜„í™©ì´ í‘œì‹œë©ë‹ˆë‹¤.', 'success');
}

function showSettlementManagement() {
  if (!isAdminAuthenticated) {
    pendingAdminAction = 'settlement';
    openPasswordModal();
    return;
  }
  openSettlementModal();
}

// ========== ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ==========
function openPasswordChangeModal() {
  document.getElementById('currentPassword').value = '';
  document.getElementById('newPassword').value = '';
  document.getElementById('confirmPassword').value = '';
  document.getElementById('passwordChangeError').style.display = 'none';
  document.getElementById('passwordChangeSuccess').style.display = 'none';
  document.getElementById('passwordChangeModal').classList.add('active');
  setTimeout(() => document.getElementById('currentPassword').focus(), 100);
}

function closePasswordChangeModal() {
  document.getElementById('passwordChangeModal').classList.remove('active');
}

function changePassword() {
  const currentPwd = document.getElementById('currentPassword').value;
  const newPwd = document.getElementById('newPassword').value;
  const confirmPwd = document.getElementById('confirmPassword').value;
  
  const errorEl = document.getElementById('passwordChangeError');
  const successEl = document.getElementById('passwordChangeSuccess');
  
  errorEl.style.display = 'none';
  successEl.style.display = 'none';
  
  // ê²€ì¦
  if (!currentPwd || !newPwd || !confirmPwd) {
    errorEl.textContent = 'ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
    errorEl.style.display = 'block';
    return;
  }
  
  if (currentPwd !== getAdminPassword()) {
    errorEl.textContent = 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.';
    errorEl.style.display = 'block';
    document.getElementById('currentPassword').value = '';
    document.getElementById('currentPassword').focus();
    return;
  }
  
  if (newPwd.length < 4) {
    errorEl.textContent = 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 4ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
    errorEl.style.display = 'block';
    return;
  }
  
  if (newPwd !== confirmPwd) {
    errorEl.textContent = 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
    errorEl.style.display = 'block';
    document.getElementById('confirmPassword').value = '';
    document.getElementById('confirmPassword').focus();
    return;
  }
  
  // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
  setAdminPassword(newPwd);
  
  successEl.textContent = 'âœ“ ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.';
  successEl.style.display = 'block';
  
  // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
  document.getElementById('currentPassword').value = '';
  document.getElementById('newPassword').value = '';
  document.getElementById('confirmPassword').value = '';
  
  // 2ì´ˆ í›„ ëª¨ë‹¬ ë‹«ê¸°
  setTimeout(() => {
    closePasswordChangeModal();
    showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
  }, 1500);
}

// ========== ì •ì‚° ê´€ë¦¬ ==========
function openSettlementModal() {
  document.getElementById('settlementModal').classList.add('active');
  loadSettlementStatusFromStorage();  // ì €ì¥ëœ ì •ì‚° ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°
  renderSettlementTable();
}

function closeSettlementModal() {
  document.getElementById('settlementModal').classList.remove('active');
}

// ì •ì‚°ë¦¬ìŠ¤íŠ¸ ì—‘ì…€ ì—…ë¡œë“œ
function handleSettlementUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
      
      // ì²«ë²ˆì§¸ ì‹œíŠ¸ (ì „ì²´ ë°ì´í„°)
      const firstSheet = wb.Sheets[wb.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '' });
      
      // ë°ì´í„° íŒŒì‹± (í–‰ 8ë¶€í„° ë°ì´í„° ì‹œì‘)
      settlementData = [];
      for (let i = 8; i < data.length; i++) {
        const row = data[i];
        if (!row[1] && !row[3]) continue;  // NOë‚˜ ê³µì‚¬í˜„ì¥ì´ ì—†ìœ¼ë©´ ìŠ¤í‚µ
        
        const item = {
          year: row[0] || '',
          no: row[1] || '',
          type: row[2] || '',  // ê³µì‚¬ì¢…ë¥˜
          site: row[3] || '',  // ê³µì‚¬í˜„ì¥
          amount: parseFloat(row[4]) || 0,  // ê³µì‚¬ê¸ˆì•¡
          period: row[5] || '',  // ê³µì‚¬ê¸°ê°„
          status: row[6] || '',  // ì…ê¸ˆì—¬ë¶€
          material: parseFloat(row[7]) || 0,  // ìì¬ë¹„
          labor: parseFloat(row[8]) || 0,  // ë…¸ë¬´ë¹„ (ì¸ê±´ë¹„)
          subcontract: parseFloat(row[9]) || 0,  // ì™¸ì£¼ë¹„
          fee: parseFloat(row[10]) || 0,  // ì§€ê¸‰ìˆ˜ìˆ˜ë£Œ
          insurance: parseFloat(row[11]) || 0,  // 4ëŒ€ë³´í—˜
          waste: parseFloat(row[12]) || 0,  // íê¸°ë¬¼ì²˜ë¦¬ë¹„
          equipment: parseFloat(row[13]) || 0,  // ì¥ë¹„ì„ëŒ€ë¹„
          consulting: parseFloat(row[14]) || 0,  // ê¸°ìˆ ì§€ë„ë¹„/ì»¨ì„¤íŒ…ë¹„
          safety: parseFloat(row[15]) || 0,  // ì•ˆì „ê´€ë¦¬ë¹„
          other: parseFloat(row[16]) || 0,  // ê¸°íƒ€ê²½ë¹„
          expenseTotal: parseFloat(row[17]) || 0,  // ê²½ë¹„í•©ê³„
          salesShare: parseFloat(row[18]) || 0,  // ì˜ì—…ì •ì‚°ë¶„
          expectedExpense: parseFloat(row[19]) || 0,  // ì§€ì¶œì˜ˆì •ê¸ˆì•¡
          safetyExpense: parseFloat(row[20]) || 0,  // ì•ˆì „ê²½ë¹„
          salesSettlement: parseFloat(row[21]) || 0,  // ì˜ì—…ì •ì‚°
          totalExpense: parseFloat(row[22]) || 0,  // ì§€ì¶œì´ì•¡
          profit: parseFloat(row[23]) || 0,  // ì´ìµê¸ˆ (ê³µì‚¬ìˆ˜ìµê¸ˆ)
          profitRate: parseFloat(row[24]) || 0,  // ì´ìµë¥ 
          realSettlement: parseFloat(row[25]) || 0,  // ì‹¤ì •ì‚°ê¸ˆì•¡ (15%)
          companyProfit: parseFloat(row[26]) || 0,  // ê³µì‚¬ìˆ˜ìµ (85%)
          manager: row[27] || ''  // ì˜ì—…ë‹´ë‹¹ì
        };
        
        // ë…¸ë¬´ë¹„ í•©ì‚° (ì¸ê±´ë¹„ + ì™¸ì£¼ë¹„)
        item.laborTotal = item.labor + item.subcontract;
        
        settlementData.push(item);
      }
      
      showToast(`ì •ì‚°ë¦¬ìŠ¤íŠ¸ ${settlementData.length}ê±´ ë¡œë“œ ì™„ë£Œ`, 'success');
      renderSettlementTable();
      openSettlementModal();
      
    } catch(err) {
      console.error(err);
      showToast('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
  };
  reader.readAsArrayBuffer(file);
  event.target.value = '';
}

function renderSettlementTable() {
  // ì •ì‚° ë°ì´í„°ê°€ ì—†ìœ¼ë©´ í˜„ì¬ ê³µì‚¬í˜„í™© ë°ì´í„° ì‚¬ìš©
  let dataToRender = settlementData.length > 0 ? [...settlementData] : generateSettlementFromCurrentData();
  
  console.log('ì •ì‚°ê´€ë¦¬ ë°ì´í„°:', dataToRender.length, 'ê±´');
  console.log('allData í‚¤:', Object.keys(allData));
  console.log('allData[2025] ê¸¸ì´:', allData['2025']?.length);
  
  // í•„í„° ì ìš©
  const searchKeyword = (document.getElementById('settlementSearchInput')?.value || '').trim().toLowerCase();
  const yearFilter = document.getElementById('settlementYearFilter').value;
  const managerFilter = document.getElementById('settlementManagerFilter').value;
  const statusFilter = document.getElementById('settlementStatusFilter').value;
  const settledFilter = document.getElementById('settlementSettledFilter').value;
  
  console.log('í•„í„° - ê²€ìƒ‰:', searchKeyword, 'ë…„ë„:', yearFilter, 'ë‹´ë‹¹ì:', managerFilter, 'ìƒíƒœ:', statusFilter, 'ì •ì‚°:', settledFilter);
  
  // ê²€ìƒ‰ í•„í„°
  if (searchKeyword) {
    dataToRender = dataToRender.filter(item => {
      const site = (item.site || '').toLowerCase();
      const manager = (item.manager || '').toLowerCase();
      const type = (item.type || '').toLowerCase();
      return site.includes(searchKeyword) || manager.includes(searchKeyword) || type.includes(searchKeyword);
    });
  }
  
  // ë…„ë„ í•„í„°
  if (yearFilter === '2024') {
    dataToRender = dataToRender.filter(item => String(item.year).includes('24'));
  } else if (yearFilter === '2025') {
    dataToRender = dataToRender.filter(item => String(item.year).includes('25'));
  } else if (yearFilter === '2024+2025') {
    // 24ë…„ ë¯¸ì •ì‚° + 25ë…„ ì „ì²´
    dataToRender = dataToRender.filter(item => {
      const is24 = String(item.year).includes('24');
      const is25 = String(item.year).includes('25');
      if (is24) {
        // 24ë…„ì€ ë¯¸ì •ì‚° ê±´ë§Œ
        return item.settled !== 'ì •ì‚°ì™„ë£Œ';
      }
      return is25;
    });
  }
  // 26ë…„ ìƒë°˜ê¸° (1~6ì›” ì…ê¸ˆ)
  else if (yearFilter === '2026-1H') {
    dataToRender = dataToRender.filter(item => {
      if (!String(item.year).includes('26')) return false;
      // ì…ê¸ˆì¼ ê¸°ì¤€ 1~6ì›”
      const paidDate = item.paidDate;
      if (!paidDate) return false;
      const month = new Date(paidDate).getMonth() + 1;
      return month >= 1 && month <= 6;
    });
    document.getElementById('halfYearNotice').style.display = 'block';
  }
  // 26ë…„ í•˜ë°˜ê¸° (7~12ì›” ì…ê¸ˆ)
  else if (yearFilter === '2026-2H') {
    dataToRender = dataToRender.filter(item => {
      if (!String(item.year).includes('26')) return false;
      const paidDate = item.paidDate;
      if (!paidDate) return false;
      const month = new Date(paidDate).getMonth() + 1;
      return month >= 7 && month <= 12;
    });
    document.getElementById('halfYearNotice').style.display = 'block';
  }
  // 26ë…„ ì „ì²´
  else if (yearFilter === '2026') {
    dataToRender = dataToRender.filter(item => String(item.year).includes('26'));
  }
  else {
    document.getElementById('halfYearNotice').style.display = 'none';
  }
  
  // ë³¸ì‚¬/ì™¸ì£¼ í•„í„°
  const typeFilter = document.getElementById('settlementTypeFilter').value;
  if (typeFilter === 'ë³¸ì‚¬') {
    dataToRender = dataToRender.filter(item => item.hqType === 'ë³¸ì‚¬' || (item.type && (item.type.includes('(ë³¸)') || (!item.type.includes('(ì™¸)')))));
  } else if (typeFilter === 'ì™¸ì£¼') {
    dataToRender = dataToRender.filter(item => item.hqType === 'ì™¸ì£¼' || (item.type && item.type.includes('(ì™¸)')));
  }
  
  if (managerFilter) {
    dataToRender = dataToRender.filter(item => item.manager === managerFilter);
  }
  if (statusFilter) {
    dataToRender = dataToRender.filter(item => item.status && item.status.includes(statusFilter));
  }
  if (settledFilter) {
    dataToRender = dataToRender.filter(item => {
      if (settledFilter === 'ì •ì‚°ì™„ë£Œ') return item.settled === 'ì •ì‚°ì™„ë£Œ';
      if (settledFilter === 'ë¯¸ì •ì‚°') return item.settled === 'ë¯¸ì •ì‚°';
      if (settledFilter === 'ì§„í–‰ì¤‘') return item.settled === 'ì§„í–‰ì¤‘';
      return true;
    });
  }
  
  // ë‹´ë‹¹ì ëª©ë¡ ì—…ë°ì´íŠ¸
  updateManagerFilterOptions();
  
  // í…Œì´ë¸” ë Œë”ë§
  let html = '';
  let totals = {
    amount: 0, material: 0, laborTotal: 0, expenseTotal: 0, totalExpense: 0,
    profit: 0, realSettlement: 0, companyProfit: 0, count: 0
  };
  // ë³¸ì‚¬/ì™¸ì£¼ë³„ ì†Œê³„
  let hqTotals = { count: 0, amount: 0, profit: 0, realSettlement: 0 };
  let extTotals = { count: 0, amount: 0, profit: 0, realSettlement: 0 };
  
  dataToRender.forEach((item, idx) => {
    const profitClass = item.profit >= 0 ? 'profit-positive' : 'profit-negative';
    const statusClass = item.status ? 'status-' + item.status.replace(/\s/g, '') : '';
    
    // ì •ì‚° ìƒíƒœ ë“œë¡­ë‹¤ìš´ (3ê°€ì§€: ì •ì‚°ì™„ë£Œ, ë¯¸ì •ì‚°, ì§„í–‰ì¤‘)
    const settledValue = item.settled || 'ë¯¸ì •ì‚°';
    let bgColor = '#fff3e0'; // ë¯¸ì •ì‚°: ì£¼í™©
    let txtColor = '#e65100';
    if (settledValue === 'ì •ì‚°ì™„ë£Œ') {
      bgColor = '#c8e6c9'; txtColor = '#2e7d32'; // ì´ˆë¡
    } else if (settledValue === 'ì§„í–‰ì¤‘') {
      bgColor = '#e3f2fd'; txtColor = '#1565c0'; // íŒŒë‘
    }
    const settledSelect = `<select onchange="updateSettlementStatus('${item.year}', '${item.no}', this.value)" style="font-size:0.7rem;padding:2px 4px;border-radius:4px;border:1px solid #ddd;background:${bgColor};color:${txtColor};font-weight:600;cursor:pointer;">
      <option value="ë¯¸ì •ì‚°" ${settledValue === 'ë¯¸ì •ì‚°' ? 'selected' : ''}>ë¯¸ì •ì‚°</option>
      <option value="ì§„í–‰ì¤‘" ${settledValue === 'ì§„í–‰ì¤‘' ? 'selected' : ''}>ì§„í–‰ì¤‘</option>
      <option value="ì •ì‚°ì™„ë£Œ" ${settledValue === 'ì •ì‚°ì™„ë£Œ' ? 'selected' : ''}>ì •ì‚°ì™„ë£Œ</option>
    </select>`;
    
    // ë³¸ì‚¬/ì™¸ì£¼ êµ¬ë¶„
    const isExt = item.hqType === 'ì™¸ì£¼' || (item.type && item.type.includes('(ì™¸)'));
    const hqTypeBadge = isExt 
      ? '<span style="background:#e1bee7;color:#7b1fa2;padding:2px 5px;border-radius:4px;font-size:0.65rem;font-weight:600;">ì™¸ì£¼</span>'
      : '<span style="background:#bbdefb;color:#1565c0;padding:2px 5px;border-radius:4px;font-size:0.65rem;font-weight:600;">ë³¸ì‚¬</span>';
    
    // ì´ê´„í‘œ ë°ì´í„° ìœ ë¬´ í‘œì‹œ
    const dataIcon = item.hasDetailData 
      ? '<span title="ì´ê´„í‘œ ë°ì´í„° ìˆìŒ" style="color:#66bb6a;">âœ“</span>' 
      : '<span title="ì´ê´„í‘œ ë°ì´í„° ì—†ìŒ (ì¶”ì •ì¹˜)" style="color:#bdbdbd;">~</span>';
    
    html += `<tr class="${statusClass}">
      <td>${item.year || '-'}</td>
      <td>${item.no || (idx + 1)} ${dataIcon}</td>
      <td>${hqTypeBadge}</td>
      <td>${item.type || '-'}</td>
      <td title="${item.site}" style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${item.site || '-'}</td>
      <td>${fmt(item.amount)}</td>
      <td>${item.status || '-'}</td>
      <td style="font-size:0.7rem;">${item.paidDate || '-'}</td>
      <td>${fmt(item.material)}</td>
      <td>${fmt(item.laborTotal || item.labor)}</td>
      <td>${fmt(item.expenseTotal)}</td>
      <td>${fmt(item.totalExpense)}</td>
      <td class="${profitClass}">${fmt(item.profit)}</td>
      <td class="${profitClass}">${item.profitRate ? (item.profitRate * 100).toFixed(1) + '%' : '-'}</td>
      <td style="color:#1565c0;font-weight:700;background:#e3f2fd;">${fmt(item.realSettlement)}</td>
      <td style="color:#2e7d32;font-weight:600;">${fmt(item.companyProfit)}</td>
      <td style="font-size:0.72rem;">${item.manager || '-'}</td>
      <td>${settledSelect}</td>
    </tr>`;
    
    totals.amount += item.amount || 0;
    totals.material += item.material || 0;
    totals.laborTotal += item.laborTotal || item.labor || 0;
    totals.expenseTotal += item.expenseTotal || 0;
    totals.totalExpense += item.totalExpense || 0;
    totals.profit += item.profit || 0;
    totals.realSettlement += item.realSettlement || 0;
    totals.companyProfit += item.companyProfit || 0;
    totals.count++;
    
    // ë³¸ì‚¬/ì™¸ì£¼ ì†Œê³„
    if (isExt) {
      extTotals.count++;
      extTotals.amount += item.amount || 0;
      extTotals.profit += item.profit || 0;
      extTotals.realSettlement += item.realSettlement || 0;
    } else {
      hqTotals.count++;
      hqTotals.amount += item.amount || 0;
      hqTotals.profit += item.profit || 0;
      hqTotals.realSettlement += item.realSettlement || 0;
    }
  });
  
  document.getElementById('settlementTableBody').innerHTML = html || '<tr><td colspan="18" style="text-align:center;color:var(--gray-400);padding:2rem;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì •ì‚°ë¦¬ìŠ¤íŠ¸ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.</td></tr>';
  
  // í•©ê³„ í–‰
  const avgProfitRate = totals.amount > 0 ? (totals.profit / totals.amount * 100).toFixed(1) : 0;
  document.getElementById('settlementTableFoot').innerHTML = `
    <tr style="background:#e3f2fd;">
      <td colspan="5" style="text-align:center;">ë³¸ì‚¬ ì†Œê³„ (${hqTotals.count}ê±´)</td>
      <td>${fmt(hqTotals.amount)}</td>
      <td colspan="6">-</td>
      <td class="${hqTotals.profit >= 0 ? 'profit-positive' : 'profit-negative'}">${fmt(hqTotals.profit)}</td>
      <td>-</td>
      <td style="color:var(--primary);font-weight:700;">${fmt(hqTotals.realSettlement)}</td>
      <td colspan="3">-</td>
    </tr>
    <tr style="background:#f3e5f5;">
      <td colspan="5" style="text-align:center;">ì™¸ì£¼ ì†Œê³„ (${extTotals.count}ê±´)</td>
      <td>${fmt(extTotals.amount)}</td>
      <td colspan="6">-</td>
      <td class="${extTotals.profit >= 0 ? 'profit-positive' : 'profit-negative'}">${fmt(extTotals.profit)}</td>
      <td>-</td>
      <td style="color:#9c27b0;font-weight:700;">${fmt(extTotals.realSettlement)}</td>
      <td colspan="3">-</td>
    </tr>
    <tr>
      <td colspan="5" style="text-align:center;font-weight:700;">ì´ í•©ê³„ (${totals.count}ê±´)</td>
      <td>${fmt(totals.amount)}</td>
      <td>-</td>
      <td>-</td>
      <td>${fmt(totals.material)}</td>
      <td>${fmt(totals.laborTotal)}</td>
      <td>${fmt(totals.expenseTotal)}</td>
      <td>${fmt(totals.totalExpense)}</td>
      <td class="${totals.profit >= 0 ? 'profit-positive' : 'profit-negative'}">${fmt(totals.profit)}</td>
      <td>${avgProfitRate}%</td>
      <td style="color:var(--primary);font-weight:700;">${fmt(totals.realSettlement)}</td>
      <td>${fmt(totals.companyProfit)}</td>
      <td>-</td>
      <td>-</td>
    </tr>
  `;
  
  // ì´ê´„í‘œ ë°ì´í„° ìˆëŠ” ê±´ìˆ˜ ê³„ì‚°
  const withDetailCount = dataToRender.filter(item => item.hasDetailData).length;
  const withoutDetailCount = dataToRender.length - withDetailCount;
  
  // í•„í„° ê²°ê³¼ í‘œì‹œ
  let filterResultText = `${dataToRender.length}ê±´ í‘œì‹œ (ë³¸ì‚¬ ${hqTotals.count} / ì™¸ì£¼ ${extTotals.count})`;
  if (withoutDetailCount > 0) {
    filterResultText += ` | <span style="color:#ff9800;">~${withoutDetailCount}ê±´ ì¶”ì •ì¹˜</span>`;
  }
  document.getElementById('settlementFilterResult').innerHTML = filterResultText;
  
  // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
  updateSettlementStatsCards(dataToRender);
  
  // ë‹´ë‹¹ìë³„ ìš”ì•½ ë Œë”ë§
  renderManagerSettlementSummary(dataToRender);
}

// ì •ì‚° ìƒíƒœ ì—…ë°ì´íŠ¸
function updateSettlementStatus(year, no, status) {
  console.log('ì •ì‚° ìƒíƒœ ì—…ë°ì´íŠ¸:', year, no, status);
  
  // localStorageì—ì„œ ê¸°ì¡´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
  const statusData = JSON.parse(localStorage.getItem('settlementStatusData') || '{}');
  
  // í•´ë‹¹ í•­ëª© ì—…ë°ì´íŠ¸
  const key = `${year}_${no}`;
  statusData[key] = status;
  
  // localStorageì— ì €ì¥
  localStorage.setItem('settlementStatusData', JSON.stringify(statusData));
  console.log('ì •ì‚° ìƒíƒœ ì €ì¥:', key, 'â†’', status);
  
  // settlementDataì—ë„ ë°˜ì˜ (í˜„ì¬ í™”ë©´ìš©)
  const item = settlementData.find(d => String(d.year) === String(year) && String(d.no) === String(no));
  if (item) {
    item.settled = status;
  }
  
  // ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ (ë°”ë¡œ ë°˜ì˜)
  let bgColor = '#fff3e0'; // ë¯¸ì •ì‚°: ì£¼í™©
  let txtColor = '#e65100';
  if (status === 'ì •ì‚°ì™„ë£Œ') {
    bgColor = '#c8e6c9'; txtColor = '#2e7d32'; // ì´ˆë¡
  } else if (status === 'ì§„í–‰ì¤‘') {
    bgColor = '#e3f2fd'; txtColor = '#1565c0'; // íŒŒë‘
  }
  event.target.style.background = bgColor;
  event.target.style.color = txtColor;
  
  showToast(`${year}ë…„ NO.${no} â†’ ${status}`, 'success');
}

// ì •ì‚° ìƒíƒœ ì €ì¥ (ì¼ê´„ ì €ì¥ìš©)
function saveSettlementStatusToStorage() {
  const statusData = JSON.parse(localStorage.getItem('settlementStatusData') || '{}');
  settlementData.forEach(item => {
    if (item.settled) {
      const key = `${item.year}_${item.no}`;
      statusData[key] = item.settled;
    }
  });
  localStorage.setItem('settlementStatusData', JSON.stringify(statusData));
  console.log('ì •ì‚° ìƒíƒœ ì €ì¥ ì™„ë£Œ:', Object.keys(statusData).length, 'ê±´');
}

// ì •ì‚° ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°
function loadSettlementStatusFromStorage() {
  try {
    const saved = localStorage.getItem('settlementStatusData');
    if (saved) {
      const statusData = JSON.parse(saved);
      console.log('ì •ì‚° ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°:', Object.keys(statusData).length, 'ê±´');
      settlementData.forEach(item => {
        const key = `${item.year}_${item.no}`;
        if (statusData[key]) {
          item.settled = statusData[key];
        }
      });
    }
  } catch (e) {
    console.error('ì •ì‚° ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
  }
}

// ì •ì‚°ê´€ë¦¬ í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
function updateSettlementStatsCards(data) {
  let totalAmount = 0;      // ê³µì‚¬ê¸ˆì•¡
  let totalExpense = 0;     // ì§€ì¶œì´ì•¡
  let totalProfit = 0;      // ì´ìµê¸ˆ
  let totalSettlement = 0;  // ì •ì‚°ê¸ˆì•¡ (15%)
  let totalCompany = 0;     // íšŒì‚¬ìˆ˜ìµ (85%)
  let count = 0;
  
  data.forEach(item => {
    totalAmount += item.amount || 0;
    totalExpense += item.totalExpense || 0;
    totalProfit += item.profit || 0;
    totalSettlement += item.realSettlement || 0;
    totalCompany += item.companyProfit || 0;
    count++;
  });
  
  const profitRate = totalAmount > 0 ? (totalProfit / totalAmount * 100).toFixed(1) : 0;
  
  // ì¹´ë“œ ì—…ë°ì´íŠ¸
  document.getElementById('settlementStatAmount').textContent = fmtAmount(totalAmount);
  document.getElementById('settlementStatAmountCount').textContent = count + 'ê±´';
  
  document.getElementById('settlementStatExpense').textContent = fmtAmount(totalExpense);
  
  document.getElementById('settlementStatProfit').textContent = fmtAmount(totalProfit);
  document.getElementById('settlementStatProfit').style.color = totalProfit >= 0 ? '#2e7d32' : '#c62828';
  document.getElementById('settlementStatProfitRate').textContent = 'ì´ìµë¥  ' + profitRate + '%';
  
  document.getElementById('settlementStatSettlement').textContent = fmtAmount(totalSettlement);
  
  document.getElementById('settlementStatCompany').textContent = fmtAmount(totalCompany);
}

function generateSettlementFromCurrentData() {
  // 24ë…„, 25ë…„, 26ë…„ ë°ì´í„° ëª¨ë‘ ê°€ì ¸ì˜¤ê¸°
  let allSettlementData = [];
  
  ['2024', '2025', '2026'].forEach(year => {
    const data = allData[year] || [];
    const cancelledList = CANCELLED_INFO[year] || [];
    
    data.filter(item => {
      const noKey = String(Math.floor(Number(item.no)));
      const isCancelled = cancelledList.includes(noKey) || (item.site && item.site.includes('í•´ì§€'));
      return !isCancelled;
    }).forEach(item => {
      const amount = item.amount || 0;
      
      // ì´ê´„í‘œ ë°ì´í„°ì—ì„œ ì‹¤ì œ ì •ì‚° ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      const key = `${year}_${item.no}`;
      const detail = detailData[key];
      
      let material = 0;
      let labor = 0;
      let otherExpense = 0;
      let totalExpense = 0;
      let profit = 0;
      let hasDetailData = false;
      
      if (detail) {
        // ì •ì‚°ì„œ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì‹¤ì œ ë°ì´í„° ì‚¬ìš©
        hasDetailData = true;
        
        // ìì¬ë¹„ í•©ê³„ (ì •ì‚°ì„œ íƒ­)
        if (detail.settlementMaterials && detail.settlementMaterials.length > 0) {
          detail.settlementMaterials.forEach(m => {
            material += parseNumber(m.purchase);
          });
        }
        
        // ë…¸ë¬´ë¹„ í•©ê³„ (ì •ì‚°ì„œ íƒ­)
        if (detail.settlementLabors && detail.settlementLabors.length > 0) {
          detail.settlementLabors.forEach(l => {
            labor += parseNumber(l.purchase);
          });
        }
        
        // ê¸°íƒ€ê²½ë¹„ í•©ê³„ (ì •ì‚°ì„œ íƒ­)
        if (detail.settlementOthers && detail.settlementOthers.length > 0) {
          detail.settlementOthers.forEach(o => {
            otherExpense += parseNumber(o.purchase);
          });
        }
        
        // ê³µì‚¬ íˆ¬ì…ë¹„ë„ í™•ì¸ (ì •ì‚°ì„œ íƒ­)
        if (detail.settlementWorks && detail.settlementWorks.length > 0) {
          detail.settlementWorks.forEach(w => {
            totalExpense += parseNumber(w.purchase);
          });
        }
        
        // ì •ì‚°ì„œ íƒ­ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ê¸ˆì•¡ì´ 0ì´ë©´ íˆ¬ì…ë‚´ì—­(expenses) ì‚¬ìš©
        if ((material === 0 && labor === 0 && otherExpense === 0) && detail.expenses && detail.expenses.length > 0) {
          detail.expenses.forEach(exp => {
            const expAmt = parseNumber(exp.amount);
            if (exp.type === 'ìì¬ë¹„') material += expAmt;
            else if (exp.type === 'ë…¸ë¬´ë¹„') labor += expAmt;
            else otherExpense += expAmt;
          });
        }
        
        // ê°œë³„ í•­ëª©ë„ ì²´í¬ - ì •ì‚°ì„œì— ì—†ìœ¼ë©´ expensesì—ì„œ ê°€ì ¸ì˜¤ê¸°
        if (material === 0 && detail.expenses && detail.expenses.length > 0) {
          detail.expenses.filter(e => e.type === 'ìì¬ë¹„').forEach(exp => {
            material += parseNumber(exp.amount);
          });
        }
        if (labor === 0 && detail.expenses && detail.expenses.length > 0) {
          detail.expenses.filter(e => e.type === 'ë…¸ë¬´ë¹„').forEach(exp => {
            labor += parseNumber(exp.amount);
          });
        }
        if (otherExpense === 0 && detail.expenses && detail.expenses.length > 0) {
          detail.expenses.filter(e => e.type === 'ê¸°íƒ€ê²½ë¹„').forEach(exp => {
            otherExpense += parseNumber(exp.amount);
          });
        }
        
        totalExpense += material + labor + otherExpense;
        
        // ë§¤ì¶œì•¡ (ì •ì‚°ì„œ ê¸°ì¤€)
        const salesAmount = parseNumber(detail.settlementSales) || amount;
        profit = salesAmount - totalExpense;
      } else {
        // ìƒì„¸ ë°ì´í„° ì—†ìœ¼ë©´ ì„ì‹œ ê³„ì‚° (10% ì´ìµ ê°€ì •)
        profit = amount * 0.1;
        totalExpense = amount - profit;
      }
      
      const realSettlement = profit * 0.15;
      const companyProfit = profit * 0.85;
      
      // ì…ê¸ˆ ìƒíƒœ í™•ì¸ í•¨ìˆ˜
      const checkPaid = (p) => {
        if (!p) return false;
        if (p.isRed) return false;
        if (p.manualPaid) return true;
        return p.paid && p.paid !== '' && p.paid !== 'ë¯¸ì •';
      };
      
      // ìƒíƒœ ì„¸ë¶„í™”: ì…ê¸ˆ(ì”ê¸ˆì™„ë£Œ), ì¤‘ë„ê¸ˆ, ê³„ì•½ê¸ˆ, ì§„í–‰, ë¯¸ì…ê¸ˆ
      let status = 'ë¯¸ì…ê¸ˆ';
      let detailStatus = 'unpaid';  // unpaid, progress, contract, interim, paid
      
      if (checkPaid(item.balance1)) {
        status = 'ì…ê¸ˆ';
        detailStatus = 'paid';
      } else if (checkPaid(item.interim1)) {
        status = 'ì§„í–‰';
        detailStatus = 'interim';
      } else if (checkPaid(item.contract1)) {
        status = 'ì§„í–‰';
        detailStatus = 'contract';
      } else if (item.contract1?.amt > 0 || item.interim1?.amt > 0 || item.balance1?.amt > 0) {
        status = 'ì§„í–‰';
        detailStatus = 'progress';
      }
      
      // ì…ê¸ˆì¼ (ì”ê¸ˆ ì…ê¸ˆì¼ ìš°ì„ , ì—†ìœ¼ë©´ ì¤‘ë„ê¸ˆ, ê³„ì•½ê¸ˆ ìˆœ)
      let paidDate = '';
      if (item.balance1?.paid && item.balance1.paid !== 'ë¯¸ì •') {
        paidDate = item.balance1.paid;
      } else if (item.interim1?.paid && item.interim1.paid !== 'ë¯¸ì •') {
        paidDate = item.interim1.paid;
      } else if (item.contract1?.paid && item.contract1.paid !== 'ë¯¸ì •') {
        paidDate = item.contract1.paid;
      }
      
      // ë³¸ì‚¬/ì™¸ì£¼ êµ¬ë¶„ (ë‹´ë‹¹ì ê¸°ì¤€ ìš°ì„ , ì—†ìœ¼ë©´ ê³µì‚¬ìœ í˜•ìœ¼ë¡œ)
      const manager = item.manager || 'ê¸°íƒ€';
      let hqType = 'ë³¸ì‚¬';
      
      // ê³µì‚¬ìœ í˜•ì— (ì™¸) í‘œì‹œê°€ ìˆìœ¼ë©´ ì™¸ì£¼
      if (item.type && item.type.includes('(ì™¸)')) {
        hqType = 'ì™¸ì£¼';
      }
      // ì™¸ì£¼ ë‹´ë‹¹ì ëª©ë¡ì— ìˆìœ¼ë©´ ì™¸ì£¼
      if (EXT_MANAGERS.includes(manager)) {
        hqType = 'ì™¸ì£¼';
      }
      // ë³¸ì‚¬ ë‹´ë‹¹ì ëª©ë¡ì— ìˆìœ¼ë©´ ë¬´ì¡°ê±´ ë³¸ì‚¬ (ìš°ì„ ìˆœìœ„ ë†’ìŒ)
      if (HQ_MANAGERS.includes(manager)) {
        hqType = 'ë³¸ì‚¬';
      }
      
      // ì €ì¥ëœ ì •ì‚° ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°
      let savedSettled = null;
      try {
        const savedStatus = JSON.parse(localStorage.getItem('settlementStatusData') || '{}');
        const statusKey = `${year.substring(2)}_${item.no}`;
        if (savedStatus[statusKey]) {
          savedSettled = savedStatus[statusKey];
        }
      } catch(e) {}
      
      allSettlementData.push({
        year: year.substring(2),  // '24' ë˜ëŠ” '25' ë˜ëŠ” '26'
        no: item.no,
        type: item.type,
        site: item.site,
        amount: amount,
        status: status,
        detailStatus: detailStatus,  // ì„¸ë¶„í™”ëœ ìƒíƒœ
        paidDate: paidDate,
        hqType: hqType,
        material: material,
        labor: labor,
        laborTotal: labor,
        expenseTotal: otherExpense,
        totalExpense: totalExpense,
        profit: profit,
        profitRate: amount > 0 ? profit / amount : 0,
        realSettlement: realSettlement,
        companyProfit: companyProfit,
        manager: manager,
        settled: savedSettled || (detailStatus === 'paid' ? 'ì •ì‚°ì™„ë£Œ' : 'ë¯¸ì •ì‚°'),
        hasDetailData: hasDetailData,  // ì´ê´„í‘œ ë°ì´í„° ìœ ë¬´
        isExcluded: EXCLUDE_MANAGERS.includes(manager)  // ì •ì‚° ì œì™¸ ëŒ€ìƒ
      });
    });
  });
  
  return allSettlementData;
}

// ìˆ«ì íŒŒì‹± í—¬í¼ í•¨ìˆ˜
function parseNumber(val) {
  if (!val) return 0;
  if (typeof val === 'number') return val;
  return parseFloat(String(val).replace(/[,ì›]/g, '')) || 0;
}

function updateManagerFilterOptions() {
  const data = settlementData.length > 0 ? settlementData : generateSettlementFromCurrentData();
  
  // ë°ì´í„°ì—ì„œ ë‹´ë‹¹ì ì¶”ì¶œ + ê¸°ë³¸ ë‹´ë‹¹ì ëª©ë¡ ë³‘í•©
  const managersFromData = data.map(item => item.manager).filter(m => m && m !== 'ê¸°íƒ€');
  const allManagers = new Set([...HQ_MANAGERS, ...managersFromData]);
  const managers = [...allManagers].sort();
  
  const select = document.getElementById('settlementManagerFilter');
  const currentValue = select.value;
  
  select.innerHTML = '<option value="">ì „ì²´ ë‹´ë‹¹ì</option>';
  managers.forEach(manager => {
    select.innerHTML += `<option value="${manager}">${manager}</option>`;
  });
  
  select.value = currentValue;
}

function filterSettlementByManager() {
  renderSettlementTable();
}

function renderManagerSettlementSummary(data) {
  // ë³¸ì‚¬/ì™¸ì£¼ë³„ë¡œ ë‹´ë‹¹ì ë¶„ë¥˜ (ì •ì‚° ì œì™¸ ë‹´ë‹¹ìëŠ” ë³„ë„ í‘œì‹œ)
  const hqManagers = {};
  const extManagers = {};
  const excludedManagers = {};
  let hqTotal = { count: 0, amount: 0, profit: 0, realSettlement: 0 };
  let extTotal = { count: 0, amount: 0, profit: 0, realSettlement: 0 };
  let excludedTotal = { count: 0, amount: 0, profit: 0, realSettlement: 0 };
  
  data.forEach(item => {
    const manager = item.manager || 'ê¸°íƒ€';
    const isExcluded = item.isExcluded || EXCLUDE_MANAGERS.includes(manager);
    const isExt = item.hqType === 'ì™¸ì£¼';
    
    let targetManagers, targetTotal;
    
    if (isExcluded) {
      targetManagers = excludedManagers;
      targetTotal = excludedTotal;
    } else if (isExt) {
      targetManagers = extManagers;
      targetTotal = extTotal;
    } else {
      targetManagers = hqManagers;
      targetTotal = hqTotal;
    }
    
    if (!targetManagers[manager]) {
      targetManagers[manager] = { count: 0, amount: 0, profit: 0, realSettlement: 0, companyProfit: 0 };
    }
    targetManagers[manager].count++;
    targetManagers[manager].amount += item.amount || 0;
    targetManagers[manager].profit += item.profit || 0;
    targetManagers[manager].realSettlement += item.realSettlement || 0;
    targetManagers[manager].companyProfit += item.companyProfit || 0;
    
    targetTotal.count++;
    targetTotal.amount += item.amount || 0;
    targetTotal.profit += item.profit || 0;
    targetTotal.realSettlement += item.realSettlement || 0;
  });
  
  let html = '';
  
  // ë³¸ì‚¬ ë‹´ë‹¹ì
  if (Object.keys(hqManagers).length > 0) {
    html += `
      <div style="margin-bottom:1.5rem;">
        <h4 style="color:#1565c0;margin-bottom:0.75rem;padding:0.5rem;background:#e3f2fd;border-radius:6px;">
          ğŸ¢ ë³¸ì‚¬ ë‹´ë‹¹ì (${hqTotal.count}ê±´ / ì •ì‚°ê¸ˆì•¡: ${fmtAmount(hqTotal.realSettlement)})
        </h4>
        <div class="settlement-summary-grid">
    `;
    
    Object.entries(hqManagers)
      .sort((a, b) => b[1].realSettlement - a[1].realSettlement)
      .forEach(([manager, stats]) => {
        const avgProfitRate = stats.amount > 0 ? (stats.profit / stats.amount * 100).toFixed(1) : 0;
        html += `
          <div class="settlement-summary-card" style="border-left:4px solid #2196f3;">
            <div class="manager-name">ğŸ‘¤ ${manager}</div>
            <div class="summary-row"><span class="label">ê³µì‚¬ê±´ìˆ˜</span><span class="value">${stats.count}ê±´</span></div>
            <div class="summary-row"><span class="label">ê³µì‚¬ê¸ˆì•¡</span><span class="value">${fmtAmount(stats.amount)}</span></div>
            <div class="summary-row"><span class="label">ì´ìµê¸ˆ</span><span class="value" style="color:${stats.profit >= 0 ? 'var(--success)' : 'var(--danger)'};">${fmtAmount(stats.profit)}</span></div>
            <div class="summary-row"><span class="label">ì´ìµë¥ </span><span class="value">${avgProfitRate}%</span></div>
            <div class="summary-row summary-total"><span class="label"><strong>ğŸ’µ ì •ì‚°ê¸ˆì•¡</strong></span><span class="value">${fmtAmount(stats.realSettlement)}</span></div>
          </div>
        `;
      });
    
    html += '</div></div>';
  }
  
  // ì™¸ì£¼ ë‹´ë‹¹ì
  if (Object.keys(extManagers).length > 0) {
    html += `
      <div>
        <h4 style="color:#7b1fa2;margin-bottom:0.75rem;padding:0.5rem;background:#f3e5f5;border-radius:6px;">
          ğŸ¤ ì™¸ì£¼ ë‹´ë‹¹ì (${extTotal.count}ê±´ / ì •ì‚°ê¸ˆì•¡: ${fmtAmount(extTotal.realSettlement)})
        </h4>
        <div class="settlement-summary-grid">
    `;
    
    Object.entries(extManagers)
      .sort((a, b) => b[1].realSettlement - a[1].realSettlement)
      .forEach(([manager, stats]) => {
        const avgProfitRate = stats.amount > 0 ? (stats.profit / stats.amount * 100).toFixed(1) : 0;
        html += `
          <div class="settlement-summary-card" style="border-left:4px solid #9c27b0;">
            <div class="manager-name">ğŸ‘¤ ${manager}</div>
            <div class="summary-row"><span class="label">ê³µì‚¬ê±´ìˆ˜</span><span class="value">${stats.count}ê±´</span></div>
            <div class="summary-row"><span class="label">ê³µì‚¬ê¸ˆì•¡</span><span class="value">${fmtAmount(stats.amount)}</span></div>
            <div class="summary-row"><span class="label">ì´ìµê¸ˆ</span><span class="value" style="color:${stats.profit >= 0 ? 'var(--success)' : 'var(--danger)'};">${fmtAmount(stats.profit)}</span></div>
            <div class="summary-row"><span class="label">ì´ìµë¥ </span><span class="value">${avgProfitRate}%</span></div>
            <div class="summary-row summary-total"><span class="label"><strong>ğŸ’µ ì •ì‚°ê¸ˆì•¡</strong></span><span class="value">${fmtAmount(stats.realSettlement)}</span></div>
          </div>
        `;
      });
    
    html += '</div></div>';
  }
  
  // ì •ì‚° ì œì™¸ ë‹´ë‹¹ì (ì°¸ê³ ìš©)
  if (Object.keys(excludedManagers).length > 0) {
    html += `
      <div style="margin-bottom:1.5rem;">
        <h4 style="color:#757575;margin-bottom:0.75rem;padding:0.5rem;background:#eeeeee;border-radius:6px;">
          ğŸ“Œ ì •ì‚° ì œì™¸ (${excludedTotal.count}ê±´) - ì°¸ê³ ìš©
        </h4>
        <div class="settlement-summary-grid">
    `;
    
    Object.entries(excludedManagers)
      .sort((a, b) => b[1].realSettlement - a[1].realSettlement)
      .forEach(([manager, stats]) => {
        const avgProfitRate = stats.amount > 0 ? (stats.profit / stats.amount * 100).toFixed(1) : 0;
        html += `
          <div class="settlement-summary-card" style="border-left:4px solid #9e9e9e;opacity:0.7;">
            <div class="manager-name">ğŸ‘¤ ${manager}</div>
            <div class="summary-row"><span class="label">ê³µì‚¬ê±´ìˆ˜</span><span class="value">${stats.count}ê±´</span></div>
            <div class="summary-row"><span class="label">ê³µì‚¬ê¸ˆì•¡</span><span class="value">${fmtAmount(stats.amount)}</span></div>
            <div class="summary-row"><span class="label">ì´ìµê¸ˆ</span><span class="value">${fmtAmount(stats.profit)}</span></div>
            <div class="summary-row"><span class="label">ì´ìµë¥ </span><span class="value">${avgProfitRate}%</span></div>
            <div class="summary-row"><span class="label" style="text-decoration:line-through;">ì •ì‚°ê¸ˆì•¡</span><span class="value" style="color:#9e9e9e;">ì œì™¸</span></div>
          </div>
        `;
      });
    
    html += '</div></div>';
  }
  
  if (!html) {
    html = '<div style="text-align:center;color:var(--gray-400);padding:2rem;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
  }
  
  document.getElementById('managerSettlementSummary').innerHTML = html;
}

// ========== ì´ë©”ì¼ ê´€ë¦¬ ëª¨ë‹¬ ==========
function openEmailManageModal() {
  document.getElementById('emailManageModal').classList.add('active');
  renderEmailManageList();
}

function closeEmailManageModal() {
  document.getElementById('emailManageModal').classList.remove('active');
}

function renderEmailManageList() {
  // ëª¨ë“  ë‹´ë‹¹ì ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
  const allManagers = new Set();
  
  // settlementDataì—ì„œ ë‹´ë‹¹ì ìˆ˜ì§‘
  const data = settlementData.length > 0 ? settlementData : generateSettlementFromCurrentData();
  data.forEach(item => {
    if (item.manager) allManagers.add(item.manager);
  });
  
  // HQ_MANAGERSì—ì„œë„ ì¶”ê°€
  HQ_MANAGERS.forEach(m => allManagers.add(m));
  
  const managers = Array.from(allManagers).sort();
  
  let html = `
    <div style="margin-bottom:1rem;padding:0.75rem;background:#e3f2fd;border-radius:6px;font-size:0.85rem;">
      ğŸ“§ ë‹´ë‹¹ìë³„ ì´ë©”ì¼ì„ ë“±ë¡í•˜ë©´ í™•ì¸ì„œ ë°œì†¡ ì‹œ ì‚¬ìš©ë©ë‹ˆë‹¤.
    </div>
    <table style="width:100%;border-collapse:collapse;font-size:0.9rem;">
      <thead>
        <tr style="background:#f5f5f5;">
          <th style="padding:0.75rem;border:1px solid #ddd;text-align:left;width:100px;">ë‹´ë‹¹ì</th>
          <th style="padding:0.75rem;border:1px solid #ddd;text-align:left;">ì´ë©”ì¼</th>
        </tr>
      </thead>
      <tbody>
  `;
  
  managers.forEach(manager => {
    const email = managerEmails[manager] || '';
    html += `
      <tr>
        <td style="padding:0.5rem;border:1px solid #ddd;font-weight:600;">${manager}</td>
        <td style="padding:0.5rem;border:1px solid #ddd;">
          <input type="email" id="email_${manager}" value="${email}" 
            placeholder="example@email.com" 
            style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;">
        </td>
      </tr>
    `;
  });
  
  html += '</tbody></table>';
  document.getElementById('emailManageContent').innerHTML = html;
}

function saveAllManagerEmails() {
  const inputs = document.querySelectorAll('#emailManageContent input[type="email"]');
  inputs.forEach(input => {
    const manager = input.id.replace('email_', '');
    const email = input.value.trim();
    if (email) {
      managerEmails[manager] = email;
    } else {
      delete managerEmails[manager];
    }
  });
  saveManagerEmails();
  showToast('ì´ë©”ì¼ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
  closeEmailManageModal();
}

// ========== ë‹´ë‹¹ì í™•ì¸ì„œ ëª¨ë‹¬ ==========
// ê¸°ìˆ ì»¨ì„¤íŒ… ë°ì´í„° (í™•ì¸ì„œì—ì„œ ì‚¬ìš©)
let consultingData = [];
let filteredConsultingData = [];

let currentConfirmationData = null;
let currentConfirmationManager = null;
let currentConfirmationType = 'construction'; // construction, consulting, integrated

// ê¸°ìˆ ì»¨ì„¤íŒ… ë°ì´í„° ë¡œë“œ
function loadConsultingData() {
  try {
    const saved = localStorage.getItem('consultingData');
    if (saved) {
      consultingData = JSON.parse(saved);
    }
  } catch(e) {
    console.error('ê¸°ìˆ ì»¨ì„¤íŒ… ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
    consultingData = [];
  }
}

function openConfirmationModal() {
  document.getElementById('confirmationModal').classList.add('active');
  
  // ê¸°ë³¸ íƒ­ ì„¤ì •
  currentConfirmationType = 'construction';
  switchConfirmationTab('construction');
  
  // ë‹´ë‹¹ì ëª©ë¡ ì±„ìš°ê¸°
  populateConfirmationManagerSelect();
  
  renderConfirmationPreview();
}

// í™•ì¸ì„œ íƒ­ ì „í™˜
function switchConfirmationTab(tab) {
  currentConfirmationType = tab;
  
  const tabConstruction = document.getElementById('confirmTabConstruction');
  const tabConsulting = document.getElementById('confirmTabConsulting');
  const tabIntegrated = document.getElementById('confirmTabIntegrated');
  
  // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
  [tabConstruction, tabConsulting, tabIntegrated].forEach(t => {
    t.style.background = '#e0e0e0';
    t.style.color = '#666';
  });
  
  // ì„ íƒëœ íƒ­ í™œì„±í™”
  if (tab === 'construction') {
    tabConstruction.style.background = '#1976d2';
    tabConstruction.style.color = 'white';
  } else if (tab === 'consulting') {
    tabConsulting.style.background = '#00897b';
    tabConsulting.style.color = 'white';
  } else {
    tabIntegrated.style.background = '#9c27b0';
    tabIntegrated.style.color = 'white';
  }
  
  renderConfirmationPreview();
}

function populateConfirmationManagerSelect() {
  // ê³µì‚¬ì •ì‚° ë°ì´í„°
  const constructionData = settlementData.length > 0 ? settlementData : generateSettlementFromCurrentData();
  
  // ê¸°ìˆ ì»¨ì„¤íŒ… ë°ì´í„°
  loadConsultingData();
  
  // ëª¨ë“  ë‹´ë‹¹ì ìˆ˜ì§‘
  const managersFromConstruction = constructionData.map(item => item.manager).filter(m => m && m !== 'ê¸°íƒ€');
  const managersFromConsulting = consultingData.map(item => item.manager).filter(m => m && m !== 'ê¸°íƒ€');
  const allManagers = new Set([...HQ_MANAGERS, ...managersFromConstruction, ...managersFromConsulting]);
  const managers = [...allManagers].sort();
  
  const select = document.getElementById('confirmationManagerSelect');
  select.innerHTML = '<option value="">ì „ì²´ ë‹´ë‹¹ì</option>';
  managers.forEach(manager => {
    select.innerHTML += `<option value="${manager}">${manager}</option>`;
  });
}

function closeConfirmationModal() {
  document.getElementById('confirmationModal').classList.remove('active');
}

function getFilteredConfirmationData() {
  let data = settlementData.length > 0 ? [...settlementData] : generateSettlementFromCurrentData();
  
  // í™•ì¸ì„œ ëª¨ë‹¬ ë‚´ í•„í„° ì‚¬ìš©
  const yearFilter = document.getElementById('confirmationYearSelect')?.value || '';
  const managerFilter = document.getElementById('confirmationManagerSelect')?.value || '';
  const settledFilter = document.getElementById('confirmationSettledSelect')?.value || '';
  
  // ë…„ë„ í•„í„°
  if (yearFilter === '2024') {
    data = data.filter(item => String(item.year).includes('24'));
  } else if (yearFilter === '2025') {
    data = data.filter(item => String(item.year).includes('25'));
  } else if (yearFilter === '2026') {
    data = data.filter(item => String(item.year).includes('26'));
  } else if (yearFilter === '2024+2025') {
    data = data.filter(item => {
      const is24 = String(item.year).includes('24');
      const is25 = String(item.year).includes('25');
      if (is24) return item.settled !== 'ì •ì‚°ì™„ë£Œ';
      return is25;
    });
  }
  
  // ë‹´ë‹¹ì í•„í„°
  if (managerFilter) {
    data = data.filter(item => item.manager === managerFilter);
  }
  
  // ì •ì‚°ì—¬ë¶€ í•„í„°
  if (settledFilter) {
    data = data.filter(item => item.settled === settledFilter);
  }
  
  return { data, managerFilter, settledFilter, yearFilter };
}

function renderConfirmationPreview() {
  // íƒ­ì— ë”°ë¼ ë‹¤ë¥¸ ë Œë”ë§ í•¨ìˆ˜ í˜¸ì¶œ
  if (currentConfirmationType === 'consulting') {
    renderConsultingConfirmationPreview();
  } else if (currentConfirmationType === 'integrated') {
    renderIntegratedConfirmationPreview();
  } else {
    renderConstructionConfirmationPreview();
  }
}

// ê³µì‚¬ì •ì‚° í™•ì¸ì„œ ë¯¸ë¦¬ë³´ê¸°
function renderConstructionConfirmationPreview() {
  const { data, managerFilter, settledFilter } = getFilteredConfirmationData();
  
  currentConfirmationData = data;
  currentConfirmationManager = managerFilter;
  
  if (data.length === 0) {
    document.getElementById('confirmationPreview').innerHTML = `
      <div style="text-align:center;padding:2rem;color:#999;">
        ì¶œë ¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. í•„í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.
      </div>
    `;
    return;
  }
  
  const managerName = managerFilter || 'ì „ì²´ ë‹´ë‹¹ì';
  const managerEmail = managerEmails[managerFilter] || '';
  const statusText = settledFilter || 'ì „ì²´';
  
  // í•©ê³„ ê³„ì‚°
  let totalAmount = 0, totalProfit = 0, totalSettlement = 0;
  data.forEach(item => {
    totalAmount += item.amount || 0;
    totalProfit += item.profit || 0;
    totalSettlement += item.realSettlement || 0;
  });
  
  const today = new Date();
  const reportDate = `${today.getFullYear()}ë…„ ${today.getMonth()+1}ì›” ${today.getDate()}ì¼`;
  
  // 24ë…„/25ë…„ ë¶„ë¦¬
  const data24 = data.filter(item => String(item.year).includes('24'));
  const data25 = data.filter(item => String(item.year).includes('25'));
  
  const total24 = data24.reduce((sum, i) => sum + (i.realSettlement || 0), 0);
  const total25 = data25.reduce((sum, i) => sum + (i.realSettlement || 0), 0);
  
  let html = `
    <div style="border:1px solid #ddd;border-radius:8px;overflow:hidden;">
      <!-- ë‹´ë‹¹ì ì •ë³´ -->
      <div style="background:#1976d2;color:white;padding:1rem;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <span style="font-size:0.85rem;opacity:0.9;">ğŸ—ï¸ ê³µì‚¬ì •ì‚°</span>
            <strong style="font-size:1.2rem;margin-left:0.5rem;">ğŸ‘¤ ${managerName}</strong>
            <span style="margin-left:1rem;font-size:0.85rem;opacity:0.9;">ìƒíƒœ: ${statusText}</span>
          </div>
          <div style="font-size:0.85rem;">
            ${managerEmail ? `ğŸ“§ ${managerEmail}` : '<span style="opacity:0.7;">ì´ë©”ì¼ ë¯¸ë“±ë¡</span>'}
          </div>
        </div>
      </div>
      
      <!-- ìš”ì•½ -->
      <div style="padding:1rem;background:#e3f2fd;">
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;text-align:center;">
          <div>
            <div style="font-size:0.75rem;color:#666;">ì´ ê±´ìˆ˜</div>
            <div style="font-size:1.1rem;font-weight:700;">${data.length}ê±´</div>
          </div>
          <div>
            <div style="font-size:0.75rem;color:#666;">ì´ ê³µì‚¬ê¸ˆì•¡</div>
            <div style="font-size:1.1rem;font-weight:700;">${fmt(totalAmount)}</div>
          </div>
          <div>
            <div style="font-size:0.75rem;color:#666;">ì´ ì´ìµê¸ˆ</div>
            <div style="font-size:1.1rem;font-weight:700;color:${totalProfit >= 0 ? '#2e7d32' : '#c62828'};">${fmt(totalProfit)}</div>
          </div>
          <div>
            <div style="font-size:0.75rem;color:#666;">ì •ì‚°ê¸ˆì•¡</div>
            <div style="font-size:1.1rem;font-weight:700;color:#1565c0;">${fmt(totalSettlement)}</div>
          </div>
        </div>
      </div>
      
      <!-- í˜„ì¥ ëª©ë¡ -->
      <div style="padding:1rem;max-height:300px;overflow-y:auto;">
  `;
  
  // 24ë…„ ë°ì´í„°
  if (data24.length > 0) {
    html += `
      <h4 style="margin:0 0 0.5rem 0;color:#e65100;">ğŸ“… 2024ë…„ (${data24.length}ê±´) - ${fmt(total24)}</h4>
      <table style="width:100%;border-collapse:collapse;font-size:0.8rem;margin-bottom:1rem;">
        <thead>
          <tr style="background:#ffecb3;">
            <th style="padding:0.4rem;border:1px solid #ddd;">NO</th>
            <th style="padding:0.4rem;border:1px solid #ddd;text-align:left;">í˜„ì¥ëª…</th>
            <th style="padding:0.4rem;border:1px solid #ddd;text-align:right;">ì •ì‚°ê¸ˆì•¡</th>
          </tr>
        </thead>
        <tbody>
          ${data24.map(item => `
            <tr>
              <td style="padding:0.4rem;border:1px solid #ddd;text-align:center;">${item.no}</td>
              <td style="padding:0.4rem;border:1px solid #ddd;">${item.site || ''}</td>
              <td style="padding:0.4rem;border:1px solid #ddd;text-align:right;font-family:monospace;">${fmt(item.realSettlement)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }
  
  // 25ë…„ ë°ì´í„°
  if (data25.length > 0) {
    html += `
      <h4 style="margin:0 0 0.5rem 0;color:#1565c0;">ğŸ“… 2025ë…„ (${data25.length}ê±´) - ${fmt(total25)}</h4>
      <table style="width:100%;border-collapse:collapse;font-size:0.8rem;">
        <thead>
          <tr style="background:#bbdefb;">
            <th style="padding:0.4rem;border:1px solid #ddd;">NO</th>
            <th style="padding:0.4rem;border:1px solid #ddd;text-align:left;">í˜„ì¥ëª…</th>
            <th style="padding:0.4rem;border:1px solid #ddd;text-align:right;">ì •ì‚°ê¸ˆì•¡</th>
          </tr>
        </thead>
        <tbody>
          ${data25.map(item => `
            <tr>
              <td style="padding:0.4rem;border:1px solid #ddd;text-align:center;">${item.no}</td>
              <td style="padding:0.4rem;border:1px solid #ddd;">${item.site || ''}</td>
              <td style="padding:0.4rem;border:1px solid #ddd;text-align:right;font-family:monospace;">${fmt(item.realSettlement)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }
  
  html += `
      </div>
      
      <!-- ì´ì•¡ -->
      <div style="background:#e3f2fd;padding:1rem;text-align:center;border-top:1px solid #ddd;">
        <span style="color:#1565c0;">ğŸ“Œ ê³µì‚¬ì •ì‚° ì´ì•¡: </span>
        <strong style="font-size:1.3rem;color:#1565c0;">${fmt(totalSettlement)}</strong>
      </div>
    </div>
  `;
  
  document.getElementById('confirmationPreview').innerHTML = html;
}

// ê¸°ìˆ ì»¨ì„¤íŒ… í™•ì¸ì„œ ë¯¸ë¦¬ë³´ê¸°
function renderConsultingConfirmationPreview() {
  loadConsultingData();
  
  const yearFilter = document.getElementById('confirmationYearSelect')?.value || '';
  const managerFilter = document.getElementById('confirmationManagerSelect')?.value || '';
  const settledFilter = document.getElementById('confirmationSettledSelect')?.value || '';
  
  let data = [...consultingData];
  
  // í•„í„° ì ìš©
  if (yearFilter && yearFilter !== '2024+2025') {
    data = data.filter(item => item.year === yearFilter);
  } else if (yearFilter === '2024+2025') {
    data = data.filter(item => {
      if (item.year === '2024') return item.settled !== 'ì •ì‚°ì™„ë£Œ';
      return item.year === '2025';
    });
  }
  
  if (managerFilter) {
    data = data.filter(item => item.manager === managerFilter);
  }
  
  if (settledFilter) {
    data = data.filter(item => item.settled === settledFilter);
  }
  
  if (data.length === 0) {
    document.getElementById('confirmationPreview').innerHTML = `
      <div style="text-align:center;padding:2rem;color:#999;">
        ê¸°ìˆ ì»¨ì„¤íŒ… ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. í•„í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.
      </div>
    `;
    return;
  }
  
  const managerName = managerFilter || 'ì „ì²´ ë‹´ë‹¹ì';
  const managerEmail = managerEmails[managerFilter] || '';
  const statusText = settledFilter || 'ì „ì²´';
  
  // í•©ê³„ ê³„ì‚°
  let totalBidAmount = 0, totalProfit = 0, totalSettlement = 0;
  data.forEach(item => {
    totalBidAmount += item.bidAmount || 0;
    totalProfit += item.profit || 0;
    totalSettlement += item.settlement || 0;
  });
  
  // ë…„ë„ë³„ ë¶„ë¦¬
  const data24 = data.filter(item => item.year === '2024');
  const data25 = data.filter(item => item.year === '2025');
  const data26 = data.filter(item => item.year === '2026');
  
  const total24 = data24.reduce((sum, i) => sum + (i.settlement || 0), 0);
  const total25 = data25.reduce((sum, i) => sum + (i.settlement || 0), 0);
  const total26 = data26.reduce((sum, i) => sum + (i.settlement || 0), 0);
  
  let html = `
    <div style="border:1px solid #ddd;border-radius:8px;overflow:hidden;">
      <!-- ë‹´ë‹¹ì ì •ë³´ -->
      <div style="background:#00897b;color:white;padding:1rem;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <span style="font-size:0.85rem;opacity:0.9;">ğŸ“‹ ê¸°ìˆ ì»¨ì„¤íŒ…</span>
            <strong style="font-size:1.2rem;margin-left:0.5rem;">ğŸ‘¤ ${managerName}</strong>
            <span style="margin-left:1rem;font-size:0.85rem;opacity:0.9;">ìƒíƒœ: ${statusText}</span>
          </div>
          <div style="font-size:0.85rem;">
            ${managerEmail ? `ğŸ“§ ${managerEmail}` : '<span style="opacity:0.7;">ì´ë©”ì¼ ë¯¸ë“±ë¡</span>'}
          </div>
        </div>
      </div>
      
      <!-- ìš”ì•½ -->
      <div style="padding:1rem;background:#e0f2f1;">
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;text-align:center;">
          <div>
            <div style="font-size:0.75rem;color:#666;">ì´ ê±´ìˆ˜</div>
            <div style="font-size:1.1rem;font-weight:700;">${data.length}ê±´</div>
          </div>
          <div>
            <div style="font-size:0.75rem;color:#666;">ì´ ë‚™ì°°ê¸ˆì•¡</div>
            <div style="font-size:1.1rem;font-weight:700;">${fmt(totalBidAmount)}</div>
          </div>
          <div>
            <div style="font-size:0.75rem;color:#666;">ì´ ì´ìµê¸ˆ</div>
            <div style="font-size:1.1rem;font-weight:700;color:${totalProfit >= 0 ? '#2e7d32' : '#c62828'};">${fmt(totalProfit)}</div>
          </div>
          <div>
            <div style="font-size:0.75rem;color:#666;">ì •ì‚°ê¸ˆì•¡</div>
            <div style="font-size:1.1rem;font-weight:700;color:#00897b;">${fmt(totalSettlement)}</div>
          </div>
        </div>
      </div>
      
      <!-- í˜„ì¥ ëª©ë¡ -->
      <div style="padding:1rem;max-height:300px;overflow-y:auto;">
  `;
  
  // ë…„ë„ë³„ í…Œì´ë¸” ìƒì„± í•¨ìˆ˜
  const renderYearTable = (yearData, year, yearTotal, bgColor) => {
    if (yearData.length === 0) return '';
    return `
      <h4 style="margin:0 0 0.5rem 0;color:#00695c;">ğŸ“… ${year}ë…„ (${yearData.length}ê±´) - ${fmt(yearTotal)}</h4>
      <table style="width:100%;border-collapse:collapse;font-size:0.8rem;margin-bottom:1rem;">
        <thead>
          <tr style="background:${bgColor};">
            <th style="padding:0.4rem;border:1px solid #ddd;text-align:left;">í˜„ì¥ëª…</th>
            <th style="padding:0.4rem;border:1px solid #ddd;text-align:left;">ê³µì‚¬ëª…</th>
            <th style="padding:0.4rem;border:1px solid #ddd;text-align:right;">ì •ì‚°ê¸ˆì•¡</th>
          </tr>
        </thead>
        <tbody>
          ${yearData.map(item => `
            <tr>
              <td style="padding:0.4rem;border:1px solid #ddd;">${item.site || ''}</td>
              <td style="padding:0.4rem;border:1px solid #ddd;font-size:0.75rem;color:#666;">${item.project || '-'}</td>
              <td style="padding:0.4rem;border:1px solid #ddd;text-align:right;font-family:monospace;">${fmt(item.settlement)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  };
  
  html += renderYearTable(data24, '2024', total24, '#ffecb3');
  html += renderYearTable(data25, '2025', total25, '#b2dfdb');
  html += renderYearTable(data26, '2026', total26, '#c8e6c9');
  
  html += `
      </div>
      
      <!-- ì´ì•¡ -->
      <div style="background:#e0f2f1;padding:1rem;text-align:center;border-top:1px solid #ddd;">
        <span style="color:#00695c;">ğŸ“Œ ê¸°ìˆ ì»¨ì„¤íŒ… ì •ì‚° ì´ì•¡: </span>
        <strong style="font-size:1.3rem;color:#00695c;">${fmt(totalSettlement)}</strong>
      </div>
    </div>
  `;
  
  document.getElementById('confirmationPreview').innerHTML = html;
}

// í†µí•© í™•ì¸ì„œ ë¯¸ë¦¬ë³´ê¸°
function renderIntegratedConfirmationPreview() {
  // ê³µì‚¬ì •ì‚° ë°ì´í„°
  const { data: constructionData, managerFilter, settledFilter } = getFilteredConfirmationData();
  
  // ê¸°ìˆ ì»¨ì„¤íŒ… ë°ì´í„°
  loadConsultingData();
  const yearFilter = document.getElementById('confirmationYearSelect')?.value || '';
  
  let consultingFiltered = [...consultingData];
  
  if (yearFilter && yearFilter !== '2024+2025') {
    consultingFiltered = consultingFiltered.filter(item => item.year === yearFilter);
  } else if (yearFilter === '2024+2025') {
    consultingFiltered = consultingFiltered.filter(item => {
      if (item.year === '2024') return item.settled !== 'ì •ì‚°ì™„ë£Œ';
      return item.year === '2025';
    });
  }
  
  if (managerFilter) {
    consultingFiltered = consultingFiltered.filter(item => item.manager === managerFilter);
  }
  
  if (settledFilter) {
    consultingFiltered = consultingFiltered.filter(item => item.settled === settledFilter);
  }
  
  if (constructionData.length === 0 && consultingFiltered.length === 0) {
    document.getElementById('confirmationPreview').innerHTML = `
      <div style="text-align:center;padding:2rem;color:#999;">
        ì¶œë ¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. í•„í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.
      </div>
    `;
    return;
  }
  
  const managerName = managerFilter || 'ì „ì²´ ë‹´ë‹¹ì';
  const managerEmail = managerEmails[managerFilter] || '';
  const statusText = settledFilter || 'ì „ì²´';
  
  // ê³µì‚¬ì •ì‚° í•©ê³„
  let constructionTotal = 0;
  constructionData.forEach(item => {
    constructionTotal += item.realSettlement || 0;
  });
  
  // ê¸°ìˆ ì»¨ì„¤íŒ… í•©ê³„
  let consultingTotal = 0;
  consultingFiltered.forEach(item => {
    consultingTotal += item.settlement || 0;
  });
  
  const grandTotal = constructionTotal + consultingTotal;
  
  let html = `
    <div style="border:1px solid #ddd;border-radius:8px;overflow:hidden;">
      <!-- ë‹´ë‹¹ì ì •ë³´ -->
      <div style="background:#9c27b0;color:white;padding:1rem;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <span style="font-size:0.85rem;opacity:0.9;">ğŸ“Š í†µí•© í™•ì¸ì„œ</span>
            <strong style="font-size:1.2rem;margin-left:0.5rem;">ğŸ‘¤ ${managerName}</strong>
            <span style="margin-left:1rem;font-size:0.85rem;opacity:0.9;">ìƒíƒœ: ${statusText}</span>
          </div>
          <div style="font-size:0.85rem;">
            ${managerEmail ? `ğŸ“§ ${managerEmail}` : '<span style="opacity:0.7;">ì´ë©”ì¼ ë¯¸ë“±ë¡</span>'}
          </div>
        </div>
      </div>
      
      <!-- í†µí•© ìš”ì•½ -->
      <div style="padding:1rem;background:#f3e5f5;">
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;text-align:center;">
          <div>
            <div style="font-size:0.75rem;color:#666;">ê³µì‚¬ì •ì‚°</div>
            <div style="font-size:1rem;font-weight:700;color:#1976d2;">${constructionData.length}ê±´</div>
            <div style="font-size:0.9rem;color:#1976d2;">${fmt(constructionTotal)}</div>
          </div>
          <div>
            <div style="font-size:0.75rem;color:#666;">ê¸°ìˆ ì»¨ì„¤íŒ…</div>
            <div style="font-size:1rem;font-weight:700;color:#00897b;">${consultingFiltered.length}ê±´</div>
            <div style="font-size:0.9rem;color:#00897b;">${fmt(consultingTotal)}</div>
          </div>
          <div>
            <div style="font-size:0.75rem;color:#666;">ì´ ê±´ìˆ˜</div>
            <div style="font-size:1.1rem;font-weight:700;">${constructionData.length + consultingFiltered.length}ê±´</div>
          </div>
          <div>
            <div style="font-size:0.75rem;color:#666;">ì •ì‚° ì´ì•¡</div>
            <div style="font-size:1.2rem;font-weight:700;color:#9c27b0;">${fmt(grandTotal)}</div>
          </div>
        </div>
      </div>
      
      <!-- ìƒì„¸ ëª©ë¡ -->
      <div style="padding:1rem;max-height:350px;overflow-y:auto;">
  `;
  
  // ê³µì‚¬ì •ì‚° ì„¹ì…˜
  if (constructionData.length > 0) {
    html += `
      <div style="margin-bottom:1.5rem;">
        <h4 style="margin:0 0 0.5rem 0;color:#1976d2;display:flex;align-items:center;gap:0.5rem;">
          <span style="background:#1976d2;color:white;padding:0.2rem 0.5rem;border-radius:4px;font-size:0.75rem;">ğŸ—ï¸ ê³µì‚¬ì •ì‚°</span>
          ${constructionData.length}ê±´ / ${fmt(constructionTotal)}
        </h4>
        <table style="width:100%;border-collapse:collapse;font-size:0.8rem;">
          <thead>
            <tr style="background:#e3f2fd;">
              <th style="padding:0.4rem;border:1px solid #ddd;width:50px;">ë…„ë„</th>
              <th style="padding:0.4rem;border:1px solid #ddd;text-align:left;">í˜„ì¥ëª…</th>
              <th style="padding:0.4rem;border:1px solid #ddd;text-align:right;width:100px;">ì •ì‚°ê¸ˆì•¡</th>
            </tr>
          </thead>
          <tbody>
            ${constructionData.map(item => `
              <tr>
                <td style="padding:0.4rem;border:1px solid #ddd;text-align:center;">${item.year}</td>
                <td style="padding:0.4rem;border:1px solid #ddd;">${item.site || ''}</td>
                <td style="padding:0.4rem;border:1px solid #ddd;text-align:right;font-family:monospace;">${fmt(item.realSettlement)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
  }
  
  // ê¸°ìˆ ì»¨ì„¤íŒ… ì„¹ì…˜
  if (consultingFiltered.length > 0) {
    html += `
      <div>
        <h4 style="margin:0 0 0.5rem 0;color:#00897b;display:flex;align-items:center;gap:0.5rem;">
          <span style="background:#00897b;color:white;padding:0.2rem 0.5rem;border-radius:4px;font-size:0.75rem;">ğŸ“‹ ê¸°ìˆ ì»¨ì„¤íŒ…</span>
          ${consultingFiltered.length}ê±´ / ${fmt(consultingTotal)}
        </h4>
        <table style="width:100%;border-collapse:collapse;font-size:0.8rem;">
          <thead>
            <tr style="background:#e0f2f1;">
              <th style="padding:0.4rem;border:1px solid #ddd;width:50px;">ë…„ë„</th>
              <th style="padding:0.4rem;border:1px solid #ddd;text-align:left;">í˜„ì¥ëª…</th>
              <th style="padding:0.4rem;border:1px solid #ddd;text-align:right;width:100px;">ì •ì‚°ê¸ˆì•¡</th>
            </tr>
          </thead>
          <tbody>
            ${consultingFiltered.map(item => `
              <tr>
                <td style="padding:0.4rem;border:1px solid #ddd;text-align:center;">${item.year}</td>
                <td style="padding:0.4rem;border:1px solid #ddd;">${item.site || ''}</td>
                <td style="padding:0.4rem;border:1px solid #ddd;text-align:right;font-family:monospace;">${fmt(item.settlement)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
  }
  
  html += `
      </div>
      
      <!-- ì´ì•¡ -->
      <div style="background:#f3e5f5;padding:1rem;text-align:center;border-top:1px solid #ddd;">
        <div style="display:flex;justify-content:center;gap:2rem;flex-wrap:wrap;">
          <span style="color:#1976d2;">ğŸ—ï¸ ê³µì‚¬: <strong>${fmt(constructionTotal)}</strong></span>
          <span style="color:#00897b;">ğŸ“‹ ì»¨ì„¤íŒ…: <strong>${fmt(consultingTotal)}</strong></span>
          <span style="color:#9c27b0;font-size:1.1rem;">ğŸ“Œ ì´ì•¡: <strong style="font-size:1.3rem;">${fmt(grandTotal)}</strong></span>
        </div>
      </div>
    </div>
  `;
  
  document.getElementById('confirmationPreview').innerHTML = html;
}

function generateConfirmationHTML(forPDF = false) {
  const { data, managerFilter, settledFilter } = getFilteredConfirmationData();
  
  if (data.length === 0) return '';
  
  const managerName = managerFilter || 'ì „ì²´ ë‹´ë‹¹ì';
  const statusText = settledFilter || 'ì „ì²´';
  
  let totalAmount = 0, totalProfit = 0, totalSettlement = 0;
  data.forEach(item => {
    totalAmount += item.amount || 0;
    totalProfit += item.profit || 0;
    totalSettlement += item.realSettlement || 0;
  });
  
  const today = new Date();
  const reportDate = `${today.getFullYear()}ë…„ ${today.getMonth()+1}ì›” ${today.getDate()}ì¼`;
  
  const data24 = data.filter(item => String(item.year).includes('24'));
  const data25 = data.filter(item => String(item.year).includes('25'));
  const total24 = data24.reduce((sum, i) => sum + (i.realSettlement || 0), 0);
  const total25 = data25.reduce((sum, i) => sum + (i.realSettlement || 0), 0);
  
  let html = `
    <div style="font-family:'Noto Sans KR','Malgun Gothic',sans-serif;padding:20px;max-width:800px;margin:0 auto;">
      <div style="text-align:center;margin-bottom:2rem;border-bottom:2px solid #333;padding-bottom:1rem;">
        <h2 style="margin:0 0 0.5rem 0;font-size:1.5rem;">ğŸ“‹ ì •ì‚° í™•ì¸ì„œ</h2>
        <p style="margin:0;color:#666;font-size:0.9rem;">ë‹´ë‹¹ì: <strong style="color:#1565c0;font-size:1.1rem;">${managerName}</strong></p>
        <p style="margin:0.25rem 0 0 0;color:#888;font-size:0.8rem;">ë°œí–‰ì¼: ${reportDate} / ìƒíƒœ: ${statusText}</p>
      </div>
      
      <!-- ìš”ì•½ -->
      <div style="background:#f5f5f5;padding:1rem;border-radius:8px;margin-bottom:1.5rem;">
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;text-align:center;">
          <div>
            <div style="font-size:0.75rem;color:#666;">ì´ ê±´ìˆ˜</div>
            <div style="font-size:1.2rem;font-weight:700;">${data.length}ê±´</div>
          </div>
          <div>
            <div style="font-size:0.75rem;color:#666;">ì´ ê³µì‚¬ê¸ˆì•¡</div>
            <div style="font-size:1.2rem;font-weight:700;">${fmt(totalAmount)}</div>
          </div>
          <div>
            <div style="font-size:0.75rem;color:#666;">ì´ ì´ìµê¸ˆ</div>
            <div style="font-size:1.2rem;font-weight:700;color:${totalProfit >= 0 ? '#2e7d32' : '#c62828'};">${fmt(totalProfit)}</div>
          </div>
          <div>
            <div style="font-size:0.75rem;color:#666;">ì •ì‚°ê¸ˆì•¡ (15%)</div>
            <div style="font-size:1.2rem;font-weight:700;color:#1565c0;">${fmt(totalSettlement)}</div>
          </div>
        </div>
      </div>
  `;
  
  // 24ë…„ ë°ì´í„°
  if (data24.length > 0) {
    html += `
      <div style="margin-bottom:1.5rem;">
        <h3 style="font-size:1rem;margin-bottom:0.75rem;color:#e65100;padding:0.5rem;background:#fff3e0;border-radius:4px;">
          ğŸ“… 2024ë…„ (${data24.length}ê±´) - ì •ì‚°ê¸ˆì•¡: <strong>${fmt(total24)}</strong>
        </h3>
        <table style="width:100%;border-collapse:collapse;font-size:0.8rem;">
          <thead>
            <tr style="background:#ff9800;color:white;">
              <th style="padding:0.5rem;border:1px solid #e65100;text-align:center;">NO</th>
              <th style="padding:0.5rem;border:1px solid #e65100;text-align:left;">ê³µì‚¬í˜„ì¥</th>
              <th style="padding:0.5rem;border:1px solid #e65100;text-align:right;">ê³µì‚¬ê¸ˆì•¡</th>
              <th style="padding:0.5rem;border:1px solid #e65100;text-align:right;">ì´ìµê¸ˆ</th>
              <th style="padding:0.5rem;border:1px solid #e65100;text-align:right;">ì •ì‚°ê¸ˆì•¡</th>
            </tr>
          </thead>
          <tbody>
            ${data24.map(item => `
              <tr>
                <td style="padding:0.5rem;border:1px solid #ddd;text-align:center;">${item.no}</td>
                <td style="padding:0.5rem;border:1px solid #ddd;">${item.site || ''}</td>
                <td style="padding:0.5rem;border:1px solid #ddd;text-align:right;font-family:monospace;">${fmt(item.amount)}</td>
                <td style="padding:0.5rem;border:1px solid #ddd;text-align:right;font-family:monospace;color:${item.profit >= 0 ? '#2e7d32' : '#c62828'};">${fmt(item.profit)}</td>
                <td style="padding:0.5rem;border:1px solid #ddd;text-align:right;font-family:monospace;font-weight:600;color:#1565c0;">${fmt(item.realSettlement)}</td>
              </tr>
            `).join('')}
          </tbody>
          <tfoot>
            <tr style="background:#ffecb3;font-weight:700;">
              <td colspan="2" style="padding:0.5rem;border:1px solid #ddd;">2024ë…„ ì†Œê³„</td>
              <td style="padding:0.5rem;border:1px solid #ddd;text-align:right;font-family:monospace;">${fmt(data24.reduce((s,i) => s + (i.amount||0), 0))}</td>
              <td style="padding:0.5rem;border:1px solid #ddd;text-align:right;font-family:monospace;">${fmt(data24.reduce((s,i) => s + (i.profit||0), 0))}</td>
              <td style="padding:0.5rem;border:1px solid #ddd;text-align:right;font-family:monospace;color:#e65100;">${fmt(total24)}</td>
            </tr>
          </tfoot>
        </table>
      </div>
    `;
  }
  
  // 25ë…„ ë°ì´í„°
  if (data25.length > 0) {
    html += `
      <div style="margin-bottom:1.5rem;">
        <h3 style="font-size:1rem;margin-bottom:0.75rem;color:#1565c0;padding:0.5rem;background:#e3f2fd;border-radius:4px;">
          ğŸ“… 2025ë…„ (${data25.length}ê±´) - ì •ì‚°ê¸ˆì•¡: <strong>${fmt(total25)}</strong>
        </h3>
        <table style="width:100%;border-collapse:collapse;font-size:0.8rem;">
          <thead>
            <tr style="background:#1976d2;color:white;">
              <th style="padding:0.5rem;border:1px solid #1565c0;text-align:center;">NO</th>
              <th style="padding:0.5rem;border:1px solid #1565c0;text-align:left;">ê³µì‚¬í˜„ì¥</th>
              <th style="padding:0.5rem;border:1px solid #1565c0;text-align:right;">ê³µì‚¬ê¸ˆì•¡</th>
              <th style="padding:0.5rem;border:1px solid #1565c0;text-align:right;">ì´ìµê¸ˆ</th>
              <th style="padding:0.5rem;border:1px solid #1565c0;text-align:right;">ì •ì‚°ê¸ˆì•¡</th>
            </tr>
          </thead>
          <tbody>
            ${data25.map(item => `
              <tr>
                <td style="padding:0.5rem;border:1px solid #ddd;text-align:center;">${item.no}</td>
                <td style="padding:0.5rem;border:1px solid #ddd;">${item.site || ''}</td>
                <td style="padding:0.5rem;border:1px solid #ddd;text-align:right;font-family:monospace;">${fmt(item.amount)}</td>
                <td style="padding:0.5rem;border:1px solid #ddd;text-align:right;font-family:monospace;color:${item.profit >= 0 ? '#2e7d32' : '#c62828'};">${fmt(item.profit)}</td>
                <td style="padding:0.5rem;border:1px solid #ddd;text-align:right;font-family:monospace;font-weight:600;color:#1565c0;">${fmt(item.realSettlement)}</td>
              </tr>
            `).join('')}
          </tbody>
          <tfoot>
            <tr style="background:#bbdefb;font-weight:700;">
              <td colspan="2" style="padding:0.5rem;border:1px solid #ddd;">2025ë…„ ì†Œê³„</td>
              <td style="padding:0.5rem;border:1px solid #ddd;text-align:right;font-family:monospace;">${fmt(data25.reduce((s,i) => s + (i.amount||0), 0))}</td>
              <td style="padding:0.5rem;border:1px solid #ddd;text-align:right;font-family:monospace;">${fmt(data25.reduce((s,i) => s + (i.profit||0), 0))}</td>
              <td style="padding:0.5rem;border:1px solid #ddd;text-align:right;font-family:monospace;color:#1565c0;">${fmt(total25)}</td>
            </tr>
          </tfoot>
        </table>
      </div>
    `;
  }
  
  // ì´ì•¡ ë° íšŒì‹  ìš”ì²­
  html += `
      <div style="background:#ffebee;padding:1rem;border-radius:8px;margin-bottom:1.5rem;text-align:center;border:1px solid #ef9a9a;">
        <span style="font-size:1rem;color:#c62828;">ğŸ“Œ ì •ì‚° ì´ì•¡: </span>
        <span style="font-size:1.5rem;font-weight:700;color:#c62828;">${fmt(totalSettlement)}</span>
        ${data24.length > 0 && data25.length > 0 ? `
        <span style="font-size:0.85rem;color:#666;margin-left:0.5rem;">(24ë…„ ${fmt(total24)} + 25ë…„ ${fmt(total25)})</span>
        ` : ''}
      </div>
      
      <!-- íšŒì‹  ìš”ì²­ -->
      <div style="background:#e8f5e9;padding:1rem;border-radius:8px;margin-bottom:1rem;border:1px solid #a5d6a7;">
        <p style="margin:0;text-align:center;font-size:0.95rem;color:#2e7d32;">
          <strong>ğŸ“§ í™•ì¸ ì™„ë£Œ ì‹œ ë³¸ ë©”ì¼ì— íšŒì‹  ë¶€íƒë“œë¦½ë‹ˆë‹¤.</strong>
        </p>
        <p style="margin:0.5rem 0 0 0;text-align:center;font-size:0.85rem;color:#666;">
          ì´ìƒì´ ìˆëŠ” ê²½ìš° í•´ë‹¹ í˜„ì¥ëª…ê³¼ ë‚´ìš©ì„ í•¨ê»˜ íšŒì‹ í•´ì£¼ì„¸ìš”.
        </p>
      </div>
      
      <div style="text-align:center;padding-top:1rem;margin-top:1rem;border-top:1px solid #eee;color:#999;font-size:0.75rem;">
        ãˆœì„ë¯¼ì´ì•¤ì”¨ ì •ì‚° ê´€ë¦¬ ì‹œìŠ¤í…œ
      </div>
    </div>
  `;
  
  return html;
}

function downloadConfirmationPDF() {
  const managerFilter = document.getElementById('confirmationManagerSelect')?.value || '';
  const managerName = managerFilter || 'ì „ì²´ë‹´ë‹¹ì';
  
  let html = '';
  let title = '';
  
  if (currentConfirmationType === 'consulting') {
    html = generateConsultingConfirmationHTML();
    title = `ê¸°ìˆ ì»¨ì„¤íŒ…_í™•ì¸ì„œ_${managerName}`;
  } else if (currentConfirmationType === 'integrated') {
    html = generateIntegratedConfirmationHTML();
    title = `í†µí•©_í™•ì¸ì„œ_${managerName}`;
  } else {
    html = generateConfirmationHTML(true);
    title = `ê³µì‚¬ì •ì‚°_í™•ì¸ì„œ_${managerName}`;
  }
  
  if (!html) {
    showToast('ì¶œë ¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
    return;
  }
  
  // ì¸ì‡„ ì°½ìœ¼ë¡œ PDF ì €ì¥
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>${title}</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', 'Malgun Gothic', sans-serif; }
        @media print { 
          body { padding: 0; } 
          @page { margin: 10mm; }
        }
      </style>
    </head>
    <body>${html}</body>
    </html>
  `);
  printWindow.document.close();
  
  showToast('PDF ì €ì¥: ì¸ì‡„ ì°½ì—ì„œ "PDFë¡œ ì €ì¥"ì„ ì„ íƒí•˜ì„¸ìš”.', 'info');
  setTimeout(() => printWindow.print(), 300);
}

// ê¸°ìˆ ì»¨ì„¤íŒ… í™•ì¸ì„œ HTML ìƒì„±
function generateConsultingConfirmationHTML() {
  loadConsultingData();
  
  const yearFilter = document.getElementById('confirmationYearSelect')?.value || '';
  const managerFilter = document.getElementById('confirmationManagerSelect')?.value || '';
  const settledFilter = document.getElementById('confirmationSettledSelect')?.value || '';
  
  let data = [...consultingData];
  
  if (yearFilter && yearFilter !== '2024+2025') {
    data = data.filter(item => item.year === yearFilter);
  } else if (yearFilter === '2024+2025') {
    data = data.filter(item => {
      if (item.year === '2024') return item.settled !== 'ì •ì‚°ì™„ë£Œ';
      return item.year === '2025';
    });
  }
  
  if (managerFilter) {
    data = data.filter(item => item.manager === managerFilter);
  }
  
  if (settledFilter) {
    data = data.filter(item => item.settled === settledFilter);
  }
  
  if (data.length === 0) return '';
  
  const managerName = managerFilter || 'ì „ì²´ ë‹´ë‹¹ì';
  const statusText = settledFilter || 'ì „ì²´';
  
  let totalBidAmount = 0, totalProfit = 0, totalSettlement = 0;
  data.forEach(item => {
    totalBidAmount += item.bidAmount || 0;
    totalProfit += item.profit || 0;
    totalSettlement += item.settlement || 0;
  });
  
  const today = new Date();
  const reportDate = `${today.getFullYear()}ë…„ ${today.getMonth()+1}ì›” ${today.getDate()}ì¼`;
  
  let html = `
    <div style="font-family:'Noto Sans KR','Malgun Gothic',sans-serif;padding:20px;max-width:800px;margin:0 auto;">
      <div style="text-align:center;margin-bottom:2rem;border-bottom:2px solid #00897b;padding-bottom:1rem;">
        <h2 style="margin:0 0 0.5rem 0;font-size:1.5rem;color:#00897b;">ğŸ“‹ ê¸°ìˆ ì»¨ì„¤íŒ… ì •ì‚° í™•ì¸ì„œ</h2>
        <p style="margin:0;color:#666;font-size:0.9rem;">ë‹´ë‹¹ì: <strong style="color:#00897b;font-size:1.1rem;">${managerName}</strong></p>
        <p style="margin:0.25rem 0 0 0;color:#888;font-size:0.8rem;">ë°œí–‰ì¼: ${reportDate} / ìƒíƒœ: ${statusText}</p>
      </div>
      
      <div style="background:#e0f2f1;padding:1rem;border-radius:8px;margin-bottom:1.5rem;">
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;text-align:center;">
          <div>
            <div style="font-size:0.75rem;color:#666;">ì´ ê±´ìˆ˜</div>
            <div style="font-size:1.2rem;font-weight:700;">${data.length}ê±´</div>
          </div>
          <div>
            <div style="font-size:0.75rem;color:#666;">ì´ ë‚™ì°°ê¸ˆì•¡</div>
            <div style="font-size:1.2rem;font-weight:700;">${fmt(totalBidAmount)}</div>
          </div>
          <div>
            <div style="font-size:0.75rem;color:#666;">ì´ ì´ìµê¸ˆ</div>
            <div style="font-size:1.2rem;font-weight:700;color:${totalProfit >= 0 ? '#2e7d32' : '#c62828'};">${fmt(totalProfit)}</div>
          </div>
          <div>
            <div style="font-size:0.75rem;color:#666;">ì •ì‚°ê¸ˆì•¡ (15%)</div>
            <div style="font-size:1.2rem;font-weight:700;color:#00897b;">${fmt(totalSettlement)}</div>
          </div>
        </div>
      </div>
      
      <table style="width:100%;border-collapse:collapse;font-size:0.85rem;margin-bottom:1.5rem;">
        <thead>
          <tr style="background:#00897b;color:white;">
            <th style="padding:0.5rem;border:1px solid #00695c;">ë…„ë„</th>
            <th style="padding:0.5rem;border:1px solid #00695c;text-align:left;">í˜„ì¥ëª…</th>
            <th style="padding:0.5rem;border:1px solid #00695c;text-align:left;">ê³µì‚¬ëª…</th>
            <th style="padding:0.5rem;border:1px solid #00695c;text-align:right;">ì •ì‚°ê¸ˆì•¡</th>
          </tr>
        </thead>
        <tbody>
          ${data.map(item => `
            <tr>
              <td style="padding:0.5rem;border:1px solid #ddd;text-align:center;">${item.year}</td>
              <td style="padding:0.5rem;border:1px solid #ddd;">${item.site || ''}</td>
              <td style="padding:0.5rem;border:1px solid #ddd;font-size:0.8rem;color:#666;">${item.project || '-'}</td>
              <td style="padding:0.5rem;border:1px solid #ddd;text-align:right;font-family:monospace;">${fmt(item.settlement)}</td>
            </tr>
          `).join('')}
        </tbody>
        <tfoot>
          <tr style="background:#b2dfdb;font-weight:700;">
            <td colspan="3" style="padding:0.5rem;border:1px solid #ddd;">í•©ê³„</td>
            <td style="padding:0.5rem;border:1px solid #ddd;text-align:right;font-family:monospace;color:#00695c;">${fmt(totalSettlement)}</td>
          </tr>
        </tfoot>
      </table>
      
      <div style="background:#e8f5e9;padding:1rem;border-radius:8px;margin-bottom:1rem;border:1px solid #a5d6a7;">
        <p style="margin:0;text-align:center;font-size:0.95rem;color:#2e7d32;">
          <strong>ğŸ“§ í™•ì¸ ì™„ë£Œ ì‹œ ë³¸ ë©”ì¼ì— íšŒì‹  ë¶€íƒë“œë¦½ë‹ˆë‹¤.</strong>
        </p>
      </div>
      
      <div style="text-align:center;padding-top:1rem;color:#999;font-size:0.75rem;">
        ãˆœì„ë¯¼ì´ì—”ì”¨ ì •ì‚° ê´€ë¦¬ ì‹œìŠ¤í…œ
      </div>
    </div>
  `;
  
  return html;
}

// í†µí•© í™•ì¸ì„œ HTML ìƒì„±
function generateIntegratedConfirmationHTML() {
  const { data: constructionData, managerFilter, settledFilter } = getFilteredConfirmationData();
  
  loadConsultingData();
  const yearFilter = document.getElementById('confirmationYearSelect')?.value || '';
  
  let consultingFiltered = [...consultingData];
  
  if (yearFilter && yearFilter !== '2024+2025') {
    consultingFiltered = consultingFiltered.filter(item => item.year === yearFilter);
  } else if (yearFilter === '2024+2025') {
    consultingFiltered = consultingFiltered.filter(item => {
      if (item.year === '2024') return item.settled !== 'ì •ì‚°ì™„ë£Œ';
      return item.year === '2025';
    });
  }
  
  if (managerFilter) {
    consultingFiltered = consultingFiltered.filter(item => item.manager === managerFilter);
  }
  
  if (settledFilter) {
    consultingFiltered = consultingFiltered.filter(item => item.settled === settledFilter);
  }
  
  if (constructionData.length === 0 && consultingFiltered.length === 0) return '';
  
  const managerName = managerFilter || 'ì „ì²´ ë‹´ë‹¹ì';
  const statusText = settledFilter || 'ì „ì²´';
  
  let constructionTotal = constructionData.reduce((sum, i) => sum + (i.realSettlement || 0), 0);
  let consultingTotal = consultingFiltered.reduce((sum, i) => sum + (i.settlement || 0), 0);
  const grandTotal = constructionTotal + consultingTotal;
  
  const today = new Date();
  const reportDate = `${today.getFullYear()}ë…„ ${today.getMonth()+1}ì›” ${today.getDate()}ì¼`;
  
  let html = `
    <div style="font-family:'Noto Sans KR','Malgun Gothic',sans-serif;padding:20px;max-width:800px;margin:0 auto;">
      <div style="text-align:center;margin-bottom:2rem;border-bottom:2px solid #9c27b0;padding-bottom:1rem;">
        <h2 style="margin:0 0 0.5rem 0;font-size:1.5rem;color:#9c27b0;">ğŸ“Š í†µí•© ì •ì‚° í™•ì¸ì„œ</h2>
        <p style="margin:0;color:#666;font-size:0.9rem;">ë‹´ë‹¹ì: <strong style="color:#9c27b0;font-size:1.1rem;">${managerName}</strong></p>
        <p style="margin:0.25rem 0 0 0;color:#888;font-size:0.8rem;">ë°œí–‰ì¼: ${reportDate} / ìƒíƒœ: ${statusText}</p>
      </div>
      
      <div style="background:#f3e5f5;padding:1rem;border-radius:8px;margin-bottom:1.5rem;">
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;text-align:center;">
          <div>
            <div style="font-size:0.75rem;color:#666;">ğŸ—ï¸ ê³µì‚¬ì •ì‚°</div>
            <div style="font-size:1rem;font-weight:700;">${constructionData.length}ê±´</div>
            <div style="font-size:0.9rem;color:#1976d2;">${fmt(constructionTotal)}</div>
          </div>
          <div>
            <div style="font-size:0.75rem;color:#666;">ğŸ“‹ ê¸°ìˆ ì»¨ì„¤íŒ…</div>
            <div style="font-size:1rem;font-weight:700;">${consultingFiltered.length}ê±´</div>
            <div style="font-size:0.9rem;color:#00897b;">${fmt(consultingTotal)}</div>
          </div>
          <div>
            <div style="font-size:0.75rem;color:#666;">ì´ ê±´ìˆ˜</div>
            <div style="font-size:1.2rem;font-weight:700;">${constructionData.length + consultingFiltered.length}ê±´</div>
          </div>
          <div>
            <div style="font-size:0.75rem;color:#666;">ì •ì‚° ì´ì•¡</div>
            <div style="font-size:1.3rem;font-weight:700;color:#9c27b0;">${fmt(grandTotal)}</div>
          </div>
        </div>
      </div>
  `;
  
  // ê³µì‚¬ì •ì‚° ì„¹ì…˜
  if (constructionData.length > 0) {
    html += `
      <div style="margin-bottom:1.5rem;">
        <h3 style="font-size:1rem;margin-bottom:0.5rem;color:#1976d2;background:#e3f2fd;padding:0.5rem;border-radius:4px;">
          ğŸ—ï¸ ê³µì‚¬ì •ì‚° (${constructionData.length}ê±´) - ${fmt(constructionTotal)}
        </h3>
        <table style="width:100%;border-collapse:collapse;font-size:0.8rem;">
          <thead>
            <tr style="background:#1976d2;color:white;">
              <th style="padding:0.4rem;border:1px solid #1565c0;">ë…„ë„</th>
              <th style="padding:0.4rem;border:1px solid #1565c0;text-align:left;">í˜„ì¥ëª…</th>
              <th style="padding:0.4rem;border:1px solid #1565c0;text-align:right;">ì •ì‚°ê¸ˆì•¡</th>
            </tr>
          </thead>
          <tbody>
            ${constructionData.map(item => `
              <tr>
                <td style="padding:0.4rem;border:1px solid #ddd;text-align:center;">${item.year}</td>
                <td style="padding:0.4rem;border:1px solid #ddd;">${item.site || ''}</td>
                <td style="padding:0.4rem;border:1px solid #ddd;text-align:right;font-family:monospace;">${fmt(item.realSettlement)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
  }
  
  // ê¸°ìˆ ì»¨ì„¤íŒ… ì„¹ì…˜
  if (consultingFiltered.length > 0) {
    html += `
      <div style="margin-bottom:1.5rem;">
        <h3 style="font-size:1rem;margin-bottom:0.5rem;color:#00897b;background:#e0f2f1;padding:0.5rem;border-radius:4px;">
          ğŸ“‹ ê¸°ìˆ ì»¨ì„¤íŒ… (${consultingFiltered.length}ê±´) - ${fmt(consultingTotal)}
        </h3>
        <table style="width:100%;border-collapse:collapse;font-size:0.8rem;">
          <thead>
            <tr style="background:#00897b;color:white;">
              <th style="padding:0.4rem;border:1px solid #00695c;">ë…„ë„</th>
              <th style="padding:0.4rem;border:1px solid #00695c;text-align:left;">í˜„ì¥ëª…</th>
              <th style="padding:0.4rem;border:1px solid #00695c;text-align:right;">ì •ì‚°ê¸ˆì•¡</th>
            </tr>
          </thead>
          <tbody>
            ${consultingFiltered.map(item => `
              <tr>
                <td style="padding:0.4rem;border:1px solid #ddd;text-align:center;">${item.year}</td>
                <td style="padding:0.4rem;border:1px solid #ddd;">${item.site || ''}</td>
                <td style="padding:0.4rem;border:1px solid #ddd;text-align:right;font-family:monospace;">${fmt(item.settlement)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
  }
  
  html += `
      <div style="background:#ffebee;padding:1rem;border-radius:8px;margin-bottom:1rem;text-align:center;border:1px solid #ef9a9a;">
        <div style="color:#666;margin-bottom:0.5rem;">
          <span style="margin-right:1.5rem;">ğŸ—ï¸ ê³µì‚¬: <strong style="color:#1976d2;">${fmt(constructionTotal)}</strong></span>
          <span>ğŸ“‹ ì»¨ì„¤íŒ…: <strong style="color:#00897b;">${fmt(consultingTotal)}</strong></span>
        </div>
        <span style="font-size:1rem;color:#c62828;">ğŸ“Œ ì •ì‚° ì´ì•¡: </span>
        <strong style="font-size:1.5rem;color:#c62828;">${fmt(grandTotal)}</strong>
      </div>
      
      <div style="background:#e8f5e9;padding:1rem;border-radius:8px;margin-bottom:1rem;border:1px solid #a5d6a7;">
        <p style="margin:0;text-align:center;font-size:0.95rem;color:#2e7d32;">
          <strong>ğŸ“§ í™•ì¸ ì™„ë£Œ ì‹œ ë³¸ ë©”ì¼ì— íšŒì‹  ë¶€íƒë“œë¦½ë‹ˆë‹¤.</strong>
        </p>
      </div>
      
      <div style="text-align:center;padding-top:1rem;color:#999;font-size:0.75rem;">
        ãˆœì„ë¯¼ì´ì—”ì”¨ ì •ì‚° ê´€ë¦¬ ì‹œìŠ¤í…œ
      </div>
    </div>
  `;
  
  return html;
}

function sendConfirmationEmail() {
  const managerFilter = document.getElementById('confirmationManagerSelect')?.value || '';
  const managerName = managerFilter || 'ì „ì²´ ë‹´ë‹¹ì';
  const managerEmail = managerEmails[managerFilter] || '';
  
  if (!managerFilter) {
    showToast('ë‹´ë‹¹ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”. (ì „ì²´ ë‹´ë‹¹ìì—ê²ŒëŠ” ê°œë³„ ë°œì†¡ í•„ìš”)', 'error');
    return;
  }
  
  if (!managerEmail) {
    const usePrompt = confirm(`${managerName}ë‹˜ì˜ ì´ë©”ì¼ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\nì´ë©”ì¼ ê´€ë¦¬ì—ì„œ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
    if (usePrompt) {
      closeConfirmationModal();
      openEmailManageModal();
    }
    return;
  }
  
  // íƒ­ì— ë”°ë¼ ë‹¤ë¥¸ ë°ì´í„° ê³„ì‚°
  let totalSettlement = 0;
  let totalCount = 0;
  let typeText = '';
  
  if (currentConfirmationType === 'consulting') {
    loadConsultingData();
    const yearFilter = document.getElementById('confirmationYearSelect')?.value || '';
    const settledFilter = document.getElementById('confirmationSettledSelect')?.value || '';
    
    let data = [...consultingData];
    if (yearFilter && yearFilter !== '2024+2025') {
      data = data.filter(item => item.year === yearFilter);
    }
    if (managerFilter) {
      data = data.filter(item => item.manager === managerFilter);
    }
    if (settledFilter) {
      data = data.filter(item => item.settled === settledFilter);
    }
    
    data.forEach(item => {
      totalSettlement += item.settlement || 0;
    });
    totalCount = data.length;
    typeText = 'ê¸°ìˆ ì»¨ì„¤íŒ… ';
    
  } else if (currentConfirmationType === 'integrated') {
    // ê³µì‚¬ì •ì‚°
    const { data: constructionData } = getFilteredConfirmationData();
    constructionData.forEach(item => {
      totalSettlement += item.realSettlement || 0;
    });
    
    // ê¸°ìˆ ì»¨ì„¤íŒ…
    loadConsultingData();
    const yearFilter = document.getElementById('confirmationYearSelect')?.value || '';
    const settledFilter = document.getElementById('confirmationSettledSelect')?.value || '';
    
    let consultingFiltered = [...consultingData];
    if (yearFilter && yearFilter !== '2024+2025') {
      consultingFiltered = consultingFiltered.filter(item => item.year === yearFilter);
    }
    if (managerFilter) {
      consultingFiltered = consultingFiltered.filter(item => item.manager === managerFilter);
    }
    if (settledFilter) {
      consultingFiltered = consultingFiltered.filter(item => item.settled === settledFilter);
    }
    
    consultingFiltered.forEach(item => {
      totalSettlement += item.settlement || 0;
    });
    
    totalCount = constructionData.length + consultingFiltered.length;
    typeText = 'í†µí•©(ê³µì‚¬+ì»¨ì„¤íŒ…) ';
    
  } else {
    // ê³µì‚¬ì •ì‚°
    const { data } = getFilteredConfirmationData();
    data.forEach(item => {
      totalSettlement += item.realSettlement || 0;
    });
    totalCount = data.length;
    typeText = 'ê³µì‚¬ ';
  }
  
  if (totalCount === 0) {
    showToast('ë°œì†¡í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
    return;
  }
  
  // ë©”ì¼ ì œëª© ë° ë³¸ë¬¸
  const subject = encodeURIComponent(`[${typeText}ì •ì‚°í™•ì¸ìš”ì²­] ${managerName}ë‹˜ ì •ì‚°ë‚´ì—­ í™•ì¸ ìš”ì²­ë“œë¦½ë‹ˆë‹¤`);
  const body = encodeURIComponent(`${managerName}ë‹˜ ì•ˆë…•í•˜ì„¸ìš”.

${typeText}ì •ì‚° ë‚´ì—­ í™•ì¸ì„ ìš”ì²­ë“œë¦½ë‹ˆë‹¤.

â–  ì •ì‚° ì´ì•¡: ${fmt(totalSettlement)}
â–  ëŒ€ìƒ ê±´ìˆ˜: ${totalCount}ê±´

ìƒì„¸ ë‚´ì—­ì€ ì²¨ë¶€ëœ PDF íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.

í™•ì¸ ì™„ë£Œ ì‹œ ë³¸ ë©”ì¼ì— "í™•ì¸ì™„ë£Œ" íšŒì‹  ë¶€íƒë“œë¦½ë‹ˆë‹¤.
ì´ìƒì´ ìˆëŠ” ê²½ìš° í•´ë‹¹ í˜„ì¥ëª…ê³¼ ë‚´ìš©ì„ í•¨ê»˜ íšŒì‹ í•´ì£¼ì„¸ìš”.

ê°ì‚¬í•©ë‹ˆë‹¤.
ãˆœì„ë¯¼ì´ì•¤ì”¨`);
  
  // mailto ë§í¬ ì—´ê¸°
  window.open(`mailto:${managerEmail}?subject=${subject}&body=${body}`, '_blank');
  
  showToast(`${managerName}ë‹˜ê»˜ ì´ë©”ì¼ ë°œì†¡ ì°½ì´ ì—´ë ¸ìŠµë‹ˆë‹¤.\nPDFë¥¼ ì²¨ë¶€í•˜ì—¬ ë°œì†¡í•˜ì„¸ìš”.`, 'success');
}

// ========== ê¸°ìˆ ì»¨ì„¤íŒ… ì •ì‚°ê´€ë¦¬ ==========
// (consultingData, filteredConsultingData, loadConsultingDataëŠ” ë‹´ë‹¹ì í™•ì¸ì„œ ëª¨ë‹¬ ì„¹ì…˜ì—ì„œ ì„ ì–¸ë¨)

// ê¸°ìˆ ì»¨ì„¤íŒ… ë°ì´í„° ì €ì¥
function saveConsultingData() {
  const editId = document.getElementById('consultingEditId').value;
  
  const year = document.getElementById('consultingYear').value;
  const type = document.getElementById('consultingType').value;
  const site = document.getElementById('consultingSite').value.trim();
  const project = document.getElementById('consultingProject').value.trim();
  const bidAmount = parseFloat(document.getElementById('consultingBidAmount').value) || 0;
  const execAmount = parseFloat(document.getElementById('consultingExecAmount').value) || 0;
  const companyExp = parseFloat(document.getElementById('consultingCompanyExp').value) || 0;
  const otherExp = parseFloat(document.getElementById('consultingOtherExp').value) || 0;
  const manager = document.getElementById('consultingManager').value;
  
  if (!site) {
    showToast('ê³µì‚¬í˜„ì¥ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
    return;
  }
  if (!manager) {
    showToast('ë‹´ë‹¹ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
    return;
  }
  
  const totalExpense = execAmount + companyExp + otherExp;
  const profit = bidAmount - totalExpense;
  const profitRate = bidAmount > 0 ? (profit / bidAmount * 100) : 0;
  const settlement = profit > 0 ? Math.round(profit * 0.15) : 0;
  const companyProfit = profit - settlement;
  
  const item = {
    id: editId || Date.now().toString(),
    year,
    type,
    site,
    project,
    bidAmount,
    execAmount,
    companyExp,
    otherExp,
    totalExpense,
    profit,
    profitRate: profitRate.toFixed(1),
    settlement,
    companyProfit,
    manager,
    settled: 'ë¯¸ì •ì‚°'
  };
  
  if (editId) {
    // ìˆ˜ì •
    const idx = consultingData.findIndex(d => d.id === editId);
    if (idx !== -1) {
      item.settled = consultingData[idx].settled; // ê¸°ì¡´ ì •ì‚°ìƒíƒœ ìœ ì§€
      consultingData[idx] = item;
    }
  } else {
    // ì‹ ê·œ
    consultingData.push(item);
  }
  
  localStorage.setItem('consultingData', JSON.stringify(consultingData));
  showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
  closeConsultingAddModal();
  renderConsultingTable();
}

// ì •ì‚°ê´€ë¦¬ ë©”ì¸ íƒ­ ì „í™˜
function switchSettlementMainTab(tab) {
  const tabConstruction = document.getElementById('tabConstruction');
  const tabConsulting = document.getElementById('tabConsulting');
  const sectionConstruction = document.getElementById('constructionSection');
  const sectionConsulting = document.getElementById('consultingSection');
  
  if (tab === 'construction') {
    tabConstruction.style.background = '#1976d2';
    tabConstruction.style.color = 'white';
    tabConsulting.style.background = '#e0e0e0';
    tabConsulting.style.color = '#666';
    sectionConstruction.style.display = 'block';
    sectionConsulting.style.display = 'none';
  } else {
    tabConstruction.style.background = '#e0e0e0';
    tabConstruction.style.color = '#666';
    tabConsulting.style.background = '#00897b';
    tabConsulting.style.color = 'white';
    sectionConstruction.style.display = 'none';
    sectionConsulting.style.display = 'block';
    
    // ê¸°ìˆ ì»¨ì„¤íŒ… í˜„ì¥ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì •ì‚°ê´€ë¦¬ ë°ì´í„°ë¡œ ë™ê¸°í™”
    syncAllConsultingListToSettlement();
    
    renderConsultingTable();
    populateConsultingManagerFilter();
  }
}

// ê¸°ìˆ ì»¨ì„¤íŒ… í˜„ì¥ ë¦¬ìŠ¤íŠ¸ ì „ì²´ë¥¼ ì •ì‚°ê´€ë¦¬ë¡œ ë™ê¸°í™”
function syncAllConsultingListToSettlement() {
  // í˜„ì¥ ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
  loadConsultingListData();
  
  // ê° í˜„ì¥ì— ëŒ€í•´ ì •ì‚° ë°ì´í„° ë™ê¸°í™”
  consultingListData.forEach(item => {
    syncConsultingToSettlement(item);
  });
  
  // ì €ì¥
  localStorage.setItem('consultingData', JSON.stringify(consultingData));
}

// ê¸°ìˆ ì»¨ì„¤íŒ… ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°
function openConsultingAddModal(editId = null) {
  document.getElementById('consultingAddModal').classList.add('active');
  document.getElementById('consultingEditId').value = '';
  document.getElementById('consultingYear').value = '2025';
  document.getElementById('consultingType').value = 'ì¼ë°˜';
  document.getElementById('consultingSite').value = '';
  document.getElementById('consultingProject').value = '';
  document.getElementById('consultingBidAmount').value = '';
  document.getElementById('consultingExecAmount').value = '';
  document.getElementById('consultingCompanyExp').value = '';
  document.getElementById('consultingOtherExp').value = '';
  
  // ë‹´ë‹¹ì ëª©ë¡
  const managerSelect = document.getElementById('consultingManager');
  managerSelect.innerHTML = '<option value="">ì„ íƒ</option>';
  const allManagers = new Set([...HQ_MANAGERS]);
  consultingData.forEach(d => { if (d.manager) allManagers.add(d.manager); });
  Array.from(allManagers).sort().forEach(m => {
    managerSelect.innerHTML += `<option value="${m}">${m}</option>`;
  });
  managerSelect.value = '';
  
  document.getElementById('consultingAddModalTitle').textContent = 'ğŸ“‹ ê¸°ìˆ ì»¨ì„¤íŒ… ë“±ë¡';
  
  if (editId) {
    const item = consultingData.find(d => d.id === editId);
    if (item) {
      document.getElementById('consultingEditId').value = editId;
      document.getElementById('consultingYear').value = item.year;
      document.getElementById('consultingType').value = item.type;
      document.getElementById('consultingSite').value = item.site;
      document.getElementById('consultingProject').value = item.project || '';
      document.getElementById('consultingBidAmount').value = item.bidAmount || '';
      document.getElementById('consultingExecAmount').value = item.execAmount || '';
      document.getElementById('consultingCompanyExp').value = item.companyExp || '';
      document.getElementById('consultingOtherExp').value = item.otherExp || '';
      managerSelect.value = item.manager || '';
      document.getElementById('consultingAddModalTitle').textContent = 'ğŸ“‹ ê¸°ìˆ ì»¨ì„¤íŒ… ìˆ˜ì •';
    }
  }
  
  calcConsultingPreview();
}

// ê¸°ìˆ ì»¨ì„¤íŒ… ëª¨ë‹¬ ë‹«ê¸°
function closeConsultingAddModal() {
  document.getElementById('consultingAddModal').classList.remove('active');
}

// ê³„ì‚° ë¯¸ë¦¬ë³´ê¸°
function calcConsultingPreview() {
  const bidAmount = parseFloat(document.getElementById('consultingBidAmount').value) || 0;
  const execAmount = parseFloat(document.getElementById('consultingExecAmount').value) || 0;
  const companyExp = parseFloat(document.getElementById('consultingCompanyExp').value) || 0;
  const otherExp = parseFloat(document.getElementById('consultingOtherExp').value) || 0;
  
  const totalExpense = execAmount + companyExp + otherExp;
  const profit = bidAmount - totalExpense;
  const profitRate = bidAmount > 0 ? (profit / bidAmount * 100) : 0;
  const settlement = profit > 0 ? Math.round(profit * 0.15) : 0;
  
  document.getElementById('consultingPreviewExpense').textContent = fmt(totalExpense);
  document.getElementById('consultingPreviewProfit').textContent = fmt(profit);
  document.getElementById('consultingPreviewProfit').style.color = profit >= 0 ? '#2e7d32' : '#c62828';
  document.getElementById('consultingPreviewRate').textContent = profitRate.toFixed(1) + '%';
  document.getElementById('consultingPreviewSettlement').textContent = fmt(settlement);
}

// ê¸°ìˆ ì»¨ì„¤íŒ… ë‹´ë‹¹ì í•„í„° ì±„ìš°ê¸°
function populateConsultingManagerFilter() {
  const select = document.getElementById('consultingManagerFilter');
  const current = select.value;
  select.innerHTML = '<option value="">ì „ì²´ ë‹´ë‹¹ì</option>';
  
  const managers = new Set();
  consultingData.forEach(d => { if (d.manager) managers.add(d.manager); });
  
  Array.from(managers).sort().forEach(m => {
    select.innerHTML += `<option value="${m}">${m}</option>`;
  });
  select.value = current;
}

// ê¸°ìˆ ì»¨ì„¤íŒ… í•„í„°ë§
function filterConsultingData() {
  const yearFilter = document.getElementById('consultingYearFilter').value;
  const typeFilter = document.getElementById('consultingTypeFilter').value;
  const managerFilter = document.getElementById('consultingManagerFilter').value;
  const settledFilter = document.getElementById('consultingSettledFilter').value;
  
  filteredConsultingData = consultingData.filter(item => {
    if (yearFilter && item.year !== yearFilter) return false;
    if (typeFilter && item.type !== typeFilter) return false;
    if (managerFilter && item.manager !== managerFilter) return false;
    if (settledFilter && item.settled !== settledFilter) return false;
    return true;
  });
  
  renderConsultingTable();
}

// ê¸°ìˆ ì»¨ì„¤íŒ… í…Œì´ë¸” ë Œë”ë§
function renderConsultingTable() {
  // í•„í„° ì ìš©
  const yearFilter = document.getElementById('consultingYearFilter').value;
  const typeFilter = document.getElementById('consultingTypeFilter').value;
  const managerFilter = document.getElementById('consultingManagerFilter').value;
  const settledFilter = document.getElementById('consultingSettledFilter').value;
  
  let filtered = consultingData;
  if (yearFilter || typeFilter || managerFilter || settledFilter) {
    filtered = consultingData.filter(item => {
      if (yearFilter && item.year !== yearFilter) return false;
      if (typeFilter && item.type !== typeFilter) return false;
      if (managerFilter && item.manager !== managerFilter) return false;
      if (settledFilter && item.settled !== settledFilter) return false;
      return true;
    });
  }
  
  const tbody = document.getElementById('consultingTableBody');
  const tfoot = document.getElementById('consultingTableFoot');
  
  if (filtered.length === 0) {
    tbody.innerHTML = '<tr><td colspan="15" style="text-align:center;padding:2rem;color:#999;">ë“±ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. [â• ì‹ ê·œ ë“±ë¡] ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì¶”ê°€í•˜ì„¸ìš”.</td></tr>';
    tfoot.innerHTML = '';
    updateConsultingStats([]);
    document.getElementById('consultingFilterResult').textContent = '0ê±´';
    return;
  }
  
  // ì •ë ¬ (ë…„ë„ ë‚´ë¦¼ì°¨ìˆœ)
  filtered.sort((a, b) => {
    if (b.year !== a.year) return b.year.localeCompare(a.year);
    return (b.id || '').localeCompare(a.id || '');
  });
  
  let html = '';
  filtered.forEach(item => {
    const settledValue = item.settled || 'ë¯¸ì •ì‚°';
    let bgColor = '#fff3e0', txtColor = '#e65100';
    if (settledValue === 'ì •ì‚°ì™„ë£Œ') { bgColor = '#c8e6c9'; txtColor = '#2e7d32'; }
    else if (settledValue === 'ì§„í–‰ì¤‘') { bgColor = '#e3f2fd'; txtColor = '#1565c0'; }
    
    html += `
      <tr>
        <td style="text-align:center;">${item.year}</td>
        <td style="text-align:center;"><span style="padding:0.2rem 0.5rem;background:${item.type === 'ì‹œì§€ì›' ? '#e3f2fd' : item.type === 'ì‚¬í›„ì •ì‚°' ? '#f3e5f5' : '#f5f5f5'};border-radius:4px;font-size:0.75rem;">${item.type}</span></td>
        <td style="font-weight:500;">${item.site}</td>
        <td style="font-size:0.8rem;color:#666;">${item.project || '-'}</td>
        <td style="text-align:right;font-family:monospace;color:#00897b;font-weight:600;">${fmt(item.bidAmount)}</td>
        <td style="text-align:right;font-family:monospace;">${fmt(item.execAmount)}</td>
        <td style="text-align:right;font-family:monospace;">${fmt(item.companyExp)}</td>
        <td style="text-align:right;font-family:monospace;">${fmt(item.otherExp)}</td>
        <td style="text-align:right;font-family:monospace;color:#e65100;">${fmt(item.totalExpense)}</td>
        <td style="text-align:right;font-family:monospace;font-weight:600;color:${item.profit >= 0 ? '#2e7d32' : '#c62828'};">${fmt(item.profit)}</td>
        <td style="text-align:center;">${item.profitRate}%</td>
        <td style="text-align:right;font-family:monospace;font-weight:600;color:#7b1fa2;">${fmt(item.settlement)}</td>
        <td style="text-align:center;">${item.manager || '-'}</td>
        <td style="text-align:center;">
          <select onchange="updateConsultingSettled('${item.id}', this.value)" style="padding:0.25rem;border-radius:4px;border:1px solid #ddd;font-size:0.75rem;background:${bgColor};color:${txtColor};">
            <option value="ë¯¸ì •ì‚°" ${settledValue === 'ë¯¸ì •ì‚°' ? 'selected' : ''}>ë¯¸ì •ì‚°</option>
            <option value="ì§„í–‰ì¤‘" ${settledValue === 'ì§„í–‰ì¤‘' ? 'selected' : ''}>ì§„í–‰ì¤‘</option>
            <option value="ì •ì‚°ì™„ë£Œ" ${settledValue === 'ì •ì‚°ì™„ë£Œ' ? 'selected' : ''}>ì •ì‚°ì™„ë£Œ</option>
          </select>
        </td>
        <td style="text-align:center;">
          <button onclick="openConsultingAddModal('${item.id}')" style="padding:0.25rem 0.5rem;border:none;background:#2196f3;color:white;border-radius:4px;cursor:pointer;font-size:0.7rem;margin-right:2px;">ìˆ˜ì •</button>
          <button onclick="deleteConsultingItem('${item.id}')" style="padding:0.25rem 0.5rem;border:none;background:#f44336;color:white;border-radius:4px;cursor:pointer;font-size:0.7rem;">ì‚­ì œ</button>
        </td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
  
  // í•©ê³„
  const totals = {
    bidAmount: filtered.reduce((s, i) => s + (i.bidAmount || 0), 0),
    totalExpense: filtered.reduce((s, i) => s + (i.totalExpense || 0), 0),
    profit: filtered.reduce((s, i) => s + (i.profit || 0), 0),
    settlement: filtered.reduce((s, i) => s + (i.settlement || 0), 0),
    companyProfit: filtered.reduce((s, i) => s + (i.companyProfit || 0), 0)
  };
  
  tfoot.innerHTML = `
    <tr style="background:#e0f2f1;font-weight:700;">
      <td colspan="4" style="text-align:center;">í•©ê³„ (${filtered.length}ê±´)</td>
      <td style="text-align:right;font-family:monospace;color:#00897b;">${fmt(totals.bidAmount)}</td>
      <td colspan="3"></td>
      <td style="text-align:right;font-family:monospace;color:#e65100;">${fmt(totals.totalExpense)}</td>
      <td style="text-align:right;font-family:monospace;color:${totals.profit >= 0 ? '#2e7d32' : '#c62828'};">${fmt(totals.profit)}</td>
      <td style="text-align:center;">${totals.bidAmount > 0 ? (totals.profit / totals.bidAmount * 100).toFixed(1) : 0}%</td>
      <td style="text-align:right;font-family:monospace;color:#7b1fa2;">${fmt(totals.settlement)}</td>
      <td colspan="3"></td>
    </tr>
  `;
  
  document.getElementById('consultingFilterResult').textContent = `${filtered.length}ê±´`;
  updateConsultingStats(filtered);
  renderConsultingManagerSummary(filtered);
}

// í†µê³„ ì—…ë°ì´íŠ¸
function updateConsultingStats(data) {
  const totals = {
    count: data.length,
    bidAmount: data.reduce((s, i) => s + (i.bidAmount || 0), 0),
    totalExpense: data.reduce((s, i) => s + (i.totalExpense || 0), 0),
    profit: data.reduce((s, i) => s + (i.profit || 0), 0),
    settlement: data.reduce((s, i) => s + (i.settlement || 0), 0),
    companyProfit: data.reduce((s, i) => s + (i.companyProfit || 0), 0)
  };
  
  document.getElementById('consultingStatAmount').textContent = fmtAmount(totals.bidAmount);
  document.getElementById('consultingStatCount').textContent = `${totals.count}ê±´`;
  document.getElementById('consultingStatExpense').textContent = fmtAmount(totals.totalExpense);
  document.getElementById('consultingStatProfit').textContent = fmtAmount(totals.profit);
  document.getElementById('consultingStatProfit').style.color = totals.profit >= 0 ? '#2e7d32' : '#c62828';
  document.getElementById('consultingStatProfitRate').textContent = `ì´ìµë¥  ${totals.bidAmount > 0 ? (totals.profit / totals.bidAmount * 100).toFixed(1) : 0}%`;
  document.getElementById('consultingStatSettlement').textContent = fmtAmount(totals.settlement);
  document.getElementById('consultingStatCompany').textContent = fmtAmount(totals.companyProfit);
}

// ì •ì‚° ìƒíƒœ ë³€ê²½
function updateConsultingSettled(id, status) {
  const item = consultingData.find(d => d.id === id);
  if (item) {
    item.settled = status;
    localStorage.setItem('consultingData', JSON.stringify(consultingData));
    renderConsultingTable();
  }
}

// ì‚­ì œ
function deleteConsultingItem(id) {
  if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  consultingData = consultingData.filter(d => d.id !== id);
  localStorage.setItem('consultingData', JSON.stringify(consultingData));
  showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
  renderConsultingTable();
}

// ë‹´ë‹¹ìë³„ ìš”ì•½ ë Œë”ë§
function renderConsultingManagerSummary(data) {
  const summary = {};
  data.forEach(item => {
    const manager = item.manager || 'ê¸°íƒ€';
    if (!summary[manager]) {
      summary[manager] = { count: 0, bidAmount: 0, profit: 0, settlement: 0 };
    }
    summary[manager].count++;
    summary[manager].bidAmount += item.bidAmount || 0;
    summary[manager].profit += item.profit || 0;
    summary[manager].settlement += item.settlement || 0;
  });
  
  if (Object.keys(summary).length === 0) {
    document.getElementById('consultingManagerSummary').innerHTML = '';
    return;
  }
  
  let html = '<div class="settlement-summary-grid">';
  Object.entries(summary)
    .sort((a, b) => b[1].settlement - a[1].settlement)
    .forEach(([manager, stats]) => {
      html += `
        <div class="settlement-summary-card" style="border-left:4px solid #00897b;">
          <div class="manager-name">ğŸ‘¤ ${manager}</div>
          <div class="summary-row"><span class="label">ê±´ìˆ˜</span><span class="value">${stats.count}ê±´</span></div>
          <div class="summary-row"><span class="label">ë‚™ì°°ê¸ˆì•¡</span><span class="value">${fmtAmount(stats.bidAmount)}</span></div>
          <div class="summary-row"><span class="label">ì´ìµê¸ˆ</span><span class="value" style="color:${stats.profit >= 0 ? 'var(--success)' : 'var(--danger)'};">${fmtAmount(stats.profit)}</span></div>
          <div class="summary-row summary-total"><span class="label"><strong>ğŸ’µ ì •ì‚°ê¸ˆì•¡</strong></span><span class="value">${fmtAmount(stats.settlement)}</span></div>
        </div>
      `;
    });
  html += '</div>';
  
  document.getElementById('consultingManagerSummary').innerHTML = html;
}

// ========== ê¸°ìˆ ì»¨ì„¤íŒ… í˜„ì¥ ë¦¬ìŠ¤íŠ¸ ==========
let consultingListData = [];

// ë©”ì¸ ë¦¬ìŠ¤íŠ¸ íƒ­ ì „í™˜
function switchMainListTab(tab) {
  console.log('íƒ­ ì „í™˜:', tab);
  
  const tabConstruction = document.getElementById('mainTabConstruction');
  const tabConsulting = document.getElementById('mainTabConsulting');
  const sectionConstruction = document.getElementById('mainConstructionSection');
  const sectionConsulting = document.getElementById('mainConsultingSection');
  
  if (!tabConstruction || !tabConsulting || !sectionConstruction || !sectionConsulting) {
    console.error('íƒ­ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
    return;
  }
  
  if (tab === 'construction') {
    tabConstruction.style.background = '#1976d2';
    tabConstruction.style.color = 'white';
    tabConsulting.style.background = '#e0e0e0';
    tabConsulting.style.color = '#666';
    sectionConstruction.style.display = 'block';
    sectionConsulting.style.display = 'none';
  } else {
    tabConstruction.style.background = '#e0e0e0';
    tabConstruction.style.color = '#666';
    tabConsulting.style.background = '#00897b';
    tabConsulting.style.color = 'white';
    sectionConstruction.style.display = 'none';
    sectionConsulting.style.display = 'block';
    
    // ë…„ë„ í•„í„° ë™ê¸°í™”
    const yearFilter = document.getElementById('consultingMainYearFilter');
    if (yearFilter && currentYear && !currentYear.includes('-')) {
      yearFilter.value = currentYear;
    }
    
    // ì•½ê°„ì˜ ì§€ì—° í›„ ë Œë”ë§ (display ë³€ê²½ í›„)
    setTimeout(() => {
      populateConsultingMainManagerFilter();
      renderConsultingMain();
    }, 10);
  }
}

// ë‹´ë‹¹ì í•„í„° ì±„ìš°ê¸° (ë©”ì¸ í™”ë©´)
function populateConsultingMainManagerFilter() {
  const select = document.getElementById('consultingMainManagerFilter');
  const current = select.value;
  select.innerHTML = '<option value="">ì „ì²´ ë‹´ë‹¹ì</option>';
  
  // ê¸°ë³¸ ë‹´ë‹¹ì + ë°ì´í„°ì—ì„œ ì¶”ì¶œ
  const managers = new Set([...HQ_MANAGERS]);
  consultingListData.forEach(d => { if (d.manager) managers.add(d.manager); });
  
  Array.from(managers).sort().forEach(m => {
    select.innerHTML += `<option value="${m}">${m}</option>`;
  });
  select.value = current;
}

// ê¸°ìˆ ì»¨ì„¤íŒ… ë©”ì¸ í™”ë©´ í•„í„°ë§
function filterConsultingMain() {
  renderConsultingMain();
}

// ê¸°ìˆ ì»¨ì„¤íŒ… ë©”ì¸ í™”ë©´ ë Œë”ë§
function renderConsultingMain() {
  const searchText = (document.getElementById('consultingMainSearch').value || '').toLowerCase();
  const yearFilterDropdown = document.getElementById('consultingMainYearFilter').value;
  const typeFilter = document.getElementById('consultingMainTypeFilter').value;
  const managerFilter = document.getElementById('consultingMainManagerFilter').value;
  
  // í—¤ë” ë…„ë„ íƒ­ ë˜ëŠ” ë“œë¡­ë‹¤ìš´ í•„í„° ì‚¬ìš©
  let yearFilter = yearFilterDropdown;
  if (!yearFilter && currentYear && !currentYear.includes('-')) {
    yearFilter = currentYear;
    // ë“œë¡­ë‹¤ìš´ë„ ë™ê¸°í™”
    const dropdown = document.getElementById('consultingMainYearFilter');
    if (dropdown) dropdown.value = currentYear;
  }
  
  let filtered = consultingListData.filter(item => {
    if (searchText && !(item.site || '').toLowerCase().includes(searchText) && !(item.project || '').toLowerCase().includes(searchText)) return false;
    if (yearFilter && item.year !== yearFilter) return false;
    if (typeFilter && item.type !== typeFilter) return false;
    if (managerFilter && item.manager !== managerFilter) return false;
    return true;
  });
  
  // ì •ë ¬ (ë…„ë„ ë‚´ë¦¼ì°¨ìˆœ, ID ë‚´ë¦¼ì°¨ìˆœ)
  filtered.sort((a, b) => {
    if (b.year !== a.year) return (b.year || '').localeCompare(a.year || '');
    return (b.id || '').localeCompare(a.id || '');
  });
  
  // í†µê³„ ì—…ë°ì´íŠ¸
  const totalCount = filtered.length;
  const yCount = filtered.filter(d => d.consulting === 'Y').length;
  const totalBid = filtered.reduce((s, d) => s + (d.bidAmount || 0), 0);
  const totalExec = filtered.reduce((s, d) => s + (d.execAmount || 0), 0);
  
  document.getElementById('consultingMainStatTotal').textContent = `${totalCount}ê±´`;
  document.getElementById('consultingMainStatY').textContent = `${yCount}ê±´`;
  document.getElementById('consultingMainStatBid').textContent = fmtAmount(totalBid);
  document.getElementById('consultingMainStatExec').textContent = fmtAmount(totalExec);
  
  const tbody = document.getElementById('consultingMainTableBody');
  
  if (filtered.length === 0) {
    tbody.innerHTML = '<tr><td colspan="18" style="text-align:center;padding:2rem;color:#999;">ë“±ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. [â• ì‹ ê·œ ë“±ë¡] ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì¶”ê°€í•˜ì„¸ìš”.</td></tr>';
    document.getElementById('consultingMainCount').textContent = '0ê±´';
    return;
  }
  
  let html = '';
  filtered.forEach(item => {
    const typeBg = item.type === 'ì‹œì§€ì›' ? '#e3f2fd' : item.type === 'ì‚¬í›„ì •ì‚°' ? '#f3e5f5' : '#f5f5f5';
    const consultingBg = item.consulting === 'Y' ? '#c8e6c9' : '#ffcdd2';
    const photoBg = item.photo === 'O' ? '#c8e6c9' : '#f5f5f5';
    
    html += `
      <tr>
        <td style="text-align:center;">${item.year || ''}</td>
        <td style="text-align:center;"><span style="padding:0.15rem 0.4rem;background:${typeBg};border-radius:4px;font-size:0.75rem;">${item.type || ''}</span></td>
        <td style="text-align:center;"><span style="padding:0.15rem 0.4rem;background:${consultingBg};border-radius:4px;font-size:0.75rem;font-weight:600;">${item.consulting || 'N'}</span></td>
        <td style="font-weight:500;">${item.site || ''}</td>
        <td style="font-size:0.85rem;color:#666;">${item.project || '-'}</td>
        <td style="text-align:right;font-family:monospace;color:#00897b;font-weight:600;">${fmt(item.bidAmount)}</td>
        <td style="text-align:right;font-family:monospace;">${fmt(item.execAmount)}</td>
        <td style="text-align:center;">${item.manager || '-'}</td>
        <td style="font-size:0.85rem;">${item.company || '-'}</td>
        <td style="text-align:center;font-size:0.85rem;">${item.companyManager || '-'}</td>
        <td style="text-align:center;font-size:0.85rem;">${item.warranty || '-'}</td>
        <td style="text-align:center;">${item.fieldManager || '-'}</td>
        <td style="text-align:center;"><span style="padding:0.15rem 0.4rem;background:${photoBg};border-radius:4px;font-size:0.75rem;">${item.photo || 'X'}</span></td>
        <td style="text-align:center;font-size:0.85rem;">${item.contractDate || '-'}</td>
        <td style="text-align:center;font-size:0.85rem;">${item.startDate || '-'}</td>
        <td style="text-align:center;font-size:0.85rem;">${item.endDate || '-'}</td>
        <td style="font-size:0.85rem;color:#666;">${item.note || ''}</td>
        <td style="text-align:center;">
          <button onclick="openConsultingItemModal('${item.id}')" style="padding:0.25rem 0.5rem;border:none;background:#2196f3;color:white;border-radius:4px;cursor:pointer;font-size:0.7rem;margin-right:2px;">ìˆ˜ì •</button>
          <button onclick="deleteConsultingListItem('${item.id}')" style="padding:0.25rem 0.5rem;border:none;background:#f44336;color:white;border-radius:4px;cursor:pointer;font-size:0.7rem;">ì‚­ì œ</button>
        </td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
  document.getElementById('consultingMainCount').textContent = `${filtered.length}ê±´`;
}

// ê¸°ìˆ ì»¨ì„¤íŒ… ë¦¬ìŠ¤íŠ¸ ë°ì´í„° ë¡œë“œ
function loadConsultingListData() {
  try {
    const saved = localStorage.getItem('consultingListData');
    if (saved) {
      consultingListData = JSON.parse(saved);
    }
  } catch(e) {
    console.error('ê¸°ìˆ ì»¨ì„¤íŒ… ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', e);
    consultingListData = [];
  }
}

// ê¸°ìˆ ì»¨ì„¤íŒ… ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬ ì—´ê¸° (ë” ì´ìƒ ì‚¬ìš© ì•ˆí•¨ - ë©”ì¸ì—ì„œ ì§ì ‘ ê´€ë¦¬)
function openConsultingListModal() {
  // ë©”ì¸ íƒ­ìœ¼ë¡œ ì „í™˜
  switchMainListTab('consulting');
}

// ê¸°ìˆ ì»¨ì„¤íŒ… ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬ ë‹«ê¸°
function closeConsultingListModal() {
  document.getElementById('consultingListModal').classList.remove('active');
}

// ë‹´ë‹¹ì í•„í„° ì±„ìš°ê¸°
function populateConsultingListManagerFilter() {
  const select = document.getElementById('consultingListManagerFilter');
  const current = select.value;
  select.innerHTML = '<option value="">ì „ì²´ ë‹´ë‹¹ì</option>';
  
  const managers = new Set([...HQ_MANAGERS]);
  consultingListData.forEach(d => { if (d.manager) managers.add(d.manager); });
  
  Array.from(managers).sort().forEach(m => {
    select.innerHTML += `<option value="${m}">${m}</option>`;
  });
  select.value = current;
}

// ê¸°ìˆ ì»¨ì„¤íŒ… ë¦¬ìŠ¤íŠ¸ í•„í„°ë§ ë° ë Œë”ë§
function filterConsultingList() {
  renderConsultingList();
}

function renderConsultingList() {
  const searchText = (document.getElementById('consultingListSearch').value || '').toLowerCase();
  const yearFilter = document.getElementById('consultingListYearFilter').value;
  const typeFilter = document.getElementById('consultingListTypeFilter').value;
  const managerFilter = document.getElementById('consultingListManagerFilter').value;
  
  let filtered = consultingListData.filter(item => {
    if (searchText && !(item.site || '').toLowerCase().includes(searchText) && !(item.project || '').toLowerCase().includes(searchText)) return false;
    if (yearFilter && item.year !== yearFilter) return false;
    if (typeFilter && item.type !== typeFilter) return false;
    if (managerFilter && item.manager !== managerFilter) return false;
    return true;
  });
  
  // ì •ë ¬ (ë…„ë„ ë‚´ë¦¼ì°¨ìˆœ, ID ë‚´ë¦¼ì°¨ìˆœ)
  filtered.sort((a, b) => {
    if (b.year !== a.year) return (b.year || '').localeCompare(a.year || '');
    return (b.id || '').localeCompare(a.id || '');
  });
  
  const tbody = document.getElementById('consultingListTableBody');
  
  if (filtered.length === 0) {
    tbody.innerHTML = '<tr><td colspan="18" style="text-align:center;padding:2rem;color:#999;">ë“±ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    document.getElementById('consultingListCount').textContent = '0ê±´';
    return;
  }
  
  let html = '';
  filtered.forEach(item => {
    const typeBg = item.type === 'ì‹œì§€ì›' ? '#e3f2fd' : item.type === 'ì‚¬í›„ì •ì‚°' ? '#f3e5f5' : '#f5f5f5';
    const consultingBg = item.consulting === 'Y' ? '#c8e6c9' : '#ffcdd2';
    const photoBg = item.photo === 'O' ? '#c8e6c9' : '#f5f5f5';
    
    html += `
      <tr>
        <td style="text-align:center;">${item.year || ''}</td>
        <td style="text-align:center;"><span style="padding:0.15rem 0.4rem;background:${typeBg};border-radius:4px;font-size:0.75rem;">${item.type || ''}</span></td>
        <td style="text-align:center;"><span style="padding:0.15rem 0.4rem;background:${consultingBg};border-radius:4px;font-size:0.75rem;font-weight:600;">${item.consulting || 'N'}</span></td>
        <td style="font-weight:500;">${item.site || ''}</td>
        <td style="font-size:0.8rem;color:#666;">${item.project || '-'}</td>
        <td style="text-align:right;font-family:monospace;">${fmt(item.bidAmount)}</td>
        <td style="text-align:right;font-family:monospace;">${fmt(item.execAmount)}</td>
        <td style="text-align:center;">${item.manager || '-'}</td>
        <td>${item.company || '-'}</td>
        <td style="text-align:center;">${item.companyManager || '-'}</td>
        <td style="text-align:center;font-size:0.8rem;">${item.warranty || '-'}</td>
        <td style="text-align:center;">${item.fieldManager || '-'}</td>
        <td style="text-align:center;"><span style="padding:0.15rem 0.4rem;background:${photoBg};border-radius:4px;font-size:0.75rem;">${item.photo || 'X'}</span></td>
        <td style="text-align:center;font-size:0.8rem;">${item.contractDate || '-'}</td>
        <td style="text-align:center;font-size:0.8rem;">${item.startDate || '-'}</td>
        <td style="text-align:center;font-size:0.8rem;">${item.endDate || '-'}</td>
        <td style="font-size:0.8rem;color:#666;">${item.note || ''}</td>
        <td style="text-align:center;">
          <button onclick="openConsultingItemModal('${item.id}')" style="padding:0.2rem 0.4rem;border:none;background:#2196f3;color:white;border-radius:3px;cursor:pointer;font-size:0.7rem;margin-right:2px;">ìˆ˜ì •</button>
          <button onclick="deleteConsultingListItem('${item.id}')" style="padding:0.2rem 0.4rem;border:none;background:#f44336;color:white;border-radius:3px;cursor:pointer;font-size:0.7rem;">ì‚­ì œ</button>
        </td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
  document.getElementById('consultingListCount').textContent = `${filtered.length}ê±´`;
}

// ê¸°ìˆ ì»¨ì„¤íŒ… í˜„ì¥ ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬
function openConsultingItemModal(editId = null) {
  document.getElementById('consultingItemModal').classList.add('active');
  document.getElementById('consultingItemEditId').value = '';
  
  // ì´ˆê¸°í™”
  document.getElementById('consultingItemYear').value = '2025';
  document.getElementById('consultingItemType').value = 'ì¼ë°˜';
  document.getElementById('consultingItemConsulting').value = 'Y';
  document.getElementById('consultingItemSite').value = '';
  document.getElementById('consultingItemProject').value = '';
  document.getElementById('consultingItemBidAmount').value = '';
  document.getElementById('consultingItemExecAmount').value = '';
  document.getElementById('consultingItemCompany').value = '';
  document.getElementById('consultingItemCompanyManager').value = '';
  document.getElementById('consultingItemWarranty').value = '';
  document.getElementById('consultingItemFieldManager').value = '';
  document.getElementById('consultingItemPhoto').value = 'X';
  document.getElementById('consultingItemContractDate').value = '';
  document.getElementById('consultingItemStartDate').value = '';
  document.getElementById('consultingItemEndDate').value = '';
  document.getElementById('consultingItemNote').value = '';
  
  // ë‹´ë‹¹ì ëª©ë¡
  const managerSelect = document.getElementById('consultingItemManager');
  managerSelect.innerHTML = '<option value="">ì„ íƒ</option>';
  const allManagers = new Set([...HQ_MANAGERS]);
  consultingListData.forEach(d => { if (d.manager) allManagers.add(d.manager); });
  Array.from(allManagers).sort().forEach(m => {
    managerSelect.innerHTML += `<option value="${m}">${m}</option>`;
  });
  managerSelect.value = '';
  
  document.getElementById('consultingItemModalTitle').textContent = 'ğŸ“‹ ê¸°ìˆ ì»¨ì„¤íŒ… í˜„ì¥ ë“±ë¡';
  
  if (editId) {
    const item = consultingListData.find(d => d.id === editId);
    if (item) {
      document.getElementById('consultingItemEditId').value = editId;
      document.getElementById('consultingItemYear').value = item.year || '2025';
      document.getElementById('consultingItemType').value = item.type || 'ì¼ë°˜';
      document.getElementById('consultingItemConsulting').value = item.consulting || 'Y';
      document.getElementById('consultingItemSite').value = item.site || '';
      document.getElementById('consultingItemProject').value = item.project || '';
      document.getElementById('consultingItemBidAmount').value = item.bidAmount || '';
      document.getElementById('consultingItemExecAmount').value = item.execAmount || '';
      managerSelect.value = item.manager || '';
      document.getElementById('consultingItemCompany').value = item.company || '';
      document.getElementById('consultingItemCompanyManager').value = item.companyManager || '';
      document.getElementById('consultingItemWarranty').value = item.warranty || '';
      document.getElementById('consultingItemFieldManager').value = item.fieldManager || '';
      document.getElementById('consultingItemPhoto').value = item.photo || 'X';
      document.getElementById('consultingItemContractDate').value = item.contractDate || '';
      document.getElementById('consultingItemStartDate').value = item.startDate || '';
      document.getElementById('consultingItemEndDate').value = item.endDate || '';
      document.getElementById('consultingItemNote').value = item.note || '';
      document.getElementById('consultingItemModalTitle').textContent = 'ğŸ“‹ ê¸°ìˆ ì»¨ì„¤íŒ… í˜„ì¥ ìˆ˜ì •';
    }
  }
}

function closeConsultingItemModal() {
  document.getElementById('consultingItemModal').classList.remove('active');
}

// ê¸°ìˆ ì»¨ì„¤íŒ… í˜„ì¥ ì €ì¥
function saveConsultingItem() {
  const editId = document.getElementById('consultingItemEditId').value;
  
  const site = document.getElementById('consultingItemSite').value.trim();
  const manager = document.getElementById('consultingItemManager').value;
  
  if (!site) {
    showToast('ê³µì‚¬í˜„ì¥ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
    return;
  }
  if (!manager) {
    showToast('ì˜ì—…ë‹´ë‹¹ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
    return;
  }
  
  const item = {
    id: editId || Date.now().toString(),
    year: document.getElementById('consultingItemYear').value,
    type: document.getElementById('consultingItemType').value,
    consulting: document.getElementById('consultingItemConsulting').value,
    site: site,
    project: document.getElementById('consultingItemProject').value.trim(),
    bidAmount: parseFloat(document.getElementById('consultingItemBidAmount').value) || 0,
    execAmount: parseFloat(document.getElementById('consultingItemExecAmount').value) || 0,
    manager: manager,
    company: document.getElementById('consultingItemCompany').value.trim(),
    companyManager: document.getElementById('consultingItemCompanyManager').value.trim(),
    warranty: document.getElementById('consultingItemWarranty').value.trim(),
    fieldManager: document.getElementById('consultingItemFieldManager').value.trim(),
    photo: document.getElementById('consultingItemPhoto').value,
    contractDate: document.getElementById('consultingItemContractDate').value,
    startDate: document.getElementById('consultingItemStartDate').value,
    endDate: document.getElementById('consultingItemEndDate').value,
    note: document.getElementById('consultingItemNote').value.trim()
  };
  
  if (editId) {
    const idx = consultingListData.findIndex(d => d.id === editId);
    if (idx !== -1) {
      consultingListData[idx] = item;
    }
  } else {
    consultingListData.push(item);
  }
  
  localStorage.setItem('consultingListData', JSON.stringify(consultingListData));
  
  // ì •ì‚°ê´€ë¦¬ ë°ì´í„°ì—ë„ ë™ê¸°í™”
  syncConsultingToSettlement(item);
  
  showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
  closeConsultingItemModal();
  renderConsultingMain();  // ë©”ì¸ í™”ë©´ ìƒˆë¡œê³ ì¹¨
}

// ì •ì‚°ê´€ë¦¬ ê¸°ìˆ ì»¨ì„¤íŒ…ê³¼ ë™ê¸°í™”
function syncConsultingToSettlement(item) {
  // ì •ì‚°ê´€ë¦¬ ë°ì´í„°ì—ì„œ ê°™ì€ ID ì°¾ê¸°
  const existIdx = consultingData.findIndex(d => d.listId === item.id);
  
  const settlementItem = {
    id: existIdx !== -1 ? consultingData[existIdx].id : Date.now().toString() + '_s',
    listId: item.id,
    year: item.year,
    type: item.type,
    site: item.site,
    project: item.project,
    bidAmount: item.bidAmount,
    execAmount: item.execAmount,
    companyExp: existIdx !== -1 ? consultingData[existIdx].companyExp : 0,
    otherExp: existIdx !== -1 ? consultingData[existIdx].otherExp : 0,
    manager: item.manager,
    settled: existIdx !== -1 ? consultingData[existIdx].settled : 'ë¯¸ì •ì‚°'
  };
  
  // ê³„ì‚°
  settlementItem.totalExpense = settlementItem.execAmount + settlementItem.companyExp + settlementItem.otherExp;
  settlementItem.profit = settlementItem.bidAmount - settlementItem.totalExpense;
  settlementItem.profitRate = settlementItem.bidAmount > 0 ? (settlementItem.profit / settlementItem.bidAmount * 100).toFixed(1) : '0.0';
  settlementItem.settlement = settlementItem.profit > 0 ? Math.round(settlementItem.profit * 0.15) : 0;
  settlementItem.companyProfit = settlementItem.profit - settlementItem.settlement;
  
  if (existIdx !== -1) {
    consultingData[existIdx] = settlementItem;
  } else {
    consultingData.push(settlementItem);
  }
  
  localStorage.setItem('consultingData', JSON.stringify(consultingData));
}

// ì‚­ì œ
function deleteConsultingListItem(id) {
  if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  consultingListData = consultingListData.filter(d => d.id !== id);
  localStorage.setItem('consultingListData', JSON.stringify(consultingListData));
  
  // ì •ì‚°ê´€ë¦¬ì—ì„œë„ ì‚­ì œ
  consultingData = consultingData.filter(d => d.listId !== id);
  localStorage.setItem('consultingData', JSON.stringify(consultingData));
  
  showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
  renderConsultingMain();  // ë©”ì¸ í™”ë©´ ìƒˆë¡œê³ ì¹¨
}

// ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
function downloadConsultingListExcel() {
  const wsData = [
    ['ë…„ë„', 'êµ¬ë¶„', 'ì»¨ì„¤íŒ…', 'ê³µì‚¬í˜„ì¥', 'ê³µì‚¬ëª…', 'ë‚™ì°°ê¸ˆì•¡', 'ì‹¤í–‰ê¸ˆì•¡', 'ì˜ì—…ë‹´ë‹¹ì', 'ì—…ì²´ëª…', 'ì—…ì²´ë‹´ë‹¹ì', 'í•˜ìê¸°ê°„', 'í˜„ì¥ì†Œì¥', 'ì‚¬ì§„ì²©', 'ê³„ì•½ì¼', 'ì‹¤ì°©ê³µì¼', 'ì‹¤ì¤€ê³µì¼', 'ë¹„ê³ ']
  ];
  
  consultingListData.forEach(item => {
    wsData.push([
      item.year,
      item.type,
      item.consulting,
      item.site,
      item.project,
      item.bidAmount,
      item.execAmount,
      item.manager,
      item.company,
      item.companyManager,
      item.warranty,
      item.fieldManager,
      item.photo,
      item.contractDate,
      item.startDate,
      item.endDate,
      item.note
    ]);
  });
  
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ê¸°ìˆ ì»¨ì„¤íŒ…');
  
  XLSX.writeFile(wb, `ê¸°ìˆ ì»¨ì„¤íŒ…_ë¦¬ìŠ¤íŠ¸_${new Date().toISOString().split('T')[0]}.xlsx`);
  showToast('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
}


function downloadSettlementExcel() {
  const data = settlementData.length > 0 ? settlementData : generateSettlementFromCurrentData();
  
  // ì—‘ì…€ ë°ì´í„° ìƒì„±
  const wsData = [
    ['NO', 'ê³µì‚¬ì¢…ë¥˜', 'ê³µì‚¬í˜„ì¥', 'ê³µì‚¬ê¸ˆì•¡', 'ì…ê¸ˆì—¬ë¶€', 'ìì¬ë¹„', 'ë…¸ë¬´ë¹„', 'ê²½ë¹„í•©ê³„', 'ì§€ì¶œì´ì•¡', 'ì´ìµê¸ˆ', 'ì´ìµë¥ ', 'ì‹¤ì •ì‚°ê¸ˆì•¡(15%)', 'ê³µì‚¬ìˆ˜ìµ(85%)', 'ì˜ì—…ë‹´ë‹¹ì']
  ];
  
  data.forEach(item => {
    wsData.push([
      item.no,
      item.type,
      item.site,
      item.amount,
      item.status,
      item.material,
      item.laborTotal || item.labor,
      item.expenseTotal,
      item.totalExpense,
      item.profit,
      item.profitRate,
      item.realSettlement,
      item.companyProfit,
      item.manager
    ]);
  });
  
  // ë‹´ë‹¹ìë³„ ìš”ì•½ ì‹œíŠ¸
  const summaryData = [['ë‹´ë‹¹ì', 'ê³µì‚¬ê±´ìˆ˜', 'ê³µì‚¬ê¸ˆì•¡í•©ê³„', 'ì´ìµê¸ˆí•©ê³„', 'í‰ê· ì´ìµë¥ ', 'ì‹¤ì •ì‚°ê¸ˆì•¡(15%)', 'íšŒì‚¬ìˆ˜ìµ(85%)']];
  
  const managerSummary = {};
  data.forEach(item => {
    const manager = item.manager || 'ê¸°íƒ€';
    if (!managerSummary[manager]) {
      managerSummary[manager] = { count: 0, amount: 0, profit: 0, realSettlement: 0, companyProfit: 0 };
    }
    managerSummary[manager].count++;
    managerSummary[manager].amount += item.amount || 0;
    managerSummary[manager].profit += item.profit || 0;
    managerSummary[manager].realSettlement += item.realSettlement || 0;
    managerSummary[manager].companyProfit += item.companyProfit || 0;
  });
  
  Object.entries(managerSummary).forEach(([manager, stats]) => {
    summaryData.push([
      manager,
      stats.count,
      stats.amount,
      stats.profit,
      stats.amount > 0 ? stats.profit / stats.amount : 0,
      stats.realSettlement,
      stats.companyProfit
    ]);
  });
  
  const ws1 = XLSX.utils.aoa_to_sheet(wsData);
  const ws2 = XLSX.utils.aoa_to_sheet(summaryData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws1, 'ì •ì‚°ë‚´ì—­');
  XLSX.utils.book_append_sheet(wb, ws2, 'ë‹´ë‹¹ìë³„ìš”ì•½');
  
  XLSX.writeFile(wb, `ì •ì‚°ê´€ë¦¬_${currentYear}_${new Date().toISOString().split('T')[0]}.xlsx`);
  showToast('ì •ì‚° ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
}

// ========== ëŒ€í‘œ ë³´ê³ ì„œ ==========
let currentReportType = 'ë³¸ì‚¬';  // í˜„ì¬ ë³´ê³ ì„œ íƒ€ì…

function openReportModal(type = 'ë³¸ì‚¬') {
  currentReportType = type;
  document.getElementById('reportModal').classList.add('active');
  
  // ëª¨ë‹¬ ì œëª© ë³€ê²½
  const title = type === 'ë³¸ì‚¬' ? 'ğŸ“‹ ë³¸ì‚¬ ë‹´ë‹¹ì ë³´ê³ ì„œ' : 'ğŸ“‹ ì™¸ì£¼ ì´ì‚¬ ë³´ê³ ì„œ';
  document.getElementById('reportModalTitle').textContent = title;
  
  // ëª¨ë‹¬ í—¤ë” ìƒ‰ìƒ ë³€ê²½
  const header = document.getElementById('reportModal').querySelector('.modal-header');
  header.style.background = type === 'ë³¸ì‚¬' ? '#1565c0' : '#7b1fa2';
  
  renderReport(type);
}

function closeReportModal() {
  document.getElementById('reportModal').classList.remove('active');
}

function renderReport(reportType = 'ë³¸ì‚¬') {
  // í˜„ì¬ í•„í„° ì ìš©ëœ ë°ì´í„° ê¸°ì¤€ìœ¼ë¡œ ë³´ê³ ì„œ ìƒì„±
  let data = settlementData.length > 0 ? [...settlementData] : generateSettlementFromCurrentData();
  
  // ë…„ë„ í•„í„° ì ìš©
  const yearFilter = document.getElementById('settlementYearFilter').value;
  if (yearFilter === '2024') {
    data = data.filter(item => String(item.year).includes('24'));
  } else if (yearFilter === '2025') {
    data = data.filter(item => String(item.year).includes('25'));
  } else if (yearFilter === '2024+2025') {
    data = data.filter(item => {
      const is24 = String(item.year).includes('24');
      const is25 = String(item.year).includes('25');
      if (is24) return item.settled !== 'ì •ì‚°ì™„ë£Œ';
      return is25;
    });
  } else if (yearFilter === '2026-1H') {
    data = data.filter(item => {
      if (!String(item.year).includes('26')) return false;
      const paidDate = item.paidDate;
      if (!paidDate) return false;
      const month = new Date(paidDate).getMonth() + 1;
      return month >= 1 && month <= 6;
    });
  } else if (yearFilter === '2026-2H') {
    data = data.filter(item => {
      if (!String(item.year).includes('26')) return false;
      const paidDate = item.paidDate;
      if (!paidDate) return false;
      const month = new Date(paidDate).getMonth() + 1;
      return month >= 7 && month <= 12;
    });
  } else if (yearFilter === '2026') {
    data = data.filter(item => String(item.year).includes('26'));
  }
  
  // ë³¸ì‚¬/ì™¸ì£¼ë³„ ë‹´ë‹¹ì ì§‘ê³„ (ì •ì‚° ì œì™¸ ë‹´ë‹¹ì ë¶„ë¦¬)
  const hqManagers = {};
  const extManagers = {};
  const excludedManagers = {};
  let grandTotal = { count: 0, amount: 0, profit: 0, realSettlement: 0, companyProfit: 0 };
  let hqTotal = { count: 0, amount: 0, profit: 0, realSettlement: 0 };
  let extTotal = { count: 0, amount: 0, profit: 0, realSettlement: 0 };
  let excludedTotal = { count: 0, amount: 0, profit: 0, realSettlement: 0 };
  
  // 24ë…„ ë¯¸ì •ì‚° vs 25ë…„ êµ¬ë¶„ ì§‘ê³„
  const year24Unsettled = { count: 0, amount: 0, profit: 0, realSettlement: 0 };
  const year25Total = { count: 0, amount: 0, profit: 0, realSettlement: 0 };
  
  data.forEach(item => {
    const manager = item.manager || 'ê¸°íƒ€';
    const isExcluded = item.isExcluded || EXCLUDE_MANAGERS.includes(manager);
    const isExt = item.hqType === 'ì™¸ì£¼';
    
    let targetManagers, targetTotal;
    
    if (isExcluded) {
      targetManagers = excludedManagers;
      targetTotal = excludedTotal;
    } else if (isExt) {
      targetManagers = extManagers;
      targetTotal = extTotal;
    } else {
      targetManagers = hqManagers;
      targetTotal = hqTotal;
    }
    
    if (!targetManagers[manager]) {
      targetManagers[manager] = { 
        count: 0, amount: 0, profit: 0, realSettlement: 0, companyProfit: 0,
        year24: { count: 0, amount: 0, profit: 0, realSettlement: 0 },
        year25: { count: 0, amount: 0, profit: 0, realSettlement: 0 }
      };
    }
    
    targetManagers[manager].count++;
    targetManagers[manager].amount += item.amount || 0;
    targetManagers[manager].profit += item.profit || 0;
    targetManagers[manager].realSettlement += item.realSettlement || 0;
    targetManagers[manager].companyProfit += item.companyProfit || 0;
    
    grandTotal.count++;
    grandTotal.amount += item.amount || 0;
    grandTotal.profit += item.profit || 0;
    // ì •ì‚° ì œì™¸ ë‹´ë‹¹ìëŠ” íšŒì‚¬ ìˆ˜ìµì—ë§Œ í¬í•¨
    if (isExcluded) {
      grandTotal.companyProfit += item.profit || 0;  // ì´ìµê¸ˆ ì „ì•¡ íšŒì‚¬
    } else {
      grandTotal.realSettlement += item.realSettlement || 0;
      grandTotal.companyProfit += item.companyProfit || 0;
    }
    
    targetTotal.count++;
    targetTotal.amount += item.amount || 0;
    targetTotal.profit += item.profit || 0;
    targetTotal.realSettlement += item.realSettlement || 0;
    
    // ë…„ë„ë³„ êµ¬ë¶„
    if (String(item.year).includes('24')) {
      targetManagers[manager].year24.count++;
      targetManagers[manager].year24.realSettlement += item.realSettlement || 0;
      year24Unsettled.count++;
      year24Unsettled.amount += item.amount || 0;
      year24Unsettled.profit += item.profit || 0;
      year24Unsettled.realSettlement += item.realSettlement || 0;
    } else if (String(item.year).includes('25')) {
      targetManagers[manager].year25.count++;
      targetManagers[manager].year25.realSettlement += item.realSettlement || 0;
      year25Total.count++;
      year25Total.amount += item.amount || 0;
      year25Total.profit += item.profit || 0;
      year25Total.realSettlement += item.realSettlement || 0;
    }
  });
  
  const today = new Date();
  const reportDate = `${today.getFullYear()}ë…„ ${today.getMonth()+1}ì›” ${today.getDate()}ì¼`;
  
  // ë³´ê³ ì„œ ì œëª©
  let reportTitle = reportType === 'ë³¸ì‚¬' ? 'ğŸ¢ ë³¸ì‚¬ ë‹´ë‹¹ì ì •ì‚° ë³´ê³ ì„œ' : 'ğŸ¤ ì™¸ì£¼ ì´ì‚¬ ì •ì‚° ë³´ê³ ì„œ';
  if (yearFilter === '2026-1H') reportTitle = reportType === 'ë³¸ì‚¬' ? 'ğŸ¢ ë³¸ì‚¬ 2026ë…„ ìƒë°˜ê¸° ë³´ê³ ì„œ' : 'ğŸ¤ ì™¸ì£¼ 2026ë…„ ìƒë°˜ê¸° ë³´ê³ ì„œ';
  else if (yearFilter === '2026-2H') reportTitle = reportType === 'ë³¸ì‚¬' ? 'ğŸ¢ ë³¸ì‚¬ 2026ë…„ í•˜ë°˜ê¸° ë³´ê³ ì„œ' : 'ğŸ¤ ì™¸ì£¼ 2026ë…„ í•˜ë°˜ê¸° ë³´ê³ ì„œ';
  else if (yearFilter === '2024+2025') reportTitle = reportType === 'ë³¸ì‚¬' ? 'ğŸ¢ ë³¸ì‚¬ 24ë…„ ë¯¸ì •ì‚° + 25ë…„ ë³´ê³ ì„œ' : 'ğŸ¤ ì™¸ì£¼ 24ë…„ ë¯¸ì •ì‚° + 25ë…„ ë³´ê³ ì„œ';
  
  // ë³¸ì‚¬/ì™¸ì£¼ì— ë”°ë¥¸ ë°ì´í„° ì„ íƒ
  const targetManagers = reportType === 'ë³¸ì‚¬' ? hqManagers : extManagers;
  const targetTotal = reportType === 'ë³¸ì‚¬' ? hqTotal : extTotal;
  const themeColor = reportType === 'ë³¸ì‚¬' ? '#1565c0' : '#7b1fa2';
  const themeBgColor = reportType === 'ë³¸ì‚¬' ? '#e3f2fd' : '#f3e5f5';
  
  let html = `
    <div class="report-container" style="font-family:'Noto Sans KR',sans-serif;">
      <div style="text-align:center;margin-bottom:2rem;">
        <h2 style="font-size:1.5rem;margin-bottom:0.5rem;color:${themeColor};">${reportTitle}</h2>
        <p style="color:var(--gray-500);font-size:0.875rem;">ë³´ê³ ì¼: ${reportDate}</p>
      </div>
      
      <!-- ìš”ì•½ -->
      <div style="background:${themeBgColor};padding:1.25rem;border-radius:10px;margin-bottom:1.5rem;border:1px solid ${themeColor}40;">
        <h3 style="font-size:1rem;margin-bottom:1rem;color:${themeColor};">ğŸ“ˆ ${reportType} ì •ì‚° ìš”ì•½</h3>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;text-align:center;">
          <div style="background:white;padding:1rem;border-radius:8px;border:1px solid var(--gray-200);">
            <div style="font-size:0.75rem;color:var(--gray-500);">ì´ ê³µì‚¬ê±´ìˆ˜</div>
            <div style="font-size:1.25rem;font-weight:700;color:var(--gray-800);">${targetTotal.count}ê±´</div>
          </div>
          <div style="background:white;padding:1rem;border-radius:8px;border:1px solid var(--gray-200);">
            <div style="font-size:0.75rem;color:var(--gray-500);">ì´ ê³µì‚¬ê¸ˆì•¡</div>
            <div style="font-size:1.25rem;font-weight:700;color:var(--gray-800);">${fmtAmount(targetTotal.amount)}</div>
          </div>
          <div style="background:white;padding:1rem;border-radius:8px;border:1px solid var(--gray-200);">
            <div style="font-size:0.75rem;color:var(--gray-500);">ì´ ì´ìµê¸ˆ</div>
            <div style="font-size:1.25rem;font-weight:700;color:${targetTotal.profit >= 0 ? 'var(--success)' : 'var(--danger)'};">${fmtAmount(targetTotal.profit)}</div>
          </div>
          <div style="background:white;padding:1rem;border-radius:8px;border:1px solid var(--gray-200);">
            <div style="font-size:0.75rem;color:var(--gray-500);">ì •ì‚°ê¸ˆì•¡ (15%)</div>
            <div style="font-size:1.25rem;font-weight:700;color:${themeColor};">${fmtAmount(targetTotal.realSettlement)}</div>
          </div>
        </div>
      </div>
      
      <!-- ë‹´ë‹¹ìë³„ ì •ì‚° í…Œì´ë¸” -->
      ${Object.keys(targetManagers).length > 0 ? `
      <div style="margin-bottom:1.5rem;">
        <h3 style="font-size:1rem;margin-bottom:1rem;color:${themeColor};padding:0.5rem;background:${themeBgColor};border-radius:6px;">
          ${reportType === 'ë³¸ì‚¬' ? 'ğŸ¢' : 'ğŸ¤'} ${reportType} ë‹´ë‹¹ìë³„ ì •ì‚° ë‚´ì—­ (${targetTotal.count}ê±´)
        </h3>
        <table style="width:100%;border-collapse:collapse;font-size:0.8rem;">
          <thead>
            <tr style="background:${themeColor};color:white;">
              <th style="padding:0.625rem;text-align:left;border:1px solid ${themeColor};">ë‹´ë‹¹ì</th>
              <th style="padding:0.625rem;text-align:center;border:1px solid ${themeColor};">ê±´ìˆ˜</th>
              <th style="padding:0.625rem;text-align:right;border:1px solid ${themeColor};">ê³µì‚¬ê¸ˆì•¡</th>
              <th style="padding:0.625rem;text-align:right;border:1px solid ${themeColor};">ì´ìµê¸ˆ</th>
              <th style="padding:0.625rem;text-align:center;border:1px solid ${themeColor};">ì´ìµë¥ </th>
              <th style="padding:0.625rem;text-align:right;border:1px solid ${themeColor};">ì •ì‚°ê¸ˆì•¡(15%)</th>
            </tr>
          </thead>
          <tbody>
            ${Object.entries(targetManagers)
              .sort((a, b) => b[1].realSettlement - a[1].realSettlement)
              .map(([manager, stats]) => `
                <tr style="border-bottom:1px solid var(--gray-200);">
                  <td style="padding:0.625rem;font-weight:600;border:1px solid var(--gray-200);">${manager}</td>
                  <td style="padding:0.625rem;text-align:center;border:1px solid var(--gray-200);">${stats.count}ê±´</td>
                  <td style="padding:0.625rem;text-align:right;font-family:'Courier New',monospace;border:1px solid var(--gray-200);">${fmt(stats.amount)}</td>
                  <td style="padding:0.625rem;text-align:right;font-family:'Courier New',monospace;border:1px solid var(--gray-200);color:${stats.profit >= 0 ? '#2e7d32' : '#c62828'};">${fmt(stats.profit)}</td>
                  <td style="padding:0.625rem;text-align:center;border:1px solid var(--gray-200);">${stats.amount > 0 ? (stats.profit / stats.amount * 100).toFixed(1) : 0}%</td>
                  <td style="padding:0.625rem;text-align:right;font-family:'Courier New',monospace;font-weight:700;color:${themeColor};border:1px solid var(--gray-200);">${fmt(stats.realSettlement)}</td>
                </tr>
              `).join('')}
          </tbody>
          <tfoot>
            <tr style="background:${themeBgColor};font-weight:700;">
              <td style="padding:0.625rem;border:1px solid var(--gray-300);">${reportType} í•©ê³„</td>
              <td style="padding:0.625rem;text-align:center;border:1px solid var(--gray-300);">${targetTotal.count}ê±´</td>
              <td style="padding:0.625rem;text-align:right;font-family:'Courier New',monospace;border:1px solid var(--gray-300);">${fmt(targetTotal.amount)}</td>
              <td style="padding:0.625rem;text-align:right;font-family:'Courier New',monospace;border:1px solid var(--gray-300);color:${targetTotal.profit >= 0 ? '#2e7d32' : '#c62828'};">${fmt(targetTotal.profit)}</td>
              <td style="padding:0.625rem;text-align:center;border:1px solid var(--gray-300);">${targetTotal.amount > 0 ? (targetTotal.profit / targetTotal.amount * 100).toFixed(1) : 0}%</td>
              <td style="padding:0.625rem;text-align:right;font-family:'Courier New',monospace;font-weight:700;color:${themeColor};border:1px solid var(--gray-300);">${fmt(targetTotal.realSettlement)}</td>
            </tr>
          </tfoot>
        </table>
      </div>
      ` : ''}
      
      <!-- ë³¸ì‚¬ ë‹´ë‹¹ìë³„ ë¯¸ì •ì‚° ë‚´ì—­ (24ë…„/25ë…„ ë¶„ë¦¬) - ë³¸ì‚¬ ë³´ê³ ì„œì—ë§Œ í‘œì‹œ -->
      ${reportType === 'ë³¸ì‚¬' ? renderHqUnsettledByYear(data) : renderExtUnsettledByYear(data)}
      
      <!-- ì´ í•©ê³„ -->
      <div style="background:var(--gray-700);color:white;padding:1rem;border-radius:8px;margin-bottom:1rem;">
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;text-align:center;">
          <div>
            <div style="font-size:0.75rem;opacity:0.8;">ì´ ê±´ìˆ˜</div>
            <div style="font-size:1.25rem;font-weight:700;">${grandTotal.count}ê±´</div>
          </div>
          <div>
            <div style="font-size:0.75rem;opacity:0.8;">ì´ ì´ìµê¸ˆ</div>
            <div style="font-size:1.25rem;font-weight:700;">${fmtAmount(grandTotal.profit)}</div>
          </div>
          <div>
            <div style="font-size:0.75rem;opacity:0.8;">ë‹´ë‹¹ì ë°°ë¶„ í•©ê³„</div>
            <div style="font-size:1.25rem;font-weight:700;">${fmtAmount(grandTotal.realSettlement)}</div>
          </div>
          <div>
            <div style="font-size:0.75rem;opacity:0.8;">íšŒì‚¬ ìˆ˜ìµ í•©ê³„</div>
            <div style="font-size:1.25rem;font-weight:700;">${fmtAmount(grandTotal.companyProfit)}</div>
          </div>
        </div>
      </div>
      
      <div style="text-align:center;padding-top:1rem;border-top:1px solid var(--gray-200);color:var(--gray-400);font-size:0.75rem;">
        ãˆœì„ë¯¼ì´ì•¤ì”¨ ì •ì‚° ê´€ë¦¬ ì‹œìŠ¤í…œ
      </div>
    </div>
  `;
  
  document.getElementById('reportContent').innerHTML = html;
}

// ë³¸ì‚¬ ë‹´ë‹¹ìë³„ ë¯¸ì •ì‚° ë‚´ì—­ (24ë…„/25ë…„ ë¶„ë¦¬)
function renderHqUnsettledByYear(data) {
  // ë¯¸ì •ì‚° ë°ì´í„°ë§Œ í•„í„°
  const unsettledData = data.filter(item => item.settled === 'ë¯¸ì •ì‚°');
  
  // ë³¸ì‚¬ë§Œ í•„í„°
  const hqUnsettled = unsettledData.filter(item => {
    const isExt = item.hqType === 'ì™¸ì£¼' || (item.type && item.type.includes('(ì™¸)'));
    const isExcluded = item.isExcluded || EXCLUDE_MANAGERS.includes(item.manager);
    return !isExt && !isExcluded;
  });
  
  if (hqUnsettled.length === 0) return '';
  
  // 24ë…„/25ë…„ ë¶„ë¦¬
  const data24 = hqUnsettled.filter(item => String(item.year).includes('24'));
  const data25 = hqUnsettled.filter(item => String(item.year).includes('25'));
  
  // ë‹´ë‹¹ìë³„ ì§‘ê³„
  const groupByManager = (items) => {
    const result = {};
    items.forEach(item => {
      const manager = item.manager || 'ê¸°íƒ€';
      if (!result[manager]) {
        result[manager] = { count: 0, amount: 0, profit: 0, realSettlement: 0, sites: [] };
      }
      result[manager].count++;
      result[manager].amount += item.amount || 0;
      result[manager].profit += item.profit || 0;
      result[manager].realSettlement += item.realSettlement || 0;
      result[manager].sites.push({ no: item.no, site: item.site, amount: item.amount, settlement: item.realSettlement });
    });
    return result;
  };
  
  const managers24 = groupByManager(data24);
  const managers25 = groupByManager(data25);
  
  // ì „ì²´ í•©ê³„
  const total24 = { count: data24.length, settlement: data24.reduce((sum, i) => sum + (i.realSettlement || 0), 0) };
  const total25 = { count: data25.length, settlement: data25.reduce((sum, i) => sum + (i.realSettlement || 0), 0) };
  
  // í…Œì´ë¸” í–‰ ìƒì„± í•¨ìˆ˜
  const renderManagerRows = (managers) => {
    return Object.entries(managers)
      .sort((a, b) => b[1].realSettlement - a[1].realSettlement)
      .map(([manager, stats]) => `
        <tr style="border-bottom:1px solid #ddd;">
          <td style="padding:0.5rem;font-weight:600;border:1px solid #ddd;">${manager}</td>
          <td style="padding:0.5rem;text-align:center;border:1px solid #ddd;">${stats.count}ê±´</td>
          <td style="padding:0.5rem;text-align:right;font-family:monospace;border:1px solid #ddd;">${fmt(stats.amount)}</td>
          <td style="padding:0.5rem;text-align:right;font-family:monospace;font-weight:700;color:#1565c0;border:1px solid #ddd;">${fmt(stats.realSettlement)}</td>
        </tr>
      `).join('');
  };
  
  let html = `
    <div style="margin-bottom:1.5rem;page-break-before:always;">
      <h3 style="font-size:1.1rem;margin-bottom:1rem;color:#e65100;padding:0.75rem;background:#fff3e0;border-radius:6px;border-left:4px solid #ff9800;">
        ğŸ“‹ ë³¸ì‚¬ ë‹´ë‹¹ìë³„ ë¯¸ì •ì‚° ë‚´ì—­ (24ë…„ + 25ë…„)
      </h3>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;">
        <!-- 24ë…„ ë¯¸ì •ì‚° -->
        <div>
          <h4 style="font-size:0.95rem;margin-bottom:0.75rem;color:#e65100;padding:0.5rem;background:#ffecb3;border-radius:4px;">
            ğŸ“… 2024ë…„ ë¯¸ì •ì‚° (${total24.count}ê±´)
          </h4>
          ${data24.length > 0 ? `
          <table style="width:100%;border-collapse:collapse;font-size:0.8rem;">
            <thead>
              <tr style="background:#ff9800;color:white;">
                <th style="padding:0.5rem;text-align:left;border:1px solid #e65100;">ë‹´ë‹¹ì</th>
                <th style="padding:0.5rem;text-align:center;border:1px solid #e65100;">ê±´ìˆ˜</th>
                <th style="padding:0.5rem;text-align:right;border:1px solid #e65100;">ê³µì‚¬ê¸ˆì•¡</th>
                <th style="padding:0.5rem;text-align:right;border:1px solid #e65100;">ì •ì‚°ê¸ˆì•¡</th>
              </tr>
            </thead>
            <tbody>
              ${renderManagerRows(managers24)}
            </tbody>
            <tfoot>
              <tr style="background:#ffecb3;font-weight:700;">
                <td style="padding:0.5rem;border:1px solid #ddd;">í•©ê³„</td>
                <td style="padding:0.5rem;text-align:center;border:1px solid #ddd;">${total24.count}ê±´</td>
                <td style="padding:0.5rem;text-align:right;font-family:monospace;border:1px solid #ddd;">${fmt(data24.reduce((s,i) => s + (i.amount||0), 0))}</td>
                <td style="padding:0.5rem;text-align:right;font-family:monospace;font-weight:700;color:#e65100;border:1px solid #ddd;">${fmt(total24.settlement)}</td>
              </tr>
            </tfoot>
          </table>
          ` : '<p style="color:#999;text-align:center;padding:1rem;">ë¯¸ì •ì‚° í˜„ì¥ ì—†ìŒ</p>'}
        </div>
        
        <!-- 25ë…„ ë¯¸ì •ì‚° -->
        <div>
          <h4 style="font-size:0.95rem;margin-bottom:0.75rem;color:#1565c0;padding:0.5rem;background:#bbdefb;border-radius:4px;">
            ğŸ“… 2025ë…„ ë¯¸ì •ì‚° (${total25.count}ê±´)
          </h4>
          ${data25.length > 0 ? `
          <table style="width:100%;border-collapse:collapse;font-size:0.8rem;">
            <thead>
              <tr style="background:#1976d2;color:white;">
                <th style="padding:0.5rem;text-align:left;border:1px solid #1565c0;">ë‹´ë‹¹ì</th>
                <th style="padding:0.5rem;text-align:center;border:1px solid #1565c0;">ê±´ìˆ˜</th>
                <th style="padding:0.5rem;text-align:right;border:1px solid #1565c0;">ê³µì‚¬ê¸ˆì•¡</th>
                <th style="padding:0.5rem;text-align:right;border:1px solid #1565c0;">ì •ì‚°ê¸ˆì•¡</th>
              </tr>
            </thead>
            <tbody>
              ${renderManagerRows(managers25)}
            </tbody>
            <tfoot>
              <tr style="background:#bbdefb;font-weight:700;">
                <td style="padding:0.5rem;border:1px solid #ddd;">í•©ê³„</td>
                <td style="padding:0.5rem;text-align:center;border:1px solid #ddd;">${total25.count}ê±´</td>
                <td style="padding:0.5rem;text-align:right;font-family:monospace;border:1px solid #ddd;">${fmt(data25.reduce((s,i) => s + (i.amount||0), 0))}</td>
                <td style="padding:0.5rem;text-align:right;font-family:monospace;font-weight:700;color:#1565c0;border:1px solid #ddd;">${fmt(total25.settlement)}</td>
              </tr>
            </tfoot>
          </table>
          ` : '<p style="color:#999;text-align:center;padding:1rem;">ë¯¸ì •ì‚° í˜„ì¥ ì—†ìŒ</p>'}
        </div>
      </div>
      
      <!-- ì´ ë¯¸ì •ì‚° í•©ê³„ -->
      <div style="margin-top:1rem;padding:1rem;background:#ffebee;border-radius:8px;border:1px solid #ef9a9a;text-align:center;">
        <span style="font-size:0.9rem;color:#c62828;">ğŸ“Œ ë³¸ì‚¬ ë‹´ë‹¹ì ë¯¸ì •ì‚° ì´ì•¡: </span>
        <span style="font-size:1.3rem;font-weight:700;color:#c62828;">${fmt(total24.settlement + total25.settlement)}</span>
        <span style="font-size:0.85rem;color:#666;margin-left:0.5rem;">(24ë…„ ${fmt(total24.settlement)} + 25ë…„ ${fmt(total25.settlement)})</span>
      </div>
    </div>
  `;
  
  return html;
}

// ì™¸ì£¼ ë‹´ë‹¹ìë³„ ë¯¸ì •ì‚° ë‚´ì—­ (24ë…„/25ë…„ ë¶„ë¦¬)
function renderExtUnsettledByYear(data) {
  // ë¯¸ì •ì‚° ë°ì´í„°ë§Œ í•„í„°
  const unsettledData = data.filter(item => item.settled === 'ë¯¸ì •ì‚°');
  
  // ì™¸ì£¼ë§Œ í•„í„°
  const extUnsettled = unsettledData.filter(item => {
    const isExt = item.hqType === 'ì™¸ì£¼' || (item.type && item.type.includes('(ì™¸)'));
    return isExt;
  });
  
  if (extUnsettled.length === 0) return '';
  
  // 24ë…„/25ë…„ ë¶„ë¦¬
  const data24 = extUnsettled.filter(item => String(item.year).includes('24'));
  const data25 = extUnsettled.filter(item => String(item.year).includes('25'));
  
  // ë‹´ë‹¹ìë³„ ì§‘ê³„
  const groupByManager = (items) => {
    const result = {};
    items.forEach(item => {
      const manager = item.manager || 'ê¸°íƒ€';
      if (!result[manager]) {
        result[manager] = { count: 0, amount: 0, profit: 0, realSettlement: 0, sites: [] };
      }
      result[manager].count++;
      result[manager].amount += item.amount || 0;
      result[manager].profit += item.profit || 0;
      result[manager].realSettlement += item.realSettlement || 0;
      result[manager].sites.push({ no: item.no, site: item.site, amount: item.amount, settlement: item.realSettlement });
    });
    return result;
  };
  
  const managers24 = groupByManager(data24);
  const managers25 = groupByManager(data25);
  
  // ì „ì²´ í•©ê³„
  const total24 = { count: data24.length, settlement: data24.reduce((sum, i) => sum + (i.realSettlement || 0), 0) };
  const total25 = { count: data25.length, settlement: data25.reduce((sum, i) => sum + (i.realSettlement || 0), 0) };
  
  // í…Œì´ë¸” í–‰ ìƒì„± í•¨ìˆ˜
  const renderManagerRows = (managers) => {
    return Object.entries(managers)
      .sort((a, b) => b[1].realSettlement - a[1].realSettlement)
      .map(([manager, stats]) => `
        <tr style="border-bottom:1px solid #ddd;">
          <td style="padding:0.5rem;font-weight:600;border:1px solid #ddd;">${manager}</td>
          <td style="padding:0.5rem;text-align:center;border:1px solid #ddd;">${stats.count}ê±´</td>
          <td style="padding:0.5rem;text-align:right;font-family:monospace;border:1px solid #ddd;">${fmt(stats.amount)}</td>
          <td style="padding:0.5rem;text-align:right;font-family:monospace;font-weight:700;color:#7b1fa2;border:1px solid #ddd;">${fmt(stats.realSettlement)}</td>
        </tr>
      `).join('');
  };
  
  let html = `
    <div style="margin-bottom:1.5rem;page-break-before:always;">
      <h3 style="font-size:1.1rem;margin-bottom:1rem;color:#7b1fa2;padding:0.75rem;background:#f3e5f5;border-radius:6px;border-left:4px solid #9c27b0;">
        ğŸ“‹ ì™¸ì£¼ ë‹´ë‹¹ìë³„ ë¯¸ì •ì‚° ë‚´ì—­ (24ë…„ + 25ë…„)
      </h3>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;">
        <!-- 24ë…„ ë¯¸ì •ì‚° -->
        <div>
          <h4 style="font-size:0.95rem;margin-bottom:0.75rem;color:#7b1fa2;padding:0.5rem;background:#e1bee7;border-radius:4px;">
            ğŸ“… 2024ë…„ ë¯¸ì •ì‚° (${total24.count}ê±´)
          </h4>
          ${data24.length > 0 ? `
          <table style="width:100%;border-collapse:collapse;font-size:0.8rem;">
            <thead>
              <tr style="background:#9c27b0;color:white;">
                <th style="padding:0.5rem;text-align:left;border:1px solid #7b1fa2;">ë‹´ë‹¹ì</th>
                <th style="padding:0.5rem;text-align:center;border:1px solid #7b1fa2;">ê±´ìˆ˜</th>
                <th style="padding:0.5rem;text-align:right;border:1px solid #7b1fa2;">ê³µì‚¬ê¸ˆì•¡</th>
                <th style="padding:0.5rem;text-align:right;border:1px solid #7b1fa2;">ì •ì‚°ê¸ˆì•¡</th>
              </tr>
            </thead>
            <tbody>
              ${renderManagerRows(managers24)}
            </tbody>
            <tfoot>
              <tr style="background:#e1bee7;font-weight:700;">
                <td style="padding:0.5rem;border:1px solid #ddd;">í•©ê³„</td>
                <td style="padding:0.5rem;text-align:center;border:1px solid #ddd;">${total24.count}ê±´</td>
                <td style="padding:0.5rem;text-align:right;font-family:monospace;border:1px solid #ddd;">${fmt(data24.reduce((s,i) => s + (i.amount||0), 0))}</td>
                <td style="padding:0.5rem;text-align:right;font-family:monospace;font-weight:700;color:#7b1fa2;border:1px solid #ddd;">${fmt(total24.settlement)}</td>
              </tr>
            </tfoot>
          </table>
          ` : '<p style="color:#999;text-align:center;padding:1rem;">ë¯¸ì •ì‚° í˜„ì¥ ì—†ìŒ</p>'}
        </div>
        
        <!-- 25ë…„ ë¯¸ì •ì‚° -->
        <div>
          <h4 style="font-size:0.95rem;margin-bottom:0.75rem;color:#7b1fa2;padding:0.5rem;background:#e1bee7;border-radius:4px;">
            ğŸ“… 2025ë…„ ë¯¸ì •ì‚° (${total25.count}ê±´)
          </h4>
          ${data25.length > 0 ? `
          <table style="width:100%;border-collapse:collapse;font-size:0.8rem;">
            <thead>
              <tr style="background:#9c27b0;color:white;">
                <th style="padding:0.5rem;text-align:left;border:1px solid #7b1fa2;">ë‹´ë‹¹ì</th>
                <th style="padding:0.5rem;text-align:center;border:1px solid #7b1fa2;">ê±´ìˆ˜</th>
                <th style="padding:0.5rem;text-align:right;border:1px solid #7b1fa2;">ê³µì‚¬ê¸ˆì•¡</th>
                <th style="padding:0.5rem;text-align:right;border:1px solid #7b1fa2;">ì •ì‚°ê¸ˆì•¡</th>
              </tr>
            </thead>
            <tbody>
              ${renderManagerRows(managers25)}
            </tbody>
            <tfoot>
              <tr style="background:#e1bee7;font-weight:700;">
                <td style="padding:0.5rem;border:1px solid #ddd;">í•©ê³„</td>
                <td style="padding:0.5rem;text-align:center;border:1px solid #ddd;">${total25.count}ê±´</td>
                <td style="padding:0.5rem;text-align:right;font-family:monospace;border:1px solid #ddd;">${fmt(data25.reduce((s,i) => s + (i.amount||0), 0))}</td>
                <td style="padding:0.5rem;text-align:right;font-family:monospace;font-weight:700;color:#7b1fa2;border:1px solid #ddd;">${fmt(total25.settlement)}</td>
              </tr>
            </tfoot>
          </table>
          ` : '<p style="color:#999;text-align:center;padding:1rem;">ë¯¸ì •ì‚° í˜„ì¥ ì—†ìŒ</p>'}
        </div>
      </div>
      
      <!-- ì´ ë¯¸ì •ì‚° í•©ê³„ -->
      <div style="margin-top:1rem;padding:1rem;background:#f3e5f5;border-radius:8px;border:1px solid #ce93d8;text-align:center;">
        <span style="font-size:0.9rem;color:#7b1fa2;">ğŸ“Œ ì™¸ì£¼ ë‹´ë‹¹ì ë¯¸ì •ì‚° ì´ì•¡: </span>
        <span style="font-size:1.3rem;font-weight:700;color:#7b1fa2;">${fmt(total24.settlement + total25.settlement)}</span>
        <span style="font-size:0.85rem;color:#666;margin-left:0.5rem;">(24ë…„ ${fmt(total24.settlement)} + 25ë…„ ${fmt(total25.settlement)})</span>
      </div>
    </div>
  `;
  
  return html;
}

function printReport() {
  const content = document.getElementById('reportContent').innerHTML;
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>ì •ì‚° í˜„í™© ë³´ê³ ì„œ</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', 'Malgun Gothic', sans-serif; padding: 20px; font-size: 12px; }
        @media print { body { padding: 0; } }
      </style>
    </head>
    <body>${content}</body>
    </html>
  `);
  printWindow.document.close();
  setTimeout(() => printWindow.print(), 300);
}

function downloadReportExcel() {
  let data = settlementData.length > 0 ? [...settlementData] : generateSettlementFromCurrentData();
  
  const yearFilter = document.getElementById('settlementYearFilter').value;
  if (yearFilter === '2024') {
    data = data.filter(item => String(item.year).includes('24'));
  } else if (yearFilter === '2025') {
    data = data.filter(item => String(item.year).includes('25'));
  } else if (yearFilter === '2024+2025') {
    data = data.filter(item => {
      const is24 = String(item.year).includes('24');
      const is25 = String(item.year).includes('25');
      if (is24) return item.settled !== 'ì •ì‚°ì™„ë£Œ';
      return is25;
    });
  }
  
  // ë‹´ë‹¹ìë³„ ìš”ì•½
  const managerSummary = {};
  data.forEach(item => {
    const manager = item.manager || 'ê¸°íƒ€';
    if (!managerSummary[manager]) {
      managerSummary[manager] = { count: 0, amount: 0, profit: 0, realSettlement: 0, companyProfit: 0 };
    }
    managerSummary[manager].count++;
    managerSummary[manager].amount += item.amount || 0;
    managerSummary[manager].profit += item.profit || 0;
    managerSummary[manager].realSettlement += item.realSettlement || 0;
    managerSummary[manager].companyProfit += item.companyProfit || 0;
  });
  
  const wsData = [
    ['ì •ì‚° í˜„í™© ë³´ê³ ì„œ'],
    ['ë³´ê³ ì¼: ' + new Date().toLocaleDateString('ko-KR')],
    [],
    ['ë‹´ë‹¹ì', 'ê±´ìˆ˜', 'ê³µì‚¬ê¸ˆì•¡', 'ì´ìµê¸ˆ', 'ì´ìµë¥ ', 'ì •ì‚°ê¸ˆì•¡(15%)', 'íšŒì‚¬ìˆ˜ìµ(85%)']
  ];
  
  let totals = { count: 0, amount: 0, profit: 0, realSettlement: 0, companyProfit: 0 };
  
  Object.entries(managerSummary)
    .sort((a, b) => b[1].realSettlement - a[1].realSettlement)
    .forEach(([manager, stats]) => {
      wsData.push([
        manager,
        stats.count,
        stats.amount,
        stats.profit,
        stats.amount > 0 ? stats.profit / stats.amount : 0,
        stats.realSettlement,
        stats.companyProfit
      ]);
      totals.count += stats.count;
      totals.amount += stats.amount;
      totals.profit += stats.profit;
      totals.realSettlement += stats.realSettlement;
      totals.companyProfit += stats.companyProfit;
    });
  
  wsData.push([
    'í•©ê³„',
    totals.count,
    totals.amount,
    totals.profit,
    totals.amount > 0 ? totals.profit / totals.amount : 0,
    totals.realSettlement,
    totals.companyProfit
  ]);
  
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ë³´ê³ ì„œ');
  
  XLSX.writeFile(wb, `ì •ì‚°ë³´ê³ ì„œ_${new Date().toISOString().split('T')[0]}.xlsx`);
  showToast('ë³´ê³ ì„œ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
}
</script>
</body>
</html>
